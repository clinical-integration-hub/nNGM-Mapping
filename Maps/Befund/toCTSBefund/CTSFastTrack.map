/// version = 0.1
/// title = "nNGM: Mapping Fast Track CTS"

map "http://uk-koeln.de/fhir/StructureMap/nNGM_Mapping_FastTrackCTS" = nNGM_Mapping_FastTrackCTS

uses "http://hl7.org/fhir/StructureDefinition/Bundle" as source
uses "http://hl7.org/fhir/StructureDefinition/CTS_Transport" as target

group TransformCTS(source src: Bundle, target tgt: CTS_Transport)
{
    src -> tgt.version = '1.1';
    src -> tgt.sourcesystem = 'https:\/\/nngm-qat.staging.healex.systems\/';

    src -> tgt.operations as operations collate, operations.crfid = '*2-FT1';
    src -> tgt.operations as operations collate, operations.type = 'save';

     src.entry as entry then
    {
        /*---------------Episode Of Care----------------*/
        entry.resource as episodeofcare where "resource is EpisodeOfCare" then
        {
            //Biopsie-ID
            episodeofcare -> tgt.operations as operations collate then
            {
                //Untersuchung-ID
                episodeofcare -> operations.data as data then
                {
                    episodeofcare.identifier as identifier, identifier.value as value then
                    {   
                        episodeofcare -> data.blockindex = 1;
                        episodeofcare -> data.groupindex = 0;
                        episodeofcare -> data.itemid = 'assessment_id';
                        value -> data.values as values, values.value = value;
                    };
                };
            };
        };
        /*---------------Organization----------------*/
        entry.resource as organization where "resource is Organization" then
        {
            //Standort
            organization -> tgt.operations as operations collate then
            {
                organization -> operations.data as data then
                {
                    organization.name as name then
                    {   
                        organization -> data.blockindex = 2;
                        organization -> data.groupindex = 0;
                        organization -> data.itemid = 'id_2435';
                        name -> data.values as values, values.value = name;
                    };
                };                
            };
            //SOP-Versionsnummer des Standorts
            organization -> tgt.operations as operations collate then
            {
                organization -> operations.data as data then
                {
                    organization.type as type then
                    {   
                        organization -> data.blockindex = 2;
                        organization -> data.groupindex = 0;
                        organization -> data.itemid = 'id_2486';
                        type.text as text -> data.values as values, values.value = text;
                    };
                };                
            };
        };
        /*-----------------------BRAF Exon 15----------------------*/
        entry.resource as observation where "resource is Observation 
                                            and resource.code.coding.code = 'BRAF Exon 15'" then
        {
            //Date Of Assesment
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.effectivePeriod as period then
                    {   
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_1945';
                        period.start as dateOfAssessment -> data.values as values, values.value = dateOfAssessment;
                    };
                };                
            };
            //Assay
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {
                        component.code where "code.coding.code = 'C60819'"then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_1912';
                            component.valueString as valueString -> data.values as values, values.value = valueString;
                        };
                    };
                };                
            };
            //Hersteller
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {
                        component.code where "code.coding.code = 'C25392'"then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_1912';
                            component.valueCodeableConcept as valueCodeableConcept,
                            valueCodeableConcept.coding as coding, coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };                
            };
            //Ergebnis
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {
                        component.code where "code.coding.code = 'testCodeErgebnis'"then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_1946';
                            component.valueCodeableConcept as valueCodeableConcept,
                            valueCodeableConcept.coding as coding, coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };                
            };
            //Change DNA
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {
                        component.code where "code.coding.code = '48004-6'"then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_1947';
                            component.valueString as valueString -> data.values as values, values.value = valueString;
                        };
                    };
                };                
            };
            //Change Protein
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {
                        component.code where "code.coding.code = '48005-3'"then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_1948';
                            component.valueString as valueString -> data.values as values, values.value = valueString;
                        };
                    };
                };                
            };


        };

        /*-----------------------Observation EGFR Exon 19----------------------*/
        entry.resource as observation where "resource is Observation 
                                            and resource.code.coding.code = 'C128662'" then
        {
            //Date Of Assesment
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.effectivePeriod as period then
                    {   
                        observation -> data.blockindex = 5;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'ft_grp_egfr_19-21';
                        period.start as dateOfAssessment -> data.values as values, values.value = dateOfAssessment;
                    };
                };                
            };
            //Assay
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {
                        component.code where "code.coding.code = 'C60819'"then
                        {
                            observation -> data.blockindex = 5;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2608';
                            component.valueString as valueString -> data.values as values, values.value = valueString;
                        };
                    };
                };                
            };
            //Hersteller
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {
                        component.code where "code.coding.code = 'C25392'"then
                        {
                            observation -> data.blockindex = 5;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2609';
                            component.valueCodeableConcept as valueCodeableConcept,
                            valueCodeableConcept.coding as coding, coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };                
            };
            //Ergebnis
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {
                        component.code where "code.coding.code = 'testCodeErgebnis'"then
                        {
                            observation -> data.blockindex = 5;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_1950';
                            component.valueCodeableConcept as valueCodeableConcept,
                            valueCodeableConcept.coding as coding, coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };                
            };
            //Change DNA
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {
                        component.code where "code.coding.code = '48004-6'"then
                        {
                            observation -> data.blockindex = 5;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_1951';
                            component.valueString as valueString -> data.values as values, values.value = valueString;
                        };
                    };
                };                
            };
            //Change Protein
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {
                        component.code where "code.coding.code = '48005-3'"then
                        {
                            observation -> data.blockindex = 5;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_1952';
                            component.valueString as valueString -> data.values as values, values.value = valueString;
                        };
                    };
                };                
            };

        };
         /*-----------------------BRAF Exon 20----------------------*/
        entry.resource as observation where "resource is Observation 
                                            and resource.code.coding.code = 'EGFR Exon 20'" then
        {
            //Ergebnis
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {
                        component.code where "code.coding.code = 'testCodeErgebnis'"then
                        {
                            observation -> data.blockindex = 5;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_1954';
                            component.valueCodeableConcept as valueCodeableConcept,
                            valueCodeableConcept.coding as coding, coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };                
            };
            //Change DNA
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {
                        component.code where "code.coding.code = '48004-6'"then
                        {
                            observation -> data.blockindex = 5;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_1955';
                            component.valueString as valueString -> data.values as values, values.value = valueString;
                        };
                    };
                };                
            };
            //Change Protein
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {
                        component.code where "code.coding.code = '48005-3'"then
                        {
                            observation -> data.blockindex = 5;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_1956';
                            component.valueString as valueString -> data.values as values, values.value = valueString;
                        };
                    };
                };                
            };
        };

        /*-----------------------BRAF Exon 21----------------------*/
        entry.resource as observation where "resource is Observation 
                                            and resource.code.coding.code = 'EGFR Exon 21'" then
        {
            //Ergebnis
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {
                        component.code where "code.coding.code = 'testCodeErgebnis'"then
                        {
                            observation -> data.blockindex = 5;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_1958';
                            component.valueCodeableConcept as valueCodeableConcept,
                            valueCodeableConcept.coding as coding, coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };                
            };
            //Change DNA
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {
                        component.code where "code.coding.code = '48004-6'"then
                        {
                            observation -> data.blockindex = 5;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_1959';
                            component.valueString as valueString -> data.values as values, values.value = valueString;
                        };
                    };
                };                
            };
            //Change Protein
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {
                        component.code where "code.coding.code = '48005-3'"then
                        {
                            observation -> data.blockindex = 5;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_1960';
                            component.valueString as valueString -> data.values as values, values.value = valueString;
                        };
                    };
                };                
            };
        };

        /*-----------------------KRAS Exon 2----------------------*/
        entry.resource as observation where "resource is Observation 
                                            and resource.code.coding.code = 'C135715'" then
        {
            //Date Of Assesment
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.effectivePeriod as period then
                    {   
                        observation -> data.blockindex = 6;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_1961';
                        period.start as dateOfAssessment -> data.values as values, values.value = dateOfAssessment;
                    };
                };                
            };
            //Assay
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {
                        component.code where "code.coding.code = 'C60819'"then
                        {
                            observation -> data.blockindex = 6;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2610';
                            component.valueString as valueString -> data.values as values, values.value = valueString;
                        };
                    };
                };                
            };
            //Hersteller
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {
                        component.code where "code.coding.code = 'C25392'"then
                        {
                            observation -> data.blockindex = 6;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2611';
                            component.valueCodeableConcept as valueCodeableConcept,
                            valueCodeableConcept.coding as coding, coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };                
            };
             //Ergebnis
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {
                        component.code where "code.coding.code = 'testCodeErgebnis'"then
                        {
                            observation -> data.blockindex = 6;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_1962';
                            component.valueCodeableConcept as valueCodeableConcept,
                            valueCodeableConcept.coding as coding, coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };                
            };
            //Change DNA
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {
                        component.code where "code.coding.code = '48004-6'"then
                        {
                            observation -> data.blockindex = 6;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_1963';
                            component.valueString as valueString -> data.values as values, values.value = valueString;
                        };
                    };
                };                
            };
            //Change Protein
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {
                        component.code where "code.coding.code = '48005-3'"then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_1964';
                            component.valueString as valueString -> data.values as values, values.value = valueString;
                        };
                    };
                };                
            };
        };
    };
}