/// version = 0.1
/// title = "nNGM: Mapping Immunhistochemie CTS"

map "http://uk-koeln.de/fhir/StructureMap/nNGM_Mapping_ImmunhistochemieCTS" = nNGM_Mapping_ImmunhistochemieCTS

uses "http://hl7.org/fhir/StructureDefinition/Bundle" as source
uses "http://hl7.org/fhir/StructureDefinition/CTS_Transport" as target

group TransformImmunohistochemieCTS(source src: Bundle, target tgt: CTS_Transport)
{
 
    src -> tgt.crfid = 'IHC1';
    src -> tgt.type = 'save';

    src.entry as entry then
    {
        /* --------------- ServiceRequest ---------------------- */
        entry.resource as serviceRequest where "resource is ServiceRequest" then
        {
            // Durchfuehrung 
            serviceRequest -> tgt.data as data then
            {
                serviceRequest.status as status where "$this.status = 'active'" then
                {
                    serviceRequest ->  data.blockindex = 15;
                    serviceRequest ->  data.groupindex = 0;
                    serviceRequest ->  data.itemid = 'id_2520';
                    status -> data.values as values,values.value = 'in Bearbeitung';
                };
                serviceRequest.status as status where "$this.status = 'completed'" then
                {
                    serviceRequest ->  data.blockindex = 15;
                    serviceRequest ->  data.groupindex = 0;
                    serviceRequest ->  data.itemid = 'id_2520';
                    status -> data.values as values,values.value = 'abgeschlossen';
                };
            };

            // Abschluss 
            serviceRequest -> tgt.data as data then
            {
                serviceRequest.status as status, status.extension as statusAbschluss, statusAbschluss.extension as statusextension then
                {
                    statusextension where "$this.url ='status'" then
                    {
                        serviceRequest ->  data.blockindex = 15;
                        serviceRequest ->  data.groupindex = 0;
                        serviceRequest ->  data.itemid = 'id_2462';
                        statusextension.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code  -> data.values as values,values.value = code;
                    };
                };
            };
        
            // Datum des Abschlusses 
            serviceRequest -> tgt.data as data then
            {
                serviceRequest.status as status, status.extension as statusAbschluss, statusAbschluss.extension as datumextension then
                {
                    datumextension where "$this.url ='datum'" then
                    {
                        serviceRequest ->  data.blockindex = 15;
                        serviceRequest ->  data.groupindex = 0;
                        serviceRequest ->  data.itemid = 'id_2521';
                        datumextension.valueDate as valueDate -> data.values as values,values.value = valueDate;
                    };
                };
            };
        };

        //------------------------ Specimen ------------------------
        entry.resource as specimen where "resource is Specimen" then
        {
            // Biopsy-ID 
            specimen -> tgt.data as data then
            {
                specimen.identifier as identifier then
                {   
                    specimen -> data.blockindex = 0;
                    specimen -> data.groupindex = 0;
                    specimen -> data.itemid = 'id_1601';
                    identifier.value as value-> data.values as values, values.value = value, values.unit = 'count';
                };
            };                
        };


        //------------------------ DiagnosticReport ------------------------
        entry.resource as diagnosticReport where "resource is DiagnosticReport" then
        {
            // Untersuchungs-ID
            diagnosticReport -> tgt.data as data then
            {
                diagnosticReport.identifier as identifier,
                    identifier.system as system where "system = 'http://uk-koeln.de/NamingSystem/nNGM/befundnummer'"then
                {   
                    diagnosticReport -> data.blockindex = 1;
                    diagnosticReport -> data.groupindex = 0;
                    diagnosticReport -> data.itemid = 'assessment_id';
                    identifier.value as value-> data.values as values, values.value = value;
                };
            };                
        };

        // Observation




    }; //src entry
} //group