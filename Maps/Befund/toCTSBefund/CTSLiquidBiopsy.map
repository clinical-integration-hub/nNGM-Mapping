/// version = 0.1
/// title = "nNGM: nNGM_Mapping_LiquidBiopsy"
/*
TODO
    Biopsie-ID: it doesn't correspond to the properly itemID(excel file)
    OBSERVATION: SOP component doesn't exist in the profile on simplifier
    OBSERVATION: Assay component doesn't exist in the profile on simplifier
    OBSERVATION: Hersteller component doesn't exist in the profile on simplifier
    SERVICEREQUEST ->  Durchfuehrung: No properly transformed, issue with status
                    Abschluss : No properly transformed, issue with status extension
                    Datum des Abschlusses : No properly transformed, issue with status extension
*/

map "http://uk-koeln.de/fhir/StructureMap/nNGM_Mapping_LiquidBiopsyCTS" = nNGM_Mapping_LiquidBiopsyCTS

uses "http://hl7.org/fhir/StructureDefinition/Bundle" as source
uses "http://hl7.org/fhir/StructureDefinition/CTS_Transport" as target

group TransformCTS(source src: Bundle, target tgt: CTS_Transport)
{
    src -> tgt.version = '1.1';
    src -> tgt.sourcesystem = 'https:\/\/nngm-qat.staging.healex.systems\/';

    src -> tgt.operations as operations collate, operations.crfid = '6-LB1';
    src -> tgt.operations as operations collate, operations.type = 'save';

     src.entry as entry then
    {

        //------------------------ Specimen ------------------------
        entry.resource as specimen where "resource is Specimen" then
        {
            //Biopsy-ID -> 0, 0, id_1601
            specimen -> tgt.operations as operations collate then
            {
                specimen -> operations.data as data then
                {
                    specimen.identifier as identifier,
                     identifier.system as system where "system = 'http://uk-koeln.de/NamingSystem/nNGM/biopsienummer'"then
                    {   
                        specimen -> data.blockindex = 0;
                        specimen -> data.groupindex = 0;
                        specimen -> data.itemid = 'id_1601';
                        identifier.value as value-> data.values as values collate, 
                                                    values.value = value,
                                                    values.unit = 'count';
                    };
                };                
            };
        };
        //------------------------ Organization ------------------------
        entry.resource as organization where "resource is Organization" then
        {
            //Standort -> 2, 0, id_2435
            organization -> tgt.operations as operations collate then
            {
                organization -> operations.data as data then
                {
                    organization.name as name then
                    {   
                        organization -> data.blockindex = 2;
                        organization -> data.groupindex = 0;
                        organization -> data.itemid = 'id_2435';
                        name -> data.values as values, values.value = name;
                    };
                };                
            };
        };
        //------------------------ Observation ------------------------
        //TODO
        /*
        entry.resource as observation where "resource is Observation" then
        {
            //NetzwerkZentrum
            //SOP-Versionsnummer des Standorts -> 2, 0, id_2614
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then 
                    {
                       component.code where "code.coding.code = '' and %tgt.operations.data.where(itemid = 'id_2614').exists().not()" then
                       {
                            observation ->  data.blockindex = 2;
                            observation ->  data.groupindex = 0;
                            observation ->  data.itemid = 'id_2614';
                            component.valueString as valueString -> data.values as values, values.value = valueString;
                       };
                    };
                };
            };
        };*/
        entry.resource as observation where "resource is Observation" then
        {
            //Assay -> 3, 0, id_2601
            //TODO
            /*observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {
                        component.code where "code.coding.code = ''"then
                        {
                            component.valueCodeableConcept as valueCodeableConcept,
                            valueCodeableConcept.coding as coding,
                            coding.code as code then 
                            {
                                observation -> data.blockindex = 3;
                                observation -> data.groupindex = 0;
                                observation -> data.itemid = 'id_2601';
                                code -> data.values as values, values.value = code;
                            };
                        };
                    };
                };
            };*/
            //TODO
            //Hersteller -> 3, 0, id_2602
            /*observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {
                        component.code where "code.coding.code = ''"then
                        {
                            component.valueCodeableConcept as valueCodeableConcept,
                            valueCodeableConcept.coding as coding,
                            coding.code as code then 
                            {
                                observation -> data.blockindex = 3;
                                observation -> data.groupindex = 0;
                                observation -> data.itemid = 'id_2602';
                                code -> data.values as values, values.value = code;
                            };
                        };
                    };
                };
            };*/
            //Date of Assessment 4, 0, id_2528
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.effectiveDateTime as effectiveDateTime then
                    {
                        observation ->  data.blockindex = 4;
                        observation ->  data.groupindex = 0;
                        observation ->  data.itemid = 'id_2528';
                        effectiveDateTime -> data.values as values,values.value = effectiveDateTime;
                    };
                };
            };
            //Phaenotyp -> 4, 0, id_1929
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {
                        component.code where "code.coding.code = 'C16977'"then
                        {
                            component.valueCodeableConcept as valueCodeableConcept,
                            valueCodeableConcept.coding as coding,
                            coding.code as code then 
                            {
                                observation -> data.blockindex = 4;
                                observation -> data.groupindex = 0;
                                observation -> data.itemid = 'id_1929';
                                code -> data.values as values, values.value = code;
                            };
                        };
                    };
                };
            };
            // Gen 4, 0, id_1928
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {
                        component.code where "code.coding.code = '48018-6'"then
                        {
                            component.valueCodeableConcept as valueCodeableConcept,
                            valueCodeableConcept.coding as coding,
                            coding.code as code then 
                            {
                                observation -> data.blockindex = 4;
                                observation -> data.groupindex = 0;
                                observation -> data.itemid = 'id_1928';
                                code -> data.values as values, values.value = code;
                            };
                        };
                    };
                };
            };
            // Exon des 5' Gens 4, 0, id_1931
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {
                        component.code where "code.coding.code = 'C13231'"then
                        {
                            component.valueInteger as valueInteger then 
                            {
                                observation -> data.blockindex = 4;
                                observation -> data.groupindex = 0;
                                observation -> data.itemid = 'id_1931';
                                valueInteger -> data.values as values, values.value = valueInteger;
                            };
                        };
                    };
                };
            };
            // Referenztranskript 5' Gen -> 4, 0, lb_referencetranscript_5_end_gene
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {
                        component.code where "code.coding.code = '51958-7'"then
                        {
                            component.valueString as valueString then 
                            {
                                observation -> data.blockindex = 4;
                                observation -> data.groupindex = 0;
                                observation -> data.itemid = 'lb_referencetranscript_5_end_gene';
                                valueString -> data.values as values, values.value = valueString;
                            };
                        };
                    };
                };
            };
            //3' Gen der Fusion (2.Gen) -> 4, 0, lb_3_end_gene
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {
                        component.code where "code.coding.code = '2ndGen'"then
                        {
                            component.valueCodeableConcept as valueCodeableConcept,
                            valueCodeableConcept.coding as coding,
                            coding.code as code then 
                            {
                                observation -> data.blockindex = 4;
                                observation -> data.groupindex = 0;
                                observation -> data.itemid = 'lb_3_end_gene';
                                code -> data.values as values, values.value = code;
                            };
                        };
                    };
                };
            };
            // Exon des 3' Gens-> 4, 0, lb_exon_3_end_gen
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {
                        component.code where "code.coding.code = '2ndGenExon'"then
                        {
                            component.valueInteger as valueInteger then 
                            {
                                observation -> data.blockindex = 4;
                                observation -> data.groupindex = 0;
                                observation -> data.itemid = 'lb_exon_3_end_gen';
                                valueInteger -> data.values as values, values.value = valueInteger;
                            };
                        };
                    };
                };
            };
            // Referenztranskript 3' Gen:n -> 4, 0, lb_referencetranscript_3_end_gen
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {
                        component.code where "code.coding.code = '2ndGenTranskript'"then
                        {
                            component.valueString as valueString then 
                            {
                                observation -> data.blockindex = 4;
                                observation -> data.groupindex = 0;
                                observation -> data.itemid = 'lb_referencetranscript_3_end_gen';
                                valueString -> data.values as values, values.value = valueString;
                            };
                        };
                    };
                };
            };
            // Referenztranskript 5' Gen -> 4, 0, id_1930
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {
                        component.code where "code.coding.code = '48004-6'"then
                        {
                            component.valueString as valueString then 
                            {
                                observation -> data.blockindex = 4;
                                observation -> data.groupindex = 0;
                                observation -> data.itemid = 'id_1930';
                                valueString -> data.values as values, values.value = valueString;
                            };
                        };
                    };
                };
            };
            // HGVS p. (Mutation Protein) -> 4, 0, id_1932
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {
                        component.code where "code.coding.code = '48005-3'"then
                        {
                            component.valueString as valueString then 
                            {
                                observation -> data.blockindex = 4;
                                observation -> data.groupindex = 0;
                                observation -> data.itemid = 'id_1932';
                                valueString -> data.values as values, values.value = valueString;
                            };
                        };
                    };
                };
            };
        };
        /* --------------- ServiceRequest ---------------------- */
        entry.resource as serviceRequest where "resource is ServiceRequest" then
        {
            //TODO
            //Durchfuehrung -> 5,0,  id_2520
            serviceRequest -> tgt.operations as operations collate then
            {
                serviceRequest -> operations.data as data then
                {
                    serviceRequest.status as status then
                    {
                        serviceRequest ->  data.blockindex = 5;
                        serviceRequest ->  data.groupindex = 0;
                        serviceRequest ->  data.itemid = 'id_2520';
                        status -> data.values as values,values.value = status;
                    };
                };
            };
            //TODO
            //Abschluss -> 5,0, id_2462
            serviceRequest -> tgt.operations as operations collate then
            {
                serviceRequest -> operations.data as data then
                {
                    serviceRequest.status as status, status.extension as statusAbschluss, statusAbschluss.extension as statusextension then
                    {
                        statusextension where "statusextension.url ='status'" then
                        {
                            serviceRequest ->  data.blockindex = 5;
                            serviceRequest ->  data.groupindex = 0;
                            serviceRequest ->  data.itemid = 'id_2462';
                            statusextension.valueDate as valueDate -> data.values as values,values.value = valueDate;
                        };
                    };
                };
            };
            //TODO
            //Datum des Abschlusses -> 5,0, id_2521
            serviceRequest -> tgt.operations as operations collate then
            {
                serviceRequest -> operations.data as data then
                {
                    serviceRequest.status as status, status.extension as statusAbschluss, statusAbschluss.extension as datumextension then
                    {
                        datumextension where "datumextension.url ='datum'" then
                        {
                            serviceRequest ->  data.blockindex = 5;
                            serviceRequest ->  data.groupindex = 0;
                            serviceRequest ->  data.itemid = 'id_2521';
                            datumextension.valueCodeableConcept as valueCodeableConcept,
                            valueCodeableConcept.coding as coding,
                            coding.code as code  -> data.values as values,values.value = code;
                        };
                    };
                };
            };
        };
    };

}