/// version = 0.1
/// title = "nNGM: reverse LiquidBiopsy - FHIR to CTS"

map "http://uk-koeln.de/fhir/StructureMap/LiquidBiopsyMappingCTS" = LiquidBiopsyMappingCTS

uses "http://hl7.org/fhir/StructureDefinition/Bundle" as source
uses "http://hl7.org/fhir/StructureDefinition/CTS_Transport" as target

group TransformCTS(source src: Bundle, target tgt: CTS_Transport)
{
    // Metadata
    src -> tgt.version = '1.1';
    src -> tgt.crfid = '6-LB1';
    src -> tgt.type = 'save';

    src -> tgt.sourcesystem = 'https:\/\/nngm-qat.staging.healex.systems\/';
    
    src.entry as entry then
    {
        //------------------------ Specimen ------------------------
        entry.resource as specimen where "resource is Specimen" then
        {
            //Biopsy-ID -> 0, 0, id_1601
            specimen -> tgt.data as data then
            {
                specimen.identifier as identifier then
                {   
                    specimen -> data.blockindex = 0;
                    specimen -> data.groupindex = 0;
                    specimen -> data.itemid = 'id_1601';
                    identifier.value as value-> data.values as values, values.value = value, values.unit = 'count';
                };
            };                
        };
        //------------------------ DiagnosticReport ------------------------
        entry.resource as diagnosticReport where "resource is DiagnosticReport" then
        {
            //Biopsy-ID -> 1, 0, assessment_id
            diagnosticReport -> tgt.data as data then
            {
                diagnosticReport.identifier as identifier,
                    identifier.system as system where "system = 'http://uk-koeln.de/NamingSystem/nNGM/befundnummer'"then
                {   
                    diagnosticReport -> data.blockindex = 1;
                    diagnosticReport -> data.groupindex = 0;
                    diagnosticReport -> data.itemid = 'assessment_id';
                    identifier.value as value-> data.values as values, values.value = value;
                };
            };                
        };
        /* ------------------------------ Organization ---------------------------- */
        entry.resource as organization where "resource is Organization" then
        {
            
            // Standort -> 2, 0, id_2435
            organization -> tgt.operations as operations collate then
            {
                organization -> operations.data as data then
                {
                    organization.name as name then
                    {
                        organization -> data.blockindex = 2;
                        organization -> data.groupindex = 0;
                        organization -> data.itemid = 'id_2435';
                        name -> data.values as values, values.value = name;
                    };
                };
            };

            // SOP-Versionsnummer des Standorts -> 2, 0, id_2614
            organization -> tgt.operations as operations collate then
            {
                organization -> operations.data as data then
                {
                    organization.type as type, type.text as text then
                    {
                        organization -> data.blockindex = 2;
                        organization -> data.groupindex = 0;
                        organization -> data.itemid = 'id_2614';
                        text -> data.values as values, values.value = text;
                    };
                };
            };
        };

        /* ------------------------------ Observation ---------------------------- */
        entry.resource as observation where "resource is Observation" then
        {
            // Assay -> 3, 0, id_2601
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component, 
                    component.valueCodeableConcept as vcc,
                    vcc.coding as coding, 
                    coding.code as code where "code = 'Assay'" then
                    {
                        observation -> data.blockindex = 3;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2601';
                        code -> data.values as values, values.value = code;
                    };
                };
            };

            // Hersteller -> 3, 0, id_2602
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component, component.valueCodeableConcept as vcc, vcc.coding as coding, coding.code as code where "code = 'Hersteller'" then
                    {
                        observation -> data.blockindex = 3;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2602';
                        code -> data.values as values, values.value = code;
                    };
                };
            };

            // Date of Assessment -> 4, 0, id_2528
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.valueDateTime as vdt then
                    {
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2528';
                        vdt -> data.values as values, values.value = vdt;
                    };
                };
            };

            // Phaenotyp -> 4, 0, id_1929
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component,
                    component.valueCodeableConcept as vcc, 
                    vcc.coding as coding where "coding.system = 'http://uk-koeln.de/fhir/ValueSet/phenotypes'" then
                    {
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_1929';
                        coding.code as code -> data.values as values, values.value = code;
                    };
                };
            };

            // Gen -> 4, 0, id_1928
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then 
                {
                    observation.component as component, 
                    component.valueCodeableConcept as vcc, 
                    vcc.coding as coding where "coding.system = 'http://hl7.org/fhir/uv/genomics-reporting/ValueSet/hgnc'" then
                    {
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_1928';
                        coding.code as code -> data.values as values, values.value = code;
                    };
                };
            };

            // Exon des 5' Gens -> 4, 0, id_1931
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component, 
                    component.code as code, 
                    code.coding as coding where "coding.system = 'http://uk-koeln.de/fhir/CodeSystem/tbd-codes'" then
                    {
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_1931';
                        component.valueInteger as integer -> data.values as values, values.value = integer;
                    };
                };
            };

            // Referenztranskript 5' Gen -> 4, 0, lb_referencetranscript_5_end_gene
            // component:exon.valueInteger	1b_referencetranscript_5_end_gene
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component, component.valueInteger as integer then
                    {
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'lb_referencetranscript_5_end_gene';
                        integer -> data.values as values, values.value = integer;
                    };
                };
            };

            // Exon des 3' Gens -> 4, 0, lb_3_end_gene
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component, 
                    component.code as code, 
                    code.coding as coding where "coding.system = 'http://uk-koeln.de/fhir/CodeSystem/tbd-codes'" then
                    {
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'lb_3_end_gene';
                        component.valueInteger as integer -> data.values as values, values.value = integer;
                    };
                };
            };

            // Referenztranskript 3' Gen -> 4, 0, lb_referencetranscript_3_end_gen
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component, component.valueInteger as integer then
                    {
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'lb_referencetranscript_3_end_gen';
                        integer -> data.values as values, values.value = integer;
                    };
                };
            };

            // HGVS c. (Mutation cDNA)-> 4, 0, id_1930
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component, component.valueString as valueStr then
                    {
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_1930';
                        valueStr -> data.values as values, values.value = valueStr;
                    };
                };
            };

            // HGVS p. (Mutation Protein) -> 4, 0, id_1932
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component, component.valueString as valueStr then
                    {
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_1932';
                        valueStr -> data.values as values, values.value = valueStr;
                    };
                };
            };
        };

        /* --------------- ServiceRequest ---------------------- */
        entry.resource as serviceRequest where "resource is ServiceRequest" then
        {
            //Durchfuehrung -> 5, 0, id_2520
            serviceRequest -> tgt.operations as operations collate then
            {
                serviceRequest -> operations.data as data then 
                {
                    serviceRequest.status as status where "$this.status = 'active'" then
                    {
                        serviceRequest ->  data.blockindex = 5;
                        serviceRequest ->  data.groupindex = 0;
                        serviceRequest ->  data.itemid = 'id_2520';
                        status -> data.values as values,values.value = 'in Bearbeitung';
                    };
                    serviceRequest.status as status where "$this.status = 'completed'" then
                    {
                        serviceRequest ->  data.blockindex = 5;
                        serviceRequest ->  data.groupindex = 0;
                        serviceRequest ->  data.itemid = 'id_2520';
                        status -> data.values as values,values.value = 'abgeschlossen';
                    };  
                };
            };

            //Abschluss -> 5, 0, id_2462
            serviceRequest -> tgt.operations as operations collate then
            {
                serviceRequest -> operations.data as data then 
                {
                    serviceRequest.status as status, status.extension as statusAbschluss, statusAbschluss.extension as statusextension then
                    {
                        statusextension where "$this.url ='status'" then
                        {
                            serviceRequest ->  data.blockindex = 5;
                            serviceRequest ->  data.groupindex = 0;
                            serviceRequest ->  data.itemid = 'id_2462';
                            statusextension.valueCodeableConcept as valueCodeableConcept,
                            valueCodeableConcept.coding as coding,
                            coding.code as code  -> data.values as values,values.value = code;
                        };
                    };
                };
            };

            //Datum des Abschlusses -> 5,0, id_2521
            serviceRequest -> tgt.data as data then
            {
                serviceRequest -> operations.data as data then 
                {
                    serviceRequest.status as status, status.extension as statusAbschluss, statusAbschluss.extension as datumextension then
                    {
                        datumextension where "$this.url ='datum'" then
                        {
                            serviceRequest ->  data.blockindex = 7;
                            serviceRequest ->  data.groupindex = 0;
                            serviceRequest ->  data.itemid = 'id_2521';
                            datumextension.valueDate as valueDate -> data.values as values,values.value = valueDate;
                        };
                    };
                };
            };
        };
    };
}