// version = 0.1
/// title = "nNGM: Befund - FHIR to CTS"

/*
line 115, 130 evaluate doesnt run with $this.display included


*/

map "http://uk-koeln.de/fhir/StructureMap/BefundCTS" = BefundCTS

uses "http://hl7.org/fhir/StructureDefinition/Bundle" as source
uses "http://hl7.org/fhir/StructureDefinition/CTS_Transport" as target

group TransformCTS(source src: Bundle, target tgt: CTS_Transport)
{
    src -> tgt.version = '1.1';
    src -> tgt.sourcesystem = 'https:\/\/nngm-qat.staging.healex.systems\/';
    
    src -> tgt.operations as operations collate, operations.crfid = 'Befund';
    src -> tgt.operations as operations collate, operations.type = 'save';

    src.entry as entry then
    {
        //Specimen
        entry.resource as specimen where "resource is Specimen" then
        {
            
            //Untersuchungs-ID 
            specimen -> tgt.operations as operations collate then
            {
                specimen -> operations.data as data then
                {
                    specimen.identifier as identifier, identifier.value as value where "$this.system = 'http://uk-koeln.de/fhir/NamingSystem/nNGM/fallnummer'" then
                    {   
                        specimen -> data.blockindex = 5;
                        specimen -> data.groupindex = 0;
                        specimen -> data.itemid = 'extern_patho_case_id';
                        value -> data.values as values, values.value = value;
                    };
                };
            };

            //Pathologie-Fall-ID
            specimen -> tgt.operations as operations collate then
            {
                specimen -> operations.data as data then
                {
                    specimen.identifier as identifier, identifier.value as value where "$this.system = 'http://uk-koeln.de/NamingSystem/nNGM/biopsienummer'" then
                    {   
                        specimen -> data.blockindex = 0;
                        specimen -> data.groupindex = 0;
                        specimen -> data.itemid = 'assessment_id';
                        value -> data.values as values, values.value = value;
                    };
                };
            };
            
            //Eingang des Tumormaterials in der Pathologie
            specimen -> tgt.operations as operations collate then
            {
                specimen -> operations.data as data then
                {
                    specimen.collection as collection, collection.collectedDateTime as eingangsdatum then
                    {   
                        specimen -> data.blockindex = 0;
                        specimen -> data.groupindex = 0;
                        specimen -> data.itemid = 'id_2515';
                        eingangsdatum -> data.values as values, values.value = eingangsdatum;
                    };
                };
            };


            //Eingangsnummer des Tumormaterials in der Pathologie
            specimen -> tgt.operations as operations collate then
            {
                specimen -> operations.data as data then
                {
                    specimen.accessionIdentifier as identifier, identifier.value as identValue then
                    {   
                        specimen -> data.blockindex = 0;
                        specimen -> data.groupindex = 0;
                        specimen -> data.itemid = 'id_2516';
                        identValue -> data.values as values, values.value = identValue;
                    };
                };
            };

            //Tumormaterial 
            //THIS GROUP MAPS NOTHING BECAUSE TODOS IN TO FHIR MAPPING. LOOK TODO IN THE TOFHIR MAP!
            /*specimen -> tgt.operations as operations collate then
            {
                specimen -> operations.data as data then
                {
                    specimen.accessionIdentifier as identifier, identifier.value as identValue then
                    {   
                        specimen -> data.blockindex = 0;
                        specimen -> data.groupindex = 0;
                        specimen -> data.itemid = 'id_2516';
                        identValue -> data.values as values, values.value = identValue;
                    };
                };
            };*/
        };

       
        entry.resource as observation where "resource is Observation" then
        {
            //Klassifikation
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.code as code, code.coding as coding then
                    {   
                        observation -> data.blockindex = 2;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_1658';
                        coding -> data.values as values, values.value = evaluate(coding, '$this.code');  //+ \'\\t\' +  $this.display');
                    };
                };
            };

            //Lokalisation
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.bodySite as code, code.coding as coding then
                    {   
                        observation -> data.blockindex = 2;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2469';
                        coding -> data.values as values, values.value = evaluate(coding, '$this.code'); //+ \'\\t\' +  $this.display');
                    };
                };
            };

            //Grading
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.valueCodeableConcept as cc, cc.coding as coding then
                    {   
                        observation -> data.blockindex = 2;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2403';
                        coding.code as code -> data.values as values, values.value = code;
                    };
                };
            };

            //Wachstumsmuster bei Adenokarzinom lepidisch
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                   observation.component as component then
                    {   
                        component.valueQuantity as valuequantity where "code.coding.system = 'urn:oid:2.16.840.1.113883.6.43.1' and code.coding.code = '8250/3'" then
                        {
                            observation -> data.blockindex = 3;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_1286';
                            valuequantity.value as value -> data.values as values, values.value = value;
                        };
                    };
                };
            };

            //Wachstumsmuster bei Adenokarzinom azinär
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                   observation.component as component then
                    {   
                        component.valueQuantity as valuequantity where "code.coding.system = 'urn:oid:2.16.840.1.113883.6.43.1' and code.coding.code = '8551/3'" then
                        {
                            observation -> data.blockindex = 3;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_1296';
                            valuequantity.value as value -> data.values as values, values.value = value;
                        };
                    };
                };
            };

            //Wachstumsmuster bei Adenokarzinom papillär
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                   observation.component as component then
                    {   
                        component.valueQuantity as valuequantity where "code.coding.system = 'urn:oid:2.16.840.1.113883.6.43.1' and code.coding.code = '8260/3'" then
                        {
                            observation -> data.blockindex = 3;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_1294';
                            valuequantity.value as value -> data.values as values, values.value = value;
                        };
                    };
                };
            };

            //Wachstumsmuster bei Adenokarzinom mikropapillär
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                   observation.component as component then
                    {   
                        component.valueQuantity as valuequantity where "code.coding.system = 'urn:oid:2.16.840.1.113883.6.43.1' and code.coding.code = '8265/3'" then
                        {
                            observation -> data.blockindex = 3;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_1288';
                            valuequantity.value as value -> data.values as values, values.value = value;
                        };
                    };
                };
            };

            //Wachstumsmuster bei Adenokarzinom solide
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                   observation.component as component then
                    {   
                        component.valueQuantity as valuequantity where "code.coding.system = 'urn:oid:2.16.840.1.113883.6.43.1' and code.coding.code = '8230/3'" then
                        {
                            observation -> data.blockindex = 3;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_1292';
                            valuequantity.value as value -> data.values as values, values.value = value;
                        };
                    };
                };
            };

            //THIS BLOCK WILL NOT WORK BEACUSE OF A MISSING CODE IN THE COMPONENT. PLEASE CHECK TOFHIR MAP TODO!
            //Anteil an Siegelringzellkarzinomen 
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                   observation.component as component then
                    {   
                        component.valueQuantity as valuequantity where "code.coding.system = 'urn:oid:2.16.840.1.113883.6.43.1' and code.coding.code = '8490/3'" then
                        {
                            observation -> data.blockindex = 3;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2519';
                            valuequantity.value as value -> data.values as values, values.value = value;
                        };
                    };
                };
            };


            //Durchführung
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.status as status where "%tgt.operations.data.where(itemid = 'id_2520').exists().not()" then
                    {
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2520';
                        status.value as value -> data.values as values, values.value = value;
                    };
                };
            };

            //Abschluss
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.status as status where "%tgt.operations.data.where(itemid = 'id_2462').exists().not()" then
                    {
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2462';
                        status.extension as extension then
                        {
                            extension.valueCodeableConcept as cc, cc.coding as coding, coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            //Datum des Abschlusses
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.effectivePeriod as effectiveperiod where "%tgt.operations.data.where(itemid = 'id_2521').exists().not()" then
                    {
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2521';
                        effectiveperiod.end as abschlussdatum -> data.values as values, values.value = abschlussdatum;
                    };
                };
            };
        };
        
        /* ------------------------------ Specimen ---------------------------- */
        entry.resource as specimen where "resource is Specimen" then
        {
            /* ------------------------------ Referenzen ---------------------------- */
            // Specimen
            specimen -> tgt.operations as operations collate then
            {
                specimen -> operations.data as data then
                {
                    specimen.identifier as identifier, identifier.value as value then
                    {
                        specimen -> data.blockindex = 1;
                        specimen -> data.groupindex = 0;
                        specimen -> data.itemid = 'assessment_id';
                        value -> data.values as values, values.value = value;
                    };
                };
            };

            //Biopsie-ID
            specimen -> tgt.operations as operations collate then
            {
                specimen -> operations.data as data then
                {
                    specimen.identifier as biopsieID then
                    {   
                        biopsieID.value as bid then
                        {
                            specimen -> data.blockindex = 0;
                            specimen -> data.groupindex = 0;
                            specimen -> data.itemid = 'id_1601';
                            biopsieID -> data.values as values, values.value = bid;
                        };
                    };
                };
            };
        };

        /* ------------------------------ Organization ---------------------------- */
        entry.resource as organization where "resource is Organization and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Organization/clinical-site'" then
        {
            /* ------------------------------ Netzwerkzentrum ---------------------------- */
            // Standort
            organization -> tgt.operations as operations collate then
            {
                organization -> operations.data as data then
                {
                    organization.name as name then
                    {
                        organization -> data.blockindex = 2;
                        organization -> data.groupindex = 0;
                        organization -> data.itemid = 'id_2435';
                        name -> data.values as values, values.value = name;
                    };
                };
            };

            /* ------------------------------ Netzwerkzentrum ---------------------------- */
            // SOP-Versionsnummer des Standorts
            organization -> tgt.operations as operations collate then
            {
                organization -> operations.data as data then
                {
                    organization.type as type, type.text as text then
                    {
                        organization -> data.blockindex = 2;
                        organization -> data.groupindex = 0;
                        organization -> data.itemid = 'id_2614';
                        text -> data.values as values, values.value = text;
                    };
                };
            };
        };

        /* ------------------------------ Observation ---------------------------- */
        entry.resource as observation where "resource is Observation and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/ngs-fusion-expression'" then
        {
            /* ------------------------------ Methodik ---------------------------- */
            // Assay
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component, component.valueCodeableConcept as vcc, vcc.coding as coding, coding.code as code where "code = 'Assay'" then
                    {
                        observation -> data.blockindex = 3;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2601';
                        code -> data.values as values, values.value = code;
                    };
                };
            };

            /* ------------------------------ Methodik ---------------------------- */
            // Hersteller
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component, component.valueCodeableConcept as vcc, vcc.coding as coding, coding.code as code where "code = 'Hersteller'" then
                    {
                        observation -> data.blockindex = 3;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2602';
                        code -> data.values as values, values.value = code;
                    };
                };
            };

            /* ------------------------------ Primaermutation/Ressistenztestung ---------------------------- */
            // Date of Assessment
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.valueDateTime as vdt then
                    {
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2528';
                        vdt -> data.values as values, values.value = vdt;
                    };
                };
            };

            /* ------------------------------ Primaermutation/Ressistenztestung ---------------------------- */
            // Phaenotyp
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component, component.valueCodeableConcept as vcc, vcc.coding as coding where "coding.system = 'http://uk-koeln.de/fhir/ValueSet/phenotypes'" then
                    {
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_1929';
                        coding.code as code -> data.values as values, values.value = code;
                    };
                };
            };

            /* ------------------------------ Primaermutation/Ressistenztestung ---------------------------- */
            // Gen
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then 
                {
                    observation.component as component, component.valueCodeableConcept as vcc, vcc.coding as coding where "coding.system = 'http://hl7.org/fhir/uv/genomics-reporting/ValueSet/hgnc'" then
                    {
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_1928';
                        coding.code as code -> data.values as values, values.value = code;
                    };
                };
            };

            /* ------------------------------ Primaermutation/Ressistenztestung ---------------------------- */
            // Exon des 5' Gens
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component, component.code as code, code.coding as coding where "coding.system = 'http://uk-koeln.de/fhir/CodeSystem/tbd-codes'" then
                    {
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_1931';
                        component.valueInteger as integer -> data.values as values, values.value = integer;
                    };
                };
            };

            /* ------------------------------ Primaermutation/Ressistenztestung ---------------------------- */
            // Referenztranskript 5' Gen
            // component:exon.valueInteger	1_LB1__4_0__lb_referencetranscript_5_end_gene
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component, component.valueInteger as integer then
                    {
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'lb_referencetranscript_5_end_gene';
                        integer -> data.values as values, values.value = integer;
                    };
                };
            };

            /* ------------------------------ Primaermutation/Ressistenztestung ---------------------------- */
            // Exon des 3' Gens
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component, component.code as code, code.coding as coding where "coding.system = 'http://uk-koeln.de/fhir/CodeSystem/tbd-codes'" then
                    {
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'lb_3_end_gene';
                        component.valueInteger as integer -> data.values as values, values.value = integer;
                    };
                };
            };

            /* ------------------------------ Primaermutation/Ressistenztestung ---------------------------- */
            // Referenztranskript 3' Gen
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component, component.valueInteger as integer then
                    {
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'lb_referencetranscript_3_end_gen';
                        integer -> data.values as values, values.value = integer;
                    };
                };
            };

            /* ------------------------------ Primaermutation/Ressistenztestung ---------------------------- */
            // HGVS c. (Mutation cDNA)
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component, component.valueString as valueStr then
                    {
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_1930';
                        valueStr -> data.values as values, values.value = valueStr;
                    };
                };
            };

            /* ------------------------------ Primaermutation/Ressistenztestung ---------------------------- */
            // HGVS p. (Mutation Protein)
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component, component.valueString as valueStr then
                    {
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_1932';
                        valueStr -> data.values as values, values.value = valueStr;
                    };
                };
            };
        };

        entry.resource as serviceRequest where "resource is ServiceRequest and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/ServiceRequest/nNGM/testung'" then
        {
            /* ------------------------------ Status der Untersuchungen ---------------------------- */
            //Durchfuehrung
            serviceRequest -> tgt.operations as operations collate then
            {
                serviceRequest -> operations.data as data then
                {
                    serviceRequest.status as status then
                    {
                        serviceRequest -> data.blockindex = 5;
                        serviceRequest -> data.groupindex = 0;
                        serviceRequest -> data.itemid = 'id_2520';
                        status -> data.values as values, values.value = status;
                    };
                };
            };

            /* ------------------------------ Status der Untersuchungen ---------------------------- */
            //Abschluss
            serviceRequest -> tgt.operations as operations collate then
            {
                serviceRequest -> operations.data as data then
                {
                    serviceRequest.category as category, category.coding as coding, coding.code as code then
                    {
                        serviceRequest -> data.blockindex = 5;
                        serviceRequest -> data.groupindex = 0;
                        serviceRequest -> data.itemid = 'id_2462';
                        code -> data.values as values, values.value = code;
                    };
                };
            };

            /* ------------------------------ Status der Untersuchungen ---------------------------- */
            //Datum des Abschlusses
            serviceRequest -> tgt.operations as operations collate then
            {
                serviceRequest -> operations.data as data then
                {
                    serviceRequest.occurrenceDateTime as vdt then
                    {
                        serviceRequest -> data.blockindex = 5;
                        serviceRequest -> data.groupindex = 0;
                        serviceRequest -> data.itemid = 'id_2521';
                        vdt -> data.values as values, values.value = vdt;
                    };
                };
            };
        };

        /*---------------EpisodeOfCare----------------*/
        entry.resource as episodeofcare where "resource is EpisodeOfCare" then
        {
            //Untersuchung-ID
            episodeofcare -> tgt.operations as operations collate then
            {
                episodeofcare -> operations.data as data then
                {
                    episodeofcare.identifier as identifier, identifier.value as value then
                    {   
                        episodeofcare -> data.blockindex = 8;
                        episodeofcare -> data.groupindex = 0;
                        episodeofcare -> data.itemid = 'assessment_id';
                        value -> data.values as values, values.value = value;
                    };
                };
            };
        };

        /*---------------Organization----------------*/
         entry.resource as organization where "resource is Organization" then
        {
            //Standort
            organization -> tgt.operations as operations collate then
            {
                organization -> operations.data as data then
                {
                    organization.name as name then
                    {   
                        organization -> data.blockindex = 0;
                        organization -> data.groupindex = 0;
                        organization -> data.itemid = 'id_2435';
                        name -> data.values as values, values.value = name;
                    };
                };
            };

            //SOP-Versionsnummer des Standorts
            organization -> tgt.operations as operations collate then
            {
                organization -> operations.data as data then
                {
                    organization.type as type then
                    {   
                        organization -> data.blockindex = 0;
                        organization -> data.groupindex = 0;
                        organization -> data.itemid = 'id_2617';
                        type.text as text -> data.values as values, values.value = text;
                    };
                };
            };
        };

        /*---------------ALK CISH OBSERVATION----------------*/
        entry.resource as observation where "resource is Observation 
                                            and resource.code.coding.code = 'ALK' 
                                            and resource.category.coding.where(system = \'http://uk-koeln.de/fhir/ValueSet/obs-methods\').code = 'CISH'" then
        {
            //Kit Bezeichnung
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueCodeableConcept as cc where "code.coding.code = 'C42793' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 3;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2108';
                            cc.coding as coding, coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            //Hersteller
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueCodeableConcept as cc where "code.coding.code = 'C25392' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 3;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2109';
                            cc.coding as coding, coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            //Ergebnis
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.valueCodeableConcept as cc, cc.coding as coding then
                    {
                        observation -> data.blockindex = 3;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2112';
                        coding.code as code -> data.values as values, values.value = code;
                    };
                };
            };

            //Positive Tumorzellen
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueQuantity as quantity where "code.coding.code = 'C70460' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 3;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2113';
                            quantity.value as value -> data.values as values, values.value = value, values.unit = 'percent';
                        };
                    };
                };
            };
        };
        /*---------------ALK FISH OBSERVATION----------------*/
        entry.resource as observation where "resource is Observation 
                                            and resource.code.coding.code = 'ALK' 
                                            and resource.category.coding.where(system = \'http://uk-koeln.de/fhir/ValueSet/obs-methods\').code = 'FISH'" then
        {
            //Kit Bezeichnung
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueCodeableConcept as cc where "code.coding.code = 'C42793' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 3;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2115';
                            cc.coding as coding, coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            //Hersteller
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueCodeableConcept as cc where "code.coding.code = 'C25392' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 3;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2116';
                            cc.coding as coding, coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            //Ergebnis
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.valueCodeableConcept as cc, cc.coding as coding then
                    {
                        observation -> data.blockindex = 3;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2119';
                        coding.code as code -> data.values as values, values.value = code;
                    };
                };
            };

            //Positive Tumorzellen
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueQuantity as quantity where "code.coding.code = 'C70460' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 3;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2120';
                            quantity.value as value -> data.values as values, values.value = value, values.unit = 'percent';
                        };
                    };
                };
            };

            //Polysomie
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueQuantity as quantity where "code.coding.code = 'C36331' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 3;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2121';
                            quantity.value as value -> data.values as values, values.value = value, values.unit = 'percent';
                        };
                    };
                };
            };
        };
         /*---------------MET CISH OBSERVATION----------------*/
        entry.resource as observation where "resource is Observation 
                                            and resource.code.coding.code = 'MET' 
                                            and resource.category.coding.where(system = \'http://uk-koeln.de/fhir/ValueSet/obs-methods\').code = 'CISH'" then
        {
            //Kit Bezeichnung
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueCodeableConcept as cc where "code.coding.code = 'C42793' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2143';
                            cc.coding as coding, coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            //Hersteller
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueCodeableConcept as cc where "code.coding.code = 'C25392' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2144';
                            cc.coding as coding, coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            //Ergebnis
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.valueCodeableConcept as cc, cc.coding as coding then
                    {
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2147';
                        coding.code as code -> data.values as values, values.value = code;
                    };
                };
            };

            //Amplifikation
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueCodeableConcept as cc where "code.coding.code = 'amplification-level' and code.coding.system = 'http://uk-koeln.de/fhir/CodeSystem/tbd-codes'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2148';
                            cc.coding as coding, coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };
            };
        };

         /*---------------MET FISH OBSERVATION----------------*/
        entry.resource as observation where "resource is Observation 
                                            and resource.code.coding.code = 'MET' 
                                            and resource.category.coding.where(system = \'http://uk-koeln.de/fhir/ValueSet/obs-methods\').code = 'FISH'" then
        {
            //Kit Bezeichnung
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueCodeableConcept as cc where "code.coding.code = 'C42793' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2150';
                            cc.coding as coding, coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            //Hersteller
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueCodeableConcept as cc where "code.coding.code = 'C25392' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2151';
                            cc.coding as coding, coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            //Ergebnis
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.valueCodeableConcept as cc, cc.coding as coding then
                    {
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2154';
                        coding.code as code -> data.values as values, values.value = code;
                    };
                };
            };

            //Amplifikation
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueCodeableConcept as cc where "code.coding.code = 'amplification-level' and code.coding.system = 'http://uk-koeln.de/fhir/CodeSystem/tbd-codes'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2155';
                            cc.coding as coding, coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            //15 MET Signal
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueQuantity as quantity where "code.coding.code = '15-met-ratio' and code.coding.system = 'http://uk-koeln.de/fhir/CodeSystem/tbd-codes'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2156';
                            quantity.value as value -> data.values as values, values.value = value, values.unit = 'percent';
                        };
                    };
                };
            };

            //5 MET Signal
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueQuantity as quantity where "code.coding.code = '5-met-ratio' and code.coding.system = 'http://uk-koeln.de/fhir/CodeSystem/tbd-codes'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2157';
                            quantity.value as value -> data.values as values, values.value = value, values.unit = 'percent';
                        };
                    };
                };
            };

            //4 MET Signal
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueQuantity as quantity where "code.coding.code = '4-met-ratio' and code.coding.system = 'http://uk-koeln.de/fhir/CodeSystem/tbd-codes'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2158';
                            quantity.value as value -> data.values as values, values.value = value, values.unit = 'percent';
                        };
                    };
                };
            };

            //gezaehlte Tumorzellen
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueInteger as integer where "code.coding.code = 'C0007584' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2159';
                            integer -> data.values as values, values.value = integer, values.unit = 'count';
                        };
                    };
                };
            };

            //MET signale
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueInteger as integer where "code.coding.code = 'met-signal-count' and code.coding.system = 'http://uk-koeln.de/fhir/CodeSystem/tbd-codes'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2160';
                            integer -> data.values as values, values.value = integer;
                        };
                    };
                };
            };

            //CEN signale
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueInteger as integer where "code.coding.code = 'cet-signal-count' and code.coding.system = 'http://uk-koeln.de/fhir/CodeSystem/tbd-codes'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2161';
                            integer -> data.values as values, values.value = integer;
                        };
                    };
                };
            };

            //Quotient MET/CEN signale
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueInteger as integer where "code.coding.code = 'met-cen-signal-ratio' and code.coding.system = 'http://uk-koeln.de/fhir/CodeSystem/tbd-codes'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2162';
                            integer -> data.values as values, values.value = integer;
                        };
                    };
                };
            };

            //Durchschnitt MET-Genkopiezahl/Zelle 
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueInteger as integer where "code.coding.code = 'met-copy-per-cell' and code.coding.system = 'http://uk-koeln.de/fhir/CodeSystem/tbd-codes'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2163';
                            integer -> data.values as values, values.value = integer;
                        };
                    };
                };
            };

            //Polysomie
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueQuantity as quantity where "code.coding.code = 'C36331' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2164';
                            quantity.value as value -> data.values as values, values.value = value, values.unit = 'percent';
                        };
                    };
                };
            };
        };
          /*---------------RET CISH OBSERVATION----------------*/
        entry.resource as observation where "resource is Observation 
                                            and resource.code.coding.code = 'RET' 
                                            and resource.category.coding.where(system = \'http://uk-koeln.de/fhir/ValueSet/obs-methods\').code = 'CISH'" then
        {
            //Kit Bezeichnung
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueCodeableConcept as cc where "code.coding.code = 'C42793' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 5;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2187';
                            cc.coding as coding, coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            //Hersteller
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueCodeableConcept as cc where "code.coding.code = 'C25392' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 5;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2188';
                            cc.coding as coding, coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            //Ergebnis
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.valueCodeableConcept as cc, cc.coding as coding then
                    {
                        observation -> data.blockindex = 5;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2191';
                        coding.code as code -> data.values as values, values.value = code;
                    };
                };
            };

            //Positive Tumorzellen
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueQuantity as quantity where "code.coding.code = 'C70460' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 5;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2192';
                            quantity.value as value -> data.values as values, values.value = value, values.unit = 'percent';
                        };
                    };
                };
            };
        };

        /*---------------RET FISH OBSERVATION----------------*/
        entry.resource as observation where "resource is Observation 
                                            and resource.code.coding.code = 'RET' 
                                            and resource.category.coding.where(system = \'http://uk-koeln.de/fhir/ValueSet/obs-methods\').code = 'FISH'" then
        {
            //Kit Bezeichnung
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueCodeableConcept as cc where "code.coding.code = 'C42793' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 5;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2194';
                            cc.coding as coding, coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            //Hersteller
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueCodeableConcept as cc where "code.coding.code = 'C25392' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 5;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2195';
                            cc.coding as coding, coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            //Ergebnis
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.valueCodeableConcept as cc, cc.coding as coding then
                    {
                        observation -> data.blockindex = 5;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2198';
                        coding.code as code -> data.values as values, values.value = code;
                    };
                };
            };

            //Positive Tumorzellen
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueQuantity as quantity where "code.coding.code = 'C70460' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 5;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2199';
                            quantity.value as value -> data.values as values, values.value = value, values.unit = 'percent';
                        };
                    };
                };
            };
            //Polysomie
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueQuantity as quantity where "code.coding.code = 'C36331' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 5;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2200';
                            quantity.value as value -> data.values as values, values.value = value, values.unit = 'percent';
                        };
                    };
                };
            };
        };

         /*---------------ROS1 CISH OBSERVATION----------------*/
        entry.resource as observation where "resource is Observation 
                                            and resource.code.coding.code = 'ROS1' 
                                            and resource.category.coding.where(system = \'http://uk-koeln.de/fhir/ValueSet/obs-methods\').code = 'CISH'" then
        {
            //Kit Bezeichnung
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueCodeableConcept as cc where "code.coding.code = 'C42793' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 6;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2221';
                            cc.coding as coding, coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            //Hersteller
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueCodeableConcept as cc where "code.coding.code = 'C25392' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 6;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2222';
                            cc.coding as coding, coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            //Ergebnis
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.valueCodeableConcept as cc, cc.coding as coding then
                    {
                        observation -> data.blockindex = 6;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2225';
                        coding.code as code -> data.values as values, values.value = code;
                    };
                };
            };

            //Positive Tumorzellen
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueQuantity as quantity where "code.coding.code = 'C70460' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 6;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2226';
                            quantity.value as value -> data.values as values, values.value = value, values.unit = 'percent';
                        };
                    };
                };
            };
            //Polysomie
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueQuantity as quantity where "code.coding.code = 'C36331' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 6;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2227';
                            quantity.value as value -> data.values as values, values.value = value, values.unit = 'percent';
                        };
                    };
                };
            };
        };

         /*---------------ROS1 FISH OBSERVATION----------------*/
        entry.resource as observation where "resource is Observation 
                                            and resource.code.coding.code = 'ROS1' 
                                            and resource.category.coding.where(system = \'http://uk-koeln.de/fhir/ValueSet/obs-methods\').code = 'FISH'" then
        {
            //Kit Bezeichnung
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueCodeableConcept as cc where "code.coding.code = 'C42793' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 6;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2229';
                            cc.coding as coding, coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            //Hersteller
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueCodeableConcept as cc where "code.coding.code = 'C25392' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 6;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2230';
                            cc.coding as coding, coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            //Ergebnis
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.valueCodeableConcept as cc, cc.coding as coding then
                    {
                        observation -> data.blockindex = 6;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2233';
                        coding.code as code -> data.values as values, values.value = code;
                    };
                };
            };

            //Positive Tumorzellen
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueQuantity as quantity where "code.coding.code = 'C70460' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 6;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2234';
                            quantity.value as value -> data.values as values, values.value = value, values.unit = 'percent';
                        };
                    };
                };
            };
            //Polysomie
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueQuantity as quantity where "code.coding.code = 'C36331' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 6;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2235';
                            quantity.value as value -> data.values as values, values.value = value, values.unit = 'percent';
                        };
                    };
                };
            };
        };
        /*---------------STATUS DER UNTERSUCHUNGEN----------------*/

        /*---------------ALK----------------*/
        entry.resource as observation where "resource is Observation 
                                            and resource.code.coding.code = 'ALK'" then
        {
            //Durchführung
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.status as status where "%tgt.operations.data.where(itemid = 'id_2520').exists().not()" then
                    {
                        observation -> data.blockindex = 7;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2520';
                        status.value as value -> data.values as values, values.value = value;
                    };
                };
            };

            //Abschluss
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.status as status where "%tgt.operations.data.where(itemid = 'id_2462').exists().not()" then
                    {
                        observation -> data.blockindex = 7;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2462';
                        status.extension as extension where "$this.extension.url = 'http://uk-koeln.de/fhir/Extension/statusAbschluss'" then
                        {
                            extension.valueCodeableConcept as cc, cc.coding as coding, coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            /*
            //Datum des Anfang MET?
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.effectivePeriod as effectiveperiod where "%tgt.operations.data.where(itemid = 'id_2132').exists().not()" then
                    {
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2132';
                        effectiveperiod.start as abschlussdatum -> data.values as values, values.value = abschlussdatum;
                    };
                };
            };

            //Datum des Anfang RET?
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.effectivePeriod as effectiveperiod where "%tgt.operations.data.where(itemid = 'id_2183').exists().not()" then
                    {
                        observation -> data.blockindex = 5;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2183';
                        effectiveperiod.start as abschlussdatum -> data.values as values, values.value = abschlussdatum;
                    };
                };
            };
            */

            //Datum des Abschlusses
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.effectivePeriod as effectiveperiod where "%tgt.operations.data.where(itemid = 'id_2521').exists().not()" then
                    {
                        observation -> data.blockindex = 7;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2521';
                        effectiveperiod.end as abschlussdatum -> data.values as values, values.value = abschlussdatum;
                    };
                };
            };
        };

        /*---------------MET----------------*/
        entry.resource as observation where "resource is Observation 
                                            and resource.code.coding.code = 'MET'" then
        {
            //Durchführung
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.status as status where "%tgt.operations.data.where(itemid = 'id_2520').exists().not()" then
                    {
                        observation -> data.blockindex = 7;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2520';
                        status.value as value -> data.values as values, values.value = value;
                    };
                };
            };

            //Abschluss
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.status as status where "%tgt.operations.data.where(itemid = 'id_2462').exists().not()" then
                    {
                        observation -> data.blockindex = 7;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2462';
                        status.extension as extension where "$this.extension.url = 'http://uk-koeln.de/fhir/Extension/statusAbschluss'" then
                        {
                            extension.valueCodeableConcept as cc, cc.coding as coding, coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            //Datum des Abschlusses
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.effectivePeriod as effectiveperiod where "%tgt.operations.data.where(itemid = 'id_2521').exists().not()" then
                    {
                        observation -> data.blockindex = 7;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2521';
                        effectiveperiod.end as abschlussdatum -> data.values as values, values.value = abschlussdatum;
                    };
                };
            };
        };

        /*---------------RET----------------*/
        entry.resource as observation where "resource is Observation 
                                            and resource.code.coding.code = 'RET'" then
        {
            //Durchführung
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.status as status where "%tgt.operations.data.where(itemid = 'id_2520').exists().not()" then
                    {
                        observation -> data.blockindex = 7;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2520';
                        status.value as value -> data.values as values, values.value = value;
                    };
                };
            };

            //Abschluss
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.status as status where "%tgt.operations.data.where(itemid = 'id_2462').exists().not()" then
                    {
                        observation -> data.blockindex = 7;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2462';
                        status.extension as extension where "$this.extension.url = 'http://uk-koeln.de/fhir/Extension/statusAbschluss'" then
                        {
                            extension.valueCodeableConcept as cc, cc.coding as coding, coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            //Datum des Abschlusses
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.effectivePeriod as effectiveperiod where "%tgt.operations.data.where(itemid = 'id_2521').exists().not()" then
                    {
                        observation -> data.blockindex = 7;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2521';
                        effectiveperiod.end as abschlussdatum -> data.values as values, values.value = abschlussdatum;
                    };
                };
            };
        };

        /*---------------ROS1----------------*/
        entry.resource as observation where "resource is Observation 
                                            and resource.code.coding.code = 'ROS1'" then
        {
            //Durchführung
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.status as status where "%tgt.operations.data.where(itemid = 'id_2520').exists().not()" then
                    {
                        observation -> data.blockindex = 7;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2520';
                        status.value as value -> data.values as values, values.value = value;
                    };
                };
            };

            //Abschluss
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.status as status where "%tgt.operations.data.where(itemid = 'id_2462').exists().not()" then
                    {
                        observation -> data.blockindex = 7;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2462';
                        status.extension as extension where "$this.extension.url = 'http://uk-koeln.de/fhir/Extension/statusAbschluss'" then
                        {
                            extension.valueCodeableConcept as cc, cc.coding as coding, coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            //Datum des Abschlusses
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.effectivePeriod as effectiveperiod where "%tgt.operations.data.where(itemid = 'id_2521').exists().not()" then
                    {
                        observation -> data.blockindex = 7;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2521';
                        effectiveperiod.end as abschlussdatum -> data.values as values, values.value = abschlussdatum;
                    };
                };
            };
        };

        /*---------------EpisodeOfCare----------------*/
        entry.resource as episodeofcare where "resource is EpisodeOfCare" then
        {
            //Untersuchung-ID
            episodeofcare -> tgt.operations as operations collate then
            {
                episodeofcare -> operations.data as data then
                {
                    episodeofcare.identifier as identifier, identifier.value as value then
                    {   
                        episodeofcare -> data.blockindex = 1;
                        episodeofcare -> data.groupindex = 0;
                        episodeofcare -> data.itemid = 'assessment_id';
                        value -> data.values as values, values.value = value;
                    };
                };
            };
        };

        /*---------------Organization----------------*/
         entry.resource as organization where "resource is Organization" then
        {
            //Standort
            organization -> tgt.operations as operations collate then
            {
                organization -> operations.data as data then
                {
                    organization.name as name then
                    {   
                        organization -> data.blockindex = 0;
                        organization -> data.groupindex = 0;
                        organization -> data.itemid = 'id_2435';
                        name -> data.values as values, values.value = name;
                    };
                };
            };

            //SOP-Versionsnummer des Standorts
            organization -> tgt.operations as operations collate then
            {
                organization -> operations.data as data then
                {
                    organization.type as type then
                    {   
                        organization -> data.blockindex = 0;
                        organization -> data.groupindex = 0;
                        organization -> data.itemid = 'id_2617';
                        type.text as text -> data.values as values, values.value = text;
                    };
                };
            };
        };

        /*---------------Specimen----------------*/
        entry.resource as specimen where "resource is Specimen" then
        {
            
            //Biopsie-ID
            specimen -> tgt.operations as operations collate then
            {
                specimen -> operations.data as data then
                {
                    specimen.identifier as identifier, identifier.value as value where "$this.system = 'http://uk-koeln.de/fhir/NamingSystem/nNGM/biopsienummer'" then
                    {   
                        specimen -> data.blockindex = 0;
                        specimen -> data.groupindex = 0;
                        specimen -> data.itemid = 'id_1601';
                        value -> data.values as values, values.value = value;
                    };
                };
            };
        };

         /*---------------Device----------------*/
        entry.resource as device where "resource is Device" then
        {
            
            //Lung panel version
            device -> tgt.operations as operations collate then
            {
                device -> operations.data as data then
                {
                    device.version as version then
                    {   
                        device -> data.blockindex = 3;
                        device -> data.groupindex = 0;
                        device -> data.itemid = 'id_1260';
                        version.value as value -> data.values as values, values.value = value;
                    };
                };
            };

            //Sequencer
            device -> tgt.operations as operations collate then
            {
                device -> operations.data as data then
                {
                    device.type as type, type.coding as coding where "coding.system = 'http://hl7.org/fhir/ValueSet/nngm-device-typ'" then
                    {   
                        device -> data.blockindex = 3;
                        device -> data.groupindex = 0;
                        device -> data.itemid = 'id_2603';
                        coding.code as value -> data.values as values, values.value = value;
                    };
                };
            };
            
            //Hersteller
            device -> tgt.operations as operations collate then
            {
                device -> operations.data as data then
                {
                    device.manufacturer as version then
                    {   
                        device -> data.blockindex = 3;
                        device -> data.groupindex = 0;
                        device -> data.itemid = 'id_2604';
                        version.value as value -> data.values as values, values.value = value;
                    };
                };
            };

            //Panel Detail
            device -> tgt.operations as operations collate then
            {
                device -> operations.data as data then
                {
                    device.distinctIdentifier as version then
                    {   
                        device -> data.blockindex = 3;
                        device -> data.groupindex = 0;
                        device -> data.itemid = 'ngs_panel_panel_detail';
                        version.value as value -> data.values as values, values.value = value;
                    };
                };
            };
        };
            
     /*---------------Observation----------------*/

        entry.resource as observation where "resource is Observation" then
        {
            
            //Gen
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueCodeableConcept as cc where "code.coding.code = 'C16612' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_1159';
                            cc.coding as coding, coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            //Exon
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueInteger as integer where "code.coding.code = 'C13231' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_35';
                            integer -> data.values as values, values.value = integer;
                        };
                    };
                };
            };

            //HGVS c.
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueCodeableConcept as cc where "code.coding.code = '48004-6' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_36';
                            cc.coding as coding, coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            //HGVS p.
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueString as string where "code.coding.code = '48005-3' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_37';
                            string.value as value -> data.values as values, values.value = value;
                        };
                    };
                };
            };

            //Allelic fraction
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueQuantity as quantity where "code.coding.code = 'AllelicFraction' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_38';
                            quantity.value as value -> data.values as values, values.value = value, values.unit = 'percent';
                        };
                    };
                };
            };

            //Referenztranskript
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueString as string where "code.coding.code = 'Referenztranscript' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'ngs_panel_reftranscript';
                            string.value as value -> data.values as values, values.value = value;
                        };
                    };
                };
            };

            //Coverage
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueString as string where "code.coding.code = 'NGSPanelCoverage' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'ngs_panel_reftranscript';
                            string.value as value -> data.values as values, values.value = value;
                        };
                    };
                };
            };

            //Biologische/molekulare Bewertung
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueString as string where "code.coding.code = 'BiologischeMolekulareBewertung' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_47';
                            string.value as value -> data.values as values, values.value = value;
                        };
                    };
                };
            };

            //Kommentar
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.note as note then
                    {   
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_48';
                        note.text as value -> data.values as values, values.value = value;
                    };
                };
            };

            //Genome build
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueString as string where "code.coding.code = 'GenomeBuild' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_41';
                            string.value as value -> data.values as values, values.value = value;
                        };
                    };
                };
            };

            //Chromosom
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueInteger as string where "code.coding.code = 'C13202' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_42';
                            string.value as value -> data.values as values, values.value = value;
                        };
                    };
                };
            };

            //Position Start
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueInteger as integer where "code.coding.code = 'PosStart' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_43';
                            integer.value as value -> data.values as values, values.value = value;
                        };
                    };
                };
            };
            
            //Position Stop
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueInteger as integer where "code.coding.code = 'PosStop' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_44';
                            integer.value as value -> data.values as values, values.value = value;
                        };
                    };
                };
            };
            
            //Ref allele
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueString as string where "code.coding.code = '69547-8' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_45';
                            string.value as value -> data.values as values, values.value = value;
                        };
                    };
                };
            };
            
            //Alt allele
           observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueString as string where "code.coding.code = '69551-0' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_46';
                            string.value as value -> data.values as values, values.value = value;
                        };
                    };
                };
            };

            //reads ref allele
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueInteger as integer where "code.coding.code = 'ReadsRefAllel' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_39';
                            integer.value as value -> data.values as values, values.value = value;
                        };
                    };
                };
            };

            //reads alt allele
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueInteger as integer where "code.coding.code = 'ReadsAltAllel' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_40';
                            integer.value as value -> data.values as values, values.value = value;
                        };
                    };
                };
            };

            //Durchführung
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.status as status where "%tgt.operations.data.where(itemid = 'id_2520').exists().not()" then
                    {
                        observation -> data.blockindex = 5;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2520';
                        status.value as value -> data.values as values, values.value = value;
                    };
                };
            };

            //Abschluss
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.status as status where "%tgt.operations.data.where(itemid = 'id_2462').exists().not()" then
                    {
                        observation -> data.blockindex = 5;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2462';
                        status.extension as extension then
                        {
                            extension.valueCodeableConcept as cc, cc.coding as coding, coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            //Datum des Abschlusses
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.effectivePeriod as effectiveperiod where "%tgt.operations.data.where(itemid = 'id_2521').exists().not()" then
                    {
                        observation -> data.blockindex = 5;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2521';
                        effectiveperiod.end as abschlussdatum -> data.values as values, values.value = abschlussdatum;
                    };
                };
            };
        };

        /* ------------------------------ DiagnosticReport ---------------------------- */
    entry.resource as diagnosticreport where "resource is DiagnosticReport" then
    {
        //Erstelldatum
        diagnosticreport -> tgt.operations as operations collate then
        {
            diagnosticreport -> operations.data as data then
            {
                diagnosticreport.effectiveDateTime as dt then
                {   
                    diagnosticreport -> data.blockindex = 0;
                    diagnosticreport -> data.groupindex = 0;
                    diagnosticreport -> data.itemid = 'bu_creation_date';
                    dt -> data.values as values, values.value = dt;
                };
            };
        };

        //Version
        diagnosticreport -> tgt.operations as operations collate then
        {
            diagnosticreport -> operations.data as data then
            {
                diagnosticreport.status as status then
                {   
                    diagnosticreport -> data.blockindex = 0;
                    diagnosticreport -> data.groupindex = 0;
                    diagnosticreport -> data.itemid = 'bu_version';
                    status -> data.values as values, values.value = status;
                };
            };
        };


        //Klinische Information
        diagnosticreport -> tgt.operations as operations collate then
        {
            diagnosticreport -> operations.data as data then
            {
                diagnosticreport.conclusion as conclusion then
                {   
                    diagnosticreport -> data.blockindex = 0;
                    diagnosticreport -> data.groupindex = 0;
                    diagnosticreport -> data.itemid = 'id_1352';
                    conclusion -> data.values as values, values.value = conclusion;
                };
            };
        };

        //Empfehlung einer systemischen Therapie
        diagnosticreport -> tgt.operations as operations collate then
        {
            diagnosticreport -> operations.data as data then
            {
                diagnosticreport.conclusionCode as conclusionCode, conclusionCode.extension as beurteilung, beurteilung.valueBoolean as empfehlung where "$this.value = true" then
                {   
                    diagnosticreport -> data.blockindex = 0;
                    diagnosticreport -> data.groupindex = 0;
                    diagnosticreport -> data.itemid = 'id_2405';
                    empfehlung -> data.values as values, values.value = 'Ja';
                };

                diagnosticreport.conclusionCode as conclusionCode, conclusionCode.extension as beurteilung, beurteilung.valueBoolean as empfehlung where "$this.value = false" then
                {   
                    diagnosticreport -> data.blockindex = 0;
                    diagnosticreport -> data.groupindex = 0;
                    diagnosticreport -> data.itemid = 'id_2405';
                    empfehlung -> data.values as values, values.value = 'Nein';
                };
            };
        };
    };
    
    /* ------------------------------ ServiceRequest ----------------------------*/ 
    entry.resource as servicerequest where "resource is ServiceRequest" then
    {   
            //Patient ID -> cts.patid
             servicerequest -> tgt.operations as operations collate then
            {
                servicerequest -> operations.data as data then
                {
                    servicerequest.subject as subject then
                    {   
                        subject.reference as patient then
                        {
                            patient -> tgt.patid = evaluate(patient, '$this.split(\'\/\').last()');
                        };
                    };
                };
            };

            //Durchfuerung
            servicerequest -> tgt.operations as operations collate then
            {
                servicerequest -> operations.data as data then 
                {
                    servicerequest.status as durchfuerung then
                    {
                        servicerequest -> data.blockindex = 1;
                        servicerequest -> data.groupindex = 0;
                        servicerequest -> data.itemid = 'id_2523';
                        durchfuerung -> data.values as values, values.value = durchfuerung;
                    };
                };
            };

            //Abschluss 
            servicerequest -> tgt.operations as operations collate then
            {
                servicerequest -> operations.data as data then 
                {
                    servicerequest.category as abschluss, abschluss.category as category, category.coding as coding, coding.code as abschluss then
                    {
                        servicerequest -> data.blockindex = 1;
                        servicerequest -> data.groupindex = 0;
                        servicerequest -> data.itemid = 'bu_closing';
                        abschluss -> data.values as values, values.value = abschluss;
                    };
                };
            };
            

            //Datum des abschlusses 
            servicerequest -> tgt.operations as operations collate then
            {
                servicerequest -> operations.data as data then 
                {
                    servicerequest.extension as extension, extension.valueDateTime as datumAbschlusses  where "$this.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/nNGM/datumabschluss'" then
                    {
                        servicerequest -> data.blockindex = 1;
                        servicerequest -> data.groupindex = 0;
                        servicerequest -> data.itemid = 'id_2524';
                        datumAbschlusses -> data.values as values, values.value = datumAbschlusses;
                    };
                };
            };

            //Datum des versands 
            servicerequest -> tgt.operations as operations collate then
            {
                servicerequest -> operations.data as data then 
                {
                    servicerequest.extension as extension, extension.valueDateTime as datumVersands where "$this.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/nNGM/datumversands'" then
                    {
                        servicerequest -> data.blockindex = 1;
                        servicerequest -> data.groupindex = 0;
                        servicerequest -> data.itemid = 'id_2525';
                        datumVersands -> data.values as values, values.value = datumVersands;
                    };
                };
            };
        };
    };
}