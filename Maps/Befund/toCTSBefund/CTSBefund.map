/// version = 0.1
/// title = "nNGM: Sonstige Therapie - FHIR to CTS"
/*
    TODO
    Missing Add Beurteilung section implementation
     
*/


map "http://uk-koeln.de/fhir/StructureMap/nNGM_Mapping_BeurteilungCST" = nNGM_Mapping_BeurteilungCST

uses "http://hl7.org/fhir/StructureDefinition/Bundle" as source
uses "http://hl7.org/fhir/StructureDefinition/CTS_Transport" as target

group TransformCTS(source src: Bundle, target tgt: CTS_Transport)
{
    src -> tgt.version = '1.1';
    src -> tgt.sourcesystem = 'https:\/\/nngm-qat.staging.healex.systems\/';
    
    src -> tgt.operations as operations collate, operations.crfid = '6-BU';
    src -> tgt.operations as operations collate, operations.type = 'save';

    src.entry as entry then
    {
        //----------------------   DiagnosticReport   --------------------
        entry.resource as diagnosticReport where "resource is DiagnosticReport" then
        {
            //Erstelldatum
            diagnosticReport -> tgt.operations as operations collate then
            {
                diagnosticReport -> operations.data as data then
                {
                    diagnosticReport.effectiveDateTime as effectiveDateTime then
                    {
                        diagnosticReport -> data.blockindex = 0;
                        diagnosticReport -> data.groupindex = 0;
                        diagnosticReport -> data.itemid = 'bu_creation_date';
                        effectiveDateTime -> data.values as values, values.value = effectiveDateTime;
                    };
                };
            };
            //Version
            diagnosticReport -> tgt.operations as operations collate then
            {
                diagnosticReport -> operations.data as data then
                {
                    diagnosticReport.status as status where "$this.status= 'preliminary'" then
                    {
                        diagnosticReport -> data.blockindex = 0;
                        diagnosticReport -> data.groupindex = 0;
                        diagnosticReport -> data.itemid = 'bu_version';
                        status -> data.values as values, values.value = 'vorlÃ¤ufig';
                    };
                    diagnosticReport.status as status where "$this.status= 'final'" then
                    {
                        diagnosticReport -> data.blockindex = 0;
                        diagnosticReport -> data.groupindex = 0;
                        diagnosticReport -> data.itemid = 'bu_version';
                        status -> data.values as values, values.value = 'final';
                    };
                };
            };
            //Klinische Information
            diagnosticReport -> tgt.operations as operations collate then
            {
                diagnosticReport -> operations.data as data then
                {
                    diagnosticReport.conclusion as conclusion then
                    {
                        diagnosticReport -> data.blockindex = 0;
                        diagnosticReport -> data.groupindex = 0;
                        diagnosticReport -> data.itemid = 'id_1352';
                        conclusion -> data.values as values, values.value = conclusion;
                    };
                };
            };
            //Empfehlung einer systemischen Therapie
            diagnosticReport -> tgt.operations as operations collate then
            {
                diagnosticReport -> operations.data as data then
                {
                    diagnosticReport.conclusionCode as conclusionCode,
                    conclusionCode.extension as empfehlung,
                    empfehlung.valueBoolean as valueBoolean where "valueBoolean = true" then
                    {
                        diagnosticReport -> data.blockindex = 0;
                        diagnosticReport -> data.groupindex = 0;
                        diagnosticReport -> data.itemid = 'id_2405';
                        valueBoolean -> data.values as values, values.value = 'Ja';
                    };
                };
                diagnosticReport -> operations.data as data then
                {
                    diagnosticReport.conclusionCode as conclusionCode,
                    conclusionCode.extension as empfehlung,
                    empfehlung.valueBoolean as valueBoolean where "valueBoolean = false" then
                    {
                        diagnosticReport -> data.blockindex = 0;
                        diagnosticReport -> data.groupindex = 0;
                        diagnosticReport -> data.itemid = 'id_2405';
                        valueBoolean -> data.values as values, values.value = 'Nein';
                    };
                };
            };
        };
        //----------------------   ServiceRequest   --------------------
        entry.resource as serviceRequest where "resource is ServiceRequest" then
        {
            //Durchfuehrung
            serviceRequest -> tgt.operations as operations collate then
            {
                serviceRequest -> operations.data as data then
                {
                    serviceRequest.status as status where "status='active'"then
                    {
                        serviceRequest -> data.blockindex = 1;
                        serviceRequest -> data.groupindex = 0;
                        serviceRequest -> data.itemid = 'id_2523';
                        status -> data.values as values, values.value ='in Bearbeitung';
                    };
                    serviceRequest.status as status where "status='completed'"then
                    {
                        serviceRequest -> data.blockindex = 1;
                        serviceRequest -> data.groupindex = 0;
                        serviceRequest -> data.itemid = 'id_2523';
                        status -> data.values as values, values.value ='abgeschlossen';
                    };
                };
            };
            //Abschluss
            serviceRequest -> tgt.operations as operations collate then
            {
                serviceRequest -> operations.data as data then
                {
                    serviceRequest.status as status, 
                    status.extension as statusAbschluss,
                    statusAbschluss.extension as statusExtension,
                    statusExtension.url as url 
                     where "$this.url = 'status'" then
                    {
                        serviceRequest -> data.blockindex = 1;
                        serviceRequest -> data.groupindex = 0;
                        serviceRequest -> data.itemid = 'bu_closing';
                        statusExtension.valueCodeable as valueCodeable,
                        valueCodeable.code as code -> data.values as values, values.value = code;
                    };
                };
            };
            //Datum des Abschlusses
            serviceRequest -> tgt.operations as operations collate then
            {
                serviceRequest -> operations.data as data then
                {
                    serviceRequest.status as status, 
                    status.extension as statusAbschluss,
                    statusAbschluss.extension as datumExtension,
                    datumExtension.url as url 
                     where "url = 'datum'" then
                    {
                        serviceRequest -> data.blockindex = 1;
                        serviceRequest -> data.groupindex = 0;
                        serviceRequest -> data.itemid = 'id_2524';
                        datumExtension.valueDate as valueDate -> data.values as values, values.value = valueDate;
                    };
                };
            };
            //Datum des versands
            serviceRequest -> tgt.operations as operations collate then
            {
                serviceRequest -> operations.data as data then
                {
                    serviceRequest.extension as datumVersands, 
                    datumVersands.url as url
                    where "url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/nNGM/datumversands'" then
                    {
                        serviceRequest -> data.blockindex = 1;
                        serviceRequest -> data.groupindex = 0;
                        serviceRequest -> data.itemid = 'id_2525';
                        datumVersands.valueDate as valueDate -> data.values as values, values.value = valueDate;
                    };
                };
            };
        };
    };
}