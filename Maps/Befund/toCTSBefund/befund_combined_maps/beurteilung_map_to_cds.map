/// version = 0.1
/// title = "nNGM: nNGM_Mapping_BeurteilungCTS - FHIR to CTS"

/*
TODO

WHERE IS STATUS DER DIAGNOSTIK?
*/

map "http://uk-koeln.de/fhir/StructureMap/nNGM_Mapping_BeurteilungCTS" = nNGM_Mapping_BeurteilungCTS

uses "http://hl7.org/fhir/StructureDefinition/Bundle" as source
uses "http://hl7.org/fhir/StructureDefinition/CTS_Transport" as target

imports "http://uk-koeln.de/fhir/StructureMap/nNGM_Mapping_Molekularpathologie_checkboxesCTS"

group TransformBeurteilungOperation(source src: Bundle, target tgt: BackboneElement)
{
    src -> tgt.type = 'save';
    src -> tgt.crfid = '1_BU';

    src.entry as entry then
    {
        entry.resource as diagnosticreport where "resource is DiagnosticReport" then
        {

            //status
            diagnosticreport -> tgt.data as data then
            {
                    diagnosticreport -> data.blockindex = 1;
                    diagnosticreport -> data.groupindex = 0;
                    diagnosticreport -> data.repeatindex = 0; 
                    diagnosticreport -> data.itemid = 'id_2523';
                    diagnosticreport -> data.values as values, values.value = 'abgeschlossen';
            };

            //Erstelldatum
            diagnosticreport -> tgt.data as data then
            {
                diagnosticreport.effectiveDateTime as dt then
                {   
                    diagnosticreport -> data.blockindex = 0;
                    diagnosticreport -> data.groupindex = 0;
                    diagnosticreport -> data.repeatindex = 0; 
                    diagnosticreport -> data.itemid = 'bu_creation_date';
                    dt -> data.values as values, values.value = dt;
                };
            };
            //Version
            diagnosticreport -> tgt.data as data then
            {
                diagnosticreport.status as status then
                {   
                    diagnosticreport -> data.blockindex = 0;
                    diagnosticreport -> data.groupindex = 0;
                    diagnosticreport -> data.repeatindex = 0; 
                    diagnosticreport -> data.itemid = 'bu_version';
                    status -> data.values as values, values.value = status;
                };
            };
            //Empfehlung einer systemischen Therapie
            diagnosticreport -> tgt.data as data then
            {
                diagnosticreport.conclusionCode as conclusionCode, conclusionCode.extension as beurteilung, beurteilung.valueBoolean as empfehlung where "$this.value = true" then
                {   
                    diagnosticreport -> data.blockindex = 0;
                    diagnosticreport -> data.groupindex = 0;
                    diagnosticreport -> data.repeatindex = 0; 
                    diagnosticreport -> data.itemid = 'id_2405';
                    empfehlung -> data.values as values, values.value = 'Ja';
                };

                diagnosticreport.conclusionCode as conclusionCode, conclusionCode.extension as beurteilung, beurteilung.valueBoolean as empfehlung where "$this.value = false" then
                {   
                    diagnosticreport -> data.blockindex = 0;
                    diagnosticreport -> data.groupindex = 0;
                    diagnosticreport -> data.repeatindex = 0; 
                    diagnosticreport -> data.itemid = 'id_2405';
                    empfehlung -> data.values as values, values.value = 'Nein';
                };
            };
        };
    };
}