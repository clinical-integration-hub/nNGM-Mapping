/// version = 0.1
/// title = "nNGM: nNGM_Mapping_HistologieCTS - FHIR to CTS"

map "http://uk-koeln.de/fhir/StructureMap/nNGM_Mapping_HistologieCTS" = nNGM_Mapping_HistologieCTS

uses "http://hl7.org/fhir/StructureDefinition/Bundle" as source
uses "http://hl7.org/fhir/StructureDefinition/CTS_Transport" as target

group TransformHistologieOperation(source src: Bundle, target tgt: BackboneElement)
{
    src -> tgt.type = 'save';
    src -> tgt.crfid = '1_HL1';

    src.entry as entry then
    {
        /*------------------------------EpisodeOFCare---------------------------------*/
       entry.resource as episodeofcare where "resource is EpisodeOfCare and resource.id = 'd2c46c91-fc7a-4a5d-9791-995f68c1bdc1'" then
        {
            //Untersuchung-ID
            episodeofcare -> tgt.data as data then
            {
                episodeofcare.identifier as identifier, identifier.value as value then
                {   
                    episodeofcare -> data.blockindex = 5;
                    episodeofcare -> data.groupindex = 0;
                    episodeofcare -> data.itemid = 'assessment_id';
                    value -> data.values as values, values.value = value;
                };
            };
        };

        /*----------------------------Specimen-----------------------------------*/
        entry.resource as specimen where "resource is Specimen and resource.identifier.system = 'http://uk-koeln.de/fhir/NamingSystem/nNGM/pathologiefallid'" then
        {
            //Eingang des Tumormaterials in der Pathologie
            specimen -> tgt.data as data then
            {
                specimen.collection as collection, collection.collectedDateTime as eingangsdatum then
                {   
                    specimen -> data.blockindex = 0;
                    specimen -> data.groupindex = 0;
                    specimen -> data.itemid = 'id_2515';
                    eingangsdatum -> data.values as values, values.value = eingangsdatum;
                };
            };

            specimen -> tgt.data as data then
            {
                specimen.identifier as identifier, identifier.value as value where "$this.system = 'http://uk-koeln.de/fhir/NamingSystem/nNGM/pathologiefallid'" then
                {   
                    specimen -> data.blockindex = 0;
                    specimen -> data.groupindex = 0;
                    specimen -> data.itemid = 'extern_patho_case_id';
                    value -> data.values as values, values.value = value;
                };
            };
        };

        /*-------------------------------Histologie Observation-------------------------------------*/

        entry.resource as observation where "resource is Observation and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/nNGM/histologie'" then
        {
            //Klassifikation
            observation -> tgt.data as data then
            {
                observation.code as code, code.coding as coding then
                {   
                    observation -> data.blockindex = 2;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_1658';
                    coding -> data.values as values, values.value = evaluate(coding, '$this.code + \'\\t\' +  $this.display');
                };
            };

            //Lokalisation
            observation -> tgt.data as data then
            {
                observation.bodySite as code, code.coding as coding then
                {   
                    observation -> data.blockindex = 2;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_2469';
                    coding -> data.values as values, values.value = evaluate(coding, '$this.code + \'\\t\' +  $this.display');
                };
            };

            //Grading
            observation -> tgt.data as data then
            {
                observation.valueCodeableConcept as cc, cc.coding as coding then
                {   
                    observation -> data.blockindex = 2;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_2403';
                    coding.code as code -> data.values as values, values.value = code;
                };
            };
            
             //Durchführung
            observation -> tgt.data as data then
            {
                observation.status as status where "%tgt.operations.data.where(itemid = 'id_2520').exists().not()" then
                {
                    observation -> data.blockindex = 4;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_2520';
                    observation -> data.values as values, values.value = 'abgeschlossen';
                };
            };

            //Abschluss
            observation -> tgt.data as data then
            {
                observation.status as status where "%tgt.operations.data.where(itemid = 'id_2462').exists().not()" then
                {
                    observation -> data.blockindex = 4;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_2462';
                    observation -> data.values as values, values.value = 'vollständig';
                };
            };

            //Datum des Abschlusses
            observation -> tgt.data as data then
            {
                observation.effectivePeriod as effectiveperiod where "%tgt.operations.data.where(itemid = 'id_2521').exists().not()" then
                {
                    observation -> data.blockindex = 4;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_2521';
                    observation -> data.values as values, values.value = '2019-11-11';
                };
            };
        };
    };
}