/// version = 0.1
/// title = "nNGM: nNGM_Mapping_NGSLungPanelCTS - FHIR to CTS"

map "http://uk-koeln.de/fhir/StructureMap/nNGM_Mapping_NGSLungPanelCTS" = nNGM_Mapping_NGSLungPanelCTS

uses "http://hl7.org/fhir/StructureDefinition/Bundle" as source
uses "http://hl7.org/fhir/StructureDefinition/CTS_Transport" as target

group TransformNGSLungPanelOperation(source src: Bundle, target tgt: BackboneElement)
{
    src -> tgt.type = 'save';
    src -> tgt.crfid = '1_LP1';
 
    src.entry as entry then
    {
        /*---------------Episode Of Care----------------*/
        entry.resource as episodeofcare where "resource is EpisodeOfCare and resource.id = 'd2c46c91-fc7a-4a5d-9791-995f68c1bdc1'" then
        {
            //Untersuchung-ID
            episodeofcare -> tgt.data as data then
            {
                episodeofcare.identifier as identifier, identifier.value as value then
                {   
                    episodeofcare -> data.blockindex = 1;
                    episodeofcare -> data.groupindex = 0;
                    episodeofcare -> data.itemid = 'assessment_id';
                    value -> data.values as values, values.value = value;
                };
            };
        };

        /*---------------Organization----------------*/
        entry.resource as organization where "resource is Organization" then
        {
            //Standort
            organization -> tgt.data as data then
            {
                organization.name as name then
                {   
                    organization -> data.blockindex = 2;
                    organization -> data.groupindex = 0;
                    organization -> data.itemid = 'id_2435';
                    name -> data.values as values, values.value = name;
                };
            };
        };
        /*---------------Device----------------*/
        entry.resource as device where "resource is Device" then
        {
            //Lung panel version
            device -> tgt.data as data then
            {
                device.version as version then
                {   
                    device -> data.blockindex = 3;
                    device -> data.groupindex = 0;
                    device -> data.itemid = 'id_1260';
                    version.value as value -> data.values as values, values.value = value;
                };
            };

            //Sequencer
            device -> tgt.data as data then
            {
                device.type as type, type.coding as coding where "coding.system = 'http://hl7.org/fhir/ValueSet/nngm-device-typ'" then
                {   
                    device -> data.blockindex = 3;
                    device -> data.groupindex = 0;
                    device -> data.itemid = 'id_2603';
                    coding.code as value -> data.values as values, values.value = value;
                };
            };
            
            //Hersteller
            device -> tgt.data as data then
            {
                device.manufacturer as version then
                {   
                    device -> data.blockindex = 3;
                    device -> data.groupindex = 0;
                    device -> data.itemid = 'id_2604';
                    version.value as value -> data.values as values, values.value = value;
                };
            };

            //Panel Detail
            device -> tgt.data as data then
            {
                device.distinctIdentifier as version then
                {   
                    device -> data.blockindex = 3;
                    device -> data.groupindex = 0;
                    device -> data.itemid = 'ngs_panel_panel_detail';
                    version.value as value -> data.values as values, values.value = value;
                };
            };
        };

        /*----------------Observation-----------------------*/
        entry.resource as observation where "resource is Observation 
                                                and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/ngs-panel'" then
        {
            observation.status as selection where "component.valueInteger = 21" then
            {
                //Date of Assessment
                observation -> tgt.data as data then
                {
                    observation.effectiveDateTime as dateTime then
                    {   
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.repeatindex = 0;
                        observation -> data.itemid = 'id_1160';
                        dateTime -> data.values as values, values.value = dateTime;
                    };
                };
                //Gen
                observation -> tgt.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueCodeableConcept as cc where "code.coding.code = 'C16612' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.repeatindex = 0;
                            observation -> data.itemid = 'id_1159';
                            cc.coding as coding, coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };
                //Exon
                observation -> tgt.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueInteger as integer where "code.coding.code = 'C13231' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.repeatindex = 0;
                            observation -> data.itemid = 'id_35';
                            integer -> data.values as values, values.value = integer;
                        };
                    };
                };
                //HGVS p.
                observation -> tgt.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueString as string where "code.coding.code = '48005-3' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.repeatindex = 0;
                            observation -> data.itemid = 'id_37';
                            string.value as value -> data.values as values, values.value = value;
                        };
                    };
                };
                //Allelic fraction
                observation -> tgt.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueQuantity as quantity where "code.coding.code = 'AllelicFraction' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.repeatindex = 0;
                            observation -> data.itemid = 'id_38';
                            quantity.value as value -> data.values as values, values.unit = 'percent', values.value = value;
                        };
                    };
                };
                //Biologische/molekulare Bewertung
                observation -> tgt.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueString as string where "code.coding.code = 'BiologischeMolekulareBewertung' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.repeatindex = 0;
                            observation -> data.itemid = 'id_47';
                            string.value as value -> data.values as values, values.value = value;
                        };
                    };
                };
            };

            observation.status as selection where "component.valueInteger = 21" then
            {
                //Date of Assessment
                observation -> tgt.data as data then
                {
                    observation.effectiveDateTime as dateTime then
                    {   
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.repeatindex = 0;
                        observation -> data.itemid = 'id_1160';
                        dateTime -> data.values as values, values.value = dateTime;
                    };
                };
                //Gen
                observation -> tgt.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueCodeableConcept as cc where "code.coding.code = 'C16612' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.repeatindex = 0;
                            observation -> data.itemid = 'id_1159';
                            cc.coding as coding, coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };
                //Exon
                observation -> tgt.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueInteger as integer where "code.coding.code = 'C13231' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.repeatindex = 0;
                            observation -> data.itemid = 'id_35';
                            integer -> data.values as values, values.value = integer;
                        };
                    };
                };
                //HGVS p.
                observation -> tgt.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueString as string where "code.coding.code = '48005-3' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.repeatindex = 0;
                            observation -> data.itemid = 'id_37';
                            string.value as value -> data.values as values, values.value = value;
                        };
                    };
                };
                //Allelic fraction
                observation -> tgt.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueQuantity as quantity where "code.coding.code = 'AllelicFraction' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.repeatindex = 0;
                            observation -> data.itemid = 'id_38';
                            quantity.value as value -> data.values as values, values.unit = 'percent', values.value = value;
                        };
                    };
                };
                //Biologische/molekulare Bewertung
                observation -> tgt.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueString as string where "code.coding.code = 'BiologischeMolekulareBewertung' and code.coding.system = 'http://ncit.nci.nih.gov'" then
                        {
                            observation -> data.blockindex = 4;
                            observation -> data.groupindex = 0;
                            observation -> data.repeatindex = 0;
                            observation -> data.itemid = 'id_47';
                            string.value as value -> data.values as values, values.value = value;
                        };
                    };
                };
            };
        };

        /*------------------ServiceRequest----------------------*/
        entry.resource as servicerequest where "resource is ServiceRequest" then
        {
            //Durchführung
            servicerequest -> tgt.data as data then
            {
                servicerequest -> data.blockindex = 5;
                servicerequest -> data.groupindex = 0;
                servicerequest -> data.itemid = 'id_2520';
                servicerequest -> data.values as values, values.value = 'abgeschlossen';
            };
        };
    };
}