/// version = 0.1
/// title = "nNGM: Sonstige Therapie - FHIR to CTS"


map "http://uk-koeln.de/fhir/StructureMap/SonstigeTherapieCTS" = SonstigeTherapieCTS

uses "http://hl7.org/fhir/StructureDefinition/Bundle" as source
uses "http://hl7.org/fhir/StructureDefinition/CTS_Transport" as target

group TransformCTS(source src: Bundle, target tgt: CTS_Transport)
{
    src -> tgt.version = '1.1';
    src -> tgt.sourcesystem = 'https:\/\/nngm-qat.staging.healex.systems\/';

    src -> tgt.operations as operations collate, operations.crfid = 'SO1';
    src -> tgt.operations as operations collate, operations.type = 'save';

    src.entry as entry then
    {
        //----------------------   Diagnostic Report   --------------------
        entry.resource as diagnosticReport where "resource is DiagnosticReport" then
        {
            //Biopsie-ID
            diagnosticReport -> tgt.operations as operations collate then
            {
                //Untersuchung-ID
                diagnosticReport -> operations.data as data then
                {
                    diagnosticReport.identifier  where "identifier.system = 'http://uk-koeln.de/NamingSystem/nNGM/befundnummer'" then
                    {
                        diagnosticReport.identifier as identifier,identifier.value as value then
                        {   
                            diagnosticReport -> data.blockindex = 1;
                            diagnosticReport -> data.groupindex = 0;
                            diagnosticReport -> data.itemid = 'assessment_id';
                            value -> data.values as values, values.value = value;
                        };
                    };
                };
            };
        };
        //------------------------ Organization ------------------------
        entry.resource as organization where "resource is Organization" then
        {
            //Standort -> 2, 0, id_2435
            organization -> tgt.operations as operations collate then
            {
                organization -> operations.data as data then
                {
                    organization.name as name then
                    {   
                        organization -> data.blockindex = 2;
                        organization -> data.groupindex = 0;
                        organization -> data.itemid = 'id_2435';
                        name -> data.values as values, values.value = name;
                    };
                };                
            };
        };
        //------------------------ Observation ------------------------
        entry.resource as observation where "resource is Observation" then
        {
            //NetzwerkZentrum
            //SOP-Versionsnummer des Standorts -> 2, 0, id_2618
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then 
                    {
                       component.code where "code.coding.code = 'C48443' and %tgt.operations.data.where(itemid = 'id_2486').exists().not()" then
                       {
                            observation ->  data.blockindex = 2;
                            observation ->  data.groupindex = 0;
                            observation ->  data.itemid = 'id_2618';
                            component.valueString as valueString -> data.values as values, values.value = valueString;
                       };
                    };
                };
            };
            //Date of Assessment 3, 0, id_2527
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.effectiveDateTime as effectiveDateTime then
                    {
                        observation ->  data.blockindex = 3;
                        observation ->  data.groupindex = 0;
                        observation ->  data.itemid = 'id_2527';
                        effectiveDateTime -> data.values as values,values.value = effectiveDateTime;
                    };
                };
            };
            //Bezeichnung 3, 0, id_2026
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.code as code, code.text as text then
                    {
                        observation ->  data.blockindex = 3;
                        observation ->  data.groupindex = 0;
                        observation ->  data.itemid = 'id_2026';
                        text -> data.values as values,values.value = text;
                    };
                };
            };
            

        };
    };
}