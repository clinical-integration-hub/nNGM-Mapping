/// version = 0.1
/// title = "nNGM: nNGM_Mapping_MolekularpathologieCTS - FHIR to CTS"

<<<<<<< master
<<<<<<< master
=======
>>>>>>> to fhir fixes, finished to cds
/*
TODO

False Triggers:
IHC status.code
LP status.code
BU status.code

*/

<<<<<<< master
=======
>>>>>>> Fhir to CTS start
=======
>>>>>>> to fhir fixes, finished to cds
map "http://uk-koeln.de/fhir/StructureMap/nNGM_Mapping_MolekularpathologieCTS" = nNGM_Mapping_MolekularpathologieCTS

uses "http://hl7.org/fhir/StructureDefinition/Bundle" as source
uses "http://hl7.org/fhir/StructureDefinition/CTS_Transport" as target

imports "http://uk-koeln.de/fhir/StructureMap/nNGM_Mapping_Molekularpathologie_checkboxesCTS"

group TransformMolekularpathologieOperation(source src: Bundle, target tgt: BackboneElement)
{
    src -> tgt.type = 'save';
<<<<<<< master
    src -> tgt.crfid = 'MP1';
=======
    src -> tgt.crfid = '1_MP1';
>>>>>>> Fhir to CTS start

    src then TransformMolekularpathologieCheckboxes(src, tgt);

    src.entry as entry then
    {
<<<<<<< master

        //------------------------ Specimen ------------------------
        entry.resource as specimen where "resource is Specimen" then
        {
            //Biopsy-ID -> 0, 0, id_1601
            specimen -> tgt.data as data then
            {
                specimen.identifier as identifier then
                {   
                    specimen -> data.blockindex = 0;
                    specimen -> data.groupindex = 0;
                    specimen -> data.itemid = 'id_1601';
                    identifier.value as value-> data.values as values, values.unit = 'count', values.value = value;
                };
            };                
        };

        /*---------------------DiagnosticReport-----------------------*/
        entry.resource as episodeofcare where "resource is DiagnosticReport and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/DiagnosticReport/nNGM/befund'" then
        {
            //Untersuchung-ID
            episodeofcare -> tgt.data as data then
            {
                episodeofcare.identifier as identifier, identifier.value as value then
                {   
                    episodeofcare -> data.blockindex = 8;
                    episodeofcare -> data.groupindex = 0;
                    episodeofcare -> data.itemid = 'assessment_id';
                    value -> data.values as values, values.value = value;
                };
            };
        };

        /* --------------- ServiceRequest ---------------------- */
        entry.resource as serviceRequest where "resource is ServiceRequest and code.coding.code = 'molekularpathologie'" then
<<<<<<< master
        {
            //Durchfuehrung -> 7,0,  id_2520
            serviceRequest -> tgt.data as data then
            {
                serviceRequest.status as status where "$this.status = 'active'" then
                {
                    serviceRequest ->  data.blockindex = 7;
                    serviceRequest ->  data.groupindex = 0;
                    serviceRequest ->  data.itemid = 'id_2520';
                    status -> data.values as values,values.value = 'in Bearbeitung';
                };
                serviceRequest.status as status where "$this.status = 'completed'" then
                {
                    serviceRequest ->  data.blockindex = 7;
                    serviceRequest ->  data.groupindex = 0;
                    serviceRequest ->  data.itemid = 'id_2520';
                    status -> data.values as values,values.value = 'abgeschlossen';
                };
            };

            //Abschluss -> 7,0, id_2462
            serviceRequest -> tgt.data as data then
            {
                serviceRequest.status as status, status.extension as statusAbschluss, statusAbschluss.extension as statusextension then
                {
                    statusextension where "$this.url ='status'" then
                    {
                        serviceRequest ->  data.blockindex = 7;
                        serviceRequest ->  data.groupindex = 0;
                        serviceRequest ->  data.itemid = 'id_2462';
                        statusextension.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code  -> data.values as values,values.value = code;
                    };
                };
            };
        
            //Datum des Abschlusses -> 7,0, id_2521
            serviceRequest -> tgt.data as data then
            {
                serviceRequest.status as status, status.extension as statusAbschluss, statusAbschluss.extension as datumextension then
                {
                    datumextension where "$this.url ='datum'" then
                    {
                        serviceRequest ->  data.blockindex = 7;
                        serviceRequest ->  data.groupindex = 0;
                        serviceRequest ->  data.itemid = 'id_2521';
                        datumextension.valueDate as valueDate -> data.values as values,values.value = valueDate;
                    };
                };
            };
        };
        
        /*---------------ALK CISH OBSERVATION----------------*/
        entry.resource as observation where "resource is Observation and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/ish' and resource.code.coding.code = 'ALK'" then
        {
        
            // Date Of Assesment
            observation -> tgt.data as data then
            {
                observation.effectivePeriod as period then
                {
                    observation-> data.blockindex = 3;
                    observation-> data.groupindex = 0;
                    observation-> data.itemid = 'id_2098';
                    period.start as dateOfAssessment-> data.values as values, values.value = dateOfAssessment;
                };
            };

            // Phaenotyp
            observation -> tgt.data as data then
            {
                observation.component as component then
                {
                    component.code where "code.coding.code = 'C16977'" then
                    {
                        component.valueString as value then 
                        {
                            observation-> data.blockindex = 3;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2099';
                            value -> data.values as values, values.value = value;
                        };
                    };
=======
        /*---------------------EpisodeOfCare-----------------------*/
        entry.resource as episodeofcare where "resource is EpisodeOfCare and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/EpisodeOfCare/nNGM'" then
        {
            //Untersuchung-ID
            episodeofcare -> tgt.data as data then
            {
                episodeofcare.identifier as identifier, identifier.value as value then
                {   
                    episodeofcare -> data.blockindex = 8;
                    episodeofcare -> data.groupindex = 0;
                    episodeofcare -> data.itemid = 'assessment_id';
                    value -> data.values as values, values.value = value;
                };
            };
        };

        /*---------------------ServiceRequest-----------------------*/
        entry.resource as servicerequest where "resource is ServiceRequest and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/ServiceRequest/nNGM/testung'" then
        {
            // Durchfuehrung status.code
            servicerequest -> tgt.data as data then
            {
                servicerequest.status as value where "$this = 'completed'" then
                {   
                    servicerequest -> data.blockindex = 7;
                    servicerequest -> data.groupindex = 0;
                    servicerequest -> data.itemid = 'id_2520';
                    value -> data.values as values, values.value = 'abgeschlossen';
>>>>>>> Fhir to CTS start
                };

<<<<<<< master
            // Kit bezeichnung
            observation -> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueCodeableConcept where "code.coding.code = 'C42793' and %tgt.data.where(itemid = 'id_2108').exists().not()" then
                    {
                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code then  
                        {
                            observation-> data.blockindex = 3;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2108';
                            code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            // Hersteller
            observation -> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueCodeableConcept where "code.coding.code = 'C25392' and %tgt.data.where(itemid = 'id_2109').exists().not()" then
                    {
                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code then  
                        {
                            observation-> data.blockindex = 3;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2109';
                            code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            // Ergebnis
            observation -> tgt.data as data then
                {

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA6576-8'" then 
                    {
                        observation -> data.blockindex = 3;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2112';
                        code -> data.values as values, values.value = 'positiv';
                    };

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA6577-6'" then 
                    {
                        observation -> data.blockindex = 3;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2112';
                        code -> data.values as values, values.value = 'negativ';
                    };

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA18198-4'" then 
                    {
                        observation -> data.blockindex = 3;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2112';
                        code -> data.values as values, values.value = 'nicht auswertbar';
                    };
=======
                servicerequest.status as value where "$this = 'active'" then
                {   
                    servicerequest -> data.blockindex = 7;
                    servicerequest -> data.groupindex = 0;
                    servicerequest -> data.itemid = 'id_2520';
                    value -> data.values as values, values.value = 'in Bearbeitung';
                };
            };

            // Abschluss status.extension:statusAbschluss.extension:status.valueCodeableConcept
            servicerequest -> tgt.data as data then
            {
                servicerequest.status as status, status.extension as statusabschluss, statusabschluss.extension as ext, ext.valueCodeableConcept as vcc, vcc.coding as coding, coding.code as value then
                {   
                    servicerequest -> data.blockindex = 7;
                    servicerequest -> data.groupindex = 0;
                    servicerequest -> data.itemid = 'id_2462';
                    value -> data.values as values, values.value = value;
>>>>>>> Fhir to CTS start
                };

<<<<<<< master
            
            // Positieve Tumorzellen
            observation-> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueQuantity as quantity where "code.coding.code = 'C70460'" then
                    {
                        observation->data.blockindex = 3;
                        observation->data.groupindex = 0;
                        observation->data.itemid = 'id_2113';
                        quantity.value as value->data.values as values, values.unit = 'percent', values.value = value;
                    };
=======
            // Datum des Abschlusses status.extension:statusAbschluss.extension:status.valueCodeableConcept
            servicerequest -> tgt.data as data then
            {
                servicerequest.status as status, status.extension as statusabschluss, statusabschluss.extension as ext, ext.valueDate as value then
                {   
                    servicerequest -> data.blockindex = 7;
                    servicerequest -> data.groupindex = 0;
                    servicerequest -> data.itemid = 'id_2521';
                    value -> data.values as values, values.value = value;
>>>>>>> Fhir to CTS start
                };
            };     
        };
<<<<<<< master

        /*---------------ALK FISH OBSERVATION----------------*/
        entry.resource as observation where "resource is Observation and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/fish' and resource.code.coding.code = 'ALK'" then
        {
        
            // Kit bezeichnung
            observation -> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueCodeableConcept where "code.coding.code = 'C42793' and %tgt.data.where(itemid = 'id_2115').exists().not()" then
                    {
                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code then  
                        {
                            observation-> data.blockindex = 3;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2115';
                            code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            // Hersteller
            observation -> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueCodeableConcept where "code.coding.code = 'C25392' and %tgt.data.where(itemid = 'id_2116').exists().not()" then
                    {
                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code then  
                        {
                            observation-> data.blockindex = 3;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2116';
                            code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            // Ergebnis
            observation -> tgt.data as data then
                {

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA6576-8'" then 
                    {
                        observation -> data.blockindex = 3;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2119';
                        code -> data.values as values, values.value = 'positiv';
                    };

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA6577-6'" then 
                    {
                        observation -> data.blockindex = 3;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2119';
                        code -> data.values as values, values.value = 'negativ';
                    };

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA18198-4'" then 
                    {
                        observation -> data.blockindex = 3;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2119';
                        code -> data.values as values, values.value = 'nicht auswertbar';
                    };
                };

            
            // Positieve Tumorzellen
            observation-> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueQuantity as quantity where "code.coding.code = 'C70460'" then
                    {
                        observation->data.blockindex = 3;
                        observation->data.groupindex = 0;
                        observation->data.itemid = 'id_2120';
                        quantity.value as value->data.values as values, values.unit = 'percent', values.value = value;
                    };
                };
            };

            // Polysomie
            observation-> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueQuantity as quantity where "code.coding.code = 'C36331'" then
                    {
                        observation->data.blockindex = 3;
                        observation->data.groupindex = 0;
                        observation->data.itemid = 'id_2121';
                        quantity.value as value->data.values as values, values.unit = 'percent', values.value = value;
                    };
                };
            };          
        };

        /*---------------MET CISH OBSERVATION----------------*/
        entry.resource as observation where "resource is Observation and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/ish' and resource.code.coding.code = 'MET'" then
        {
        
            // Date Of Assesment
            observation -> tgt.data as data then
            {
                observation.effectivePeriod as period then
                {
                    observation-> data.blockindex = 4;
                    observation-> data.groupindex = 0;
                    observation-> data.itemid = 'id_2132';
                    period.start as dateOfAssessment-> data.values as values, values.value = dateOfAssessment;
                };
            };

            // Kit bezeichnung
            observation -> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueCodeableConcept where "code.coding.code = 'C42793' and %tgt.data.where(itemid = 'id_2143').exists().not()" then
                    {
                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code then  
                        {
                            observation-> data.blockindex = 4;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2143';
                            code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            // Hersteller
            observation -> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueCodeableConcept where "code.coding.code = 'C25392' and %tgt.data.where(itemid = 'id_2144').exists().not()" then
                    {
                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code then  
                        {
                            observation-> data.blockindex = 4;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2144';
                            code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            // Ergebnis
            observation -> tgt.data as data then
            {

                observation.valueCodeableConcept as valueCodeableConcept,
                valueCodeableConcept.coding as coding,
                coding.code as code where "code = 'LA6576-8'" then 
                {
                    observation -> data.blockindex = 4;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_2147';
                    code -> data.values as values, values.value = 'positiv';
                };

                observation.valueCodeableConcept as valueCodeableConcept,
                valueCodeableConcept.coding as coding,
                coding.code as code where "code = 'LA6577-6'" then 
                {
                    observation -> data.blockindex = 4;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_2147';
                    code -> data.values as values, values.value = 'negativ';
                };

                observation.valueCodeableConcept as valueCodeableConcept,
                valueCodeableConcept.coding as coding,
                coding.code as code where "code = 'LA18198-4'" then 
                {
                    observation -> data.blockindex = 4;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_2147';
                    code -> data.values as values, values.value = 'nicht auswertbar';
                };
            };

            // Amplifikation
            observation -> tgt.data as data then 
            {
                observation.component as component then
                {
                    component.valueCodeableConcept where "code.coding.code = 'amplification-level' and %tgt.data.where(itemid = 'id_2148').exists().not()" then
                    {
                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code where "code = 'LA9193-9'" then  
                        {
                            observation-> data.blockindex = 4;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2148';
                            code -> data.values as values, values.value = 'Amplifikation high-level';
                        };

                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code where "code = 'LA8982-6'" then  
                        {
                            observation-> data.blockindex = 4;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2148';
                            code -> data.values as values, values.value = 'Amplifikation moderate-level';
                        };

                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code where "code = 'LA32-8'" then  
                        {
                            observation-> data.blockindex = 4;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2148';
                            code -> data.values as values, values.value = 'keine Amplifikation';
                        };
                    };
                };
            };
        };

        /*---------------MET FISH OBSERVATION----------------*/
        entry.resource as observation where "resource is Observation and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/fish' and resource.code.coding.code = 'MET'" then
        {
        
            // Kit bezeichnung
            observation -> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueCodeableConcept where "code.coding.code = 'C42793' and %tgt.data.where(itemid = 'id_2150').exists().not()" then
                    {
                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code then  
                        {
                            observation-> data.blockindex = 4;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2150';
                            code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            // Hersteller
            observation -> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueCodeableConcept where "code.coding.code = 'C25392' and %tgt.data.where(itemid = 'id_2151').exists().not()" then
                    {
                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code then  
                        {
                            observation-> data.blockindex = 4;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2151';
                            code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            // Ergebnis
            observation -> tgt.data as data then
                {

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA6576-8'" then 
                    {
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2154';
                        code -> data.values as values, values.value = 'positiv';
                    };

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA6577-6'" then 
                    {
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2154';
                        code -> data.values as values, values.value = 'negativ';
                    };

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA18198-4'" then 
                    {
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2154';
                        code -> data.values as values, values.value = 'nicht auswertbar';
                    };
                };

            // Amplifikation
            observation -> tgt.data as data then 
            {
                observation.component as component then
                {
                    component.valueCodeableConcept where "code.coding.code = 'amplification-level' and %tgt.data.where(itemid = 'id_2155').exists().not()" then
                    {
                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code where "code = 'LA9193-9'" then  
                        {
                            observation-> data.blockindex = 4;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2155';
                            code -> data.values as values, values.value = 'Amplifikation high-level';
                        };

                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code where "code = 'LA8982-6'" then  
                        {
                            observation-> data.blockindex = 4;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2155';
                            code -> data.values as values, values.value = 'Amplifikation moderate-level';
                        };

                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code where "code = 'LA32-8'" then  
                        {
                            observation-> data.blockindex = 4;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2155';
                            code -> data.values as values, values.value = 'keine Amplifikation';
                        };
                    };
                };
            };

            // Prozentzahl an Zellen mit mehr als 15 MET-Signalen pro Zelle (Positiv ≥ 10 %) bei einer high-level Amplifikation
            observation-> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueQuantity as quantity where "code.coding.code = '15-met-ratio'" then
                    {
                        observation->data.blockindex = 4;
                        observation->data.groupindex = 0;
                        observation->data.itemid = 'id_2156';
                        quantity.value as value->data.values as values, values.unit = 'percent', values.value = value;
=======

        /*---------------MET FISH OBSERVATION----------------*/
        entry.resource as observation where "resource is Observation 
                                            and resource.code.coding.code = 'MET' 
                                            and resource.category.coding.where(system = \'http://uk-koeln.de/fhir/ValueSet/obs-methods\').code = 'FISH'" then
        {
            //Date Of Assesment
            observation -> tgt.data as data then
            {
                observation.effectivePeriod as period then
                {   
                    observation -> data.blockindex = 4;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_2132';
                    period.start as dateOfAssessment -> data.values as values, values.value = dateOfAssessment;
                };
            };

            //Ergebnis
            observation -> tgt.data as data then
            {
                observation.valueCodeableConcept as cc, cc.coding as coding then
                {
                    observation -> data.blockindex = 4;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_2154';
                    coding.code as code -> data.values as values, values.value = code;
                };
            };

            //Amplifikation
            observation -> tgt.data as data then
            {
                observation.component as component then
                {   
                    component.valueCodeableConcept as cc where "code.coding.code = 'amplification-level' and code.coding.system = 'http://uk-koeln.de/fhir/CodeSystem/tbd-codes'" then
                    {
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2155';
                        cc.coding as coding, coding.code as code -> data.values as values, values.value = code;
>>>>>>> Fhir to CTS start
                    };
                };
            };

<<<<<<< master
            // Prozentzahl an Zellen mit mehr als 5 MET-Signalen pro Zelle (Positiv ≥ 50 %) bei einer low-level Amplifikation:
            observation-> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueQuantity as quantity where "code.coding.code = '5-met-ratio'" then
                    {
                        observation->data.blockindex = 4;
                        observation->data.groupindex = 0;
                        observation->data.itemid = 'id_2157';
                        quantity.value as value->data.values as values, values.unit = 'percent', values.value = value;
                    };
                };
            };

            // Prozentzahl an Zellen mit mehr als 4 MET-Signalen pro Zelle (Positiv ≥ 40 %) bei einer low-level Amplifikation:
            observation-> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueQuantity as quantity where "code.coding.code = '4-met-ratio'" then
                    {
                        observation->data.blockindex = 4;
                        observation->data.groupindex = 0;
                        observation->data.itemid = 'id_2158';
                        quantity.value as value->data.values as values, values.unit = 'percent', values.value = value;
                    };
                };
            };

            // Gezählte Tumorzellen:
            observation-> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueInteger as integer where "code.coding.code = 'C0007584'" then
                    {
                        observation->data.blockindex = 4;
                        observation->data.groupindex = 0;
                        observation->data.itemid = 'id_2159';
                        integer -> data.values as values, values.unit = 'count', values.value = integer;
                    };
                };
            };
            

            // MET Signale
            observation-> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueInteger as integer where "code.coding.code = 'met-signal-count'" then
                    {
                        observation->data.blockindex = 4;
                        observation->data.groupindex = 0;
                        observation->data.itemid = 'id_2160';
                        integer -> data.values as values, values.unit = 'count',  values.value = integer;
                    };
                };
            };

            // CEN signale
            observation-> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueInteger as integer where "code.coding.code = 'cet-signal-count'" then
                    {
                        observation->data.blockindex = 4;
                        observation->data.groupindex = 0;
                        observation->data.itemid = 'id_2161';
                        integer -> data.values as values, values.unit = 'count',  values.value = integer;
                    };
                };
            };
            

            // Quotient MET/CEN7 Signale
            observation-> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueInteger as integer where "code.coding.code = 'met-cen-signal-count'" then
                    {
                        observation->data.blockindex = 4;
                        observation->data.groupindex = 0;
                        observation->data.itemid = 'id_2162';
                        integer -> data.values as values, values.unit = 'count',  values.value = integer;
                    };
                };
            };
            

            // Durchschnitt MET-Genkopiezahl/Zelle (Positiv ≥ 6)
            observation-> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueInteger as integer where "code.coding.code = 'met-copy-per-cell'" then
                    {
                        observation->data.blockindex = 4;
                        observation->data.groupindex = 0;
                        observation->data.itemid = 'id_2163';
                        integer -> data.values as values, values.unit = 'count', values.value = integer;
                    };
                };
            };
            

            // Polysomie
            observation-> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueQuantity as quantity where "code.coding.code = 'C36331'" then
                    {
                        observation->data.blockindex = 4;
                        observation->data.groupindex = 0;
                        observation->data.itemid = 'id_2164';
                        quantity.value as value->data.values as values, values.unit = 'percent', values.value = value;
                    };
                };
            };
        };
            
        /*---------------RET CISH OBSERVATION----------------*/
        entry.resource as observation where "resource is Observation and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/ish' and resource.code.coding.code = 'RET'" then
        {
        
            // Date Of Assesment
            observation -> tgt.data as data then
            {
                observation.effectivePeriod as period then
                {
                    observation-> data.blockindex = 5;
                    observation-> data.groupindex = 0;
                    observation-> data.itemid = 'id_2183';
                    period.start as dateOfAssessment-> data.values as values, values.value = dateOfAssessment;
                };
            };

            // Phaenotyp
            observation -> tgt.data as data then
            {
                observation.component as component then
                {
                    component.code where "code.coding.code = 'C16977'" then
                    {
                        component.valueString as value then 
                        {
                            observation-> data.blockindex = 5;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2184';
                            value -> data.values as values, values.value = value;
                        };
                    };
                };
            };

            // Kit bezeichnung
            observation -> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueCodeableConcept where "code.coding.code = 'C42793' and %tgt.data.where(itemid = 'id_2187').exists().not()" then
                    {
                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code then  
                        {
                            observation-> data.blockindex = 5;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2187';
                            code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

<<<<<<< master
            // Hersteller
            observation -> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueCodeableConcept where "code.coding.code = 'C25392' and %tgt.data.where(itemid = 'id_2188').exists().not()" then
                    {
                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code then  
                        {
                            observation-> data.blockindex = 5;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2188';
                            code -> data.values as values, values.value = code;
                        };
                    };
                };
            };
=======
group TransformMolekularpathologieOperation(source src: Bundle, target tgt: BackboneElement)
{
    src -> tgt.type = 'save';
    src -> tgt.crfid = 'MP1';
>>>>>>> to fhir fixes, finished to cds

            // Ergebnis
            observation -> tgt.data as data then
                {

<<<<<<< master
                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA6576-8'" then 
                    {
                        observation -> data.blockindex = 5;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2191';
                        code -> data.values as values, values.value = 'positiv';
                    };

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA6577-6'" then 
                    {
                        observation -> data.blockindex = 5;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2191';
                        code -> data.values as values, values.value = 'negativ';
                    };

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA18198-4'" then 
                    {
                        observation -> data.blockindex = 5;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2191';
                        code -> data.values as values, values.value = 'nicht auswertbar';
                    };
                };

            
            // Positieve Tumorzellen
            observation-> tgt.data as data then
=======
    src.entry as entry then
    {

        //------------------------ Specimen ------------------------
        entry.resource as specimen where "resource is Specimen" then
        {
            //Biopsy-ID -> 0, 0, id_1601
            specimen -> tgt.data as data then
            {
                specimen.identifier as identifier then
                {   
                    specimen -> data.blockindex = 0;
                    specimen -> data.groupindex = 0;
                    specimen -> data.itemid = 'id_1601';
                    identifier.value as value-> data.values as values, values.unit = 'count', values.value = value;
                };
            };                
        };

        /*---------------------DiagnosticReport-----------------------*/
        entry.resource as episodeofcare where "resource is DiagnosticReport and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/DiagnosticReport/nNGM/befund'" then
        {
            //Untersuchung-ID
            episodeofcare -> tgt.data as data then
>>>>>>> to fhir fixes, finished to cds
            {
                observation.component as component then
                {
                    component.valueQuantity as quantity where "code.coding.code = 'C70460'" then
                    {
                        observation->data.blockindex = 5;
                        observation->data.groupindex = 0;
                        observation->data.itemid = 'id_2192';
                        quantity.value as value->data.values as values, values.unit = 'percent', values.value = value;
                    };
                };
            };     
        };

<<<<<<< master
        /*---------------RET FISH OBSERVATION----------------*/
        entry.resource as observation where "resource is Observation and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/fish' and resource.code.coding.code = 'RET'" then
        {
        
            // Kit bezeichnung
            observation -> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueCodeableConcept where "code.coding.code = 'C42793' and %tgt.data.where(itemid = 'id_2194').exists().not()" then
                    {
                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code then  
                        {
                            observation-> data.blockindex = 5;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2194';
                            code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            // Hersteller
            observation -> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueCodeableConcept where "code.coding.code = 'C25392' and %tgt.data.where(itemid = 'id_2195').exists().not()" then
                    {
                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code then  
                        {
                            observation-> data.blockindex = 5;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2195';
                            code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            // Ergebnis
            observation -> tgt.data as data then
                {

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA6576-8'" then 
                    {
                        observation -> data.blockindex = 5;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2198';
                        code -> data.values as values, values.value = 'positiv';
                    };

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA6577-6'" then 
                    {
                        observation -> data.blockindex = 5;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2198';
                        code -> data.values as values, values.value = 'negativ';
                    };

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA18198-4'" then 
                    {
                        observation -> data.blockindex = 5;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2198';
                        code -> data.values as values, values.value = 'nicht auswertbar';
                    };
                };

            
            // Positieve Tumorzellen
            observation-> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueQuantity as quantity where "code.coding.code = 'C70460'" then
                    {
                        observation->data.blockindex = 5;
                        observation->data.groupindex = 0;
                        observation->data.itemid = 'id_2199';
                        quantity.value as value->data.values as values, values.unit = 'percent', values.value = value;
=======
        /* --------------- ServiceRequest ---------------------- */
        entry.resource as serviceRequest where "resource is ServiceRequest" then
=======
>>>>>>> servicerequest code check
        {
            //Durchfuehrung -> 7,0,  id_2520
            serviceRequest -> tgt.data as data then
            {
                serviceRequest.status as status where "$this.status = 'active'" then
                {
                    serviceRequest ->  data.blockindex = 7;
                    serviceRequest ->  data.groupindex = 0;
                    serviceRequest ->  data.itemid = 'id_2520';
                    status -> data.values as values,values.value = 'in Bearbeitung';
                };
                serviceRequest.status as status where "$this.status = 'completed'" then
                {
                    serviceRequest ->  data.blockindex = 7;
                    serviceRequest ->  data.groupindex = 0;
                    serviceRequest ->  data.itemid = 'id_2520';
                    status -> data.values as values,values.value = 'abgeschlossen';
                };
            };

            //Abschluss -> 7,0, id_2462
            serviceRequest -> tgt.data as data then
            {
                serviceRequest.status as status, status.extension as statusAbschluss, statusAbschluss.extension as statusextension then
                {
                    statusextension where "$this.url ='status'" then
                    {
                        serviceRequest ->  data.blockindex = 7;
                        serviceRequest ->  data.groupindex = 0;
                        serviceRequest ->  data.itemid = 'id_2462';
                        statusextension.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code  -> data.values as values,values.value = code;
                    };
                };
            };
        
            //Datum des Abschlusses -> 7,0, id_2521
            serviceRequest -> tgt.data as data then
            {
                serviceRequest.status as status, status.extension as statusAbschluss, statusAbschluss.extension as datumextension then
                {
                    datumextension where "$this.url ='datum'" then
                    {
                        serviceRequest ->  data.blockindex = 7;
                        serviceRequest ->  data.groupindex = 0;
                        serviceRequest ->  data.itemid = 'id_2521';
                        datumextension.valueDate as valueDate -> data.values as values,values.value = valueDate;
                    };
                };
            };
        };
        
        /*---------------ALK CISH OBSERVATION----------------*/
        entry.resource as observation where "resource is Observation and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/ish' and resource.code.coding.code = 'ALK'" then
        {
        
            // Date Of Assesment
            observation -> tgt.data as data then
            {
                observation.effectivePeriod as period then
                {
                    observation-> data.blockindex = 3;
                    observation-> data.groupindex = 0;
                    observation-> data.itemid = 'id_2098';
                    period.start as dateOfAssessment-> data.values as values, values.value = dateOfAssessment;
                };
            };

            // Phaenotyp
            observation -> tgt.data as data then
            {
                observation.component as component then
                {
                    component.code where "code.coding.code = 'C16977'" then
                    {
                        component.valueString as value then 
                        {
                            observation-> data.blockindex = 3;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2099';
                            value -> data.values as values, values.value = value;
                        };
>>>>>>> to fhir fixes, finished to cds
                    };
                };
            };

<<<<<<< master
            // Polysomie
            observation-> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueQuantity as quantity where "code.coding.code = 'C36331'" then
                    {
                        observation->data.blockindex = 5;
                        observation->data.groupindex = 0;
                        observation->data.itemid = 'id_2200';
                        quantity.value as value->data.values as values, values.unit = 'percent', values.value = value;
                    };
                };
            };          
        };


         /*---------------ROS1 CISH OBSERVATION----------------*/
        entry.resource as observation where "resource is Observation and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/ish' and resource.code.coding.code = 'ROS1'" then
        {
        
=======
            // Kit bezeichnung
            observation -> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueCodeableConcept where "code.coding.code = 'C42793' and %tgt.data.where(itemid = 'id_2108').exists().not()" then
                    {
                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code then  
                        {
                            observation-> data.blockindex = 3;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2108';
                            code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            // Hersteller
            observation -> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueCodeableConcept where "code.coding.code = 'C25392' and %tgt.data.where(itemid = 'id_2109').exists().not()" then
                    {
                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code then  
                        {
                            observation-> data.blockindex = 3;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2109';
                            code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            // Ergebnis
            observation -> tgt.data as data then
                {

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA6576-8'" then 
                    {
                        observation -> data.blockindex = 3;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2112';
                        code -> data.values as values, values.value = 'positiv';
                    };

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA6577-6'" then 
                    {
                        observation -> data.blockindex = 3;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2112';
                        code -> data.values as values, values.value = 'negativ';
                    };

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA18198-4'" then 
                    {
                        observation -> data.blockindex = 3;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2112';
                        code -> data.values as values, values.value = 'nicht auswertbar';
                    };
                };

            
            // Positieve Tumorzellen
            observation-> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueQuantity as quantity where "code.coding.code = 'C70460'" then
                    {
                        observation->data.blockindex = 3;
                        observation->data.groupindex = 0;
                        observation->data.itemid = 'id_2113';
                        quantity.value as value->data.values as values, values.unit = 'percent', values.value = value;
                    };
                };
            };     
        };

        /*---------------ALK FISH OBSERVATION----------------*/
        entry.resource as observation where "resource is Observation and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/fish' and resource.code.coding.code = 'ALK'" then
        {
        
            // Kit bezeichnung
            observation -> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueCodeableConcept where "code.coding.code = 'C42793' and %tgt.data.where(itemid = 'id_2115').exists().not()" then
                    {
                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code then  
                        {
                            observation-> data.blockindex = 3;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2115';
                            code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            // Hersteller
            observation -> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueCodeableConcept where "code.coding.code = 'C25392' and %tgt.data.where(itemid = 'id_2116').exists().not()" then
                    {
                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code then  
                        {
                            observation-> data.blockindex = 3;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2116';
                            code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            // Ergebnis
            observation -> tgt.data as data then
                {

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA6576-8'" then 
                    {
                        observation -> data.blockindex = 3;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2119';
                        code -> data.values as values, values.value = 'positiv';
                    };

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA6577-6'" then 
                    {
                        observation -> data.blockindex = 3;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2119';
                        code -> data.values as values, values.value = 'negativ';
                    };

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA18198-4'" then 
                    {
                        observation -> data.blockindex = 3;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2119';
                        code -> data.values as values, values.value = 'nicht auswertbar';
                    };
                };

            
            // Positieve Tumorzellen
            observation-> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueQuantity as quantity where "code.coding.code = 'C70460'" then
                    {
                        observation->data.blockindex = 3;
                        observation->data.groupindex = 0;
                        observation->data.itemid = 'id_2120';
                        quantity.value as value->data.values as values, values.unit = 'percent', values.value = value;
                    };
                };
            };

            // Polysomie
            observation-> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueQuantity as quantity where "code.coding.code = 'C36331'" then
                    {
                        observation->data.blockindex = 3;
                        observation->data.groupindex = 0;
                        observation->data.itemid = 'id_2121';
                        quantity.value as value->data.values as values, values.unit = 'percent', values.value = value;
                    };
                };
            };          
        };

        /*---------------MET CISH OBSERVATION----------------*/
        entry.resource as observation where "resource is Observation and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/ish' and resource.code.coding.code = 'MET'" then
        {
        
>>>>>>> to fhir fixes, finished to cds
            // Date Of Assesment
            observation -> tgt.data as data then
            {
                observation.effectivePeriod as period then
                {
<<<<<<< master
                    observation-> data.blockindex = 6;
                    observation-> data.groupindex = 0;
                    observation-> data.itemid = 'id_2211';
=======
                    observation-> data.blockindex = 4;
                    observation-> data.groupindex = 0;
                    observation-> data.itemid = 'id_2132';
>>>>>>> to fhir fixes, finished to cds
                    period.start as dateOfAssessment-> data.values as values, values.value = dateOfAssessment;
                };
            };

<<<<<<< master
            // Phaenotyp
            observation -> tgt.data as data then
            {
                observation.component as component then
                {
                    component.code where "code.coding.code = 'C16977'" then
                    {
                        component.valueString as value then 
                        {
                            observation-> data.blockindex = 6;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2212';
                            value -> data.values as values, values.value = value;
=======
            // Kit bezeichnung
            observation -> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueCodeableConcept where "code.coding.code = 'C42793' and %tgt.data.where(itemid = 'id_2143').exists().not()" then
                    {
                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code then  
                        {
                            observation-> data.blockindex = 4;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2143';
                            code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            // Hersteller
            observation -> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueCodeableConcept where "code.coding.code = 'C25392' and %tgt.data.where(itemid = 'id_2144').exists().not()" then
                    {
                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code then  
                        {
                            observation-> data.blockindex = 4;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2144';
                            code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            // Ergebnis
            observation -> tgt.data as data then
            {

                observation.valueCodeableConcept as valueCodeableConcept,
                valueCodeableConcept.coding as coding,
                coding.code as code where "code = 'LA6576-8'" then 
                {
                    observation -> data.blockindex = 4;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_2147';
                    code -> data.values as values, values.value = 'positiv';
                };

                observation.valueCodeableConcept as valueCodeableConcept,
                valueCodeableConcept.coding as coding,
                coding.code as code where "code = 'LA6577-6'" then 
                {
                    observation -> data.blockindex = 4;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_2147';
                    code -> data.values as values, values.value = 'negativ';
                };

                observation.valueCodeableConcept as valueCodeableConcept,
                valueCodeableConcept.coding as coding,
                coding.code as code where "code = 'LA18198-4'" then 
                {
                    observation -> data.blockindex = 4;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_2147';
                    code -> data.values as values, values.value = 'nicht auswertbar';
                };
            };

            // Amplifikation
            observation -> tgt.data as data then 
            {
                observation.component as component then
                {
                    component.valueCodeableConcept where "code.coding.code = 'amplification-level' and %tgt.data.where(itemid = 'id_2148').exists().not()" then
                    {
                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code where "code = 'LA9193-9'" then  
                        {
                            observation-> data.blockindex = 4;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2148';
                            code -> data.values as values, values.value = 'Amplifikation high-level';
                        };

                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code where "code = 'LA8982-6'" then  
                        {
                            observation-> data.blockindex = 4;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2148';
                            code -> data.values as values, values.value = 'Amplifikation moderate-level';
                        };

                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code where "code = 'LA32-8'" then  
                        {
                            observation-> data.blockindex = 4;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2148';
                            code -> data.values as values, values.value = 'keine Amplifikation';
>>>>>>> to fhir fixes, finished to cds
                        };
                    };
                };
            };
        };

<<<<<<< master
=======
        /*---------------MET FISH OBSERVATION----------------*/
        entry.resource as observation where "resource is Observation and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/fish' and resource.code.coding.code = 'MET'" then
        {
        
>>>>>>> to fhir fixes, finished to cds
            // Kit bezeichnung
            observation -> tgt.data as data then
            {
                observation.component as component then
                {
<<<<<<< master
                    component.valueCodeableConcept where "code.coding.code = 'C42793' and %tgt.data.where(itemid = 'id_2221').exists().not()" then
=======
                    component.valueCodeableConcept where "code.coding.code = 'C42793' and %tgt.data.where(itemid = 'id_2150').exists().not()" then
>>>>>>> to fhir fixes, finished to cds
                    {
                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code then  
                        {
<<<<<<< master
                            observation-> data.blockindex = 6;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2221';
=======
                            observation-> data.blockindex = 4;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2150';
>>>>>>> to fhir fixes, finished to cds
                            code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            // Hersteller
<<<<<<< master
            observation -> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueCodeableConcept where "code.coding.code = 'C25392' and %tgt.data.where(itemid = 'id_2222').exists().not()" then
                    {
                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code then  
                        {
                            observation-> data.blockindex = 6;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2222';
                            code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            // Ergebnis
            observation -> tgt.data as data then
                {

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA6576-8'" then 
                    {
                        observation -> data.blockindex = 6;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2225';
                        code -> data.values as values, values.value = 'positiv';
                    };

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA6577-6'" then 
                    {
                        observation -> data.blockindex = 6;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2225';
                        code -> data.values as values, values.value = 'negativ';
                    };

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA18198-4'" then 
=======
            //gezaehlte Tumorzellen
=======
>>>>>>> to fhir fixes, finished to cds
            observation -> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueCodeableConcept where "code.coding.code = 'C25392' and %tgt.data.where(itemid = 'id_2151').exists().not()" then
                    {
                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code then  
                        {
                            observation-> data.blockindex = 4;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2151';
                            code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            // Ergebnis
            observation -> tgt.data as data then
                {

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA6576-8'" then 
                    {
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2154';
                        code -> data.values as values, values.value = 'positiv';
                    };

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA6577-6'" then 
                    {
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2154';
                        code -> data.values as values, values.value = 'negativ';
                    };

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA18198-4'" then 
                    {
                        observation -> data.blockindex = 4;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2154';
                        code -> data.values as values, values.value = 'nicht auswertbar';
                    };
                };

            // Amplifikation
            observation -> tgt.data as data then 
            {
                observation.component as component then
                {
                    component.valueCodeableConcept where "code.coding.code = 'amplification-level' and %tgt.data.where(itemid = 'id_2155').exists().not()" then
                    {
                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code where "code = 'LA9193-9'" then  
                        {
                            observation-> data.blockindex = 4;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2155';
                            code -> data.values as values, values.value = 'Amplifikation high-level';
                        };

                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code where "code = 'LA8982-6'" then  
                        {
                            observation-> data.blockindex = 4;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2155';
                            code -> data.values as values, values.value = 'Amplifikation moderate-level';
                        };

                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code where "code = 'LA32-8'" then  
                        {
                            observation-> data.blockindex = 4;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2155';
                            code -> data.values as values, values.value = 'keine Amplifikation';
                        };
                    };
                };
            };

            // Prozentzahl an Zellen mit mehr als 15 MET-Signalen pro Zelle (Positiv ≥ 10 %) bei einer high-level Amplifikation
            observation-> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueQuantity as quantity where "code.coding.code = '15-met-ratio'" then
                    {
                        observation->data.blockindex = 4;
                        observation->data.groupindex = 0;
                        observation->data.itemid = 'id_2156';
                        quantity.value as value->data.values as values, values.unit = 'percent', values.value = value;
                    };
                };
            };

            // Prozentzahl an Zellen mit mehr als 5 MET-Signalen pro Zelle (Positiv ≥ 50 %) bei einer low-level Amplifikation:
            observation-> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueQuantity as quantity where "code.coding.code = '5-met-ratio'" then
                    {
                        observation->data.blockindex = 4;
                        observation->data.groupindex = 0;
                        observation->data.itemid = 'id_2157';
                        quantity.value as value->data.values as values, values.unit = 'percent', values.value = value;
                    };
                };
            };

            // Prozentzahl an Zellen mit mehr als 4 MET-Signalen pro Zelle (Positiv ≥ 40 %) bei einer low-level Amplifikation:
            observation-> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueQuantity as quantity where "code.coding.code = '4-met-ratio'" then
                    {
                        observation->data.blockindex = 4;
                        observation->data.groupindex = 0;
                        observation->data.itemid = 'id_2158';
                        quantity.value as value->data.values as values, values.unit = 'percent', values.value = value;
                    };
                };
            };

            // Gezählte Tumorzellen:
            observation-> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueInteger as integer where "code.coding.code = 'C0007584'" then
                    {
                        observation->data.blockindex = 4;
                        observation->data.groupindex = 0;
                        observation->data.itemid = 'id_2159';
                        integer -> data.values as values, values.unit = 'count', values.value = integer;
                    };
                };
            };
            

            // MET Signale
            observation-> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueInteger as integer where "code.coding.code = 'met-signal-count'" then
                    {
                        observation->data.blockindex = 4;
                        observation->data.groupindex = 0;
                        observation->data.itemid = 'id_2160';
                        integer -> data.values as values, values.unit = 'count',  values.value = integer;
                    };
                };
            };

            // CEN signale
            observation-> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueInteger as integer where "code.coding.code = 'cet-signal-count'" then
                    {
                        observation->data.blockindex = 4;
                        observation->data.groupindex = 0;
                        observation->data.itemid = 'id_2161';
                        integer -> data.values as values, values.unit = 'count',  values.value = integer;
                    };
                };
            };
            

            // Quotient MET/CEN7 Signale
            observation-> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueInteger as integer where "code.coding.code = 'met-cen-signal-count'" then
                    {
                        observation->data.blockindex = 4;
                        observation->data.groupindex = 0;
                        observation->data.itemid = 'id_2162';
                        integer -> data.values as values, values.unit = 'count',  values.value = integer;
                    };
                };
            };
            

            // Durchschnitt MET-Genkopiezahl/Zelle (Positiv ≥ 6)
            observation-> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueInteger as integer where "code.coding.code = 'met-copy-per-cell'" then
                    {
                        observation->data.blockindex = 4;
                        observation->data.groupindex = 0;
                        observation->data.itemid = 'id_2163';
                        integer -> data.values as values, values.unit = 'count', values.value = integer;
                    };
                };
            };
            

            // Polysomie
            observation-> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueQuantity as quantity where "code.coding.code = 'C36331'" then
                    {
                        observation->data.blockindex = 4;
                        observation->data.groupindex = 0;
                        observation->data.itemid = 'id_2164';
                        quantity.value as value->data.values as values, values.unit = 'percent', values.value = value;
                    };
                };
            };
        };
            
        /*---------------RET CISH OBSERVATION----------------*/
        entry.resource as observation where "resource is Observation and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/ish' and resource.code.coding.code = 'RET'" then
        {
        
            // Date Of Assesment
            observation -> tgt.data as data then
            {
                observation.effectivePeriod as period then
                {
                    observation-> data.blockindex = 5;
                    observation-> data.groupindex = 0;
                    observation-> data.itemid = 'id_2183';
                    period.start as dateOfAssessment-> data.values as values, values.value = dateOfAssessment;
                };
            };

            // Phaenotyp
            observation -> tgt.data as data then
            {
                observation.component as component then
                {
                    component.code where "code.coding.code = 'C16977'" then
                    {
                        component.valueString as value then 
                        {
                            observation-> data.blockindex = 5;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2184';
                            value -> data.values as values, values.value = value;
                        };
                    };
                };
            };

            // Kit bezeichnung
            observation -> tgt.data as data then
            {
                observation.component as component then
<<<<<<< master
                {   
                    component.valueQuantity as quantity where "code.coding.code = 'C70460' and code.coding.system = 'http://ncit.nci.nih.gov'" then
>>>>>>> Fhir to CTS start
=======
                {
                    component.valueCodeableConcept where "code.coding.code = 'C42793' and %tgt.data.where(itemid = 'id_2187').exists().not()" then
                    {
                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code then  
                        {
                            observation-> data.blockindex = 5;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2187';
                            code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            // Hersteller
            observation -> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueCodeableConcept where "code.coding.code = 'C25392' and %tgt.data.where(itemid = 'id_2188').exists().not()" then
                    {
                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code then  
                        {
                            observation-> data.blockindex = 5;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2188';
                            code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            // Ergebnis
            observation -> tgt.data as data then
                {

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA6576-8'" then 
                    {
                        observation -> data.blockindex = 5;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2191';
                        code -> data.values as values, values.value = 'positiv';
                    };

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA6577-6'" then 
>>>>>>> to fhir fixes, finished to cds
                    {
                        observation -> data.blockindex = 6;
                        observation -> data.groupindex = 0;
<<<<<<< master
<<<<<<< master
                        observation -> data.itemid = 'id_2225';
                        code -> data.values as values, values.value = 'nicht auswertbar';
                    };
                };

            
            // Positieve Tumorzellen
            observation-> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueQuantity as quantity where "code.coding.code = 'C70460'" then
                    {
                        observation->data.blockindex = 6;
                        observation->data.groupindex = 0;
                        observation->data.itemid = 'id_2226';
                        quantity.value as value->data.values as values, values.unit = 'percent', values.value = value;
                    };
                };
            };  

            // Polysomie
            observation-> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueQuantity as quantity where "code.coding.code = 'C36331'" then
                    {
                        observation->data.blockindex = 6;
                        observation->data.groupindex = 0;
                        observation->data.itemid = 'id_2227';
                        quantity.value as value->data.values as values, values.unit = 'percent', values.value = value;
                    };
=======
                        observation -> data.itemid = 'id_2199';
                        quantity.value as value -> data.values as values, values.unit = 'percent', values.value = value;
=======
                        observation -> data.itemid = 'id_2191';
                        code -> data.values as values, values.value = 'negativ';
                    };

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA18198-4'" then 
                    {
                        observation -> data.blockindex = 5;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2191';
                        code -> data.values as values, values.value = 'nicht auswertbar';
>>>>>>> to fhir fixes, finished to cds
                    };
                };

            
            // Positieve Tumorzellen
            observation-> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueQuantity as quantity where "code.coding.code = 'C70460'" then
                    {
                        observation->data.blockindex = 5;
                        observation->data.groupindex = 0;
                        observation->data.itemid = 'id_2192';
                        quantity.value as value->data.values as values, values.unit = 'percent', values.value = value;
                    };
                };
            };     
        };

        /*---------------RET FISH OBSERVATION----------------*/
        entry.resource as observation where "resource is Observation and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/fish' and resource.code.coding.code = 'RET'" then
        {
        
            // Kit bezeichnung
            observation -> tgt.data as data then
            {
                observation.component as component then
                {
<<<<<<< master
                    observation -> data.blockindex = 7;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_2520';
                    observation -> data.values as values, values.value = 'abgeschlossen';
>>>>>>> Fhir to CTS start
=======
                    component.valueCodeableConcept where "code.coding.code = 'C42793' and %tgt.data.where(itemid = 'id_2194').exists().not()" then
                    {
                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code then  
                        {
                            observation-> data.blockindex = 5;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2194';
                            code -> data.values as values, values.value = code;
                        };
                    };
>>>>>>> to fhir fixes, finished to cds
                };
            };          
        };   

<<<<<<< master
<<<<<<< master
        /*---------------ROS1 FISH OBSERVATION----------------*/
        entry.resource as observation where "resource is Observation and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/fish' and resource.code.coding.code = 'ROS1'" then
        {
        
            // Kit bezeichnung
            observation -> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueCodeableConcept where "code.coding.code = 'C42793' and %tgt.data.where(itemid = 'id_2229').exists().not()" then
                    {
                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code then  
                        {
                            observation-> data.blockindex = 6;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2229';
                            code -> data.values as values, values.value = code;
                        };
=======
            //Abschluss
=======
            // Hersteller
>>>>>>> to fhir fixes, finished to cds
            observation -> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueCodeableConcept where "code.coding.code = 'C25392' and %tgt.data.where(itemid = 'id_2195').exists().not()" then
                    {
<<<<<<< master
                        extension.valueCodeableConcept as cc, cc.coding as coding, coding.code as code -> data.values as values, values.value = code;
>>>>>>> Fhir to CTS start
=======
                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code then  
                        {
                            observation-> data.blockindex = 5;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2195';
                            code -> data.values as values, values.value = code;
                        };
>>>>>>> to fhir fixes, finished to cds
                    };
                };
            };

<<<<<<< master
<<<<<<< master
            // Hersteller
            observation -> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueCodeableConcept where "code.coding.code = 'C25392' and %tgt.data.where(itemid = 'id_2230').exists().not()" then
                    {
                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code then  
                        {
                            observation-> data.blockindex = 6;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2230';
                            code -> data.values as values, values.value = code;
                        };
                    };
=======
            //Datum des Abschlusses
=======
            // Ergebnis
>>>>>>> to fhir fixes, finished to cds
            observation -> tgt.data as data then
                {

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA6576-8'" then 
                    {
                        observation -> data.blockindex = 5;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2198';
                        code -> data.values as values, values.value = 'positiv';
                    };

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA6577-6'" then 
                    {
                        observation -> data.blockindex = 5;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2198';
                        code -> data.values as values, values.value = 'negativ';
                    };

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA18198-4'" then 
                    {
                        observation -> data.blockindex = 5;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2198';
                        code -> data.values as values, values.value = 'nicht auswertbar';
                    };
                };

            
            // Positieve Tumorzellen
            observation-> tgt.data as data then
            {
                observation.component as component then
                {
<<<<<<< master
                    observation -> data.blockindex = 7;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_2521';
                    effectiveperiod.end as abschlussdatum -> data.values as values, values.value = abschlussdatum;
>>>>>>> Fhir to CTS start
                };
            };

<<<<<<< master
            // Ergebnis
            observation -> tgt.data as data then
                {

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA6576-8'" then 
                    {
                        observation -> data.blockindex = 6;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2233';
                        code -> data.values as values, values.value = 'positiv';
                    };

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA6577-6'" then 
                    {
                        observation -> data.blockindex = 6;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2233';
                        code -> data.values as values, values.value = 'negativ';
                    };

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA18198-4'" then 
                    {
                        observation -> data.blockindex = 6;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2233';
                        code -> data.values as values, values.value = 'nicht auswertbar';
                    };
                };

            
            // Positieve Tumorzellen
            observation-> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueQuantity as quantity where "code.coding.code = 'C70460'" then
                    {
                        observation->data.blockindex = 6;
                        observation->data.groupindex = 0;
                        observation->data.itemid = 'id_2234';
=======
                    component.valueQuantity as quantity where "code.coding.code = 'C70460'" then
                    {
                        observation->data.blockindex = 5;
                        observation->data.groupindex = 0;
                        observation->data.itemid = 'id_2199';
>>>>>>> to fhir fixes, finished to cds
                        quantity.value as value->data.values as values, values.unit = 'percent', values.value = value;
                    };
                };
            };
<<<<<<< master

            // Polysomie
            observation-> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueQuantity as quantity where "code.coding.code = 'C36331'" then
                    {
                        observation->data.blockindex = 6;
                        observation->data.groupindex = 0;
                        observation->data.itemid = 'id_2235';
                        quantity.value as value->data.values as values, values.unit = 'percent', values.value = value;
                    };
=======
        /*---------------RET----------------*/
        entry.resource as observation where "resource is Observation 
                                            and resource.code.coding.code = 'RET'" then
=======

            // Polysomie
            observation-> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueQuantity as quantity where "code.coding.code = 'C36331'" then
                    {
                        observation->data.blockindex = 5;
                        observation->data.groupindex = 0;
                        observation->data.itemid = 'id_2200';
                        quantity.value as value->data.values as values, values.unit = 'percent', values.value = value;
                    };
                };
            };          
        };


         /*---------------ROS1 CISH OBSERVATION----------------*/
        entry.resource as observation where "resource is Observation and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/ish' and resource.code.coding.code = 'ROS1'" then
>>>>>>> to fhir fixes, finished to cds
        {
        
            // Date Of Assesment
            observation -> tgt.data as data then
            {
                observation.effectivePeriod as period then
                {
                    observation-> data.blockindex = 6;
                    observation-> data.groupindex = 0;
                    observation-> data.itemid = 'id_2211';
                    period.start as dateOfAssessment-> data.values as values, values.value = dateOfAssessment;
                };
            };

            // Phaenotyp
            observation -> tgt.data as data then
            {
                observation.component as component then
                {
                    component.code where "code.coding.code = 'C16977'" then
                    {
                        component.valueString as value then 
                        {
                            observation-> data.blockindex = 6;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2212';
                            value -> data.values as values, values.value = value;
                        };
                    };
                };
            };

            // Kit bezeichnung
            observation -> tgt.data as data then
            {
                observation.component as component then
                {
<<<<<<< master
                    observation -> data.blockindex = 7;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_2521';
                    observation -> data.values as values, values.value = '2019-11-10';
>>>>>>> Fhir to CTS start
                };
            };
=======
                    component.valueCodeableConcept where "code.coding.code = 'C42793' and %tgt.data.where(itemid = 'id_2221').exists().not()" then
                    {
                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code then  
                        {
                            observation-> data.blockindex = 6;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2221';
                            code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            // Hersteller
            observation -> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueCodeableConcept where "code.coding.code = 'C25392' and %tgt.data.where(itemid = 'id_2222').exists().not()" then
                    {
                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code then  
                        {
                            observation-> data.blockindex = 6;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2222';
                            code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            // Ergebnis
            observation -> tgt.data as data then
                {

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA6576-8'" then 
                    {
                        observation -> data.blockindex = 6;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2225';
                        code -> data.values as values, values.value = 'positiv';
                    };

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA6577-6'" then 
                    {
                        observation -> data.blockindex = 6;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2225';
                        code -> data.values as values, values.value = 'negativ';
                    };

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA18198-4'" then 
                    {
                        observation -> data.blockindex = 6;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2225';
                        code -> data.values as values, values.value = 'nicht auswertbar';
                    };
                };

            
            // Positieve Tumorzellen
            observation-> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueQuantity as quantity where "code.coding.code = 'C70460'" then
                    {
                        observation->data.blockindex = 6;
                        observation->data.groupindex = 0;
                        observation->data.itemid = 'id_2226';
                        quantity.value as value->data.values as values, values.unit = 'percent', values.value = value;
                    };
                };
            };  

            // Polysomie
            observation-> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueQuantity as quantity where "code.coding.code = 'C36331'" then
                    {
                        observation->data.blockindex = 6;
                        observation->data.groupindex = 0;
                        observation->data.itemid = 'id_2227';
                        quantity.value as value->data.values as values, values.unit = 'percent', values.value = value;
                    };
                };
            };          
        };   

        /*---------------ROS1 FISH OBSERVATION----------------*/
        entry.resource as observation where "resource is Observation and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/fish' and resource.code.coding.code = 'ROS1'" then
        {
        
            // Kit bezeichnung
            observation -> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueCodeableConcept where "code.coding.code = 'C42793' and %tgt.data.where(itemid = 'id_2229').exists().not()" then
                    {
                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code then  
                        {
                            observation-> data.blockindex = 6;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2229';
                            code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            // Hersteller
            observation -> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueCodeableConcept where "code.coding.code = 'C25392' and %tgt.data.where(itemid = 'id_2230').exists().not()" then
                    {
                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code then  
                        {
                            observation-> data.blockindex = 6;
                            observation-> data.groupindex = 0;
                            observation-> data.itemid = 'id_2230';
                            code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            // Ergebnis
            observation -> tgt.data as data then
                {

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA6576-8'" then 
                    {
                        observation -> data.blockindex = 6;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2233';
                        code -> data.values as values, values.value = 'positiv';
                    };

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA6577-6'" then 
                    {
                        observation -> data.blockindex = 6;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2233';
                        code -> data.values as values, values.value = 'negativ';
                    };

                    observation.valueCodeableConcept as valueCodeableConcept,
                    valueCodeableConcept.coding as coding,
                    coding.code as code where "code = 'LA18198-4'" then 
                    {
                        observation -> data.blockindex = 6;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2233';
                        code -> data.values as values, values.value = 'nicht auswertbar';
                    };
                };

            
            // Positieve Tumorzellen
            observation-> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueQuantity as quantity where "code.coding.code = 'C70460'" then
                    {
                        observation->data.blockindex = 6;
                        observation->data.groupindex = 0;
                        observation->data.itemid = 'id_2234';
                        quantity.value as value->data.values as values, values.unit = 'percent', values.value = value;
                    };
                };
            };

            // Polysomie
            observation-> tgt.data as data then
            {
                observation.component as component then
                {
                    component.valueQuantity as quantity where "code.coding.code = 'C36331'" then
                    {
                        observation->data.blockindex = 6;
                        observation->data.groupindex = 0;
                        observation->data.itemid = 'id_2235';
                        quantity.value as value->data.values as values, values.unit = 'percent', values.value = value;
                    };
                };
            };
>>>>>>> to fhir fixes, finished to cds
        };          
    }; 
}