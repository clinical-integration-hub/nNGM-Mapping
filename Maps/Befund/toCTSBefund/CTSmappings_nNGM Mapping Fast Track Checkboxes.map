/// version = 0.1
/// title = "nNGM: nNGM_Mapping_Resistenztestung_checkboxesCTS - FHIR to CTS"

map "http://uk-koeln.de/fhir/StructureMap/nNGM_Mapping_FastTrack_checkboxesCTS" = nNGM_Mapping_FastTrack_checkboxesCTS

uses "http://hl7.org/fhir/StructureDefinition/Bundle" as source
uses "http://hl7.org/fhir/StructureDefinition/CTS_Transport" as target

group TransformFastTrackCheckboxes(source src: Bundle, target tgt: BackboneElement)
{
    src.entry as entry then
    {
        // BRAF Exon 15
        entry.resource as observation where "resource is Observation and resource.code.coding.code = 'C158854'" then
        {
            observation -> tgt.data as data collate then
            {
                observation.status as status where "%tgt.data.where(itemid = 'id_2512').exists().not()" then
                {
                    observation -> data.blockindex = 3;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_2512';
                };
                observation -> data.values as values, values.value = 'BRAF Exon 15';
            };
        };

        // EGFR Exon 19-21
        entry.resource as observation where "resource is Observation and resource.code.coding.code = 'C128662'" then
        {
            observation -> tgt.data as data collate then
            {
                observation.status as status where "%tgt.data.where(itemid = 'id_2512').exists().not()" then
                {
                    observation -> data.blockindex = 3;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_2512';
                };
                observation -> data.values as values, values.value = 'EGFR Exon 19-21';
            };
        };

        // KRAS Exon 2
        entry.resource as observation where "resource is Observation and resource.code.coding.code = 'C135715'" then
        {
            observation -> tgt.data as data collate then
            {
                observation.status as status where "%tgt.data.where(itemid = 'id_2512').exists().not()" then
                {
                    observation -> data.blockindex = 3;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_2512';
                };
                observation -> data.values as values, values.value = 'KRAS Exon 2';
            };
        };

        /*
        entry.resource as observation where "resource is Observation and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/fasttrack'" then
        {
            //Untersuchungen
            //Fast Track -> 3, 0, id_2512
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.code as code,code.coding where "coding.code = 'C158854'" then
                    {
                        observation ->  data.blockindex = 3;
                        observation ->  data.groupindex = 0;
                        observation ->  data.itemid = 'id_2512';
                        observation ->  data.values as values,values.value = 'BRAF Exon 15';
                    };
                    observation.code as code,code.coding where "coding.code = 'C128662'" then
                    {
                        observation ->  data.blockindex = 3;
                        observation ->  data.groupindex = 0;
                        observation ->  data.itemid = 'id_2512';
                        observation ->  data.values as values,values.value = 'EGFR Exon 19-21';
                    };
                    observation.code as code,code.coding where "coding.code = 'C135715'" then
                    {
                        observation ->  data.blockindex = 3;
                        observation ->  data.groupindex = 0;
                        observation ->  data.itemid = 'id_2512';
                        observation ->  data.values as values,values.value = 'KRAS Exon 2';
                    };
                };
            };
        };
        */
    };
}