/// version = 0.1
/// title = "nNGM: Mapping Histologie CTS"

/*
TODO

Components not used anymore according to forms
Observation is skipped?

Move to DiagnosticReport:
//Untersuchungs-ID 
specimen -> tgt.operations as operations collate then
{
    specimen -> tgt.data as data then
    {
        specimen.identifier as identifier, identifier.value as value where "$this.system = 'http://uk-koeln.de/fhir/NamingSystem/nNGM/fallnummer'" then
        {   
            specimen -> data.blockindex = 1;
            specimen -> data.groupindex = 0;
            specimen -> data.itemid = 'assessment_id';
            value -> data.values as values, values.value = value;
        };
    };
};

*/

map "http://uk-koeln.de/fhir/StructureMap/nNGM_Mapping_HistologieCTS" = nNGM_Mapping_HistologieCTS

uses "http://hl7.org/fhir/StructureDefinition/Bundle" as source
uses "http://hl7.org/fhir/StructureDefinition/CTS_Transport" as target

group TransformHistologieOperation(source src: Bundle, target tgt: CTS_Transport)
{
    // Metadata
    src -> tgt.version = '1.1';
    src -> tgt.sourcesystem = 'https:\/\/nngm-qat.staging.healex.systems\/';

    src -> tgt.operations as operations collate, operations.crfid = '*-RT1';
    src -> tgt.operations as operations collate, operations.type = 'save';

    src.entry as entry then
    {
        /*------------------------------ Specimen -------------------------------*/
        entry.resource as specimen where "resource is Specimen and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Specimen/nNGM'" -> tgt.operations as operations collate then
        {
            // biopsieId.value --> Biopsy-ID
            specimen -> operations.data as data then
            {
                specimen.identifier as identifier, identifier.value as value where "$this.system = 'http://uk-koeln.de/NamingSystem/nNGM/biopsienummer'" then
                {   
                    specimen -> data.blockindex = 1;
                    specimen -> data.groupindex = 0;
                    specimen -> data.itemid = 'id_1601';
                    value -> data.values as values, values.value = value;
                };
            };

            //receivedTime -> Eingang des Tumormaterials in der Pathologie
            specimen -> operations.data as data then
            {
                specimen.receivedTime as receivedtime then
                {   
                    specimen -> data.blockindex = 0;
                    specimen -> data.groupindex = 0;
                    specimen -> data.itemid = 'id_2515';
                    receivedtime -> data.values as values, values.value = receivedtime;
                };
            };
        
            //accessionIdentifier.value -> Eingangsnummer des Tumormaterials in der Pathologie
            specimen -> operations.data as data then
            {
                specimen.accessionIdentifier as identifier, identifier.value as identValue then
                {   
                    specimen -> data.blockindex = 0;
                    specimen -> data.groupindex = 0;
                    specimen -> data.itemid = 'id_2516';
                    identValue -> data.values as values, values.value = identValue;
                };
            };

            //type.text -> Tumormaterial 
            specimen -> operations.data as data then
            {
                specimen.type as type, type.text as text then
                {   
                    specimen -> data.blockindex = 0;
                    specimen -> data.groupindex = 0;
                    specimen -> data.itemid = 'id_2517';
                    text -> data.values as values, values.value = text;
                };
            };
        };

        /*------------------------------ DiagnosticReport -------------------------------*/
        entry.resource as diagnosticReport where "resource is DiagnosticReport and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/DiagnosticReport/nNGM/befund'" -> tgt.operations as operations collate then
        {
            // Pathologie-Fall-ID
            diagnosticReport -> operations.data as data then
            {
                diagnosticReport.identifier as identifier, identifier.value as value where "$this.system = 'http://uk-koeln.de/NamingSystem/nNGM/externePathoBefundnummer'" then
                {   
                    value -> data.blockindex = 0;
                    value -> data.groupindex = 0;
                    value -> data.itemid = 'extern_patho_case_id';
                    value -> data.values as values, values.value = value;
                };
            };

            // Untersuchungs ID
            diagnosticReport -> operations.data as data then
            {
                diagnosticReport.identifier as identifier, identifier.value as value where "$this.system = 'http://uk-koeln.de/NamingSystem/nNGM/befundnummer'" then
                {   
                    value -> data.blockindex = 5;
                    value -> data.groupindex = 0;
                    value -> data.itemid = 'assessment_id';
                    value -> data.values as values, values.value = value;
                };
            };
        };
            
        /*------------------------------Observation-------------------------------*/
        entry.resource as observation where "resource is Observation and meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/nNGM/histologie'" -> tgt.operations as operations collate then
        {
            //Component.code -> Klassifikation
            observation -> operations.data as data then
            {
                observation.component as component, component.valueCodeableConcept as vcc, vcc.coding as coding where "valueCodeableConcept.coding.system = 'http://uk-koeln.de/fhir/ValueSet/nngm/histologie-klassifikation'" then
                {   
                    observation -> data.blockindex = 2;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_1658';
                    coding.code as code -> data.values as values, values.value = code;
                };
            };

            //bodysite -> Lokalisation
            observation -> operations.data as data then
            {
                observation.bodySite as code, code.coding as coding, coding.code as code then
                {   
                    observation -> data.blockindex = 2;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_2469';
                    code -> data.values as values, values.value = code;
                };
            };

            // valueCodeableConcept -> Grading
            observation -> operations.data as data then
            {
                observation.valueCodeableConcept as cc, cc.coding as coding then
                {   
                    observation -> data.blockindex = 2;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_2403';
                    coding.code as code -> data.values as values, values.value = code;
                };
            };
            
            /*
            //Wachstumsmuster bei Adenokarzinom lepidisch
            observation -> tgt.operations as operations collate then
            {
                observation -> tgt.data as data then
                {
                   observation.component as component then
                    {   
                        component.valueQuantity as valuequantity where "code.coding.system = 'urn:oid:2.16.840.1.113883.6.43.1' and code.coding.code = '8250/3'" then
                        {
                            observation -> data.blockindex = 3;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_1286';
                            valuequantity.value as value -> data.values as values, values.value = value;
                        };
                    };
                };
            };

            //Wachstumsmuster bei Adenokarzinom azinär
            observation -> tgt.operations as operations collate then
            {
                observation -> tgt.data as data then
                {
                   observation.component as component then
                    {   
                        component.valueQuantity as valuequantity where "code.coding.system = 'urn:oid:2.16.840.1.113883.6.43.1' and code.coding.code = '8551/3'" then
                        {
                            observation -> data.blockindex = 3;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_1296';
                            valuequantity.value as value -> data.values as values, values.value = value;
                        };
                    };
                };
            };

            //Wachstumsmuster bei Adenokarzinom papillär
            observation -> tgt.operations as operations collate then
            {
                observation -> tgt.data as data then
                {
                   observation.component as component then
                    {   
                        component.valueQuantity as valuequantity where "code.coding.system = 'urn:oid:2.16.840.1.113883.6.43.1' and code.coding.code = '8260/3'" then
                        {
                            observation -> data.blockindex = 3;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_1294';
                            valuequantity.value as value -> data.values as values, values.value = value;
                        };
                    };
                };
            };

            //Wachstumsmuster bei Adenokarzinom mikropapillär
            observation -> tgt.operations as operations collate then
            {
                observation -> tgt.data as data then
                {
                   observation.component as component then
                    {   
                        component.valueQuantity as valuequantity where "code.coding.system = 'urn:oid:2.16.840.1.113883.6.43.1' and code.coding.code = '8265/3'" then
                        {
                            observation -> data.blockindex = 3;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_1288';
                            valuequantity.value as value -> data.values as values, values.value = value;
                        };
                    };
                };
            };

            //Wachstumsmuster bei Adenokarzinom solide
            observation -> tgt.operations as operations collate then
            {
                observation -> tgt.data as data then
                {
                   observation.component as component then
                    {   
                        component.valueQuantity as valuequantity where "code.coding.system = 'urn:oid:2.16.840.1.113883.6.43.1' and code.coding.code = '8230/3'" then
                        {
                            observation -> data.blockindex = 3;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_1292';
                            valuequantity.value as value -> data.values as values, values.value = value;
                        };
                    };
                };
            };

            //THIS BLOCK WILL NOT WORK BEACUSE OF A MISSING CODE IN THE COMPONENT. PLEASE CHECK TOFHIR MAP TODO!
            //Anteil an Siegelringzellkarzinomen 
            observation -> tgt.operations as operations collate then
            {
                observation -> tgt.data as data then
                {
                   observation.component as component then
                    {   
                        component.valueQuantity as valuequantity where "code.coding.system = 'urn:oid:2.16.840.1.113883.6.43.1' and code.coding.code = '8490/3'" then
                        {
                            observation -> data.blockindex = 3;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_2519';
                            valuequantity.value as value -> data.values as values, values.value = value;
                        };
                    };
                };
            };
            */
        };

        /*------------------------------ServiceRequest-------------------------------*/

        entry.resource as servicerequest where "resource is ServiceRequest and meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/ServiceRequest/nNGM/testung'" -> tgt.operations as operations collate then
        {
            //status.code Durchführung
            servicerequest -> operations.data as data then
            {
                servicerequest.status as status then
                {
                    servicerequest -> data.blockindex = 4;
                    servicerequest -> data.groupindex = 0;
                    servicerequest -> data.itemid = 'id_2520';
                    status -> data.values as values, values.value = status;
                };
            };

            //Abschluss
            servicerequest -> operations.data as data then
            {
                servicerequest.status as status, 
                status.extension as abschluss, 
                abschluss.extension as abschlussstatus where "$this.url = 'status'" then
                {
                    servicerequest -> data.blockindex = 4;
                    servicerequest -> data.groupindex = 0;
                    servicerequest -> data.itemid = 'id_2462';
                    abschlussstatus.valuecoding as vc, vc.code as value  -> data.values as values, values.value = value;
                };
            };
        
            //Datum des Abschlusses
            servicerequest -> operations.data as data then
            {
                servicerequest.status as status, 
                status.extension as abschluss, 
                abschluss.extension as abschlussstatus where "$this.url = 'datum'" then
                {
                    servicerequest -> data.blockindex = 4;
                    servicerequest -> data.groupindex = 0;
                    servicerequest -> data.itemid = 'id_2462';
                    abschlussstatus.valueDate as value  -> data.values as values, values.value = value;
                };
            };
        };
    };
}
