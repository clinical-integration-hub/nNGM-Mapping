/// version = 0.1
/// title = "Beurteilung"

/*
TODO:
    SERVICEREQUEST -> status-status extension doesn't appear, although there is
                        data in the CTS
    Missing Add Beurteilung section implementation
*/

map "http://uk-koeln.de/fhir/StructureMap/nNGM_Mapping_Beurteilung" = nNGM_Mapping_Beurteilung 

uses "http://hl7.org/fhir/StructureDefinition/CTS_Transport" as source
uses "http://hl7.org/fhir/StructureDefinition/DiagnosticReport" as target
uses "http://hl7.org/fhir/StructureDefinition/ServiceRequest" as target

group TransformBundle(source src: CTS_Transport, target tgt: Bundle)
{
    src -> tgt.id = uuid(); 
    src -> tgt.type = 'collection';

    src -> tgt.entry as entry then CreateTransformDiagnosticReport(src, entry);
    src -> tgt.entry as entry then CreatTransformServiceRequest(src, entry);

}

group CreateTransformDiagnosticReport(source src: CTS_Transport, target tgt: BackboneElement)
{
    src.operations as operations, operations.data as data then
    {
        data.values as values where "blockindex = 0 and groupindex = 0 and itemid = 'id_1352'
        or blockindex = 0 and groupindex = 0 and itemid ='bu_creation_date'
        or blockindex = 0 and groupindex = 0 and itemid ='bu_vesion'
        or blockindex = 0 and groupindex = 0 and itemid ='id_2405'" then
        {
            src -> tgt.resource = create('DiagnosticReport') as diagnosticreport then TransformDiagnosticReport (src, diagnosticreport);
        };
    };
}

group CreatTransformServiceRequest(source src: CTS_Transport, target tgt: BackboneElement)
{
    src.operations as operations, operations.data as data then
    {
        data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'id_2523'
        or blockindex = 1 and groupindex = 0 and itemid ='id_bu_closing'
        or blockindex = 1 and groupindex = 0 and itemid ='id_2524' 
        or blockindex = 1 and groupindex = 0 and itemid ='id_2525'" then
        {
            src -> tgt.resource = create('ServiceRequest') as servicerequest then TransformServiceRequest (src, servicerequest);
        };
    };
}

/* ------------------------------DiagnosticReport---------------------------- */
group TransformDiagnosticReport(source src: CTS_Transport, target tgt: DiagnosticReport)
{
    src -> tgt.id = uuid();
    src -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/DiagnosticReport/nNGM/beurteilung';

    src.patid as patid -> tgt.subject = create('Reference') as subject, subject.reference = evaluate(patid, '\'Patient/\' + $this');


    src.operations as operations, operations.data as data then
    {
        /*--------------Erstelldatum------------*/
        data.values as values where "blockindex = 0 and groupindex = 0 and itemid = 'bu_creation_date'" then
         {
            values.value as date -> tgt.effectiveDateTime = dateOp(date, 'dateTime');
         };

		/*--------------Version------------*/
        data.values as values where "blockindex = 0 and groupindex = 0 and itemid = 'bu_version'" then
         {   
            values.value as code where "$this.value = 'vorlÃ¤ufig'" then
            {
                code -> tgt.status = 'preliminary'; //cc('', code);
            };
            values.value as code where "$this.value = 'final'" then
            {
                code -> tgt.status = 'final'; //cc('', code);
            };
         };   

        /*--------------Klinische Information------------*/
        data.values as values where "blockindex = 0 and groupindex = 0 and itemid = 'id_1352'" then
        {  
            values.value as value -> tgt.conclusion = value;
        };

        /*----------------Empfehlung einer systemischen Therapie------------*/
        data.values as values where "blockindex = 0 and groupindex = 0 and itemid = 'id_2405'" then
        {   
            values.value as signature where "$this.value = 'Ja'" then
            {
                values.value as value -> tgt.conclusionCode as conclusioncode,
                                        conclusioncode.extension as empfehlung, 
                                        empfehlung.valueBoolean = true;
            };

            values.value as signature where "$this.value = 'Nein'" then
            {
                values.value as value -> tgt.conclusionCode as conclusioncode,
                                        conclusioncode.extension as empfehlung, 
                                        empfehlung.valueBoolean = false;
            };
        }; 
    };
}

/* -----------------------------ServiceRequest--------------------------- */ 
group TransformServiceRequest(source src: CTS_Transport, target tgt: ServiceRequest)
{   
    src -> tgt.id = uuid();
    src -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/ServiceRequest/nNGM/testung';

    src.patid as patid -> tgt.subject = create('Reference') as subject, subject.reference = evaluate(patid, '\'Patient/\' + $this');

    src -> tgt.code as code, 
            code.coding as coding, 
            coding.system as system, 
            system.extension as dataAbsentReason, 
            dataAbsentReason.url = 'http://hl7.org/fhir/StructureDefinition/data-absent-reason', 
            dataAbsentReason.valueCode = cast('not-asked', 'FHIR.code');

    src.operations as operations, operations.data as data then
    {
        /*----------------Durchfuehrung------------*/
        data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'id_2523'" then
        {   
            values.value as durchfuerung where "$this.value = 'in Bearbeitung'" then
            {
                durchfuerung -> tgt.status = 'active'; //cc('', code);
            };
            values.value as durchfuerung where "$this.value = 'abgeschlossen'" then
            {
                durchfuerung -> tgt.status = 'completed'; //cc('', code);
            };
        }; 

        /*---------------Abschluss-----------*/
        //TODO
         data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'bu_closing'" then
        {   
            values.value as abschluss -> tgt.status as status, 
                                            status.extension as statusAbschluss,
                                            statusAbschluss.extension as statusExtension,
                                            statusExtension.url = 'status',
                                            statusExtension.valueCodeable = cc('http://uk-koeln.de/fhir/ValueSet/NNGM/statusAbschluss',abschluss,abschluss);
           
        }; 

        /*---------------Datum des Abschlusses -----------*/
         data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'id_2524'" then
        {   
            values.value as datumabschluss -> tgt.status as status, 
                                            status.extension as statusAbschluss,
                                            statusAbschluss.extension as datumExtension,
                                            datumExtension.url = 'datum',
                                            datumExtension.valueDate = dateOp(datumabschluss, 'dateTime');
        }; 
     
        /*---------------Datum des versands -----------*/
         data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'id_2525'" then
        {   
            values.value as datumversands -> tgt.extension as datumVersands,
                                              datumVersands.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/nNGM/datumversands',
                                              datumVersands.valueDate = dateOp(datumversands, 'dateTime');
        };   
    };
}