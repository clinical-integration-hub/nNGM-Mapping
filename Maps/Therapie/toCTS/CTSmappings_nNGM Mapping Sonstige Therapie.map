/// version = 0.1
/// title = "nNGM: Sonstige Therapie - FHIR to CTS"

/*
    TODO
    - Methode (Freitext): missing valueSet
*/

map "http://uk-koeln.de/fhir/StructureMap/SonstigeTherapieCTS" = SonstigeTherapieCTS

uses "http://hl7.org/fhir/StructureDefinition/Bundle" as source
uses "http://hl7.org/fhir/StructureDefinition/CTS_Transport" as target

group TransformCTS(source src: Bundle, target tgt: CTS_Transport)
{
    src -> tgt.version = '1.1';
    src -> tgt.sourcesystem = 'https:\/\/nngm-qat.staging.healex.systems\/';

    src -> tgt.operations as operations collate, operations.crfid = 'SO1';
    src -> tgt.operations as operations collate, operations.type = 'save';

    src.entry as entry then
    {
        /* ------------------------------ Procedure ---------------------------- */
        entry.resource as procedure where "resource is Procedure" then
        {
            // Art der Therapie
            procedure -> tgt.operations as operations collate then
            {
                procedure -> operations.data as data then
                {
                    procedure.category as category, category.coding as coding, coding.code as code then
                    {
                        procedure -> data.blockindex = 0;
                        procedure -> data.groupindex = 0;
                        procedure -> data.itemid = 'id_1213';
                        code -> data.values as values, values.value = code;
                    };
                };
            };

            // Therapiebeginn
            procedure -> tgt.operations as operations collate then
            {
                procedure -> operations.data as data then
                {
                    procedure.performedPeriod as performedPeriod, performedPeriod.start as start then
                    {
                        procedure -> data.blockindex = 1;
                        procedure -> data.groupindex = 0;
                        procedure -> data.itemid = 'id_1220';
                        start -> data.values as values, values.value = start;
                    };
                };
            };

            // Therapieende
            procedure -> tgt.operations as operations collate then
            {
                procedure -> operations.data as data then
                {
                    procedure.performedPeriod as performedPeriod, performedPeriod.end as end then
                    {
                        procedure -> data.blockindex = 1;
                        procedure -> data.groupindex = 0;
                        procedure -> data.itemid = 'id_1221';
                        end -> data.values as values, values.value = end;
                    };
                };
            };

            // Durchführende Einrichtung
            procedure -> tgt.operations as operations collate then
            {
                procedure -> operations.data as data then
                {
                    procedure.performer as performer, performer.actor as actor, actor.display as display then
                    {
                        procedure -> data.blockindex = 1;
                        procedure -> data.groupindex = 0;
                        procedure -> data.itemid = 'id_2434';
                        display -> data.values as values, values.value = display;
                    };
                };
            };

            // Lokalisation (Auswahl)
            procedure -> tgt.operations as operations collate then
            {
                procedure -> operations.data as data then
                {
                    procedure.bodySite as bodySite, bodySite.coding as coding where "coding.system = 'http://uk-koeln.de/fhir/ValueSet/cancer-base/icdo-o-3-t'" then
                    {
                        coding.code as code where "code = 'other' or code = 'Leber' or code = 'Lunge'" then
                        {
                            procedure -> data.blockindex = 2;
                            procedure -> data.groupindex = 0;
                            procedure -> data.itemid = 'id_1215';
                            coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            // Lokalisation (Freitext)
            procedure -> tgt.operations as operations collate then
            {
                procedure -> operations.data as data then
                {
                    procedure.bodySite as bodySite then
                    {
                        bodySite.text as text where "text != 'other' and text != 'Leber' and text != 'Lunge'" then
                        {
                            procedure -> data.blockindex = 2;
                            procedure -> data.groupindex = 0;
                            procedure -> data.itemid = 'id_1215';
                            text -> data.values as values, values.value = text;
                        };
                    };
                };
            };

            // Methode (Auswahl)
            procedure -> tgt.operations as operations collate then
            {
                procedure -> operations.data as data then
                {
                    procedure.code as code, code.extension as methode, methode.extension as extension where "extension.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/nNGM/methode-sonstige-therapie'" then
                    {
                        extension.valueCodeableConcept as vcc, vcc.coding as coding, coding.code as code where "code = 'Transarterielle Chemoembolisation' or code = 'Radiofrequenzablation' or code = 'Transarterielle Chemoembolisation'" then
                        {
                            procedure -> data.blockindex = 2;
                            procedure -> data.groupindex = 0;
                            procedure -> data.itemid = 'id_1467';
                            code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            // Methode (Freitext)
            procedure -> tgt.operations as operations collate then
            {
                procedure -> operations.data as data then
                {
                    procedure.code as code, code.extension as methode, methode.extension as extension where "extension.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/nNGM/methode-sonstige-therapie'" then
                    {
                        extension.valueCodeableConcept as vcc, vcc.coding as coding, coding.code as code where "code != 'Transarterielle Chemoembolisation' and code != 'Radiofrequenzablation' and code != 'Transarterielle Chemoembolisation' and code != 'other'" then
                        {
                            procedure -> data.blockindex = 2;
                            procedure -> data.groupindex = 0;
                            procedure -> data.itemid = 'id_1467';
                            coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            // Therapeutische Intention (Auswahl)
            procedure -> tgt.operations as operations collate then
            {
                procedure -> operations.data as data then
                {
                    procedure.reasonCode as reasonCode, reasonCode.coding as coding where "coding.system = 'http://uk-koeln.de/fhir/ValueSet/nngm/intention-sonstige-therapieOther'" then
                    {
                        coding.code as code where "code = 'Alternative Methoden' or code = 'other'" then
                        {
                            procedure -> data.blockindex = 2;
                            procedure -> data.groupindex = 0;
                            procedure -> data.itemid = 'id_1218';
                            coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            // Therapeutische Intention (Freitext)
            procedure -> tgt.operations as operations collate then
            {
                procedure -> operations.data as data then
                {
                    procedure.reasonCode as reasonCode, reasonCode.text as text where "text != 'Alternative Methoden' and text != 'other'" then
                    {
                        procedure -> data.blockindex = 2;
                        procedure -> data.groupindex = 0;
                        procedure -> data.itemid = 'id_1218';
                        text -> data.values as values, values.value = text;
                    };
                };
            };

            // Bezeichnung / Beschreibung der alternativen Methoden
            procedure -> tgt.operations as operations collate then
            {
                procedure -> operations.data as data then
                {
                    procedure.reasonCode as reasonCode, reasonCode.extension as extension where "extension.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/nNGM/beschreiung-alternativer-methode'" then
                    {
                        procedure -> data.blockindex = 2;
                        procedure -> data.groupindex = 0;
                        procedure -> data.itemid = 'id_1219';
                        extension.valueString as value -> data.values as values, values.value = value;  
                    };
                };
            };

            // Grund für keine Therapie / BSC
            procedure -> tgt.operations as operations collate then
            {
                procedure -> operations.data as data then
                {
                    procedure.reasonCode as reasonCode, reasonCode.extension as extension where "extension.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/nNGM/grund-keine-therapie'" then
                    {
                        extension.valueCodeableConcept as vcc, vcc.coding as coding, coding.code as code then
                        {
                            procedure -> data.blockindex = 2;
                            procedure -> data.groupindex = 0;
                            procedure -> data.itemid = 'id_1547';
                            coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            // Maintenance
            procedure -> tgt.operations as operations collate then
            {
                procedure -> operations.data as data then
                {
                    procedure.extension as extension where "extension.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/nNGM/maintenance'" then
                    {
                        extension.valueCodeableConcept as vcc, vcc.coding as coding, coding.code as code then
                        {
                            procedure -> data.blockindex = 4;
                            procedure -> data.groupindex = 0;
                            procedure -> data.itemid = 'id_1360';
                            coding.code as code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            // Bemerkungen
            procedure -> tgt.operations as operations collate then
            {
                procedure -> operations.data as data then
                {
                    procedure.note as note, note.text as text then
                    {
                        procedure -> data.blockindex = 4;
                        procedure -> data.groupindex = 0;
                        procedure -> data.itemid = 'id_1472';
                        text -> data.values as values, values.value = text;
                    };
                };
            };
        };

        /* ------------------------------ Patient ---------------------------- */
        entry.resource as patient where "resource is Patient and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Patient/nNGM'" then
        {
            // Todesdatum
            patient -> tgt.operations as operations collate then
            {
                patient -> operations.data as data then
                {
                    patient.deceasedDateTime as deceasedDateTime then
                    {
                        patient -> data.blockindex = 3;
                        patient -> data.groupindex = 0;
                        patient -> data.itemid = 'id_2401';
                        deceasedDateTime -> data.values as values, values.value = deceasedDateTime;
                    };
                };
            };
        };
    };
}