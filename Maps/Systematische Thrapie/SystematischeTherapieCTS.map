/// version = 0.1
/// title = "SystemischeTherapieCTS"

/* TO DO
1, 0, id_2337 hilfreich ext
1, 0, id_2338 umgesetzt ext

3, 0, id_1488 anderung des schemas, forgot in bundle
*/

map "http://uk-koeln.de/fhir/StructureMap/SystemischeTherapieCTS" = SystemischeTherapieCTS

uses "http://hl7.org/fhir/StructureDefinition/Bundle" as source
uses "http://hl7.org/fhir/StructureDefinition/CTS_Transport" as target

group TransformSystematischeTherapieCTS(source src: Bundle, target tgt: BackboneElement)
{
    src -> tgt.type = 'save';
    src -> tgt.crfid = 'SY1';

    
    src.entry as entry then 
    {

    /* ------------------------------ Episode of Care ---------------------------- */
    entry.resource as episodeofcare where "resource is EpisodeOfCare and resource.id = '133dfdb2-2906-46ac-b7a4-2b22367c601a'" then
    {

            //Fallnummer
            episodeofcare -> tgt.data as data then
            {
                episodeofcare.identifier as identifier  then
                {   
                    episodeofcare -> data.blockindex = 0;
                    episodeofcare -> data.groupindex = 0;
                    episodeofcare -> data.repeatindex = 0;
                    episodeofcare -> data.itemid = 'id_1600';
                    identifier.value as value -> data.values as values, values.unit = 'count', values.value = value;
                };
            };
        };
    
    /* ------------------------------ Organization ---------------------------- */
    entry.resource as organization where "resource is Organization and resource.id = 'e8c512aa-f14d-4bf8-8412-a4d8c3e01939'" then
    {
        //Empfehlung einer systemischen Therapie
        organization -> tgt.data then
        {
            organization -> tgt.data as data then
            {
                organization.identifier as identifier then
                {   
                    organization -> data.blockindex = 2;
                    organization -> data.groupindex = 0;
                    organization -> data.repeatindex = 0;
                    organization -> data.itemid = 'id_1242';
                    identifier.value as value -> data.values as values, values.value = value;
                };
            };
        };
    };
    
     /* ------------------------------ Observation ECOG ----------------------------*/ 
    entry.resource as observation where "resource is Observation and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/nNGM/ecog' and resource.id = '7c5ad00f-7d00-4c0d-ae81-401841bccdf2'" then
    {   
        observation -> tgt.data then
        {
            observation -> tgt.data as data then
            {
                observation.valueCodeableConcept as vcc, vcc.coding as coding then
                {   
                    observation -> data.blockindex = 2;
                    observation -> data.groupindex = 0;
                    observation -> data.repeatindex = 0;
                    observation -> data.itemid = 'id_2415';
                    coding.code as ecog -> data.values as values, values.value = ecog;
                };
            };
        };
    };

    /* ------------------------------ Observation Best response----------------------------*/ 
    entry.resource as observation where "resource is Observation and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/nNGM/best-response' and resource.id = 'dd16fead-837b-457f-ad5d-31f9849cc343'" then
    {   
        observation -> tgt.data then
        {
            //vcc
            observation -> tgt.data as data then
            {
                observation.valueCodeableConcept as vcc, vcc.coding as coding then
                {   
                    observation -> data.blockindex = 5;
                    observation -> data.groupindex = 0;
                    observation -> data.repeatindex = 0;
                    observation -> data.itemid = 'id_1354';
                    coding.code as recist -> data.values as values, values.value = 'Partial Response';
                };
            };

            //method
            observation -> tgt.data as data then
            {
                observation.method as method, method.coding as coding then
                {   
                    observation -> data.blockindex = 5;
                    observation -> data.groupindex = 0;
                    observation -> data.repeatindex = 0;
                    observation -> data.itemid = 'id_1355';
                    coding.code as method -> data.values as values, values.value = method;
                };
            };
        };
    };


    /* ------------------------------ MedicationAdministration ----------------------------*/ 
    entry.resource as medicationadministration where "resource is MedicationAdministration and resource.meta.profile ='http://uk-koeln.de/fhir/StructureDefinition/Procedure/nNGM/MedicationAdministration' and resource.id = '2fa762a5-1bbd-4fe0-890e-234f74497fc5'" then
    {
        medicationadministration -> tgt.data then
        {
            //status
            medicationadministration -> tgt.data as data then
            {   
                medicationadministration.status as status then
                {   
                    medicationadministration -> data.blockindex = 6;
                    medicationadministration -> data.groupindex = 0;
                    medicationadministration -> data.repeatindex = 0;
                    medicationadministration -> data.itemid = 'id_1356';
                    status -> data.values as values, values.value = status;
                };
            };

            //effectivePeriod start
            medicationadministration -> tgt.data as data then
            {   
                medicationadministration.effectivePeriod as ep then
                {   
                    medicationadministration -> data.blockindex = 2;
                    medicationadministration -> data.groupindex = 0;
                    medicationadministration -> data.repeatindex = 0;
                    medicationadministration -> data.itemid = 'id_1246';
                    ep.start as start -> data.values as values, values.value = start;
                };
            };

            //extension hilfreich
            medicationadministration -> tgt.data as data then
            {   
                    medicationadministration -> data.blockindex = 1;
                    medicationadministration -> data.groupindex = 0;
                    medicationadministration -> data.repeatindex = 0;
                    medicationadministration -> data.itemid = 'id_2337';
                    medicationadministration -> data.values as values, values.value = 'N/A';
            };

            //extension umgesetzt
            medicationadministration -> tgt.data as data then
            {   
                    medicationadministration -> data.blockindex = 1;
                    medicationadministration -> data.groupindex = 0;
                    medicationadministration -> data.repeatindex = 0;
                    medicationadministration -> data.itemid = 'id_2338';
                    medicationadministration -> data.values as values, values.value = 'N/A';
            };

            //extension intention therapie
            medicationadministration -> tgt.data as data then
            {   
                    medicationadministration -> data.blockindex = 2;
                    medicationadministration -> data.groupindex = 0;
                    medicationadministration -> data.repeatindex = 0;
                    medicationadministration -> data.itemid = 'id_1243';
                    medicationadministration -> data.values as values, values.value = 'pallitativ';
            };

            //extension studientherapie.studie
            medicationadministration -> tgt.data as data then
            {   
                    medicationadministration -> data.blockindex = 2;
                    medicationadministration -> data.groupindex = 0;
                    medicationadministration -> data.repeatindex = 0;
                    medicationadministration -> data.itemid = 'id_1244';
                    medicationadministration -> data.values as values, values.value = '3120';
            };

            //extension studientherapie.teilnahme
            medicationadministration -> tgt.data as data then
            {   
                    medicationadministration -> data.blockindex = 2;
                    medicationadministration -> data.groupindex = 0;
                    medicationadministration -> data.repeatindex = 0;
                    medicationadministration -> data.itemid = 'id_1245';
                    medicationadministration -> data.values as values, values.value = 'Ja';
            };

            //extension off label behandlung
            medicationadministration -> tgt.data as data then
            {   
                    medicationadministration -> data.blockindex = 2;
                    medicationadministration -> data.groupindex = 0;
                    medicationadministration -> data.repeatindex = 0;
                    medicationadministration -> data.itemid = 'id_2341';
                    medicationadministration -> data.values as values, values.value = 'Nein';
            };

            //extension anderung des schemas
            medicationadministration -> tgt.data as data then
            {   
                    medicationadministration -> data.blockindex = 3;
                    medicationadministration -> data.groupindex = 0;
                    medicationadministration -> data.repeatindex = 0;
                    medicationadministration -> data.itemid = 'id_1488';
                    medicationadministration -> data.values as values, values.value = 'no';
            };
        };
    };
    };
}
