/// version = 0.1
/// title = "SystemischeTherapieCTS"

/* TO DO
1, 0, id_2337 hilfreich ext
1, 0, id_2338 umgesetzt ext

3, 0, id_1488 anderung des schemas, forgot in bundle
*/

map "http://uk-koeln.de/fhir/StructureMap/SystemischeTherapieCTS" = SystemischeTherapieCTS

uses "http://hl7.org/fhir/StructureDefinition/Bundle" as source
uses "http://hl7.org/fhir/StructureDefinition/CTS_Transport" as target

group TransformSystematischeTherapieCTS(source src: Bundle, target tgt: BackboneElement)
{
    src -> tgt.type = 'save';
    src -> tgt.crfid = 'SY1';

    
    src.entry as entry then 
    {

    /* ------------------------------ Episode of Care ---------------------------- */
    entry.resource as episodeofcare where "resource is EpisodeOfCare" then
    {

        episodeofcare -> tgt.operations as operations collate then
        {
            //Fallnummer
            episodeofcare -> operations.data as data then
            {
                episodeofcare.identifier as identifier  then
                {   
                    episodeofcare -> data.blockindex = 0;
                    episodeofcare -> data.groupindex = 0;
                    episodeofcare -> data.itemid = 'id_1600';
                    identifier.value as value -> data.values as values, values.unit = 'count', values.value = value;
                };
            };

            //Pat ID
            episodeofcare -> operations.data as data then
            {
                episodeofcare.patient as patient then
                {   
                    patient.reference as pat -> tgt.patid = evaluate(pat, '$this.split(\'\/\').last()');
                };
            };
        };
    };
    
    /* ------------------------------ Organization ---------------------------- */
    entry.resource as organization where "resource is Organization" then
    {
        //Empfehlung einer systemischen Therapie
        organization -> tgt.operations as operations collate then
        {
            organization -> operations.data as data then
            {
                organization.identifier as identifier then
                {   
                    organization -> data.blockindex = 2;
                    organization -> data.groupindex = 0;
                    organization -> data.itemid = 'id_1242';
                    identifier.value as value -> data.values as values, values.value = value;
                };
            };
        };
    };
    
     /* ------------------------------ Observation ECOG ----------------------------*/ 
    entry.resource as observation where "resource is Observation and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/nNGM/ecog' and resource.id = '7c5ad00f-7d00-4c0d-ae81-401841bccdf2'" then
    {   
        observation -> tgt.operations as operations collate then
        {
            observation -> operations.data as data then
            {
                observation.valueCodeableConcept as vcc, vcc.coding as coding then
                {   
                    observation -> data.blockindex = 2;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_2415';
                    coding.code as ecog -> data.values as values, values.value = ecog;
                };
            };
        };
    };

    /* ------------------------------ Observation Best response----------------------------*/ 
    entry.resource as observation where "resource is Observation and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/nNGM/best-response'" then
    {   
        observation -> tgt.operations as operations collate then
        {
            //vcc
            observation -> operations.data as data then
            {
                observation.valueCodeableConcept as vcc, vcc.coding as coding then
                {   
                    observation -> data.blockindex = 5;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_1354';
                    coding.code as recist -> data.values as values, values.value = 'Partial Response';
                };
            };

            //method
            observation -> operations.data as data then
            {
                observation.method as method, method.coding as coding then
                {   
                    observation -> data.blockindex = 5;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_1355';
                    coding.code as recist -> data.values as values, values.value = recist;
                };
            };
        };
    };


    /* ------------------------------ MedicationAdministration ----------------------------*/ 
    entry.resource as medicationadministration where "resource is MedicationAdministration" then
    {
        medicationadministration -> tgt.operations as operations collate then
        {
            //status
            medicationadministration -> operations.data as data then
            {   
                medicationadministration.status as status then
                {   
                    medicationadministration -> data.blockindex = 6;
                    medicationadministration -> data.groupindex = 0;
                    medicationadministration -> data.itemid = 'id_1356';
                    status -> data.values as values, values.value = status;
                };
            };

            //effectivePeriod start
            medicationadministration -> operations.data as data then
            {   
                medicationadministration.effectivePeriod as ep then
                {   
                    medicationadministration -> data.blockindex = 2;
                    medicationadministration -> data.groupindex = 0;
                    medicationadministration -> data.itemid = 'id_1246';
                    ep.start as start -> data.values as values, values.value = start;
                };
            };

            //extension hilfreich
            medicationadministration -> operations.data as data then
            {   
                    medicationadministration -> data.blockindex = 1;
                    medicationadministration -> data.groupindex = 0;
                    medicationadministration -> data.itemid = 'id_2337';
                    medicationadministration -> data.values as values, values.value = 'N/A';
            };

            //extension umgesetzt
            medicationadministration -> operations.data as data then
            {   
                    medicationadministration -> data.blockindex = 1;
                    medicationadministration -> data.groupindex = 0;
                    medicationadministration -> data.itemid = 'id_2338';
                    medicationadministration -> data.values as values, values.value = 'N/A';
            };

            //extension intention therapie
            medicationadministration -> operations.data as data then
            {   
                    medicationadministration -> data.blockindex = 2;
                    medicationadministration -> data.groupindex = 0;
                    medicationadministration -> data.itemid = 'id_1243';
                    medicationadministration -> data.values as values, values.value = 'pallitativ';
            };

            //extension studientherapie.studie
            medicationadministration -> operations.data as data then
            {   
                    medicationadministration -> data.blockindex = 2;
                    medicationadministration -> data.groupindex = 0;
                    medicationadministration -> data.itemid = 'id_1244';
                    medicationadministration -> data.values as values, values.value = '3120';
            };

            //extension studientherapie.teilnahme
            medicationadministration -> operations.data as data then
            {   
                    medicationadministration -> data.blockindex = 2;
                    medicationadministration -> data.groupindex = 0;
                    medicationadministration -> data.itemid = 'id_1245';
                    medicationadministration -> data.values as values, values.value = 'Ja';
            };

            //extension off label behandlung
            medicationadministration -> operations.data as data then
            {   
                    medicationadministration -> data.blockindex = 2;
                    medicationadministration -> data.groupindex = 0;
                    medicationadministration -> data.itemid = 'id_2341';
                    medicationadministration -> data.values as values, values.value = 'Nein';
            };

            //extension anderung des schemas
            medicationadministration -> operations.data as data then
            {   
                    medicationadministration -> data.blockindex = 3;
                    medicationadministration -> data.groupindex = 0;
                    medicationadministration -> data.itemid = 'id_1488';
                    medicationadministration -> data.values as values, values.value = 'no';
            };
        };
    };
    };
}
