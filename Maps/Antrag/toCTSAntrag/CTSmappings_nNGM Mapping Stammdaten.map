/// version = 0.1
/// title = "nNGM: nNGM_Mapping_StammdatenCTS - FHIR to CTS"

map "http://uk-koeln.de/fhir/StructureMap/nNGM_Mapping_StammdatenCTS" = nNGM_Mapping_StammdatenCTS

uses "http://hl7.org/fhir/StructureDefinition/Bundle" as source
uses "http://hl7.org/fhir/StructureDefinition/CTS_Transport" as target

group TransformStammdatenOperation(source src: Bundle, target tgt: BackboneElement)
{
    src -> tgt.type = 'save';
    src -> tgt.crfid = 'SD';

    src.entry as entry then
    {

    /* ------------------------------- Patient ---------------------------- */

        entry.resource as patient where "resource is Patient" then
        {   
            patient -> tgt.data as data then 
            {
                patient.gender as gender where "gender = 'female'" then
                {
                    patient -> data.blockindex = 0;
                    patient -> data.groupindex = 0;
                    patient -> data.itemid = 'id_1131';
                    gender -> data.values as values, values.value = 'weiblich'; 
                };
                patient.gender as gender where "gender = 'male'" then
                {
                    patient -> data.blockindex = 0;
                    patient -> data.groupindex = 0;
                    patient -> data.itemid = 'id_1131';
                    gender -> data.values as values, values.value = 'mÃ¤nnlich'; 
                };
                
                patient.gender as gender where "gender = 'X'" then
                {
                    patient -> data.blockindex = 0;
                    patient -> data.groupindex = 0;
                    patient -> data.itemid = 'id_1131';
                    gender -> data.values as values, values.value = 'divers'; 
                };
            };

            patient -> tgt.data as data then 
            {
                patient.address as address then
                {
                    patient -> data.blockindex = 0;
                    patient -> data.groupindex = 0;
                    patient -> data.itemid = 'id_1280';
                    address.country as country -> data.values as values, values.value = country;
                };
            };

            patient -> tgt.data as data then 
            {
                patient.deceasedDateTime as ddt then
                {
                    patient -> data.blockindex = 1;
                    patient -> data.groupindex = 0;
                    patient -> data.itemid = 'id_1298';
                    ddt -> data.values as values, values.value = ddt;
                };
            };

            patient -> tgt.data as data then 
            {
                patient.extension as infoq then 
                { 
                    patient.extension where "patient.extension.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/nNGM/izt'" then
                    {
                        patient -> data.blockindex = 1;
                        patient -> data.groupindex = 0;
                        patient -> data.itemid = 'id_2436';
                        infoq.valueCodeableConcept as vcc -> data.values as values, values.value = vcc;
                    };
                };
            };
        };


        entry.resource as coverage where "resource is Coverage" then
        {   
            //Krankenkasse
            coverage -> tgt.data as data then 
            {
                coverage.payor as payor then
                {
                    coverage -> data.blockindex = 2;
                    coverage -> data.groupindex = 0;
                    coverage -> data.itemid = 'id_2459';
                    payor.display as krankenkasse -> data.values as values, values.value = krankenkasse;
                };
            };

            //Typ
            coverage -> tgt.data as data then 
            {
                coverage.type as type then
                {
                    coverage -> data.blockindex = 2;
                    coverage -> data.groupindex = 0;
                    coverage -> data.itemid = 'id_1269';
                    type -> data.values as values, values.value = type;
                };
            };

            //Kooperationsvereinbarung
            coverage -> tgt.data as data then 
            {
                coverage.extension as type then
                {
                    coverage.extension where "patient.extension.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/nNGM/kooperationsvereinbarung'" then
                    {
                        coverage -> data.blockindex = 2;
                        coverage -> data.groupindex = 0;
                        coverage -> data.itemid = 'id_2460';
                        type -> data.values as values, values.value = type;
                    };
                };
            };
        };

        /* ------------------------------- EpisodeOfCare ---------------------------- */
        entry.resource as episodeofcare where "resource is EpisodeOfCare and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/EpisodeOfCare/nNGM'" then
        {   
            episodeofcare -> tgt.data as data then 
            {
                episodeofcare.extension as erstdiagnose then
                {
                    erstdiagnose.value as value where "$this.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/nNGM/nngmErstdiagnose'" then 
                    {
                       episodeofcare -> data.blockindex = 1;
                       episodeofcare -> data.groupindex = 0;
                       episodeofcare -> data.itemid = 'id_1297';
                       erstdiagnose -> data.values as values, values.value = value; 
                    };
                };
            };

            episodeofcare -> tgt.data as data then 
            {
                episodeofcare.extension as letzterkontakt then
                {
                    letzterkontakt.value as value where "$this.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/nNGM/abrechnungsinformation/letzterKontakt'" then 
                    {
                       episodeofcare -> data.blockindex = 1;
                       episodeofcare -> data.groupindex = 0;
                       episodeofcare -> data.itemid = 'id_803';
                       letzterkontakt -> data.values as values, values.value = value; 
                    };
                };
            };

            episodeofcare -> tgt.data as data then 
            {
                episodeofcare.status as status, status.extension as statusext then
                {
                    statusext.value as value where "$this.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/nNGM/nngmStatus'" then 
                    {
                       episodeofcare -> data.blockindex = 1;
                       episodeofcare -> data.groupindex = 0;
                       episodeofcare -> data.itemid = 'id_1139';
                       statusext.valueCodeableConcept as vcc, vcc.coding as coding, coding.code as value -> data.values as values, values.value = value; 
                    };
                };
            };
        };
    };
}