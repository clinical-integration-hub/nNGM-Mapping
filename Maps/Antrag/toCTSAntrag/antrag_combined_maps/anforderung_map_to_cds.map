/// version = 0.1
/// title = "nNGM: nNGM_Mapping_AnforderungCTS - FHIR to CTS"

map "http://uk-koeln.de/fhir/StructureMap/nNGM_Mapping_AnforderungCTS" = nNGM_Mapping_AnforderungCTS

uses "http://hl7.org/fhir/StructureDefinition/Bundle" as source
uses "http://hl7.org/fhir/StructureDefinition/CTS_Transport" as target

group TransformAnforderungOperation(source src: Bundle, target tgt: BackboneElement)
{
    src -> tgt.type = 'save';
    src -> tgt.crfid = '1_AF1';

    src.entry as entry then
    {
        entry.resource as specimen where "resource is Specimen and resource.id = '239592c0-a14a-41e1-bc95-d7fc80e3c3d6'" then 
        {
            //BiopsieID
            specimen -> tgt.data as data then
            {


                specimen -> data.blockindex = 5;
                specimen -> data.groupindex = 0;
                specimen -> data.itemid = 'id_1601';
                specimen -> data.values as values, values.unit = 'count', values.value = '1';
            };

            //Zu untersuchendes Material
            specimen -> tgt.data as data then
            {
               
                    
                        specimen -> data.blockindex = 0;
                        specimen -> data.groupindex = 0;
                        specimen -> data.itemid = 'id_2457';
                        specimen -> data.values as values, values.value = 'E123456/19';

            };

            // Entnahmedatum
            specimen -> tgt.data as data then
            {
                specimen.collection as collection then
                {

                        specimen -> data.blockindex = 1;
                        specimen -> data.groupindex = 0;
                        specimen -> data.itemid = 'id_1551';
                        specimen -> data.values as values, values.value = '2019-11-01';
                };
            };

            /*
            // Entnahmedatum
            specimen -> tgt.data as data then
            {
                specimen.collection as collection then
                {
                    collection.collectedDateTime as collectedDateTime then
                    {
                        specimen -> data.blockindex = 2;
                        specimen -> data.groupindex = 0;
                        specimen -> data.itemid = 'id_2316';
                        collectedDateTime -> data.values as values, values.value = collectedDateTime;
                    };
                };
            };
            */
        };

        /* ------------------------------ Observation ---------------------------- 
        entry.resource as observation where "resource is Observation and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/nNGM/histologie' and resource.id = ''" then 
        {
            //Histologie des vorbefunds
            observation -> tgt.data as data then
            {
                observation.valueCodeableConcept as vcc, vcc.coding as coding then
                {
                    observation -> data.blockindex = 1;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_836';
                    coding -> data.values as values, values.value = evaluate(coding, '$this.code + \'\\t\' + $this.display');
                };
            };

            // Histologie des vorbefunds (freitext?)
            observation -> tgt.data as data then
            {
                observation.valueCodeableConcept as vcc, vcc.coding as coding where "$this.valueCodeableConcept.coding.code = 'CUP'" then
                {
                    vcc.text as text then {
                        observation -> data.blockindex = 2;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2319';
                        coding.code -> data.values as values, values.value = evaluate(coding, '$this.code + \'\\t\' + $this.display');
                    };
                };
            };
        };/*

        /* ------------------------------ Organization ---------------------------- */
        entry.resource as organization where "resource is Organization and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Organization/clinical-site' and resource.id = '70c389c2-4cb6-445c-99f7-df982132c5ca'" then 
        {
            organization -> tgt.data as data then
            {
                organization.name as name then 
                {
                    organization -> data.blockindex = 4;
                    organization -> data.groupindex = 0;
                    organization -> data.itemid = 'id_1563';
                    name -> data.values as values, values.value = name;
                };
            };
            
            organization -> tgt.data as data then
            {
                organization.address as address then 
                {
                    address.name as text then 
                    {
                        organization -> data.blockindex = 4;
                        organization -> data.groupindex = 0;
                        organization -> data.itemid = 'id_1562';
                        text -> data.values as values, values.value = text;
                    };
                };
            };
        };


        /* ------------------------------ ServiceRequest ---------------------------- */
        entry.resource as servicerequest where "resource is ServiceRequest and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/ServiceRequest/nNGM/testung' and resource.status = 'active'" then 
        {
            // Diagnostik Typ
            servicerequest -> tgt.data as data then
            {
                servicerequest.category as category then
                {
                    category.coding as coding where "$this.coding.system = 'http://uk-koeln.de/fhir/ValueSet/nngm/tests'" then
                    {
                        servicerequest -> data.blockindex = 0;
                        servicerequest -> data.groupindex = 0;
                        servicerequest -> data.itemid = 'id_1368';
                        coding.code as code -> data.values as values, values.value = code;
                    };
                };
            };

            // Materialentnahme erfolgte
            servicerequest -> tgt.data as data then
            {
                servicerequest.extension as aufenthaltsart, aufenthaltsart.value as value where "$this.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/nNGM/aufenthaltsartAnforderung'" then
                {
                    aufenthaltsart.valueCodeableConcept as vcc, vcc.coding as coding, coding.code as code where "code = 'IMP'" then
                    {
                        servicerequest -> data.blockindex = 1;
                        servicerequest -> data.groupindex = 0;
                        servicerequest -> data.itemid  = 'id_1589';
                        code -> data.values as values, values.value = 'stationÃ¤r';
                    };
                    aufenthaltsart.valueCodeableConcept as vcc, vcc.coding as coding, coding.code as code where "code = 'AMB'" then
                    {
                        servicerequest -> data.blockindex = 1;
                        servicerequest -> data.groupindex = 0;
                        servicerequest -> data.itemid  = 'id_1589';
                        code -> data.values as values, values.value = 'ambulant';
                    };
                    aufenthaltsart.valueCodeableConcept as vcc, vcc.coding as coding, coding.code as code where "code = 'NA'" then
                    {
                        servicerequest -> data.blockindex = 1;
                        servicerequest -> data.groupindex = 0;
                        servicerequest -> data.itemid  = 'id_1589';
                        code -> data.values as values, values.value = 'N/A';
                    };
                };
            };
            
            //Tumorblockanforderung
            servicerequest -> tgt.data as data then
            {
                servicerequest.doNotPerform as dnp where "doNotPerform = true" then
                {
                    servicerequest -> data.blockindex = 4;
                    servicerequest -> data.groupindex = 0;
                    servicerequest -> data.itemid  = 'id_2476';
                    dnp -> data.values as values, values.value = 'no';
                };
            };

            servicerequest -> tgt.data as data then
            {
                servicerequest.doNotPerform as dnp where "doNotPerform = false" then
                {
                    servicerequest -> data.blockindex = 4;
                    servicerequest -> data.groupindex = 0;
                    servicerequest -> data.itemid  = 'id_2476';
                    dnp -> data.values as values, values.value = 'yes';
                };
            };

            //Grund zum entfallen der Tumorblockanforderung
            servicerequest -> tgt.data as data then
            {
                servicerequest.extension as entfallen, entfallen.value as value where "$this.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/nNGM/grundentfallen'" then 
                {
                    entfallen.valueCodeableConcept as vcc, vcc.coding as coding, coding.code as code then 
                    {
                        servicerequest -> data.blockindex = 4;
                        servicerequest -> data.groupindex = 0;
                        servicerequest -> data.itemid = 'id_2490';
                        code -> data.values as values, values.value = code;
                    };
                };
            };

            //Liquid Biopsy
            servicerequest -> tgt.data as data then
            {
                servicerequest.extension as liquidbiopsy then 
                {
                    liquidbiopsy.value as value where "$this.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/LiquidBiopsy'" then 
                    {
                        servicerequest -> data.blockindex = 3;
                        servicerequest -> data.groupindex = 0;
                        servicerequest -> data.itemid = 'id_2313';
                        liquidbiopsy -> data.values as values, values.value = value;
                    };
                };
            };

            //GrundFehlendeBiopsie
            servicerequest -> tgt.data as data then
            {
                servicerequest.extension as liquidbiopsy then 
                {
                    liquidbiopsy.value as value where "$this.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/GrundFehlendeBiopsieAnforderung'" then 
                    {
                        servicerequest -> data.blockindex = 3;
                        servicerequest -> data.groupindex = 0;
                        servicerequest -> data.itemid = 'id_2314';
                        liquidbiopsy -> data.values as values, values.value = value;
                    };
                };
            };

            //gewunschte diagnostik
            servicerequest -> tgt.data as data then
            {
                servicerequest.category as category, category.coding as coding where "coding.system = 'http://uk-koeln.de/fhir/ValueSet/nngm/diagnostikanforderung'" then                        
                {
                    servicerequest -> data.blockindex = 3;
                    servicerequest -> data.groupindex = 0;
                    servicerequest -> data.itemid = 'id_2473';
                    coding.code as diag -> data.values as values, values.value = diag; 
                };
            }; 

            //Tumorblock anforderung
            servicerequest -> tgt.data as data then
            {
                servicerequest.occurrenceDateTime as dt then 
                {
                        servicerequest -> data.blockindex = 4;
                        servicerequest -> data.groupindex = 0;
                        servicerequest -> data.itemid = 'id_2477';
                        dt -> data.values as values, values.value = dt;
                };
            };

            //wiederholungen
            servicerequest -> tgt.data as data then
            {
                servicerequest.occurrenceTiming as ot then  
                {
                    ot.repeat as repeat then 
                    {
                        servicerequest -> data.blockindex = 4;
                        servicerequest -> data.groupindex = 0;
                        servicerequest -> data.itemid = 'id_2478';
                        repeat.count as count -> data.values as values, values.value = count;
                    };
                };
            };

            //storno
            servicerequest -> tgt.data as data then
            {
                servicerequest.extension as storno then 
                {
                    storno.value as value where "$this.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/storno'" then 
                    {
                        servicerequest -> data.blockindex = 4;
                        servicerequest -> data.groupindex = 0;
                        servicerequest -> data.itemid = 'id_2479';
                        storno.valueDateTime as dt -> data.values as values, values.value = dt;
                    };
                };
            };

            //versandmaterial
            servicerequest -> tgt.data as data then
            {
                servicerequest.extension as versandmaterial then 
                {
                    versandmaterial.value as value where "$this.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/versandmaterial'" then 
                    {
                        servicerequest -> data.blockindex = 4;
                        servicerequest -> data.groupindex = 0;
                        servicerequest -> data.itemid = 'id_2480';
                        versandmaterial.valueDateTime as dt -> data.values as values, values.value = dt;
                    };
                };
            };
        };
    };
}