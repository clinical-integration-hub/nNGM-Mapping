/// version = 0.1
/// title = "nNGM: Mapping Resistenztestung CTS"
/// FHIR -> CTS

map "http://uk-koeln.de/fhir/StructureMap/nNGM_Mapping_ResistenztestungCTS" = nNGM_Mapping_ResistenztestungCTS

uses "http://hl7.org/fhir/StructureDefinition/Bundle" as source
uses "http://hl7.org/fhir/StructureDefinition/CTS_Transport" as target

group TransformResistenztestungCTS(source src: Bundle, target tgt: BackboneElement)
{
    src -> tgt.crfid = '*-RT1';
    src -> tgt.type = 'save';

    src.entry as entry, entry.resource as observations then
    {
        // EpisodeOfCare
        src.entry as entry, entry.resource as specimen where "resource is Specimen and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Specimen/nNGM'" then
        {
            specimen.identifier as identifier then
            {
                identifier.value as value where "$this.system = 'http://uk-koeln.de/NamingSystem/nNGM/biopsienummer' and %tgt.data.where(itemid = 'id_1601').exists().not()" -> tgt.data as data then
                {
                    specimen -> data.blockindex = 2;
                    specimen -> data.groupindex = 0;
                    specimen -> data.itemid = 'id_1601';
                    value -> data.values as values, values.value = value, values.unit = 'count';
                };
            };
        };

        // Progress/Reizidiv Krebserkrankung Observation
        observations as observation where "$this.code.coding.code = 'C25630'" then
        {
            // Observation.valueBoolean -> 0, 0, 1573
            observation -> tgt.data as data then
            {
                // Rezidiv = True
                observation.valueBoolean as rezidivprogress where "$this.valueBoolean = true" then
                {
                    observation -> data.blockindex = 0;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_1573';
                    observation -> data.values as values, values.value = 'yes';
                };
                
                // Rezidiv = False
                observation.valueBoolean as rezidivprogress where "$this.valueBoolean = false" then
                {
                    observation -> data.blockindex = 0;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_1573';
                    observation -> data.values as values, values.value = 'no';
                };
            };

            // Observation.effectiveDateTime -> 0, 0, 2397
            observation -> tgt.data as data then
            {
                observation.effectiveDateTime as effectiveDateTime where "$this.effectiveDateTime.empty() = false" then
                {
                    effectiveDateTime -> data.blockindex = 0;
                    effectiveDateTime -> data.groupindex = 0;
                    effectiveDateTime -> data.itemid = 'id_2397';
                    effectiveDateTime -> data.values as values, values.value = effectiveDateTime;
                };
            };
        };

        // Observation EGFR
        observations as observation where "$this.code.coding.code = 'C134501'" then
        {
            // Observation.effectiveDateTime -> 1, 0, 2502
            observation then TransformEffectiveDateTimeObservation(observation, tgt);

            // Mutations
            observation then TransformMutationsCTSResistenztestung(observation, tgt);

            // Therapy components
            observation.component as components -> tgt.data as data then 
            {
                // 1. Therapie
                components as component where "$this.extension.valueInteger = 1" -> tgt.data as data then
                {   
                    component -> data.blockindex = 1;
                    component -> data.groupindex = 0;
                    component -> data.itemid = 'id_1441';
                    component.valueCodeableConcept as valueCodeableConcept, valueCodeableConcept.text as text -> data.values as values, values.value = text;
                };

                // 2. Therapie
                components as component where "$this.extension.valueInteger = 2" -> tgt.data as data then
                {   
                    component -> data.blockindex = 1;
                    component -> data.groupindex = 0;
                    component -> data.itemid = 'id_1442';
                    component.valueCodeableConcept as valueCodeableConcept, valueCodeableConcept.text as text -> data.values as values, values.value = text;
                };

                // 3. Therapie
                components as component where "$this.extension.valueInteger = 3" -> tgt.data as data then
                {   
                    component -> data.blockindex = 1;
                    component -> data.groupindex = 0;
                    component -> data.itemid = 'id_1443';
                    component.valueCodeableConcept as valueCodeableConcept, valueCodeableConcept.text as text -> data.values as values, values.value = text;
                };

                // 4. Therapie
                components as component where "$this.extension.valueInteger = 4" -> tgt.data as data then
                {   
                    component -> data.blockindex = 1;
                    component -> data.groupindex = 0;
                    component -> data.itemid = 'id_1444';
                    component.valueCodeableConcept as valueCodeableConcept, valueCodeableConcept.text as text -> data.values as values, values.value = text;
                };
            };
        };

        // Observation ALK
        observations as observation where "$this.code.coding.code = 'C142114'" then
        {
            // Observation.effectiveDateTime -> 1, 0, 2502
            observation then TransformEffectiveDateTimeObservation(observation, tgt);
            
            // Mutations
            observation then TransformMutationsCTSResistenztestung(observation, tgt);

            // Therapies and fusionPartner
            observation.component as components -> tgt.data as data then 
            {
                // Observation.Fusionpartner -> 1, 0, 2504
                components as component where "$this.code.coding.code = 'C28510'" -> tgt.data as data then
                {   
                    component -> data.blockindex = 1;
                    component -> data.groupindex = 0;
                    component -> data.itemid = 'id_2504';
                    component.valueString as valueString -> data.values as values, values.value = valueString;
                };

                // 1. Therapie
                components as component where "$this.extension.valueInteger = 1" -> tgt.data as data then
                {   
                    component -> data.blockindex = 1;
                    component -> data.groupindex = 0;
                    component -> data.itemid = 'id_1447';
                    component.valueCodeableConcept as valueCodeableConcept, valueCodeableConcept.text as text -> data.values as values, values.value = text;
                };

                // 2. Therapie
                components as component where "$this.extension.valueInteger = 2" -> tgt.data as data then
                {   
                    component -> data.blockindex = 1;
                    component -> data.groupindex = 0;
                    component -> data.itemid = 'id_1448';
                    component.valueCodeableConcept as valueCodeableConcept, valueCodeableConcept.text as text -> data.values as values, values.value = text;
                };

                // 3. Therapie
                components as component where "$this.extension.valueInteger = 3" -> tgt.data as data then
                {   
                    component -> data.blockindex = 1;
                    component -> data.groupindex = 0;
                    component -> data.itemid = 'id_1449';
                    component.valueCodeableConcept as valueCodeableConcept, valueCodeableConcept.text as text -> data.values as values, values.value = text;
                };

                // 4. Therapie
                components as component where "$this.extension.valueInteger = 4" -> tgt.data as data then
                {   
                    component -> data.blockindex = 1;
                    component -> data.groupindex = 0;
                    component -> data.itemid = 'id_1450';
                    component.valueCodeableConcept as valueCodeableConcept, valueCodeableConcept.text as text -> data.values as values, values.value = text;
                };
            };
        };

        // Observation ROS1
        observations as observation where "$this.code.coding.code = 'C131071'" then
        {
            // Observation.effectiveDateTime -> 1, 0, 2502
            observation then TransformEffectiveDateTimeObservation(observation, tgt);

            // Mutations
            observation then TransformMutationsCTSResistenztestung(observation, tgt);

            // Therapies and fusionPartner
            observation.component as components -> tgt.data as data then 
            {
                // Observation.Fusionpartner -> 1, 0, 2506
                components as component where "$this.code.coding.code = 'C28510'" -> tgt.data as data then
                {   
                    component -> data.blockindex = 1;
                    component -> data.groupindex = 0;
                    component -> data.itemid = 'id_2506';
                    component.valueString as valueString -> data.values as values, values.value = valueString;
                };

                // 1. Therapie
                components as component where "$this.extension.valueInteger = 1" -> tgt.data as data then
                {   
                    component -> data.blockindex = 1;
                    component -> data.groupindex = 0;
                    component -> data.itemid = 'id_1453';
                    component.valueCodeableConcept as valueCodeableConcept, valueCodeableConcept.text as text -> data.values as values, values.value = text;
                };

                // 2. Therapie
                components as component where "$this.extension.valueInteger = 2" -> tgt.data as data then
                {   
                    component -> data.blockindex = 1;
                    component -> data.groupindex = 0;
                    component -> data.itemid = 'id_1454';
                    component.valueCodeableConcept as valueCodeableConcept, valueCodeableConcept.text as text -> data.values as values, values.value = text;
                };

                // 3. Therapie
                components as component where "$this.extension.valueInteger = 3" -> tgt.data as data then
                {   
                    component -> data.blockindex = 1;
                    component -> data.groupindex = 0;
                    component -> data.itemid = 'id_1455';
                    component.valueCodeableConcept as valueCodeableConcept, valueCodeableConcept.text as text -> data.values as values, values.value = text;
                };

                // 4. Therapie
                components as component where "$this.extension.valueInteger = 4" -> tgt.data as data then
                {   
                    component -> data.blockindex = 1;
                    component -> data.groupindex = 0;
                    component -> data.itemid = 'id_1456';
                    component.valueCodeableConcept as valueCodeableConcept, valueCodeableConcept.text as text -> data.values as values, values.value = text;
                };
            };
        };
    };
}

group TransformEffectiveDateTimeObservation(source observation: Observation, target tgt: BackboneElement)
{
    observation -> tgt.data as data then 
    {
        observation.effectiveDateTime as effectiveDateTime where "$this.effectiveDateTime.empty() = false and %tgt.data.where(itemid = 'id_2502').exists().not()" then
        {
            effectiveDateTime -> data.blockindex = 1;
            effectiveDateTime -> data.groupindex = 0;
            effectiveDateTime -> data.itemid = 'id_2502';
            effectiveDateTime -> data.values as values, values.value = effectiveDateTime;
        };
    };
}

group TransformMutationsCTSResistenztestung(source observation: Observation, target tgt: BackboneElement)
{
    observation then
    {
        // Mutations 
        // Observation.component.exon -> 1, 0, 1436
        observation.component as components where "%tgt.data.where(itemid = 'id_1436').exists().not()" then 
        {
            components as component where "$this.code.coding.code = 'C13231'" then
            {
                component -> tgt.data as data then
                {   
                    observation -> data.blockindex = 1;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_1436';
                    component.valueString as valuestring -> data.values as values, values.value = valuestring;
                };
            };
        };

        // Observation.component.hgvsc -> 1, 0, 1437
        observation.component as components where "%tgt.data.where(itemid = 'id_1437').exists().not()" then 
        {
            components as component where "$this.code.coding.code = '48004-6'" then 
            {
                component -> tgt.data as data then
                {   
                    observation -> data.blockindex = 1;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_1437';
                    component.valueString as valuestring -> data.values as values, values.value = valuestring;
                };
            };
        };

        // Observation.component.hgvsp -> 1, 0, 1438
        observation.component as components where "%tgt.data.where(itemid = 'id_1438').exists().not()" then 
        {
            components as component where "$this.code.coding.code = '48005-3'" then 
            {
                component -> tgt.data as data then
                {   
                    observation -> data.blockindex = 1;
                    observation -> data.groupindex = 0;
                    observation -> data.itemid = 'id_1438';
                    component.valueString as valuestring -> data.values as values, values.value = valuestring;
                };
            };
        };
    };
}