/// version = 0.1
/// title = "nNGM: Mapping Resistenztestung CTS"

map "http://uk-koeln.de/fhir/StructureMap/nNGM_Mapping_ResistenztestungCTS" = nNGM_Mapping_ResistenztestungCTS

uses "http://hl7.org/fhir/StructureDefinition/Bundle" as source
uses "http://hl7.org/fhir/StructureDefinition/CTS_Transport" as target

group TransformCTS(source src: Bundle, target tgt: CTS_Transport)
{
    src -> tgt.version = '1.1';
    src -> tgt.sourcesystem = 'https:\/\/nngm-qat.staging.healex.systems\/';

    src -> tgt.operations as operations collate, operations.crfid = '*-RT1';
    src -> tgt.operations as operations collate, operations.type = 'save';

    src.entry as entry then
    {
        //Specimen
        entry.resource as specimen where "resource is Specimen" then
        {
            //Biopsie-ID
            specimen -> tgt.operations as operations collate then
            {
                specimen -> operations.data as data then
                {
                    specimen.identifier as biopsieID then
                    {   
                        biopsieID.value as bid then
                        {
                            specimen -> data.blockindex = 2;
                            specimen -> data.groupindex = 0;
                            specimen -> data.itemid = 'id_1601';
                            biopsieID -> data.values as values, values.value = bid;
                        };
                    };
                };
            };
        };
        //Condition
        entry.resource as condition where "resource is Condition" then
        {
            condition -> tgt.operations as operations collate then
            {
                condition -> operations.data as data then
                {
                    condition.clinicalStatus as clinicalstatus, clinicalstatus.coding as coding then
                    {
                        coding.code as code where "code = 'recurrence'" then
                        {
                            condition -> data.blockindex = 0;
                            condition -> data.groupindex = 0;
                            condition -> data.itemid = 'id_1573';
                            code -> data.values as values, values.value = 'yes';
                        };

                        coding.code as code where "code = 'relapse'" then
                        {
                            condition -> data.blockindex = 0;
                            condition -> data.groupindex = 0;
                            condition -> data.itemid = 'id_1573';
                            code -> data.values as values, values.value = 'no';
                        };
                    };
                };
            };
            condition -> tgt.operations as operations collate then
            {
                condition -> operations.data as data then
                {
                    condition.recordedDate as recordedDate where "$this.recordedDate.empty() = false" then
                    {
                        condition -> data.blockindex = 0;
                        condition -> data.groupindex = 0;
                        condition -> data.itemid = 'id_2397';
                        recordedDate -> data.values as values, values.value = recordedDate;
                    };
                };
            };
        };
        //Observation
        entry.resource as observation where "resource is Observation" then
        {
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueString as valuestring where "code.coding.code = 'exon'" then
                        {
                            observation -> data.blockindex = 0;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_1436';
                            valuestring -> data.values as values, values.value = valuestring;
                        };
                    }; 
                };
            };
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueString as valuestring where "code.coding.code = 'c'" then
                        {
                            observation -> data.blockindex = 0;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_1437';
                            valuestring -> data.values as values, values.value = valuestring;
                        };
                    }; 
                };
            };
            observation -> tgt.operations as operations collate then
            {
                observation -> operations.data as data then
                {
                    observation.component as component then
                    {   
                        component.valueString as valuestring where "code.coding.code = 'p'" then
                        {
                            observation -> data.blockindex = 0;
                            observation -> data.groupindex = 0;
                            observation -> data.itemid = 'id_1438';
                            valuestring -> data.values as values, values.value = valuestring;
                        };
                    }; 
                };
            };
        };
        //Medicalstatements
        entry.resource as medicationstatement where "resource is MedicationStatement" then
        {
            medicationstatement -> tgt.operations as operations collate then
            {
                medicationstatement -> operations.data as data then
                {
                    medicationstatement.medicationCodeableConcept as concept where "category.coding.code = 'EGFR'" then
                    {
                        medicationstatement.extension as therapielinie then
                        {
                            therapielinie.valuePositiveInt as therapielinieValue where "url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/cancer-base/therapielinie' and valuePositiveInt = 1" then
                            {
                                medicationstatement -> data.blockindex = 1;
                                medicationstatement -> data.groupindex = 0;
                                medicationstatement -> data.itemid = 'id_1441';
                                concept.text as text -> data.values as values, values.value = text;
                            };
                            therapielinie.valuePositiveInt as therapielinieValue where "url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/cancer-base/therapielinie' and valuePositiveInt = 2" then
                            {
                                medicationstatement -> data.blockindex = 1;
                                medicationstatement -> data.groupindex = 0;
                                medicationstatement -> data.itemid = 'id_1442';
                                concept.text as text -> data.values as values, values.value = text;
                            };
                            therapielinie.valuePositiveInt as therapielinieValue where "url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/cancer-base/therapielinie' and valuePositiveInt = 3" then
                            {
                                medicationstatement -> data.blockindex = 1;
                                medicationstatement -> data.groupindex = 0;
                                medicationstatement -> data.itemid = 'id_1443';
                                concept.text as text -> data.values as values, values.value = text;
                            };
                            therapielinie.valuePositiveInt as therapielinieValue where "url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/cancer-base/therapielinie' and valuePositiveInt = 4" then
                            {
                                medicationstatement -> data.blockindex = 1;
                                medicationstatement -> data.groupindex = 0;
                                medicationstatement -> data.itemid = 'id_1444';
                                concept.text as text -> data.values as values, values.value = text;
                            };
                        };

                    };
                };
            };
            medicationstatement -> tgt.operations as operations collate then
            {
                medicationstatement -> operations.data as data then
                {
                    medicationstatement.medicationCodeableConcept as concept where "category.coding.code = 'ALK'" then
                    {
                        medicationstatement.extension as therapielinie then
                        {
                            therapielinie.valuePositiveInt as therapielinieValue where "url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/cancer-base/therapielinie' and valuePositiveInt = 1" then
                            {
                                medicationstatement -> data.blockindex = 1;
                                medicationstatement -> data.groupindex = 0;
                                medicationstatement -> data.itemid = 'id_1447';
                                concept.text as text -> data.values as values, values.value = text;
                            };
                             therapielinie.valuePositiveInt as therapielinieValue where "url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/cancer-base/therapielinie' and valuePositiveInt = 2" then
                            {
                                medicationstatement -> data.blockindex = 1;
                                medicationstatement -> data.groupindex = 0;
                                medicationstatement -> data.itemid = 'id_1448';
                                concept.text as text -> data.values as values, values.value = text;
                            };
                            therapielinie.valuePositiveInt as therapielinieValue where "url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/cancer-base/therapielinie' and valuePositiveInt = 3" then
                            {
                                medicationstatement -> data.blockindex = 1;
                                medicationstatement -> data.groupindex = 0;
                                medicationstatement -> data.itemid = 'id_1449';
                                concept.text as text -> data.values as values, values.value = text;
                            };
                            therapielinie.valuePositiveInt as therapielinieValue where "url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/cancer-base/therapielinie' and valuePositiveInt = 4" then
                            {
                                medicationstatement -> data.blockindex = 1;
                                medicationstatement -> data.groupindex = 0;
                                medicationstatement -> data.itemid = 'id_1450';
                                concept.text as text -> data.values as values, values.value = text;
                            };
                        };
                    };
                };
            };

            medicationstatement -> tgt.operations as operations collate then
            {
                medicationstatement -> operations.data as data then
                {
                    medicationstatement.medicationCodeableConcept as concept where "category.coding.code = 'ALK'" then
                    {
                        medicationstatement.extension as fusionpartnerextension where "%tgt.operations.data.where(itemid = 'id_2504').exists().not()" then
                        {
                            fusionpartnerextension.valueString as fusionpartner where "url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/nngm/fusionspartner'" then
                            {
                                medicationstatement -> data.blockindex = 1;
                                medicationstatement -> data.groupindex = 0;
                                medicationstatement -> data.itemid = 'id_2504';
                                fusionpartner -> data.values as values, values.value = fusionpartner;
                            };
                        };
                    };
                };
            };
           
            medicationstatement -> tgt.operations as operations collate then
            {
                medicationstatement -> operations.data as data then
                {
                    medicationstatement.medicationCodeableConcept as concept where "category.coding.code = 'ROS1'" then
                    {
                        medicationstatement.extension as therapielinie then
                        {
                            therapielinie.valuePositiveInt as therapielinieValue where "url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/cancer-base/therapielinie' and valuePositiveInt = 1" then
                            {
                                medicationstatement -> data.blockindex = 1;
                                medicationstatement -> data.groupindex = 0;
                                medicationstatement -> data.itemid = 'id_1453';
                                concept.text as text -> data.values as values, values.value = text;
                            };
                            therapielinie.valuePositiveInt as therapielinieValue where "url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/cancer-base/therapielinie' and valuePositiveInt = 2" then
                            {
                                medicationstatement -> data.blockindex = 1;
                                medicationstatement -> data.groupindex = 0;
                                medicationstatement -> data.itemid = 'id_1454';
                                concept.text as text -> data.values as values, values.value = text;
                            };
                            therapielinie.valuePositiveInt as therapielinieValue where "url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/cancer-base/therapielinie' and valuePositiveInt = 3" then
                            {
                                medicationstatement -> data.blockindex = 1;
                                medicationstatement -> data.groupindex = 0;
                                medicationstatement -> data.itemid = 'id_1455';
                                concept.text as text -> data.values as values, values.value = text;
                            };
                             therapielinie.valuePositiveInt as therapielinieValue where "url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/cancer-base/therapielinie' and valuePositiveInt = 4" then
                            {
                                medicationstatement -> data.blockindex = 1;
                                medicationstatement -> data.groupindex = 0;
                                medicationstatement -> data.itemid = 'id_1456';
                                concept.text as text -> data.values as values, values.value = text;
                            };
                        };
                        
                    };
                };
            };
            medicationstatement -> tgt.operations as operations collate then
            {
                medicationstatement -> operations.data as data then
                {
                    medicationstatement.medicationCodeableConcept as concept where "category.coding.code = 'ROS1'" then
                    {
                        medicationstatement.extension as fusionpartnerextension where "%tgt.operations.data.where(itemid = 'id_2506').exists().not()" then
                        {
                            fusionpartnerextension.valueString as fusionpartner where "url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/nngm/fusionspartner'" then
                            {
                                medicationstatement -> data.blockindex = 1;
                                medicationstatement -> data.groupindex = 0;
                                medicationstatement -> data.itemid = 'id_2506';
                                fusionpartner -> data.values as values, values.value = fusionpartner;
                            };
                        };
                    };
                };
            };
            medicationstatement -> tgt.operations as operations collate then
            {
                medicationstatement -> operations.data  as data then
                {
                    medicationstatement.medicationCodeableConcept as concept where "category.coding.code = 'ROS1' or category.coding.code = 'ALK' or category.coding.code = 'EGFR'" then
                    {
                        medicationstatement.medicationCodeableConcept as concept where "%tgt.operations.data.where(itemid = 'id_1434').exists().not()" then
                        {
                            medicationstatement -> data.blockindex = 1;
                            medicationstatement -> data.groupindex = 0;
                            medicationstatement -> data.itemid = 'id_1434';
                        };
                        medicationstatement.medicationCodeableConcept as concept where "%tgt.operations.data.where(itemid = 'id_1434').values.where(value = 'EGFR').exists().not()" then
                        {
                            medicationstatement -> data.values as values, values.value = 'EGFR';
                        };
                        medicationstatement.medicationCodeableConcept as concept where "%tgt.operations.data.where(itemid = 'id_1434').values.where(value = 'ALK').exists().not()" then
                        {
                            medicationstatement -> data.values as values, values.value = 'ALK';
                        };
                        medicationstatement.medicationCodeableConcept as concept where "%tgt.operations.data.where(itemid = 'id_1434').values.where(value = 'ROS1').exists().not()" then
                        {
                            medicationstatement -> data.values as values, values.value = 'ROS1';
                        };
                    };
                };
            };
        };
    };
}