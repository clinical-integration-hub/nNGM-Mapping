/// version = 0.1
/// title = Systematische Therapie
/// title = "nNGM: Mapping Stammdaten FHIR"


/* To Do 
-Translate not working
*/

map "http://uk-koeln.de/fhir/StructureMap/nNGM_Mapping_SystemischeTherapieFHIR" = nNGM_Mapping_SystemischeTherapieFHIR

uses "http://hl7.org/fhir/StructureDefinition/CTS_Transport" as source
uses "http://hl7.org/fhir/StructureDefinition/MedicationAdministration" as target
uses "http://hl7.org/fhir/StructureDefinition/Organization" as target
uses "http://hl7.org/fhir/StructureDefinition/Observation" as target
uses "http://hl7.org/fhir/StructureDefinition/EpisodeOfCare" as target
uses "http://hl7.org/fhir/StructureDefinition/Bundle" as target

group TransformBundle(source src: CTS_Transport, target bundle: Bundle)
{   
    //metadata
    src -> bundle.id = uuid();
    src -> bundle.type = 'collection';

    //resources
    src -> bundle.entry as entry then CreateTransformMedicationAdministrationTherapie(src, entry);
    src -> bundle.entry as entry then CreateEpisodeOfCareSystemischeTherapie(src, entry);
    src -> bundle.entry as entry then CreateOrganizationSystemischeTherapie(src, entry);
    src -> bundle.entry as entry then CreateObservationECOGSystemischeTherapie(src, entry);
    src -> bundle.entry as entry then CreateObservationBestResponseSystemischeTherapie(src, entry);

}


/* ------------------------------ MedicationAdministration ---------------------------- */

group CreateTransformMedicationAdministrationTherapie(source src: CTS_Transport, target tgt: BackboneElement)
{
    src.operations as operations, operations.data as data then
    {
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'id_1246'
                                    or blockindex = 2 and groupindex = 0 and itemid = 'id_1243'
                                    or blockindex = 1 and groupindex = 0 and itemid = 'id_2337'
                                    or blockindex = 1 and groupindex = 0 and itemid = 'id_2338'
                                    or blockindex = 2 and groupindex = 0 and itemid = 'id_2341'
                                    or blockindex = 2 and groupindex = 0 and itemid = 'id_1245'
                                    or blockindex = 2 and groupindex = 0 and itemid = 'id_1246'" then
        {
            src -> tgt.resource = create('MedicationAdministration') as medicationadministration then TransformMedicationAdministration(src, observation);
        };
    };
}

group TransformMedicationAdministration(source src: CTS_Transport, target tgt: MedicationAdministration)
{
    src -> tgt.id = uuid();
    src -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Procedure/nNGM/MedicationAdministration';

     //status 
    src -> tgt.status as encounter, 
           encounter.reference as reference, 
           reference.extension as dataAbsentReason, 
           dataAbsentReason.url = 'http://hl7.org/fhir/StructureDefinition/data-absent-reason', 
           dataAbsentReason.valueCode = cast('not-asked', 'FHIR.code');

    //subject
    src.patid as patid -> tgt.subject = create('Reference') as subject, subject.reference = evaluate(patid, '\'Patient/\' + $this');

   
    src.operations as operations, operations.data as data then
    {
        //effective period
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'id_1246'" then
        {
            values.value as value -> tgt.gender = dateOp(value, 'dateTime);
        };

        //extenson intention Therapie
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'id_1243'" then
        {
           tgt.extension as intention collate, 
           intention.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/cancer-base/intention-therapie', 
           intention.valueCodeableConcept as value = cc('http://uk-koeln.de/fhir/ValueSet/nngm/intention-therapie', value);
        };
        
        //extension hilfreich
        data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'id_2337'" then
        {
           tgt.extension as hilfreich collate, 
           hilfreich.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/hilfreich', 
           hilfreich.valueCodeableConcept as value = cc('http://uk-koeln.de/fhir/ValueSet/nngm/hilfreich', value);
        };

        //extension umgesetzt
        data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'id_2338'" then
        {
           tgt.extension as umgesetzt collate, 
           umgesetzt.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/umgesetzt', 
           umgesetzt.valueCodeableConcept as value = cc('http://uk-koeln.de/fhir/ValueSet/nngm/umgesetzt', value);
        };

        //extension off label Therapie
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'id_2341'" then
        {
           tgt.extension as offlabel collate, 
           offlabel.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/nNGM/off-label-therapie', 
           offlabel.valueBoolean as value = cast(value, 'FHIR.boolean');
        };

        //studien therapie
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'id_1245'" then
        {
           tgt.extension as studientherapie collate,
           studientherapie.extension as teilnahme,  
           teilnahme.url = 'teilnahme', 
           teilnahme.valueBoolean as value = cast(value, 'FHIR.boolean');
        };
        
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'id_1244'" then
        {
           tgt.extension as studientherapie collate,
           studientherapie.extension as studie,  
           studie.url = 'studie', 
           studie.valueBoolean as value = cast(value, 'FHIR.boolean');
        };
    };
}

/* ------------------------------ Observation ---------------------------- */

group CreateObservationBestResponseSystemischeTherapie(source src: CTS_Transport, target tgt: BackboneElement)
{
    src.operations as operations, operations.data as data then
    {
        data.values as values where "blockindex = 5 and groupindex = 0 and itemid = 'id_1354'
                                 or blockindes = 5 and groupindex = 0 and itemid = 'id_1355" then
        {
            src -> tgt.resource = create('Observation') as observation then TransformObservationBestResponseSystemischeTherapie(src, observation);
        };
    };
}

group TransformObservationBestResponseSystemischeTherapie(source src: CTS_Transport, target tgt: Observation)
{
    src -> tgt.id = uuid();
    src -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/nNGM/best-response';

    //status 
    src -> tgt.status as encounter, 
           encounter.reference as reference, 
           reference.extension as dataAbsentReason, 
           dataAbsentReason.url = 'http://hl7.org/fhir/StructureDefinition/data-absent-reason', 
           dataAbsentReason.valueCode = cast('not-asked', 'FHIR.code');

    //category
    src -> tgt.category as encounter, 
           encounter.reference as reference, 
           reference.extension as dataAbsentReason, 
           dataAbsentReason.url = 'http://hl7.org/fhir/StructureDefinition/data-absent-reason', 
           dataAbsentReason.valueCode = cast('not-asked', 'FHIR.code');

    //code
    src -> tgt.code as encounter, 
           encounter.reference as reference, 
           reference.extension as dataAbsentReason, 
           dataAbsentReason.url = 'http://hl7.org/fhir/StructureDefinition/data-absent-reason', 
           dataAbsentReason.valueCode = cast('not-asked', 'FHIR.code');

    //subject
    src.patid as patid -> tgt.subject = create('Reference') as subject, subject.reference = evaluate(patid, '\'Patient/\' + $this');

    //encounter
    src -> tgt.encounter as encounter, 
           encounter.reference as reference, 
           reference.extension as dataAbsentReason, 
           dataAbsentReason.url = 'http://hl7.org/fhir/StructureDefinition/data-absent-reason', 
           dataAbsentReason.valueCode = cast('not-asked', 'FHIR.code');

    src.operations as operations, operations.data as data then
    {
        //recist
        data.values as values where "blockindex = 5 and groupindex = 0 and itemid = 'id_1354'" then
        {
            values.value as value -> tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/cancer-base/recist',  value);
        };

        //beurteilung
        data.values as values where "blockindex = 5 and groupindex = 0 and itemid = 'id_1355'" then
        {
            values.value as country -> tgt.method as method = cc('http://uk-koeln.de/fhir/ValueSet/nngm/systemischeTherapie/beurteilung',  value);
        };
    };
}

group CreateObservationECOGSystemischeTherapie(source src: CTS_Transport, target tgt: BackboneElement)
{
    src.operations as operations, operations.data as data then
    {
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'id_2415'" then
        {
            src -> tgt.resource = create('Observation') as observation then TransformObservationECOGSystemischeTherapie(src, observation);
        };
    };
}

group TransformObservationECOGSystemischeTherapie(source src: CTS_Transport, target tgt: Observation)
{
    src -> tgt.id = uuid();
    src -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/nNGM/ecog';

    //status 
    src -> tgt.status = cast('final', 'FHIR.code');

    //category
    src -> tgt.category = cc('http://hl7.org/fhir/observation-category', 'survey');

    //code
    src -> tgt.code = cc('http://loinc.org', '89247-1');

    //subject
    src.patid as patid -> tgt.subject = create('Reference') as subject, subject.reference = evaluate(patid, '\'Patient/\' + $this');

    //encounter
    src -> tgt.encounter as encounter, 
           encounter.reference as reference, 
           reference.extension as dataAbsentReason, 
           dataAbsentReason.url = 'http://hl7.org/fhir/StructureDefinition/data-absent-reason', 
           dataAbsentReason.valueCode = cast('not-asked', 'FHIR.code');

    //ecog -> valueQuantity
    src.operations as operations, operations.data as data then
    {
        
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'id_2415'" then
        {
            values.value where "$this.value = '0 - normale, uneingeschränkte Aktivität, wie vor der Erkrankung'" then 
            {
                values.value as ecog -> tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/ecog', ecog); 
            };

            values.value where "$this.value = '1 - Einschränkung bei körperlicher Anstrengung, gehfähig, leichte körperliche Arbeit möglich'" then 
            {
                values.value as ecog -> tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/ecog', ecog); 
            };

            values.value where "$this.value = '2 - gehfähig, Selbstversorgung möglich, aber nicht arbeitsfähig, kann mehr als 50% der Wachzeit aufstehen'" then 
            {
                values.value as ecog -> tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/ecog', ecog); 
            };

            values.value where "$this.value = '3 - nur begrenzte Selbstversorgung möglich, 50% oder mehr der Wachzeit an Bett oder Stuhl gebunden'" then 
            {
                values.value as ecog -> tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/ecog', ecog); 
            };

            values.value where "$this.value = '4 - völlig pflegebedürftig, keinerlei Selbstversorgung möglich, völlig an Bett oder Stuhl gebunden'" then 
            {
                values.value as ecog -> tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/ecog', ecog); 
            };
        };
    };
}


/* ------------------------------ Organization ---------------------------- */

/*check if there is a OrganizationReferenzen required*/
group CreateOrganizationSystemischeTherapie(source src: CTS_Transport, target tgt: BackboneElement)
{
    src.operations as operations, operations.data as data then
    {
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'id_1242'" then
        {
            src -> tgt.resource = create('Organization') as organization then TransformOrganizationSystemischeTherapie(src, organization);
        };
    };
}

group TransformOrganizationSystemischeTherapie(source src: CTS_Transport, target tgt: Organization)
{
    src -> tgt.id = uuid();
    src -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Organization/clinical-site';

    src.operations as operations, operations.data as data then
    {
        //Netzwerkzentrum-id
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'id_1242'" then
        {
            values.value as netzwerkzentrumid -> tgt.identifier = id('http://fhir.de/NamingSystem/asv/teamnummer', netzwerkzentrumid);
        };
    };
}

/* ------------------------------ EpisodeOfCare ---------------------------- */

/*check if there is a EpisodeOfCare required*/
group CreateEpisodeOfCareSystemischeTherapie(source src: CTS_Transport, target tgt: BackboneElement)
{
    src.operations as operations, operations.data as data then
    {
        data.values as values where "blockindex = 0 and groupindex = 0 and itemid = 'id_1600'" then
        {
            src -> tgt.resource = create('EpisodeOfCare') as episodeofcare then TransformEpisodeOfCareSystemischeTherapie(src, episodeofcare);
        };
    };
}

group TransformEpisodeOfCareSystemischeTherapie(source src: CTS_Transport, target tgt: EpisodeOfCare)
{
    src -> tgt.id = uuid();
    src -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/EpisodeOfCare/nNGM';

    //status 
    src -> tgt.status as code, 
            code.extension as dataAbsentReason, 
            dataAbsentReason.url = 'http://hl7.org/fhir/StructureDefinition/data-absent-reason', 
            dataAbsentReason.valueCode = cast('not-asked', 'FHIR.code');

    //subject
    src.patid as patid -> tgt.patient = create('Reference') as subject, subject.reference = evaluate(patid, '\'Patient/\' + $this');

    src.operations as operations, operations.data as data then
    {
        //Diagnostik Fall ID
        data.values as values where "blockindex = 0 and groupindex = 0 and itemid = 'id_1600'" then
        {
            values.value as value -> tgt.identifier as identifier, 
            identifier.url = 'http://uk-koeln.de/fhir/NamingSystem/nNGM/fallnummer',
            identifier.value = value;
        };
   };
}