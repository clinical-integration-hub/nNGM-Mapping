/// version = 0.1
/// title = "CTSBeurteilung"

/* TO DO
- Missing repeat sections
*/

map "http://uk-koeln.de/fhir/StructureMap/nNGM_Mapping_BeurteilungCTS" = nNGM_Mapping_BeurteilungCTS

uses "http://hl7.org/fhir/StructureDefinition/Bundle" as source
uses "http://hl7.org/fhir/StructureDefinition/CTS_Transport" as target

group TransformBeurteilungCTS(source src: Bundle, target tgt: BackboneElement)
{
    // Metadata
    src -> tgt.crfid = '*-BU';
    src -> tgt.type = 'save';

    //Observation
    src.entry as entry then
    {

        /* ------------------------------ DiagnosticReport ---------------------------- */
        entry.resource as diagnosticreport where "resource is DiagnosticReport and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/DiagnosticReport/nNGM/beurteilung'" then
        {
            //Erstelldatum

            diagnosticreport->tgt.data as data then
            {
                diagnosticreport.effectiveDateTime as dt then
                {
                    diagnosticreport->data.blockindex = 0;
                    diagnosticreport->data.groupindex = 0;
                    diagnosticreport->data.repeatindex = 0;
                    diagnosticreport->data.itemid = 'bu_creation_date';
                    dt->data.values as values, values.value = dt;
                };
            };

            //Version

            diagnosticreport->tgt.data as data then
            {
                diagnosticreport.status as status then
                {
                    diagnosticreport->data.blockindex = 0;
                    diagnosticreport->data.groupindex = 0;
                    diagnosticreport->data.repeatindex = 0;
                    diagnosticreport->data.itemid = 'bu_version';
                    status->data.values as values, values.value = status;
                };
            };

            //Klinische Information
            diagnosticreport->tgt.data as data then
            {
                diagnosticreport.conclusion as conclusion then
                {
                    diagnosticreport->data.blockindex = 0;
                    diagnosticreport->data.groupindex = 0;
                    diagnosticreport->data.repeatindex = 0;
                    diagnosticreport->data.itemid = 'id_1352';
                    conclusion->data.values as values, values.value = conclusion;
                };
            };

            //Empfehlung einer systemischen Therapie
            diagnosticreport->tgt.data as data then
            {
                diagnosticreport.conclusionCode as conclusionCode, conclusionCode.extension as beurteilung, beurteilung.valueBoolean as empfehlung where "$this.value = true" then
                {
                    diagnosticreport->data.blockindex = 0;
                    diagnosticreport->data.groupindex = 0;
                    diagnosticreport->data.repeatindex = 0;
                    diagnosticreport->data.itemid = 'id_2405';
                    empfehlung->data.values as values, values.value = 'Ja';
                };

                diagnosticreport.conclusionCode as conclusionCode, conclusionCode.extension as beurteilung, beurteilung.valueBoolean as empfehlung where "$this.value = false" then
                {
                    diagnosticreport->data.blockindex = 0;
                    diagnosticreport->data.groupindex = 0;
                    diagnosticreport->data.repeatindex = 0;
                    diagnosticreport->data.itemid = 'id_2405';
                    empfehlung->data.values as values, values.value = 'Nein';
                };
            };
        };

        entry.resource as serviceRequest where "resource is ServiceRequest and resource.code.coding.code = 'C125009' and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/ServiceRequest/nNGM/testung'" then
        {
            //Durchfuehrung -
            serviceRequest -> tgt.data as data then
            {
                serviceRequest.status as status where "$this.status = 'active'" then
                {
                    serviceRequest ->  data.blockindex = 1;
                    serviceRequest ->  data.groupindex = 0;
                    serviceRequest ->  data.itemid = 'id_2523';
                    status -> data.values as values,values.value = 'in Bearbeitung';
                };
                serviceRequest.status as status where "$this.status = 'completed'" then
                {
                    serviceRequest ->  data.blockindex = 1;
                    serviceRequest ->  data.groupindex = 0;
                    serviceRequest ->  data.itemid = 'id_2523';
                    status -> data.values as values,values.value = 'abgeschlossen';
                };
            };

            //Abschluss 
            serviceRequest -> tgt.data as data then
            {
                serviceRequest.status as status, status.extension as statusAbschluss, statusAbschluss.extension as statusextension then
                {
                    statusextension where "$this.url ='status'" then
                    {
                        serviceRequest ->  data.blockindex = 1;
                        serviceRequest ->  data.groupindex = 0;
                        serviceRequest ->  data.itemid = 'id_2462';
                        statusextension.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code  -> data.values as values,values.value = code;
                    };
                };
            };
        
            //Datum des Abschlusses 
            serviceRequest -> tgt.data as data then
            {
                serviceRequest.status as status, status.extension as statusAbschluss, statusAbschluss.extension as datumextension then
                {
                    datumextension where "$this.url ='datum'" then
                    {
                        serviceRequest ->  data.blockindex = 1;
                        serviceRequest ->  data.groupindex = 0;
                        serviceRequest ->  data.itemid = 'id_2521';
                        datumextension.valueDate as valueDate -> data.values as values,values.value = valueDate;
                    };
                };
            };

            serviceRequest -> tgt.data as data then
            {
                serviceRequest.extension as extension then 
                {
                    extension.valueDateTime as datumversands where "$this.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/nNGM/datumversands'" then
                    {
                        datumversands -> data.blockindex = 1;
                        datumversands -> data.groupindex = 0;
                        datumversands -> data.itemid = 'id_2525';
                        datumversands -> data.values as values, values.value = datumversands;
                    };
                };
            };
        };
    };
}