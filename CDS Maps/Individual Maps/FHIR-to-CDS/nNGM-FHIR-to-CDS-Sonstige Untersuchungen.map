// version = 0.1
/// title = "nNGM: Sonstige Therapie - FHIR to CTS"
/*
TODO
- Repeatindex for the observation is not implemented
*/


map "http://uk-koeln.de/fhir/StructureMap/nNGM_Mapping_SonstigeUntersuchungenCTS" = nNGM_Mapping_SonstigeUntersuchungenCTS

uses "http://hl7.org/fhir/StructureDefinition/Bundle" as source
uses "http://hl7.org/fhir/StructureDefinition/CTS_Transport" as target

group TransformSonstigeUntersuchungCTS(source src: Bundle, target tgt: BackboneElement)
{
    // Metadata
    src -> tgt.crfid = '*-SU1';
    src -> tgt.type = 'save';

    // Checkboxes
    src.entry as entry then
    {
        //------------------------ Specimen ------------------------
        entry.resource as specimen where "resource is Specimen and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Specimen/nNGM'" then
        {
            //Biopsy-ID -> 0, 0, id_1601
            specimen -> tgt.data as data then
            {
                specimen.identifier as identifier then
                {   
                    specimen -> data.blockindex = 0;
                    specimen -> data.groupindex = 0;
                    specimen -> data.itemid = 'id_1601';
                    identifier.value as value-> data.values as values, values.value = value, values.unit = 'count';
                };
            };                
        };
        //------------------------ DiagnosticReport ------------------------
        entry.resource as diagnosticReport where "resource is DiagnosticReport and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/DiagnosticReport/nNGM/befund'" then
        {
            //Untersuchungs-ID 1, 0, assessment_id
            diagnosticReport -> tgt.data as data then
            {
                diagnosticReport.identifier as identifier,
                    identifier.system as system where "system = 'http://uk-koeln.de/NamingSystem/nNGM/befundnummer'"then
                {   
                    diagnosticReport -> data.blockindex = 1;
                    diagnosticReport -> data.groupindex = 0;
                    diagnosticReport -> data.itemid = 'assessment_id';
                    identifier.value as value-> data.values as values, values.value = value;
                };
            };                
        };
        //------------------------ Organization ------------------------
        entry.resource as organization where "resource is Organization and resource.meta.profile = 'http://clinicalsite.org/fhir/StructureDefinition/organizationalunit'" then
        {
            //Standort -> 2, 0, id_2435
            organization -> tgt.data as data then
            {
                organization.name as name then
                {   
                    organization -> data.blockindex = 2;
                    organization -> data.groupindex = 0;
                    organization -> data.itemid = 'id_2435';
                    name -> data.values as values, values.value = name;
                };
            };                
        };
        //------------------------ Observation ------------------------
        entry.resource as observation where "resource is Observation and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/weitere-untersuchung'" then
        {
            //NetzwerkZentrum
            //SOP-Versionsnummer des Standorts -> 2, 0, id_2618
            observation -> tgt.data as data then
            {
                observation.component as component then 
                {
                    component.code where "code.coding.code = 'C48443' and %tgt.data.where(itemid = 'id_2486').exists().not()" then
                    {
                        observation -> data.blockindex = 2;
                        observation -> data.groupindex = 0;
                        observation -> data.itemid = 'id_2618';
                        component.valueString as valueString -> data.values as values, values.value = valueString;
                    };
                };
            };

            //Date of Assessment 3, 0, id_2527
            observation -> tgt.data as data then
            {
                observation.effectiveDateTime as effectiveDateTime then
                {
                    observation -> data.blockindex = 3;
                    observation -> data.groupindex = 0;
                    observation -> data.repeatindex = 0;
                    observation -> data.itemid = 'id_2527';
                    effectiveDateTime -> data.values as values,values.value = effectiveDateTime;
                };
            };

            //Bezeichnung 3, 0, id_2026
            observation -> tgt.data as data then
            {
                observation.code as code, code.text as text then
                {
                    observation -> data.blockindex = 3;
                    observation -> data.groupindex = 0;
                    observation -> data.repeatindex = 0;
                    observation -> data.itemid = 'id_2026';
                    text -> data.values as values,values.value = text;
                };
            };

            //Assay -> 3, 0, id_2027
            observation -> tgt.data as data then
            {
                observation.component as component then
                {
                    component.code where "code.coding.code = 'C60819'"then
                    {
                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code then 
                        {
                            observation -> data.blockindex = 3;
                            observation -> data.groupindex = 0;
                            observation -> data.repeatindex = 0;
                            observation -> data.itemid = 'id_2027';
                            code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            //Hersteller -> 3, 0, id_2028
            observation -> tgt.data as data then
            {
                observation.component as component then
                {
                    component.code where "code.coding.code = 'C25392'"then
                    {
                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code then 
                        {
                            observation -> data.blockindex = 3;
                            observation -> data.groupindex = 0;
                            observation -> data.repeatindex = 0;
                            observation -> data.itemid = 'id_2028';
                            code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            //Gen -> 3, 0, id_2282
            observation -> tgt.data as data then
            {
                observation.component as component then
                {
                    component.code where "code.coding.code = '48018-6'"then
                    {
                        component.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code then 
                        {
                            observation -> data.blockindex = 3;
                            observation -> data.groupindex = 0;
                            observation -> data.repeatindex = 0;
                            observation -> data.itemid = 'id_2282';
                            code -> data.values as values, values.value = code;
                        };
                    };
                };
            };

            //Phaenotyp -> 3, 0, id_2283
            observation -> tgt.data as data then
            {
                observation.component as component then
                {
                    component.code where "code.coding.code = 'C16977'"then
                    {
                        component.valueString as valueString then  
                        {
                            observation -> data.blockindex = 3;
                            observation -> data.groupindex = 0;
                            observation -> data.repeatindex = 0;
                            observation -> data.itemid = 'id_2283';
                            valueString -> data.values as values, values.value = valueString;
                        };
                    };
                };
            };

            //Ergebnis- -> 3, 0, id_2031
            observation -> tgt.data as data then
            {
                observation.valueCodeableConcept as valueCodeableConcept,
                valueCodeableConcept.coding as coding,
                coding.code as code where "$this.code = 'aktivierende-Mutation'" then 
                {
                    observation -> data.blockindex = 3;
                    observation -> data.groupindex = 0;
                    observation -> data.repeatindex = 0;
                    observation -> data.itemid = 'id_2031';
                    code -> data.values as values, values.value = 'positiv';
                };
                observation.valueCodeableConcept as valueCodeableConcept,
                valueCodeableConcept.coding as coding,
                coding.code as code where "$this.code = 'keine-aktivierende-Mutation'" then 
                {
                    observation -> data.blockindex = 3;
                    observation -> data.groupindex = 0;
                    observation -> data.repeatindex = 0;
                    observation -> data.itemid = 'id_2031';
                    code -> data.values as values, values.value = 'negativ';
                };
                observation.valueCodeableConcept as valueCodeableConcept,
                valueCodeableConcept.coding as coding,
                coding.code as code where "$this.code = 'nicht-auswertbar'" then 
                {
                    observation -> data.blockindex = 3;
                    observation -> data.groupindex = 0;
                    observation -> data.repeatindex = 0;
                    observation -> data.itemid = 'id_2031';
                    code -> data.values as values, values.value = 'nicht auswertbar';
                };
            };
        };

        /* --------------- ServiceRequest ---------------------- */
        entry.resource as serviceRequest where "resource is ServiceRequest and resource.code.coding.code = 'sonstige-untersuchungen' and resource.meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/ServiceRequest/nNGM/testung'" then
        {
            //Durchfuehrung -> 4, 0, id_2520
            serviceRequest -> tgt.data as data then
            {
                serviceRequest.status as status where "$this.status = 'active'" then
                {
                    serviceRequest ->  data.blockindex = 4;
                    serviceRequest ->  data.groupindex = 0;
                    serviceRequest ->  data.itemid = 'id_2520';
                    status -> data.values as values,values.value = 'in Bearbeitung';
                };
                serviceRequest.status as status where "$this.status = 'completed'" then
                {
                    serviceRequest ->  data.blockindex = 4;
                    serviceRequest ->  data.groupindex = 0;
                    serviceRequest ->  data.itemid = 'id_2520';
                    status -> data.values as values,values.value = 'abgeschlossen';
                };
            };

            //Abschluss -> 4, 0, id_2462
            serviceRequest -> tgt.data as data then
            {
                serviceRequest.status as status, 
                status.extension as statusAbschluss, 
                statusAbschluss.extension as statusextension then
                {
                    statusextension where "$this.url ='status'" then
                    {
                        serviceRequest ->  data.blockindex = 4;
                        serviceRequest ->  data.groupindex = 0;
                        serviceRequest ->  data.itemid = 'id_2462';
                        statusextension.valueCodeableConcept as valueCodeableConcept,
                        valueCodeableConcept.coding as coding,
                        coding.code as code  -> data.values as values,values.value = code;
                    };
                };
            };

            //Datum des Abschlusses -> 4,0, id_2521
            serviceRequest -> tgt.data as data then
            {
                serviceRequest.status as status, 
                status.extension as statusAbschluss, 
                statusAbschluss.extension as datumextension then
                {
                    datumextension where "$this.url ='datum'" then
                    {
                        serviceRequest ->  data.blockindex = 4;
                        serviceRequest ->  data.groupindex = 0;
                        serviceRequest ->  data.itemid = 'id_2521';
                        datumextension.valueDate as valueDate -> data.values as values,values.value = valueDate;
                    };
                };
            };
        };
    };
}