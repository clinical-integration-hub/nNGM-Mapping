/// version = 0.1
/// title = "nNGM: Mapping Basisangaben FHIR"
/// CTS -> FHIR

map "http://uk-koeln.de/fhir/StructureMap/nNGM_Mapping_BasisangabenFHIR" = nNGM_Mapping_BasisangabenFHIR

uses "http://hl7.org/fhir/StructureDefinition/CTS_Transport" as source
uses "http://hl7.org/fhir/StructureDefinition/Specimen" as target
uses "http://hl7.org/fhir/StructureDefinition/Organization" as target
uses "http://hl7.org/fhir/StructureDefinition/ServiceRequest" as target
uses "http://hl7.org/fhir/StructureDefinition/Patient" as target
uses "http://hl7.org/fhir/StructureDefinition/Coverage" as target
uses "http://hl7.org/fhir/StructureDefinition/Observation" as target
uses "http://hl7.org/fhir/StructureDefinition/Consent" as target
uses "http://hl7.org/fhir/StructureDefinition/Practitioner" as target
uses "http://hl7.org/fhir/StructureDefinition/Bundle" as target

group TransformBundleBasisangaben(source operations: BackboneElement, target bundle: Bundle, target composition: Composition)
{   
    operations -> composition.section = create('BackboneElement') as section, section.title = 'basisangaben', section.code = cc('http://uk-koeln.de/fhir/CodeSystem/nngm/sections', 'basisangaben') then
    {
        // Organization
        operations then CreateOrganizationReferenzenBasisangaben(operations, bundle, composition, section);

        // Tumorboard
        operations then CreateServiceRequestBasisangaben(operations, bundle, composition, section);
        
        // Coverage
        operations then CreateCoverageBasisangaben(operations, bundle, composition, section);
        
        // Observations
        operations then CreateObservationHeightBasisangaben(operations, bundle, composition, section);
        operations then CreateObservationWeightBasisangaben(operations, bundle, composition, section);
        operations then CreateObservationECOGBasisangaben(operations, bundle, composition, section);
        operations then CreateObservationSmokingBasisangaben(operations, bundle, composition, section);

        // Practitioner
        operations then CreatePractitionerBasisangaben(operations, bundle, composition, section);
        
        // Consent
        operations then CreateConsentTeilnahmeBasisangaben(operations, bundle, composition, section);
        operations then CreateConsentDatenschutzBasisangaben(operations, bundle, composition, section);
        operations then CreateConsentEinwilligung1aBasisangaben(operations, bundle, composition, section);
        operations then CreateConsentEinwilligung1bBasisangaben(operations, bundle, composition, section);
        operations then CreateConsentEinwilligung2Basisangaben(operations, bundle, composition, section);
        operations then CreateConsentVersorgung1Basisangaben(operations, bundle, composition, section);
        operations then CreateConsentVersorgung2Basisangaben(operations, bundle, composition, section);
        operations then CreateConsentForschung1Basisangaben(operations, bundle, composition, section);
        operations then CreateConsentForschung2Basisangaben(operations, bundle, composition, section);
        operations then CreateConsentForschung3Basisangaben(operations, bundle, composition, section);
        operations then CreateConsentForschung4Basisangaben(operations, bundle, composition, section);
        operations then CreateConsentForschung5Basisangaben(operations, bundle, composition, section);
        operations then CreateConsentForschung6Basisangaben(operations, bundle, composition, section);
        operations then CreateConsentForschung7Basisangaben(operations, bundle, composition, section);
        operations then CreateConsentForschung8Basisangaben(operations, bundle, composition, section);
    };
}

/* ------------------------------ Check if Organization needs to be created ---------------------------- */
group CreateOrganizationReferenzenBasisangaben(source operations: BackboneElement, target bundle: Bundle, target composition: Composition, target section: BackboneElement)
{
    // Check whether resource should be created
    let resourceShouldBeCreated = create('Boolean');
    operations then SetBooleanToFalse(operations, resourceShouldBeCreated);

    operations.data as data, data.values as values where "blockindex = 0 and groupindex = 0 and itemid = 'id_ba_siteid'
                                    or blockindex = 2 and groupindex = 0 and itemid = 'id_2435'
                                    or blockindex = 2 and groupindex = 0 and itemid = 'id_2458'" then
    {
        operations then SetBooleanToTrue(operations, resourceShouldBeCreated);
    };

    // Create resource if bool set to true
    operations where "%resourceShouldBeCreated.valueBoolean = true" -> bundle.entry as entry, entry.resource = create('Organization') as organization then
    {
        operations then TransformOrganizationReferenzenBasisangaben(operations, organization, composition, section);
        operations -> entry.request as request, request.method = 'PUT', request.url = evaluate(organization, '\'Organization/\' + $this.id');
    };
}

/* ------------------------------ Organization ---------------------------- */
group TransformOrganizationReferenzenBasisangaben(source operations: BackboneElement, target tgt: Organization, target composition: Composition, target section: BackboneElement)
{
    // Metadata
    operations -> tgt.meta as meta collate, meta.profile = 'http://clinicalsite.org/fhir/StructureDefinition/organizationalunit';

    operations.data as data then
    {
        // ID + insert
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'uuid_organizationalunit'" then
        {
            values.value as value -> tgt.id = value;
            values.value as value -> section.entry = create('Reference') as ref, ref.reference = evaluate(value, '\'Organization/\' + $this');
        };

        // Netzwerkzentrum-id -> tgt.identifier
        data.values as values where "blockindex = 0 and groupindex = 0 and itemid = 'id_ba_siteid'" then
        {
            values.value as netzwerkzentrumid -> tgt.identifier = id('http://healex.systems/fhir/NamingSystem/nNGMnetzwerkzentrumid', netzwerkzentrumid);
        };
       
        // Standort -> tgt.name
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'id_2435'" then
        {
            values.value as value -> tgt.name = value;
        };
    
        // Kontakt -> tgt.contact.address.text
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'id_2458'" then
        {
            values.value as value -> tgt.contact = create('Contact') as contact, contact.address as address, address.text = value;
        };
    };
}

/* ------------------------------ Check if ServiceRequest needs to be created ---------------------------- */
group CreateServiceRequestBasisangaben(source operations: BackboneElement, target bundle: Bundle, target composition: Composition, target section: BackboneElement)
{
    // Check whether resource should be created
    let resourceShouldBeCreated = create('Boolean');
    operations then SetBooleanToFalse(operations, resourceShouldBeCreated);
    
    operations.data as data, data.values as values where "blockindex = 3 and groupindex = 0 and itemid = 'id_1571'
                                    or blockindex = 3 and groupindex = 0 and itemid = 'id_1576'
                                    or blockindex = 10 and groupindex = 0 and itemid = 'id_2296'
                                    or blockindex = 10 and groupindex = 0 and itemid = 'id_2297'" then
    {
        operations then SetBooleanToTrue(operations, resourceShouldBeCreated);
    };

    operations where "%resourceShouldBeCreated.valueBoolean = true" -> bundle.entry as entry, entry.resource = create('ServiceRequest') as servicerequest then
    {
        operations then TransformServiceRequestBasisangaben(operations, servicerequest, composition, section);
        operations -> entry.request as request, request.method = 'PUT', request.url = evaluate(servicerequest, '\'ServiceRequest/\' + $this.id');
    };
}

/* ------------------------------ ServiceRequest ---------------------------- */
group TransformServiceRequestBasisangaben(source operations: BackboneElement, target tgt: ServiceRequest, target composition: Composition, target section: BackboneElement)
{
    // Metadata
    operations -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/ServiceRequest/nNGM/tumorboard';

    // Status
    operations -> tgt.status = cast('active', 'FHIR.code'); 
    
    // Intent
    operations -> tgt.intent = 'proposal';

    // Code
    operations -> tgt.code = cc('http://ncit.nci.nih.gov', 'C19165');
    
    // Requester not available
    operations -> tgt.requester as requester, 
           requester.reference as reference, 
           reference.extension as dataAbsentReason, 
           dataAbsentReason.url = 'http://hl7.org/fhir/StructureDefinition/data-absent-reason', 
           dataAbsentReason.valueCode = cast('not-asked', 'FHIR.code');
    
    operations then TransformServiceRequestRequesterExtensionBasisangaben(operations, tgt);

    operations.data as data then
    {
        // ID + Composition insert
        data.values as values where "blockindex = 10 and groupindex = 0 and itemid = 'uuid_nngm_tumorboard'" then
        {
            values.value as value -> tgt.id = value;
            values.value as value -> section.entry = create('Reference') as untersuchung, untersuchung.reference = evaluate(value, '\'ServiceRequest/\' + $this');
        };

        // References
        data -> tgt.subject = create('Reference') as subject, subject.reference = evaluate(composition, '\'Patient/\' + $this.subject.reference');

        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'uuid_organizationalunit'" then
        {
            values.value as value -> tgt.performer = create('Reference') as performer, performer.reference = evaluate(value, '\'Organization/\' + $this');
        };

        data.values as values where "blockindex = 6 and groupindex = 0 and itemid = 'uuid_nngm_ecog'" then
        {
            values.value as value -> tgt.reasonReference = create('Reference') as reasonReference, reasonReference.reference = evaluate(value, '\'Observation/\' + $this');
        };

        data.values as values where "blockindex = 6 and groupindex = 0 and itemid = 'uuid_observation_nngm_koerpergewicht'" then
        {
            values.value as value -> tgt.reasonReference = create('Reference') as reasonReference, reasonReference.reference = evaluate(value, '\'Observation/\' + $this');
        };

        data.values as values where "blockindex = 6 and groupindex = 0 and itemid = 'uuid_observation_nngm_koerpergroesse'" then
        {
            values.value as value -> tgt.reasonReference = create('Reference') as reasonReference, reasonReference.reference = evaluate(value, '\'Observation/\' + $this');
        };

        data.values as values where "blockindex = 7 and groupindex = 0 and itemid = 'uuid_observation_nngm_raucherstatus'" then
        {
            values.value as value -> tgt.reasonReference = create('Reference') as reasonReference, reasonReference.reference = evaluate(value, '\'Observation/\' + $this');
        };

        // Anforderungsdatum -> authoredOn
        data.values as values where "blockindex = 3 and groupindex = 0 and itemid = 'id_1571'" then
        {
            values.value as datum -> tgt.authoredOn = dateOp(datum, 'dateTime');
        };
    
        // Zeitpunkt anforderung -> aufenthaltsart extension
        data.values as values where "blockindex = 3 and groupindex = 0 and itemid = 'id_1576'" then
        {
            values.value where "$this.value = 'stationär' or $this.value = 'station\u00e4r'" then 
            {
                values.value as za -> tgt.encounter as encounter, encounter.extension as aufenthaltsart, 
                                    aufenthaltsart.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/nNGM/aufenthaltsart', 
                                    aufenthaltsart.valueCodeableConcept = cc('http://hl7.org/fhir/v3/ActCode', 'IMP', 'inpatient encounter');
            };

            values.value where "$this.value = 'ambulant'" then 
            {
                values.value as za -> tgt.encounter as encounter, encounter.extension as aufenthaltsart, 
                                    aufenthaltsart.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/nNGM/aufenthaltsart', 
                                    aufenthaltsart.valueCodeableConcept = cc('http://hl7.org/fhir/v3/ActCode', 'AMB', 'ambulatory');
            };
            
            values.value where "$this.value = 'N/A'" then 
            {
                values.value as za -> tgt.encounter as encounter, encounter.extension as aufenthaltsart, 
                                    aufenthaltsart.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/nNGM/aufenthaltsart', 
                                    aufenthaltsart.valueCodeableConcept = cc('http://terminology.hl7.org/CodeSystem/data-absent-reason', 'unknown', 'Unknown');
            };
        };
    };
}

/* -------------------------------------- Create double extension for ServiceRequest.Requester -------------------------------------------- */
group TransformServiceRequestRequesterExtensionBasisangaben(source operations: BackboneElement, target tgt: ServiceRequest)
{
    operations.data as data then
    {
        // Vorstellung tumorboard -> requester.extension:vorstellungTmb
        data.values as values where "blockindex = 10 and groupindex = 0 and itemid = 'id_2296'" then
        {
            values -> tgt.requester as requester collate, requester.extension as vorstellung, vorstellung.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/nNGM/vorstellung-tmb' then
            {
                values.value as value where "$this.value = 'yes'" then
                {
                    value -> vorstellung.valueBoolean = cast(true, 'FHIR.boolean');
                };

                values.value as value where "$this.value = 'no'" then
                {
                    value -> vorstellung.valueBoolean = cast(false, 'FHIR.boolean');
                };
            };
        };

        // Vorstellung tumorboard -> requester.extension:vorstellungTmb
        data.values as values where "blockindex = 10 and groupindex = 0 and itemid = 'id_2297' and %tgt.requester.extension.where(url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/nNGM/persoenlicheTeilnahme').exists().not()" then
        {
            values -> tgt.requester as requester collate, requester.extension as persoenlicheTeilnahme, persoenlicheTeilnahme.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/nNGM/persoenlicheTeilnahme' then
            {
                values.value as value where "$this.value = 'yes'" then
                {
                    value -> persoenlicheTeilnahme.valueBoolean = cast(true, 'FHIR.boolean');
                };

                values.value as value where "$this.value = 'no'" then
                {
                    value -> persoenlicheTeilnahme.valueBoolean = cast(false, 'FHIR.boolean');
                };
            };
        };
    };
}

/* ------------------------------ Check if Coverage needs to be created ---------------------------- */
group CreateCoverageBasisangaben(source operations: BackboneElement, target bundle: Bundle, target composition: Composition, target section: BackboneElement)
{
    let resourceShouldBeCreated = create('Boolean');
    operations then SetBooleanToFalse(operations, resourceShouldBeCreated);

    operations.data as data, data.values as values where "blockindex = 5 and groupindex = 0 and itemid = 'id_2459'
                                        or blockindex = 5 and groupindex = 0 and itemid = 'id_1269'
                                        or blockindex = 5 and groupindex = 0 and itemid = 'id_1270'
                                        or blockindex = 5 and groupindex = 0 and itemid = 'id_2460'
                                        or blockindex = 5 and groupindex = 0 and itemid = 'id_1268'
                                        or blockindex = 5 and groupindex = 0 and itemid = 'id_1333'" then
    {
        operations then SetBooleanToTrue(operations, resourceShouldBeCreated);
    };

    operations where "%resourceShouldBeCreated.valueBoolean = true" -> bundle.entry as entry, entry.resource = create('Coverage') as coverage then
    {
        operations then TransformCoverageBasisangaben(operations, coverage, composition, section);
        operations -> entry.request as request, request.method = 'PUT', request.url = evaluate(coverage, '\'Coverage/\' + $this.id');
    };
}

/* ------------------------------ Coverage ---------------------------- */
group TransformCoverageBasisangaben(source operations: BackboneElement, target tgt: Coverage, target composition: Composition, target section: BackboneElement)
{ 
    // Metadata
    operations -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Coverage/nNGM/pseudonymisiert';

    // status = active
    operations -> tgt.status = cast('active', 'FHIR.code'); 
    
    // beneficiary, beneficiary.reference
    operations -> tgt.beneficiary as beneficiary,
           beneficiary.reference as reference, 
           reference.extension as dataAbsentReason,
           dataAbsentReason.url = 'http://hl7.org/fhir/StructureDefinition/data-absent-reason',
           dataAbsentReason.valueCode = cast('not-asked', 'FHIR.code');
    
    operations.data as data then
    {
        // ID
        data.values as values where "blockindex = 5 and groupindex = 0 and itemid = 'uuid_coverage_nngm'" then
        {
            values.value as value -> tgt.id = value;
            values.value as value -> section.entry = create('Reference') as coverage, coverage.reference = evaluate(value, '\'Coverage/\' + $this');
        };

        // References
        operations -> tgt.beneficiary = create('Reference') as beneficiary, beneficiary.reference = evaluate(composition, '\'Patient/\' + $this.subject.reference');

        // Payor
        operations -> tgt.payor = create('Reference') as payor then 
        {
            // Reference payor -> Organization
            data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'uuid_organizationalunit'" then
            {
                values.value as value -> payor.reference = evaluate(value, '\'Organization/\' + $this');
            };

            // Krankenkasse
            data.values as values where "blockindex = 5 and groupindex = 0 and itemid = 'id_2459'" then
            {
                values.value as kkasse -> payor.display = kkasse;
            };

            // Abrechnungsinformation -> payor.extension:abrechnungsinformation.valueCodeableConcept
            data.values as values where "blockindex = 5 and groupindex = 0 and itemid = 'id_1333'" then
            {
                values.value as Abrechnungsinformation -> payor.extension as abrechnungsinformationen,
                                                            abrechnungsinformationen.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/nNGM/abrechnungsinformation',
                                                            abrechnungsinformationen.valueCodeableConcept = cc('http://uk-koeln.de/fhir/CodeSystem/nngm/abrechnungsinformation', Abrechnungsinformation);
            };
        };

        // Typ   
        data.values as values where "blockindex = 5 and groupindex = 0 and itemid = 'id_1269'" then
        {
            values.value as typ -> tgt.type = cc('http://fhir.de/CodeSystem/versicherungsart-de-basis', typ);
        };

        // PKV-tariff -> extension:pkvTarifform.valueCodeableConcept
        data.values as values where "blockindex = 5 and groupindex = 0 and itemid = 'id_1270'" then
        {
            values.value as vorstellung where "$this.value = 'Basistarif'" then 
            {
                values.value as value -> tgt.extension as pkv, 
                                        pkv.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/nNGM/pkvTarifform',
                                        pkv.valueCodeableConcept = cc('http://uk-koeln.de/fhir/CodeSystem/nngm/pkv-tarifform', 'basis');
            };

            values.value as vorstellung where "$this.value = 'Standardtarif'" then 
            {
            values.value as value -> tgt.extension as pkv, 
                                        pkv.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/nNGM/pkvTarifform',
                                        pkv.valueCodeableConcept = cc('http://uk-koeln.de/fhir/CodeSystem/nngm/pkv-tarifform', 'standard');
            };

            values.value as vorstellung where "$this.value = 'Vollversichert'" then 
            {
            values.value as value -> tgt.extension as pkv, 
                                        pkv.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/nNGM/pkvTarifform',
                                        pkv.valueCodeableConcept = cc('http://uk-koeln.de/fhir/CodeSystem/nngm/pkv-tarifform', 'voll');
            };
        };

        // Kooperationsvereinbarung -> Coverage.extension:kooperationsvereinbarung.valueBoolean
        data.values as values where "blockindex = 5 and groupindex = 0 and itemid = 'id_2460'" then
        {
            values.value as value where "value = 'yes'" then
            {
                value -> tgt.extension as koop, 
                            koop.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/nNGM/kooperationsvereinbarung',
                            koop.valueBoolean = cast(true, 'FHIR.boolean');
            };

            values.value as value where "value = 'no'" then
            {
                value -> tgt.extension as koop, 
                            koop.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/nNGM/kooperationsvereinbarung',
                            koop.valueBoolean = cast(false, 'FHIR.boolean');
            };
        };

        // Versichertennummer -> not mapped because this data is likely coming from the Brückenkopf

  
    };
}

/* ------------------------------ Check if Observation height is required ---------------------------- */
group CreateObservationHeightBasisangaben(source operations: BackboneElement, target bundle: Bundle, target composition: Composition, target section: BackboneElement)
{
    operations.data as data, data.values as values where "blockindex = 6 and groupindex = 0 and itemid = 'id_1133'" -> bundle.entry as entry, entry.resource = create('Observation') as observation then
    {
        operations then TransformObservationHeightBasisangaben(operations, observation, composition, section);
        operations -> entry.request as request, request.method = 'PUT', request.url = evaluate(observation, '\'Observation/\' + $this.id');
    };
}

/* ------------------------------ Observation height ---------------------------- */
group TransformObservationHeightBasisangaben(source operations: BackboneElement, target tgt: Observation, target composition: Composition, target section: BackboneElement)
{
    // Metadata
    operations -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/nNGM/koerpergroesse';

    // Status 
    operations -> tgt.status = cast('final', 'FHIR.code');

    // Category
    operations -> tgt.category = cc('http://terminology.hl7.org/CodeSystem/observation-category', 'vital-signs');

    // Code
    operations -> tgt.code = cc('http://loinc.org', '8302-2');

    // Subject
    operations -> tgt.subject = create('Reference') as subject, subject.reference = evaluate(composition, '\'Patient/\' + $this.subject.reference');

    // Effective datetime
    operations -> tgt.effectiveDateTime as edt, 
           edt.extension as dataAbsentReason, 
           dataAbsentReason.url = 'http://hl7.org/fhir/StructureDefinition/data-absent-reason', 
           dataAbsentReason.valueCode = cast('not-asked', 'FHIR.code');

    // Kopergroesse -> valueQuantity
    operations.data as data then
    {
        // ID + insert
        data.values as values where "blockindex = 6 and groupindex = 0 and itemid = 'uuid_observation_nngm_koerpergroesse'" then
        {
            values.value as value -> tgt.id = value;
            values.value as value -> section.entry = create('Reference') as entry, entry.reference = evaluate(value, '\'Observation/\' + $this');
        };

        // Reference performer -> Organization
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'uuid_organizationalunit'" then
        {
            values.value as value -> tgt.performer = create('Reference') as performer, performer.reference = evaluate(value, '\'Organization/\' + $this');
        };

        // Reference performer -> Practitioner
        data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'uuid_practitioner_nngm'" then
        {
            values.value as value -> tgt.performer = create('Reference') as performer, performer.reference = evaluate(value, '\'Practitioner/\' + $this');
        };

        data.values as values where "blockindex = 6 and groupindex = 0 and itemid = 'id_1133'" then
        {
            values.value as kp -> tgt.valueQuantity = create('BackboneElement') as Quantity,
            Quantity.system = 'http://unitsofmeasure.org',
            Quantity.unit = 'centimeter',
            Quantity.code = cast('cm', 'FHIR.code') ,
            Quantity.value = kp;
        };
    };
}

/* ------------------------------ Check if Observation weight is required ---------------------------- */
group CreateObservationWeightBasisangaben(source operations: BackboneElement, target bundle: Bundle, target composition: Composition, target section: BackboneElement)
{
    operations.data as data, data.values as values where "blockindex = 6 and groupindex = 0 and itemid = 'id_1132'" -> bundle.entry as entry, entry.resource = create('Observation') as observation then
    {
        operations then TransformObservationWeightBasisangaben(operations, observation, composition, section);
        operations -> entry.request as request, request.method = 'PUT', request.url = evaluate(observation, '\'Observation/\' + $this.id');
    };
}

/* ------------------------------ Observation weight ---------------------------- */
group TransformObservationWeightBasisangaben(source operations: BackboneElement, target tgt: Observation, target composition: Composition, target section: BackboneElement)
{
    // Metadata
    operations -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/nNGM/koerpergewicht';

    // Status 
    operations -> tgt.status = cast('final', 'FHIR.code');

    // Category
    operations -> tgt.category = cc('http://terminology.hl7.org/CodeSystem/observation-category', 'vital-signs');

    // Code
    operations -> tgt.code = cc('http://loinc.org', '29463-7');

    // Subject
    operations -> tgt.subject = create('Reference') as subject, subject.reference = evaluate(composition, '\'Patient/\' + $this.subject.reference');
    
    // Effective datetime
    operations -> tgt.effectiveDateTime as edt, 
           edt.extension as dataAbsentReason, 
           dataAbsentReason.url = 'http://hl7.org/fhir/StructureDefinition/data-absent-reason', 
           dataAbsentReason.valueCode = cast('not-asked', 'FHIR.code');

    // Gewicht -> valueQuantity
    operations.data as data then
    {
        // ID + insert
        data.values as values where "blockindex = 6 and groupindex = 0 and itemid = 'uuid_observation_nngm_koerpergewicht'" then
        {
            values.value as value -> tgt.id = value;
            values.value as value -> section.entry = create('Reference') as entry, entry.reference = evaluate(value, '\'Observation/\' + $this');
        };

        // Reference performer -> Organization
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'uuid_organizationalunit'" then
        {
            values.value as value -> tgt.performer = create('Reference') as performer, performer.reference = evaluate(value, '\'Organization/\' + $this');
        };

        // Reference performer -> Practitioner
        data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'uuid_practitioner_nngm'" then
        {
            values.value as value -> tgt.performer = create('Reference') as performer, performer.reference = evaluate(value, '\'Practitioner/\' + $this');
        };

        data.values as values where "blockindex = 6 and groupindex = 0 and itemid = 'id_1132'" then
        {
            values.value as kg -> tgt.valueQuantity = create('BackboneElement') as Quantity,
            Quantity.system = 'http://unitsofmeasure.org',
            Quantity.unit = 'kilogram',
            Quantity.code = cast('kg', 'FHIR.code') ,
            Quantity.value = kg;
        };
    };
}

/* ------------------------------ Check if Observation ECOG is required ---------------------------- */
group CreateObservationECOGBasisangaben(source operations: BackboneElement, target bundle: Bundle, target composition: Composition, target section: BackboneElement)
{
    operations.data as data, data.values as values where "blockindex = 6 and groupindex = 0 and itemid = 'id_2290'" -> bundle.entry as entry, entry.resource = create('Observation') as observation then
    {
        operations then TransformObservationECOGBasisangaben(operations, observation, composition, section);
        operations -> entry.request as request, request.method = 'PUT', request.url = evaluate(observation, '\'Observation/\' + $this.id');
    };
}

/* ------------------------------ Observation ECOG ---------------------------- */
group TransformObservationECOGBasisangaben(source operations: BackboneElement, target tgt: Observation, target composition: Composition, target section: BackboneElement)
{
    // Metadata
    operations -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/nNGM/ecog';

    // Status 
    operations -> tgt.status = cast('final', 'FHIR.code');

    // Category
    operations -> tgt.category = cc('http://terminology.hl7.org/CodeSystem/observation-category', 'survey');

    // Code
    operations -> tgt.code = cc('http://loinc.org', '89247-1');

    // Subject
    operations -> tgt.subject = create('Reference') as subject, subject.reference = evaluate(composition, '\'Patient/\' + $this.subject.reference');

    // Ecog -> valueQuantity
    operations.data as data then
    {
        // ID + insert
        data.values as values where "blockindex = 6 and groupindex = 0 and itemid = 'uuid_nngm_ecog'" then
        {
            values.value as value -> tgt.id = value;
            values.value as value -> section.entry = create('Reference') as entry, entry.reference = evaluate(value, '\'Observation/\' + $this');
        };

        // Reference performer -> Organization
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'uuid_organizationalunit'" then
        {
            values.value as value -> tgt.performer = create('Reference') as performer, performer.reference = evaluate(value, '\'Organization/\' + $this');
        };

        // Reference performer -> Practitioner
        data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'uuid_practitioner_nngm'" then
        {
            values.value as value -> tgt.performer = create('Reference') as performer, performer.reference = evaluate(value, '\'Practitioner/\' + $this');
        };

        data.values as values where "blockindex = 6 and groupindex = 0 and itemid = 'id_2290'" then
        {
            values.value where "$this.value = '0 - normale, uneingeschränkte Aktivität, wie vor der Erkrankung' or $this.value = '0 - normale, uneingeschr\u00e4nkte Aktivit\u00e4t, wie vor der Erkrankung'" then 
            {
                values.value as ecog -> tgt.valueCodeableConcept = cc('urn:oid:1.2.276.0.76.3.1.131.1.5.153', '0', ecog); 
            };

            values.value where "$this.value = '1 - Einschränkung bei körperlicher Anstrengung, gehfähig, leichte körperliche Arbeit möglich' or $this.value = '1 - Einschr\u00e4nkung bei k\u00f6rperlicher Anstrengung, gehf\u00e4hig, leichte k\u00f6rperliche Arbeit m\u00f6glich'" then 
            {
                values.value as ecog -> tgt.valueCodeableConcept = cc('urn:oid:1.2.276.0.76.3.1.131.1.5.153','1', ecog); 
            };

            values.value where "$this.value = '2 - gehfähig, Selbstversorgung möglich, aber nicht arbeitsfähig, kann mehr als 50 % der Wachzeit aufstehen' or $this.value = '2 - gehf\u00e4hig, Selbstversorgung m\u00f6glich, aber nicht arbeitsf\u00e4hig, kann mehr als 50 % der Wachzeit aufstehen'" then 
            {
                values.value as ecog -> tgt.valueCodeableConcept = cc('urn:oid:1.2.276.0.76.3.1.131.1.5.153','2', ecog); 
            };

            values.value where "$this.value = '3 - nur begrenzte Selbstversorgung möglich, 50 % oder mehr der Wachzeit an Bett oder Stuhl gebunden' or $this.value = '3 - nur begrenzte Selbstversorgung m\u00f6glich, 50 % oder mehr der Wachzeit an Bett oder Stuhl gebunden'" then 
            {
                values.value as ecog -> tgt.valueCodeableConcept = cc('urn:oid:1.2.276.0.76.3.1.131.1.5.153','3', ecog); 
            };
 
            values.value where "$this.value = '4 - völlig pflegebedürftig, keinerlei Selbstversorgung möglich, völlig an Bett oder Stuhl gebunden' or $this.value = '4 - v\u00f6llig pflegebed\u00FCrftig, keinerlei Selbstversorgung m\u00f6glich, v\u00f6llig an Bett oder Stuhl gebunden'" then 
            {
                values.value as ecog -> tgt.valueCodeableConcept = cc('urn:oid:1.2.276.0.76.3.1.131.1.5.153','4', ecog); 
            };
        };
    };
}

/* ------------------------------ Check if Observation Smoking is required ---------------------------- */
group CreateObservationSmokingBasisangaben(source operations: BackboneElement, target bundle: Bundle, target composition: Composition, target section: BackboneElement)
{
    // Check whether resource should be created
    let resourceShouldBeCreated = create('Boolean');
    operations then SetBooleanToFalse(operations, resourceShouldBeCreated);
    
    operations.data as data, data.values as values where "blockindex = 7 and groupindex = 0 and itemid = 'id_2292'
            or blockindex = 7 and groupindex = 0 and itemid = 'id_2293'
            or blockindex = 7 and groupindex = 0 and itemid = 'id_2294'" then
    {
        operations then SetBooleanToTrue(operations, resourceShouldBeCreated);
    };

    operations where "%resourceShouldBeCreated.valueBoolean = true" -> bundle.entry as entry, entry.resource = create('Observation') as observation then
    {
        operations then TransformObservationSmokingBasisangaben(operations, observation, composition, section);
        operations -> entry.request as request, request.method = 'PUT', request.url = evaluate(observation, '\'Observation/\' + $this.id');
    };
}

/* ------------------------------ Observation Smoking ---------------------------- */
group TransformObservationSmokingBasisangaben(source operations: BackboneElement, target tgt: Observation, target composition: Composition, target section: BackboneElement)
{
    // Metadata
    operations -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/nNGM/raucherstatus';

    // Status 
    operations -> tgt.status = cast('final', 'FHIR.code');

    // Category
    operations -> tgt.category = cc('http://hl7.org/fhir/observation-category', 'social-history');

    // Code
    operations -> tgt.code = cc('http://loinc.org', '72166-2');

    // Subject
    operations -> tgt.subject = create('Reference') as subject, subject.reference = evaluate(composition, '\'Patient/\' + $this.subject.reference');

    operations.data as data then
    {
        // ID + insert
        data.values as values where "blockindex = 7 and groupindex = 0 and itemid = 'uuid_observation_nngm_raucherstatus'" then
        {
            values.value as value -> tgt.id = value;
            values.value as value -> section.entry = create('Reference') as entry, entry.reference = evaluate(value, '\'Observation/\' + $this');
        };

        // Reference performer -> Organization
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'uuid_organizationalunit'" then
        {
            values.value as value -> tgt.performer = create('Reference') as performer, performer.reference = evaluate(value, '\'Organization/\' + $this');
        };

        // Reference performer -> Practitioner
        data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'uuid_practitioner_nngm'" then
        {
            values.value as value -> tgt.performer = create('Reference') as performer, performer.reference = evaluate(value, '\'Practitioner/\' + $this');
        };

        // Typ -> valueCodeableConcept
        data.values as values where "blockindex = 7 and groupindex = 0 and itemid = 'id_2292'" then
        {
             values.value where "$this.value = 'Raucher'" then 
            {
                values.value as raucherstatus -> tgt.valueCodeableConcept = cc('http://loinc.org', 'LA18976-3', 'Current every day smoker'); 
            };

             values.value where "$this.value = 'Ex-Raucher'" then
            {
                values.value as raucherstatus -> tgt.valueCodeableConcept = cc('http://loinc.org', 'LA15920-4', 'Former smoker'); 
            };

             values.value where "$this.value = 'Nieraucher'" then 
            {
                values.value as raucherstatus -> tgt.valueCodeableConcept = cc('http://loinc.org', 'LA18978-9', 'Never smoker'); 
            };

             values.value where "$this.value = 'N/A'" then 
            {
                values.value as raucherstatus -> tgt.valueCodeableConcept = cc('http://loinc.org', 'LA18980-5', 'Unknown if ever smoked'); 
            };
        };

        // Pack years -> component:packYears.valueQuantity
        data.values as values where "blockindex = 7 and groupindex = 0 and itemid = 'id_2294'" then
        {
            values.value as packyears -> tgt.component = create('BackboneElement') as packung, 
                                                            packung.code as code, 
                                                            code.text = 'Packungen Pro Jahr',
                                                            code.coding = c('http://ncit.nci.nih.gov', 'C73993'),
                                                            packung.valueQuantity = create('Quantity') as qty, 
                                                            qty.unit = 'pack years',
                                                            qty.system = 'http://unitsofmeasure.org',
                                                            qty.code = cast('1{pack years}','FHIR.code'),
                                                            qty.value = packyears;
        };                                  

        // Nichtraucher seit -> component.nichtraucher
        data.values as values where "blockindex = 7 and groupindex = 0 and itemid = 'id_2293'" then
        {
            values.value as nichtraucher -> tgt.component = create('BackboneElement') as nr,
                                                            nr.code as code,
                                                            code.text = 'Nichtraucher Seit',
                                                            code.coding = c('http://ncit.nci.nih.gov', 'C127065'), 
                                                            nr.valueDateTime = dateOp(nichtraucher, 'dateTime');
        };
    };
}

/* ------------------------------ Check if Practitioner is required ---------------------------- */
group CreatePractitionerBasisangaben(source operations: BackboneElement, target bundle: Bundle, target composition: Composition, target section: BackboneElement)
{
    // Check whether resource should be created
    let resourceShouldBeCreated = create('Boolean');
    operations then SetBooleanToFalse(operations, resourceShouldBeCreated);
    
    operations.data as data, data.values as values where "blockindex = 10 and groupindex = 0 and itemid = 'id_2298'
        or blockindex = 1 and groupindex = 0 and itemid = 'id_2326'
        or blockindex = 1 and groupindex = 0 and itemid = 'id_2485'" then
    {
        operations then SetBooleanToTrue(operations, resourceShouldBeCreated);
    };

    operations where "%resourceShouldBeCreated.valueBoolean = true" -> bundle.entry as entry, entry.resource = create('Practitioner') as practitioner then
    {
        operations then TransformPractitionerBasisangaben(operations, practitioner, composition, section);
        operations -> entry.request as request, request.method = 'PUT', request.url = evaluate(practitioner, '\'Practitioner/\' + $this.id');
    };
}

/* ------------------------------ Practitioner ---------------------------- */
group TransformPractitionerBasisangaben(source operations: BackboneElement, target tgt: Practitioner, target composition: Composition, target section: BackboneElement)
{
    // Metadata
    operations -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Practitioner/nNGM';

    // Name
    operations -> tgt.name as name, 
            name.extension as dataAbsentReason, 
            dataAbsentReason.url = 'http://hl7.org/fhir/StructureDefinition/data-absent-reason', 
            dataAbsentReason.valueCode = cast('not-asked', 'FHIR.code');

    operations.data as data then
    {
        // ID + insert
        data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'uuid_practitioner_nngm'" then
        {
            values.value as value -> tgt.id = value;
            values.value as value -> section.entry = create('Reference') as entry, entry.reference = evaluate(value, '\'Practitioner/\' + $this');
        };

        // Netzwerkpartnernummer -> tgt.identifier:nngmPractitionerId
        data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'id_2326'" then
        {
            values.value as netzwerkpartnernr -> tgt.identifier = id('http://uk-koeln.de/NamingSystem/nNGM/practitionerId', netzwerkpartnernr);
        };
        
        // Kontakt -> tgt.address.text
        data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'id_2485'" then
        {
            values.value as kontakt -> tgt.address as address, address.text = kontakt;
        };

        // E-Mail Adresse des Anforderes (Behandler) für die Einladung -> telecom:email.value
        data.values as values where "blockindex = 10 and groupindex = 0 and itemid = 'id_2298'" then
        {
            values.value as mail -> tgt.telecom = create('ContactPoint') as cp, cp.system = 'email', cp.value = mail;
        };
    };
}

/* ------------------------------ Check if Consent Teilnahme is required ---------------------------- */
group CreateConsentTeilnahmeBasisangaben(source operations: BackboneElement, target bundle: Bundle, target composition: Composition, target section: BackboneElement)
{
    // Check whether resource should be created
    let resourceShouldBeCreated = create('Boolean');
    operations then SetBooleanToFalse(operations, resourceShouldBeCreated);
    
    operations.data as data, data.values as values where "blockindex = 9 and groupindex = 0 and itemid = 'id_2392'" then
    {
        operations then SetBooleanToTrue(operations, resourceShouldBeCreated);
    };

    operations where "%resourceShouldBeCreated.valueBoolean = true" -> bundle.entry as entry, entry.resource = create('Consent') as consent then
    {
        operations then TransformConsentTeilnahmeBasisangaben(operations, consent, composition, section);
        operations -> entry.request as request, request.method = 'PUT', request.url = evaluate(consent, '\'Consent/\' + $this.id');
    };
}

/* ------------------------------ Consent Teilnahme ---------------------------- */
group TransformConsentTeilnahmeBasisangaben(source operations: BackboneElement, target tgt: Consent, target composition: Composition, target section: BackboneElement)
{
    // Metadata
    operations -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Consent/nNGM';

    // Status
    operations -> tgt.status = cast('active', 'FHIR.code');

    // Scope
    operations -> tgt.scope = cc('http://terminology.hl7.org/CodeSystem/consentscope', 'patient-privacy');

    // Category
    operations -> tgt.category = cc('http://loinc.org', '59284-0');

    // Patient
    operations -> tgt.patient = create('Reference') as patient, patient.reference = evaluate(composition, '\'Patient/\' + $this.subject.reference');

    operations.data as data then
    {
        // ID + insert
        data.values as values where "blockindex = 9 and groupindex = 0 and itemid = 'uuid_consent_nngm_teilnahme'" then
        {
            values.value as value -> tgt.id = value;
            values.value as value -> section.entry = create('Reference') as untersuchung, untersuchung.reference = evaluate(value, '\'Consent/\' + $this');
        };

        // Reference performer -> Organization
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'uuid_organizationalunit'" then
        {
            values.value as value -> tgt.performer = create('Reference') as performer, performer.reference = evaluate(value, '\'Organization/\' + $this');
        };

        // Teilnahme unterschrieben -> provision.type
        data.values as values where "blockindex = 9 and groupindex = 0 and itemid = 'id_2392'" then
        {
            values.value as signature where "$this.value = 'yes'" then
            {
                values.value as signature -> tgt.provision = create('BackboneElement') as provision, 
                                             provision.type = cast('permit', 'FHIR.code');

                operations -> tgt.policyRule = cc('http://uk-koeln.de/fhir/CodeSystem/nngm/nngm-consent-policy', 'TE');
            };

            values.value as signature where "$this.value = 'no'" then
            {
                values.value as signature -> tgt.provision = create('BackboneElement') as provision, 
                                             provision.type = cast('deny', 'FHIR.code');
                
                operations -> tgt.policyRule = cc('http://uk-koeln.de/fhir/CodeSystem/nngm/nngm-consent-policy', 'TE');
            };
        };

        // Teilnahme datum -> provision.type.period.standort
        data.values as values where "blockindex = 9 and groupindex = 0 and itemid = 'id_2393'" then
        {
            values.value as datum -> tgt.dateTime = dateOp(datum, 'dateTime');
        };
    };
}

/* ------------------------------ Check if Consent Datenschutz is required ---------------------------- */
group CreateConsentDatenschutzBasisangaben(source operations: BackboneElement, target bundle: Bundle, target composition: Composition, target section: BackboneElement)
{
    // Check whether resource should be created
    let resourceShouldBeCreated = create('Boolean');
    operations then SetBooleanToFalse(operations, resourceShouldBeCreated);
    
    operations.data as data, data.values as values where "blockindex = 9 and groupindex = 0 and itemid = 'id_2389'" then
    {
        operations then SetBooleanToTrue(operations, resourceShouldBeCreated);
    };

    operations where "%resourceShouldBeCreated.valueBoolean = true" -> bundle.entry as entry, entry.resource = create('Consent') as consent then
    {
        operations then TransformConsentDatenschutzBasisangaben(operations, consent, composition, section);
        operations -> entry.request as request, request.method = 'PUT', request.url = evaluate(consent, '\'Consent/\' + $this.id');
    };
}

/* ------------------------------ Consent Datenschutz ---------------------------- */
group TransformConsentDatenschutzBasisangaben(source operations: BackboneElement, target tgt: Consent, target composition: Composition, target section: BackboneElement)
{
    // Metadata
    operations -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Consent/nNGM';
    
    // Status
    operations -> tgt.status = cast('active', 'FHIR.code');

    // Scope
    operations -> tgt.scope = cc('http://terminology.hl7.org/CodeSystem/consentscope', 'patient-privacy');

    // Category
    operations -> tgt.category = cc('http://loinc.org', '59284-0');

    // Patient
    operations -> tgt.patient = create('Reference') as patient, patient.reference = evaluate(composition, '\'Patient/\' + $this.subject.reference');

    // Policy
    operations.data as data then
    {
        // ID + insert
        data.values as values where "blockindex = 9 and groupindex = 0 and itemid = 'uuid_consent_nngm_datenschutz'" then
        {
            values.value as value -> tgt.id = value;
            values.value as value -> section.entry = create('Reference') as untersuchung, untersuchung.reference = evaluate(value, '\'Consent/\' + $this');
        };

        // Reference performer -> Organization
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'uuid_organizationalunit'" then
        {
            values.value as value -> tgt.performer = create('Reference') as performer, performer.reference = evaluate(value, '\'Organization/\' + $this');
        };

        // Datenschutz unterschrieben -> provision.type
        data.values as values where "blockindex = 9 and groupindex = 0 and itemid = 'id_2389'" then
        {
            values.value as signature where "$this.value = 'yes'" then
            {
                values.value as signature -> tgt.provision = create('BackboneElement') as provision, 
                                             provision.type = cast('permit', 'FHIR.code');

                operations -> tgt.policyRule = cc('http://uk-koeln.de/fhir/CodeSystem/nngm/nngm-consent-policy', 'DS');
            };

            values.value as signature where "$this.value = 'no'" then
            {
                values.value as signature -> tgt.provision = create('BackboneElement') as provision, 
                                             provision.type = cast('deny', 'FHIR.code');

                operations -> tgt.policyRule = cc('http://uk-koeln.de/fhir/CodeSystem/nngm/nngm-consent-policy', 'DS');
            };
        };

        // Datenschutz datum -> provision.type.period.standort
        data.values as values where "blockindex = 9 and groupindex = 0 and itemid = 'id_2390'" then
        {
            values.value as datum -> tgt.dateTime = dateOp(datum, 'dateTime');
        };
    }; 
}

/* ------------------------------ Check if Consent Einwilligung 1a is required ---------------------------- */
group CreateConsentEinwilligung1aBasisangaben(source operations: BackboneElement, target bundle: Bundle, target composition: Composition, target section: BackboneElement)
{
    // Check whether resource should be created
    let resourceShouldBeCreated = create('Boolean');
    operations then SetBooleanToFalse(operations, resourceShouldBeCreated);
    
    operations.data as data, data.values as values where "blockindex = 8 and groupindex = 0 and itemid = 'id_2440'" then
    {
        operations then SetBooleanToTrue(operations, resourceShouldBeCreated);
    };

    operations where "%resourceShouldBeCreated.valueBoolean = true" -> bundle.entry as entry, entry.resource = create('Consent') as consent then
    {
        operations then TransformConsentEinwilligung1aBasisangaben(operations, consent, composition, section);
        operations -> entry.request as request, request.method = 'PUT', request.url = evaluate(consent, '\'Consent/\' + $this.id');
    };
}

/* ------------------------------ Consent Einwilligung 1a ---------------------------- */
group TransformConsentEinwilligung1aBasisangaben(source operations: BackboneElement, target tgt: Consent, target composition: Composition, target section: BackboneElement)
{
    // Metadata
    operations -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Consent/nNGM';

    // Status
    operations -> tgt.status = cast('active', 'FHIR.code');

    // Scope
    operations -> tgt.scope = cc('http://terminology.hl7.org/CodeSystem/consentscope', 'patient-privacy');

    // Category
    operations -> tgt.category = cc('http://loinc.org', '59284-0');

    // Patient
    operations -> tgt.patient = create('Reference') as patient, patient.reference = evaluate(composition, '\'Patient/\' + $this.subject.reference');

    // Policy
    operations.data as data then
    {
        // ID + insert
        data.values as values where "blockindex = 8 and groupindex = 0 and itemid = 'uuid_consent_nngm_1a'" then
        {
            values.value as value -> tgt.id = value;
            values.value as value -> section.entry = create('Reference') as untersuchung, untersuchung.reference = evaluate(value, '\'Consent/\' + $this');
        };

        // Reference performer -> Organization
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'uuid_organizationalunit'" then
        {
            values.value as value -> tgt.performer = create('Reference') as performer, performer.reference = evaluate(value, '\'Organization/\' + $this');
        };

        // 1a unterschrieben -> provision.type
        data.values as values where "blockindex = 8 and groupindex = 0 and itemid = 'id_2440'" then
        {
            values.value as signature where "$this.value = 'yes'" then
            {
                values.value as signature -> tgt.provision = create('BackboneElement') as provision collate, 
                                             provision.type = cast('permit', 'FHIR.code');
                                             
                operations -> tgt.policyRule = cc('http://uk-koeln.de/fhir/CodeSystem/nngm/nngm-consent-policy', '1a');                 
            };

            values.value as signature where "$this.value = 'no'" then
            {
                values.value as signature -> tgt.provision = create('BackboneElement') as provision collate, 
                                             provision.type = cast('deny', 'FHIR.code');

                operations -> tgt.policyRule = cc('http://uk-koeln.de/fhir/CodeSystem/nngm/nngm-consent-policy', '1a');                 
            };
        };

        // 1a datum -> provision.type.period.standort
        data.values as values where "blockindex = 8 and groupindex = 0 and itemid = 'id_2441'" then
        {
            values.value as datum -> tgt.dateTime = dateOp(datum, 'dateTime');
        };
    };
}

/* ------------------------------ Check if Consent Einwilligung 1b is required ---------------------------- */
group CreateConsentEinwilligung1bBasisangaben(source operations: BackboneElement, target bundle: Bundle, target composition: Composition, target section: BackboneElement)
{
    // Check whether resource should be created
    let resourceShouldBeCreated = create('Boolean');
    operations then SetBooleanToFalse(operations, resourceShouldBeCreated);
    
    operations.data as data, data.values as values where "blockindex = 8 and groupindex = 0 and itemid = 'id_2446'" then
    {
        operations then SetBooleanToTrue(operations, resourceShouldBeCreated);
    };

    operations where "%resourceShouldBeCreated.valueBoolean = true" -> bundle.entry as entry, entry.resource = create('Consent') as consent then
    {
        operations then TransformConsentEinwilligung1bBasisangaben(operations, consent, composition, section);
        operations -> entry.request as request, request.method = 'PUT', request.url = evaluate(consent, '\'Consent/\' + $this.id');
    };
}

/* ------------------------------ Consent Einwilligung 1b ---------------------------- */
group TransformConsentEinwilligung1bBasisangaben(source operations: BackboneElement, target tgt: Consent, target composition: Composition, target section: BackboneElement)
{
    // Metadata
    operations -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Consent/nNGM';

    // Status
    operations -> tgt.status = cast('active', 'FHIR.code');

    // Scope
    operations -> tgt.scope = cc('http://terminology.hl7.org/CodeSystem/consentscope', 'patient-privacy');

    // Category
    operations -> tgt.category = cc('http://loinc.org', '59284-0');

    // Patient
    operations -> tgt.patient = create('Reference') as patient, patient.reference = evaluate(composition, '\'Patient/\' + $this.subject.reference');

    // Policy
    operations.data as data then
    {
        // ID + insert
        data.values as values where "blockindex = 8 and groupindex = 0 and itemid = 'uuid_consent_nngm_1b'" then
        {
            values.value as value -> tgt.id = value;
            values.value as value -> section.entry = create('Reference') as untersuchung, untersuchung.reference = evaluate(value, '\'Consent/\' + $this');
        };

        // Reference performer -> Organization
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'uuid_organizationalunit'" then
        {
            values.value as value -> tgt.performer = create('Reference') as performer, performer.reference = evaluate(value, '\'Organization/\' + $this');
        };

        // 1b unterschrieben -> provision.type
        data.values as values where "blockindex = 8 and groupindex = 0 and itemid = 'id_2446'" then
        {
            values.value as signature where "$this.value = 'yes'" then
            {
                values.value as signature -> tgt.provision = create('BackboneElement') as provision2, 
                                             provision2.type = cast('permit', 'FHIR.code');
                
                operations -> tgt.policyRule = cc('http://uk-koeln.de/fhir/CodeSystem/nngm/nngm-consent-policy', '1b');                 
            };

            values.value as signature where "$this.value = 'no'" then
            {
                values.value as signature -> tgt.provision = create('BackboneElement') as provision2, 
                                             provision2.type = cast('deny', 'FHIR.code');

                operations -> tgt.policyRule = cc('http://uk-koeln.de/fhir/CodeSystem/nngm/nngm-consent-policy', '1b');                 
            };
        };

        //1b datum -> provision.type.period.standort
        data.values as values where "blockindex = 8 and groupindex = 0 and itemid = 'id_2447'" then
        {
            values.value as datum -> tgt.dateTime = dateOp(datum, 'dateTime');
        };
    };
}

/* ------------------------------ Check if Consent Einwilligung 2 is required ---------------------------- */
group CreateConsentEinwilligung2Basisangaben(source operations: BackboneElement, target bundle: Bundle, target composition: Composition, target section: BackboneElement)
{
    // Check whether resource should be created
    let resourceShouldBeCreated = create('Boolean');
    operations then SetBooleanToFalse(operations, resourceShouldBeCreated);
    
    operations.data as data, data.values as values where "blockindex = 8 and groupindex = 0 and itemid = 'id_2449'" then
    {
        operations then SetBooleanToTrue(operations, resourceShouldBeCreated);
    };

    operations where "%resourceShouldBeCreated.valueBoolean = true" -> bundle.entry as entry, entry.resource = create('Consent') as consent then
    {
        operations then TransformConsentEinwilligung2Basisangaben(operations, consent, composition, section);
        operations -> entry.request as request, request.method = 'PUT', request.url = evaluate(consent, '\'Consent/\' + $this.id');
    };
}

/* ------------------------------ Consent Einwilligung 2 ---------------------------- */
group TransformConsentEinwilligung2Basisangaben(source operations: BackboneElement, target tgt: Consent, target composition: Composition, target section: BackboneElement)
{
    // Metadata
    operations -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Consent/nNGM';

    // Status
    operations -> tgt.status = cast('active', 'FHIR.code');

    // Scope
    operations -> tgt.scope = cc('http://terminology.hl7.org/CodeSystem/consentscope', 'patient-privacy');

    // Category
    operations -> tgt.category = cc('http://loinc.org', '59284-0');

    // Patient
    operations -> tgt.patient = create('Reference') as patient, patient.reference = evaluate(composition, '\'Patient/\' + $this.subject.reference');

    // Policy
    operations.data as data then
    {
        // ID + insert
        data.values as values where "blockindex = 8 and groupindex = 0 and itemid = 'uuid_consent_nngm_2'" then
        {
            values.value as value -> tgt.id = value;
            values.value as value -> section.entry = create('Reference') as untersuchung, untersuchung.reference = evaluate(value, '\'Consent/\' + $this');
        };

        // Reference performer -> Organization
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'uuid_organizationalunit'" then
        {
            values.value as value -> tgt.performer = create('Reference') as performer, performer.reference = evaluate(value, '\'Organization/\' + $this');
        };

        data.values as values where "blockindex = 8 and groupindex = 0 and itemid = 'id_2449'" then
        {
            values.value as signature where "$this.value = 'yes'" then
            {
                values.value as signature -> tgt.provision = create('BackboneElement') as provision2, 
                                             provision2.type = cast('permit', 'FHIR.code');
                
                operations -> tgt.policyRule = cc('http://uk-koeln.de/fhir/CodeSystem/nngm/nngm-consent-policy', '2');                 
            };

            values.value as signature where "$this.value = 'no'" then
            {
                values.value as signature -> tgt.provision = create('BackboneElement') as provision2, 
                                             provision2.type = cast('deny', 'FHIR.code');

                operations -> tgt.policyRule = cc('http://uk-koeln.de/fhir/CodeSystem/nngm/nngm-consent-policy', '2');                 
            };
        };

        // 2 datum -> provision.type.period.standort
        data.values as values where "blockindex = 8 and groupindex = 0 and itemid = 'id_2450'" then
        {
            values.value as datum -> tgt.dateTime = dateOp(datum, 'dateTime');
        };
    };
}

/* ------------------------------ Check if Consent Versorgung 1 is required ---------------------------- */
group CreateConsentVersorgung1Basisangaben(source operations: BackboneElement, target bundle: Bundle, target composition: Composition, target section: BackboneElement)
{
    // Check whether resource should be created
    let resourceShouldBeCreated = create('Boolean');
    operations then SetBooleanToFalse(operations, resourceShouldBeCreated);

    operations.data as data, data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'id_2351'" then
    {
        operations then SetBooleanToTrue(operations, resourceShouldBeCreated);
    };

    operations where "%resourceShouldBeCreated.valueBoolean = true" -> bundle.entry as entry, entry.resource = create('Consent') as consent then
    {
        operations then TransformConsentVersorgung1Basisangaben(operations, consent, composition, section);
        operations -> entry.request as request, request.method = 'PUT', request.url = evaluate(consent, '\'Consent/\' + $this.id');
    };
}

/* ------------------------------ Consent Versorgung 1 ---------------------------- */
group TransformConsentVersorgung1Basisangaben(source operations: BackboneElement, target tgt: Consent, target composition: Composition, target section: BackboneElement)
{
    // Metadata
    operations -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Consent/nNGM';

    // Status
    operations -> tgt.status = cast('active', 'FHIR.code');

    // Scope
    operations -> tgt.scope = cc('http://terminology.hl7.org/CodeSystem/consentscope', 'patient-privacy');
    
    // Category
    operations -> tgt.category = cc('http://loinc.org', '59284-0');

    // Patient
    operations -> tgt.patient = create('Reference') as patient, patient.reference = evaluate(composition, '\'Patient/\' + $this.subject.reference');

    // Policy
    operations.data as data then
    {
        // ID + insert
        data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'uuid_consent_nngm_2351'" then
        {
            values.value as value -> tgt.id = value;
            values.value as value -> section.entry = create('Reference') as untersuchung, untersuchung.reference = evaluate(value, '\'Consent/\' + $this');
        };

        // Reference performer -> Organization
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'uuid_organizationalunit'" then
        {
            values.value as value -> tgt.performer = create('Reference') as performer, performer.reference = evaluate(value, '\'Organization/\' + $this');
        };

        data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'id_2351'" then
        {
            values.value as signature where "$this.value = 'yes'" then
            {
                values.value as signature -> tgt.provision = create('BackboneElement') as provision2, 
                                             provision2.type = cast('permit', 'FHIR.code');
                
                operations -> tgt.policyRule = cc('http://uk-koeln.de/fhir/CodeSystem/nngm/nngm-consent-policy', 'MD');                 
            };

            values.value as signature where "$this.value = 'no'" then
            {
                values.value as signature -> tgt.provision = create('BackboneElement') as provision2, 
                                             provision2.type = cast('deny', 'FHIR.code');

                operations -> tgt.policyRule = cc('http://uk-koeln.de/fhir/CodeSystem/nngm/nngm-consent-policy', 'MD');                 
            };
        };

         data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'id_2352'" then
         {
            values.value as datum -> tgt.dateTime = dateOp(datum, 'dateTime');
         };
    };
}

/* ------------------------------ Check if Consent Versorgung 2 is required ---------------------------- */
group CreateConsentVersorgung2Basisangaben(source operations: BackboneElement, target bundle: Bundle, target composition: Composition, target section: BackboneElement)
{
    // Check whether resource should be created
    let resourceShouldBeCreated = create('Boolean');
    operations then SetBooleanToFalse(operations, resourceShouldBeCreated);

    operations.data as data, data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'id_2357'" then
    {
        operations then SetBooleanToTrue(operations, resourceShouldBeCreated);
    };

    operations where "%resourceShouldBeCreated.valueBoolean = true" -> bundle.entry as entry, entry.resource = create('Consent') as consent then
    {
        operations then TransformConsentVersorgung2Basisangaben(operations, consent, composition, section);
        operations -> entry.request as request, request.method = 'PUT', request.url = evaluate(consent, '\'Consent/\' + $this.id');
    };
}

/* ------------------------------ Consent Versorgung 2 ---------------------------- */
group TransformConsentVersorgung2Basisangaben(source operations: BackboneElement, target tgt: Consent, target composition: Composition, target section: BackboneElement)
{
    // Metadata
    operations -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Consent/nNGM';

    // Status
    operations -> tgt.status = cast('active', 'FHIR.code');

    // Scope
    operations -> tgt.scope = cc('http://terminology.hl7.org/CodeSystem/consentscope', 'patient-privacy');

    // Category
    operations -> tgt.category = cc('http://loinc.org', '59284-0');

    // Patient
    operations -> tgt.patient = create('Reference') as patient, patient.reference = evaluate(composition, '\'Patient/\' + $this.subject.reference');

    // Policy
    operations.data as data then
    {
        // ID + insert
        data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'uuid_consent_nngm_2357'" then
        {
            values.value as value -> tgt.id = value;
            values.value as value -> section.entry = create('Reference') as untersuchung, untersuchung.reference = evaluate(value, '\'Consent/\' + $this');
        };

        // Reference performer -> Organization
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'uuid_organizationalunit'" then
        {
            values.value as value -> tgt.performer = create('Reference') as performer, performer.reference = evaluate(value, '\'Organization/\' + $this');
        };

        data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'id_2357'" then
        {
            values.value as signature where "$this.value = 'yes'" then
            {
                values.value as signature -> tgt.provision = create('BackboneElement') as provision2, 
                                             provision2.type = cast('permit', 'FHIR.code');

                operations -> tgt.policyRule = cc('http://uk-koeln.de/fhir/CodeSystem/nngm/nngm-consent-policy', 'ST');                 
            };

            values.value as signature where "$this.value = 'no'" then
            {
                values.value as signature -> tgt.provision = create('BackboneElement') as provision2, 
                                             provision2.type = cast('deny', 'FHIR.code');
                
                operations -> tgt.policyRule = cc('http://uk-koeln.de/fhir/CodeSystem/nngm/nngm-consent-policy', 'ST');                 
            };
        };

        data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'id_2358'" then
        {
            values.value as datum -> tgt.dateTime = dateOp(datum, 'dateTime');
        };
    };
}

/* ------------------------------ Check if Consent Forschung 1 is required ---------------------------- */
group CreateConsentForschung1Basisangaben(source operations: BackboneElement, target bundle: Bundle, target composition: Composition, target section: BackboneElement)
{
    // Check whether resource should be created
    let resourceShouldBeCreated = create('Boolean');
    operations then SetBooleanToFalse(operations, resourceShouldBeCreated);

    operations.data as data, data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'id_2361'" then
    {
        operations then SetBooleanToTrue(operations, resourceShouldBeCreated);
    };

    operations where "%resourceShouldBeCreated.valueBoolean = true" -> bundle.entry as entry, entry.resource = create('Consent') as consent then
    {
        operations then TransformConsentForschung1Basisangaben(operations, consent, composition, section);
        operations -> entry.request as request, request.method = 'PUT', request.url = evaluate(consent, '\'Consent/\' + $this.id');
    };
}

/* ------------------------------ Consent Forschung 1 ---------------------------- */
group TransformConsentForschung1Basisangaben(source operations: BackboneElement, target tgt: Consent, target composition: Composition, target section: BackboneElement)
{
    // Metadata
    operations -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Consent/nNGM';

    // Status
    operations -> tgt.status = cast('active', 'FHIR.code');

    // Scope
    operations -> tgt.scope = cc('http://terminology.hl7.org/CodeSystem/consentscope', 'patient-privacy');

    // Category
    operations -> tgt.category = cc('http://loinc.org', '59284-0');

    // Patient
    operations -> tgt.patient = create('Reference') as patient, patient.reference = evaluate(composition, '\'Patient/\' + $this.subject.reference');

    // Policy
    operations.data as data then
    {
        // ID + insert
        data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'uuid_consent_nngm_2361'" then
        {
            values.value as value -> tgt.id = value;
            values.value as value -> section.entry = create('Reference') as untersuchung, untersuchung.reference = evaluate(value, '\'Consent/\' + $this');
        };

        // Reference performer -> Organization
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'uuid_organizationalunit'" then
        {
            values.value as value -> tgt.performer = create('Reference') as performer, performer.reference = evaluate(value, '\'Organization/\' + $this');
        };

        // Weitergabe pseudonymisierter krankheitsbezogener Daten (MDAT) innerhalb des nNGM und an kooperierende Partner unterschrieben -> provision.type
        data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'id_2361'" then
        {
            values.value as signature where "$this.value = 'yes'" then
            {
                values.value as signature -> tgt.provision = create('BackboneElement') as provision2, 
                                             provision2.type = cast('permit', 'FHIR.code');

                operations -> tgt.policyRule = cc('http://uk-koeln.de/fhir/CodeSystem/nngm/nngm-consent-policy', 'WPI');                 
            };

            values.value as signature where "$this.value = 'no'" then
            {
                values.value as signature -> tgt.provision = create('BackboneElement') as provision2, 
                                             provision2.type = cast('deny', 'FHIR.code');

                operations -> tgt.policyRule = cc('http://uk-koeln.de/fhir/CodeSystem/nngm/nngm-consent-policy', 'WPI');                 
            };
        };

        // Weitergabe pseudonymisierter krankheitsbezogener Daten (MDAT) innerhalb des nNGM und an kooperierende Partner datum -> provision.type.period.standort
        data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'id_2362'" then
        {
            values.value as datum -> tgt.dateTime = dateOp(datum, 'dateTime');
        };
    };
}

/* ------------------------------ Check if Consent Forschung 2 is required ---------------------------- */
group CreateConsentForschung2Basisangaben(source operations: BackboneElement, target bundle: Bundle, target composition: Composition, target section: BackboneElement)
{
    // Check whether resource should be created
    let resourceShouldBeCreated = create('Boolean');
    operations then SetBooleanToFalse(operations, resourceShouldBeCreated);

    operations.data as data, data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'id_2364'" then
    {
        operations then SetBooleanToTrue(operations, resourceShouldBeCreated);
    };

    operations where "%resourceShouldBeCreated.valueBoolean = true" -> bundle.entry as entry, entry.resource = create('Consent') as consent then
    {
        operations then TransformConsentForschung2Basisangaben(operations, consent, composition, section);
        operations -> entry.request as request, request.method = 'PUT', request.url = evaluate(consent, '\'Consent/\' + $this.id');
    };
}

/* ------------------------------ Consent Forschung 2 ---------------------------- */
group TransformConsentForschung2Basisangaben(source operations: BackboneElement, target tgt: Consent, target composition: Composition, target section: BackboneElement)
{
    // Metadata
    operations -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Consent/nNGM';

    // Status
    operations -> tgt.status = cast('active', 'FHIR.code');

    // Scope
    operations -> tgt.scope = cc('http://terminology.hl7.org/CodeSystem/consentscope', 'patient-privacy');

    // Category
    operations -> tgt.category = cc('http://loinc.org', '59284-0');

    // Patient
    operations -> tgt.patient = create('Reference') as patient, patient.reference = evaluate(composition, '\'Patient/\' + $this.subject.reference');

    // Policy
    operations.data as data then
    {
        // ID + insert
        data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'uuid_consent_nngm_2364'" then
        {
            values.value as value -> tgt.id = value;
            values.value as value -> section.entry = create('Reference') as untersuchung, untersuchung.reference = evaluate(value, '\'Consent/\' + $this');
        };

        // Reference performer -> Organization
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'uuid_organizationalunit'" then
        {
            values.value as value -> tgt.performer = create('Reference') as performer, performer.reference = evaluate(value, '\'Organization/\' + $this');
        };

        // Weitergabe von MDAT und Resttumorproben innerhalb des nNGM und an kooperierende Partner unterschrieben -> provision.type
        data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'id_2364'" then
        {
            values.value as signature where "$this.value = 'yes'" then
            {
                values.value as signature -> tgt.provision = create('BackboneElement') as provision2, 
                                             provision2.type = cast('permit', 'FHIR.code');
                
                operations -> tgt.policyRule = cc('http://uk-koeln.de/fhir/CodeSystem/nngm/nngm-consent-policy', 'WP');                 
            };

            values.value as signature where "$this.value = 'no'" then
            {
                values.value as signature -> tgt.provision = create('BackboneElement') as provision2, 
                                             provision2.type = cast('deny', 'FHIR.code');

                operations -> tgt.policyRule = cc('http://uk-koeln.de/fhir/CodeSystem/nngm/nngm-consent-policy', 'WP');                 
            };
        };

        // Weitergabe von MDAT und Resttumorproben innerhalb des nNGM und an kooperierende Partner datum -> provision.type.period.standort
        data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'id_2365'" then
        {
            values.value as datum -> tgt.dateTime = dateOp(datum, 'dateTime');
        };
    };
}

/* ------------------------------ Check if Consent Forschung 3 is required ---------------------------- */
group CreateConsentForschung3Basisangaben(source operations: BackboneElement, target bundle: Bundle, target composition: Composition, target section: BackboneElement)
{
    // Check whether resource should be created
    let resourceShouldBeCreated = create('Boolean');
    operations then SetBooleanToFalse(operations, resourceShouldBeCreated);

    operations.data as data, data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'id_2367'" then
    {
        operations then SetBooleanToTrue(operations, resourceShouldBeCreated);
    };

    operations where "%resourceShouldBeCreated.valueBoolean = true" -> bundle.entry as entry, entry.resource = create('Consent') as consent then
    {
        operations then TransformConsentForschung3Basisangaben(operations, consent, composition, section);
        operations -> entry.request as request, request.method = 'PUT', request.url = evaluate(consent, '\'Consent/\' + $this.id');
    };
}

/* ------------------------------ Consent Forschung 3 ---------------------------- */
group TransformConsentForschung3Basisangaben(source operations: BackboneElement, target tgt: Consent, target composition: Composition, target section: BackboneElement)
{
    // Metadata
    operations -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Consent/nNGM';

    // Status
    operations -> tgt.status = cast('active', 'FHIR.code');

    // Scope
    operations -> tgt.scope = cc('http://terminology.hl7.org/CodeSystem/consentscope', 'patient-privacy');

    // Category
    operations -> tgt.category = cc('http://loinc.org', '59284-0');

    // Patient
    operations -> tgt.patient = create('Reference') as patient, patient.reference = evaluate(composition, '\'Patient/\' + $this.subject.reference');

    // Policy
    operations.data as data then
    {
        // ID + insert
        data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'uuid_consent_nngm_2367'" then
        {
            values.value as value -> tgt.id = value;
            values.value as value -> section.entry = create('Reference') as untersuchung, untersuchung.reference = evaluate(value, '\'Consent/\' + $this');
        };

        // Reference performer -> Organization
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'uuid_organizationalunit'" then
        {
            values.value as value -> tgt.performer = create('Reference') as performer, performer.reference = evaluate(value, '\'Organization/\' + $this');
        };

        // Weitergabe pseudonymisierter krankheitsbezogener Daten (MDAT) in ein Drittland unterschrieben -> provision.type
        data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'id_2367'" then
        {
            values.value as signature where "$this.value = 'yes'" then
            {
                values.value as signature -> tgt.provision = create('BackboneElement') as provision2, 
                                             provision2.type = cast('permit', 'FHIR.code');
                
                operations -> tgt.policyRule = cc('http://uk-koeln.de/fhir/CodeSystem/nngm/nngm-consent-policy', 'WD');                 
               
            };

            values.value as signature where "$this.value = 'no'" then
            {
                values.value as signature -> tgt.provision = create('BackboneElement') as provision2, 
                                             provision2.type = cast('deny', 'FHIR.code');
                
                operations -> tgt.policyRule = cc('http://uk-koeln.de/fhir/CodeSystem/nngm/nngm-consent-policy', 'WD');                 
            };
        };

        // Weitergabe pseudonymisierter krankheitsbezogener Daten (MDAT) in ein Drittland datum -> provision.type.period.standort
        data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'id_2368'" then
        {
            values.value as datum -> tgt.dateTime = dateOp(datum, 'dateTime');
        };
    };
}

/* ------------------------------ Check if Consent Forschung 4 is required ---------------------------- */
group CreateConsentForschung4Basisangaben(source operations: BackboneElement, target bundle: Bundle, target composition: Composition, target section: BackboneElement)
{
    // Check whether resource should be created
    let resourceShouldBeCreated = create('Boolean');
    operations then SetBooleanToFalse(operations, resourceShouldBeCreated);

    operations.data as data, data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'id_2370'" then
    {
        operations then SetBooleanToTrue(operations, resourceShouldBeCreated);
    };

    operations where "%resourceShouldBeCreated.valueBoolean = true" -> bundle.entry as entry, entry.resource = create('Consent') as consent then
    {
        operations then TransformConsentForschung4Basisangaben(operations, consent, composition, section);
        operations -> entry.request as request, request.method = 'PUT', request.url = evaluate(consent, '\'Consent/\' + $this.id');
    };
}

/* ------------------------------ Consent Forschung 4 ---------------------------- */
group TransformConsentForschung4Basisangaben(source operations: BackboneElement, target tgt: Consent, target composition: Composition, target section: BackboneElement)
{
    // Metadata
    operations -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Consent/nNGM';

    // Status
    operations -> tgt.status = cast('active', 'FHIR.code');

    // Scope
    operations -> tgt.scope = cc('http://terminology.hl7.org/CodeSystem/consentscope', 'patient-privacy');

    // Category
    operations -> tgt.category = cc('http://loinc.org', '59284-0');

    // Patient
    operations -> tgt.patient = create('Reference') as patient, patient.reference = evaluate(composition, '\'Patient/\' + $this.subject.reference');

    // Policy
    operations.data as data then
    {
        // ID + insert
        data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'uuid_consent_nngm_2370'" then
        {
            values.value as value -> tgt.id = value;
            values.value as value -> section.entry = create('Reference') as untersuchung, untersuchung.reference = evaluate(value, '\'Consent/\' + $this');
        };

        // Reference performer -> Organization
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'uuid_organizationalunit'" then
        {
            values.value as value -> tgt.performer = create('Reference') as performer, performer.reference = evaluate(value, '\'Organization/\' + $this');
        };

        // Weitergabe von MDAT und Resttumorproben in ein Drittland unterschrieben -> provision.type
        data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'id_2370'" then
        {
            values.value as signature where "$this.value = 'yes'" then
            {
                values.value as signature -> tgt.provision = create('BackboneElement') as provision2, 
                                             provision2.type = cast('permit', 'FHIR.code');
                
                operations -> tgt.policyRule = cc('http://uk-koeln.de/fhir/CodeSystem/nngm/nngm-consent-policy', 'WR');                 
               
            };

            values.value as signature where "$this.value = 'no'" then
            {
                values.value as signature -> tgt.provision = create('BackboneElement') as provision2, 
                                             provision2.type = cast('deny', 'FHIR.code');
                
                operations -> tgt.policyRule = cc('http://uk-koeln.de/fhir/CodeSystem/nngm/nngm-consent-policy', 'WR');                 
            };
        };

        // Weitergabe von MDAT und Resttumorproben in ein Drittland datum -> provision.type.period.standort
        data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'id_2371'" then
        {
            values.value as datum -> tgt.dateTime = dateOp(datum, 'dateTime');
        };
    };
}

/* ------------------------------ Check if Consent Forschung 5 is required ---------------------------- */
group CreateConsentForschung5Basisangaben(source operations: BackboneElement, target bundle: Bundle, target composition: Composition, target section: BackboneElement)
{
    // Check whether resource should be created
    let resourceShouldBeCreated = create('Boolean');
    operations then SetBooleanToFalse(operations, resourceShouldBeCreated);

    operations.data as data, data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'id_2373'" then
    {
        operations then SetBooleanToTrue(operations, resourceShouldBeCreated);
    };

    operations where "%resourceShouldBeCreated.valueBoolean = true" -> bundle.entry as entry, entry.resource = create('Consent') as consent then
    {
        operations then TransformConsentForschung5Basisangaben(operations, consent, composition, section);
        operations -> entry.request as request, request.method = 'PUT', request.url = evaluate(consent, '\'Consent/\' + $this.id');
    };
}

/* ------------------------------ Consent Forschung 5 ---------------------------- */
group TransformConsentForschung5Basisangaben(source operations: BackboneElement, target tgt: Consent, target composition: Composition, target section: BackboneElement)
{
    // Metadata
    operations -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Consent/nNGM';

    // Status
    operations -> tgt.status = cast('active', 'FHIR.code');

    // Scope
    operations -> tgt.scope = cc('http://terminology.hl7.org/CodeSystem/consentscope', 'patient-privacy');

    // Category
    operations -> tgt.category = cc('http://loinc.org', '59284-0');

    // Patient
    operations -> tgt.patient = create('Reference') as patient, patient.reference = evaluate(composition, '\'Patient/\' + $this.subject.reference');

    // Policy
    operations.data as data then
    {
        // ID + insert
        data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'uuid_consent_nngm_2373'" then
        {
            values.value as value -> tgt.id = value;
            values.value as value -> section.entry = create('Reference') as untersuchung, untersuchung.reference = evaluate(value, '\'Consent/\' + $this');
        };

        // Reference performer -> Organization
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'uuid_organizationalunit'" then
        {
            values.value as value -> tgt.performer = create('Reference') as performer, performer.reference = evaluate(value, '\'Organization/\' + $this');
        };

        // Weitergabe pseudonnymisierter krankheitsbezogener Daten (MDAT) zur kommerziellen Nutzung unterschrieben -> provision.type
        data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'id_2373'" then
        {
            values.value as signature where "$this.value = 'yes'" then
            {
                values.value as signature -> tgt.provision = create('BackboneElement') as provision2, 
                                             provision2.type = cast('permit', 'FHIR.code');
                
                operations -> tgt.policyRule = cc('http://uk-koeln.de/fhir/CodeSystem/nngm/nngm-consent-policy', 'WPK');                 
               
            };

            values.value as signature where "$this.value = 'no'" then
            {
                values.value as signature -> tgt.provision = create('BackboneElement') as provision2, 
                                             provision2.type = cast('deny', 'FHIR.code');
                
                operations -> tgt.policyRule = cc('http://uk-koeln.de/fhir/CodeSystem/nngm/nngm-consent-policy', 'WPK');                 
            };
        };

        // Weitergabe pseudonnymisierter krankheitsbezogener Daten (MDAT) zur kommerziellen Nutzung datum-> provision.type.period.standort
        data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'id_2374'" then
        {
            values.value as datum -> tgt.dateTime = dateOp(datum, 'dateTime');
        };
    };
}

/* ------------------------------ Check if Consent Forschung 6 is required ---------------------------- */
group CreateConsentForschung6Basisangaben(source operations: BackboneElement, target bundle: Bundle, target composition: Composition, target section: BackboneElement)
{
    // Check whether resource should be created
    let resourceShouldBeCreated = create('Boolean');
    operations then SetBooleanToFalse(operations, resourceShouldBeCreated);

    operations.data as data, data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'id_2376'" then
    {
        operations then SetBooleanToTrue(operations, resourceShouldBeCreated);
    };

    operations where "%resourceShouldBeCreated.valueBoolean = true" -> bundle.entry as entry, entry.resource = create('Consent') as consent then
    {
        operations then TransformConsentForschung6Basisangaben(operations, consent, composition, section);
        operations -> entry.request as request, request.method = 'PUT', request.url = evaluate(consent, '\'Consent/\' + $this.id');
    };
}

/* ------------------------------ Consent Forschung 6 ---------------------------- */
group TransformConsentForschung6Basisangaben(source operations: BackboneElement, target tgt: Consent, target composition: Composition, target section: BackboneElement)
{
    // Metadata
    operations -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Consent/nNGM';

    // Status
    operations -> tgt.status = cast('active', 'FHIR.code');
    operations -> tgt.scope = cc('http://terminology.hl7.org/CodeSystem/consentscope', 'patient-privacy');

    // Category
    operations -> tgt.category = cc('http://loinc.org', '59284-0');

    // Patient
    operations -> tgt.patient = create('Reference') as patient, patient.reference = evaluate(composition, '\'Patient/\' + $this.subject.reference');

    // Policy
    operations.data as data then
    {
        // ID + insert
        data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'uuid_consent_nngm_2376'" then
        {
            values.value as value -> tgt.id = value;
            values.value as value -> section.entry = create('Reference') as untersuchung, untersuchung.reference = evaluate(value, '\'Consent/\' + $this');
        };

        // Reference performer -> Organization
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'uuid_organizationalunit'" then
        {
            values.value as value -> tgt.performer = create('Reference') as performer, performer.reference = evaluate(value, '\'Organization/\' + $this');
        };

        // Weitergabe von MDAT und Resttumorproben zur kommerziellen Nutzung unterschrieben -> provision.type
        data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'id_2376'" then
        {
            values.value as signature where "$this.value = 'yes'" then
            {
                values.value as signature -> tgt.provision = create('BackboneElement') as provision2, 
                                             provision2.type = cast('permit', 'FHIR.code');

                operations -> tgt.policyRule = cc('http://uk-koeln.de/fhir/CodeSystem/nngm/nngm-consent-policy', 'WK');                 
            };

            values.value as signature where "$this.value = 'no'" then
            {
                values.value as signature -> tgt.provision = create('BackboneElement') as provision2, 
                                             provision2.type = cast('deny', 'FHIR.code');
                
                operations -> tgt.policyRule = cc('http://uk-koeln.de/fhir/CodeSystem/nngm/nngm-consent-policy', 'WK');                 
            };
        };

        // Weitergabe von MDAT und Resttumorproben zur kommerziellen Nutzung datum -> provision.type.period.standort
        data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'id_2377'" then
        {
            values.value as datum -> tgt.dateTime = dateOp(datum, 'dateTime');
        };
    };
}

/* ------------------------------ Check if Consent Forschung 7 is required ---------------------------- */
group CreateConsentForschung7Basisangaben(source operations: BackboneElement, target bundle: Bundle, target composition: Composition, target section: BackboneElement)
{
    // Check whether resource should be created
    let resourceShouldBeCreated = create('Boolean');
    operations then SetBooleanToFalse(operations, resourceShouldBeCreated);

    operations.data as data, data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'id_2382'" then
    {
        operations then SetBooleanToTrue(operations, resourceShouldBeCreated);
    };

    operations where "%resourceShouldBeCreated.valueBoolean = true" -> bundle.entry as entry, entry.resource = create('Consent') as consent then
    {
        operations then TransformConsentForschung7Basisangaben(operations, consent, composition, section);
        operations -> entry.request as request, request.method = 'PUT', request.url = evaluate(consent, '\'Consent/\' + $this.id');
    };
}

/* ------------------------------ Consent Forschung 7 ---------------------------- */
group TransformConsentForschung7Basisangaben(source operations: BackboneElement, target tgt: Consent, target composition: Composition, target section: BackboneElement)
{
    // Metadata
    operations -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Consent/nNGM';

    // Status
    operations -> tgt.status = cast('active', 'FHIR.code');

    // Scope
    operations -> tgt.scope = cc('http://terminology.hl7.org/CodeSystem/consentscope', 'patient-privacy');

    // Category
    operations -> tgt.category = cc('http://loinc.org', '59284-0');

    // Patient
    operations -> tgt.patient = create('Reference') as patient, patient.reference = evaluate(composition, '\'Patient/\' + $this.subject.reference');

    // Policy
    operations.data as data then
    {
        // ID + insert
        data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'uuid_consent_nngm_2382'" then
        {
            values.value as value -> tgt.id = value;
            values.value as value -> section.entry = create('Reference') as untersuchung, untersuchung.reference = evaluate(value, '\'Consent/\' + $this');
        };

        // Reference performer -> Organization
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'uuid_organizationalunit'" then
        {
            values.value as value -> tgt.performer = create('Reference') as performer, performer.reference = evaluate(value, '\'Organization/\' + $this');
        };

        // Kontaktaufnahme des nNGM-Zentrums zu einem spateren Zeiptunkt zur Gewinnung weiterer informationen uber den Behandlungsverlauf unterschrieben -> provision.type
        data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'id_2382'" then
        {
            values.value as signature where "$this.value = 'yes'" then
            {
                values.value as signature -> tgt.provision = create('BackboneElement') as provision2, 
                                             provision2.type = cast('permit', 'FHIR.code');

                operations -> tgt.policyRule = cc('http://uk-koeln.de/fhir/CodeSystem/nngm/nngm-consent-policy', 'KW');                 
            };

            values.value as signature where "$this.value = 'no'" then
            {
                values.value as signature -> tgt.provision = create('BackboneElement') as provision2, 
                                             provision2.type = cast('deny', 'FHIR.code');
                
                operations -> tgt.policyRule = cc('http://uk-koeln.de/fhir/CodeSystem/nngm/nngm-consent-policy', 'KW');                 
            };
        };

        //Kontaktaufnahme des nNGM-Zentrums zu einem spateren Zeiptunkt zur Gewinnung weiterer informationen uber den Behandlungsverlauf unterschrieben Datum -> provision.type.period.standort
        data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'id_2383'" then
        {
            values.value as datum -> tgt.dateTime = dateOp(datum, 'dateTime');
        };
    };
}

/* ------------------------------ Check if Consent Forschung 8 is required ---------------------------- */
group CreateConsentForschung8Basisangaben(source operations: BackboneElement, target bundle: Bundle, target composition: Composition, target section: BackboneElement)
{
    // Check whether resource should be created
    let resourceShouldBeCreated = create('Boolean');
    operations then SetBooleanToFalse(operations, resourceShouldBeCreated);

    operations.data as data, data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'id_2379'" then
    {
        operations then SetBooleanToTrue(operations, resourceShouldBeCreated);
    };

    operations where "%resourceShouldBeCreated.valueBoolean = true" -> bundle.entry as entry, entry.resource = create('Consent') as consent then
    {
        operations then TransformConsentForschung8Basisangaben(operations, consent, composition, section);
        operations -> entry.request as request, request.method = 'PUT', request.url = evaluate(consent, '\'Consent/\' + $this.id');
    };
}

/* ------------------------------ Consent Forschung 8 ---------------------------- */
group TransformConsentForschung8Basisangaben(source operations: BackboneElement, target tgt: Consent, target composition: Composition, target section: BackboneElement) 
{
    // Metadata
    operations -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Consent/nNGM';

    // Status
    operations -> tgt.status = cast('active', 'FHIR.code');

    // Scope
    operations -> tgt.scope = cc('http://terminology.hl7.org/CodeSystem/consentscope', 'patient-privacy');
    
    // Category
    operations -> tgt.category = cc('http://loinc.org', '59284-0');

    // Patient
    operations -> tgt.patient = create('Reference') as patient, patient.reference = evaluate(composition, '\'Patient/\' + $this.subject.reference');

    // Policy
    operations.data as data then
    {
        // ID + insert
        data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'uuid_consent_nngm_2379'" then
        {
            values.value as value -> tgt.id = value;
            values.value as value -> section.entry = create('Reference') as untersuchung, untersuchung.reference = evaluate(value, '\'Consent/\' + $this');
        };

        // Reference performer -> Organization
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'uuid_organizationalunit'" then
        {
            values.value as value -> tgt.performer = create('Reference') as performer, performer.reference = evaluate(value, '\'Organization/\' + $this');
        };

        // Kontaktaufnahme des nNGM-Zentrums zum zweck des einschlusses in eine mogliche infrage kommende neue Studie -> provision.type
        data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'id_2379'" then
        {
            values.value as signature where "$this.value = 'yes'" then
            {
                values.value as signature -> tgt.provision = create('BackboneElement') as provision2, 
                                             provision2.type = cast('permit', 'FHIR.code');

                operations -> tgt.policyRule = cc('http://uk-koeln.de/fhir/CodeSystem/nngm/nngm-consent-policy', 'KE');                 
            };

            values.value as signature where "$this.value = 'no'" then
            {
                values.value as signature -> tgt.provision = create('BackboneElement') as provision2, 
                                             provision2.type = cast('deny', 'FHIR.code');
                
                operations -> tgt.policyRule = cc('http://uk-koeln.de/fhir/CodeSystem/nngm/nngm-consent-policy', 'KE');                 
            };
        };

        //Kontaktaufnahme des nNGM-Zentrums zum Zweck des Einschlusses in eine mogliche infrage kommende neue Studie datum -> provision.type.period.standort
        data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'id_2380'" then
        {
            values.value as datum -> tgt.dateTime = dateOp(datum, 'dateTime');
        };
    };
}