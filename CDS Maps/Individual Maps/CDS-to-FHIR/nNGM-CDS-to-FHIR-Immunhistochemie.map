/// version = 0.1
/// title = "ImmunhistochemieFHIR"

/*
TODO
    - Observations are missing a coding each?
    - DiagnosticReport is missing a code
    - Specimen (creation and reference of uuid_specimen_nngm4) is commented out

    id_2180 PD-L1 missing post/neg -> auswertbar cc not working
*/

map "http://uk-koeln.de/fhir/StructureMap/nNGM_Mapping_ImmunhistochemieFHIR" = ImmunhistochemieFHIR

uses "http://hl7.org/fhir/StructureDefinition/CTS_Transport" as source
uses "http://hl7.org/fhir/StructureDefinition/ServiceRequest" as target
uses "http://hl7.org/fhir/StructureDefinition/Specimen" as target
uses "http://hl7.org/fhir/StructureDefinition/DiagnosticReport" as target
uses "http://hl7.org/fhir/StructureDefinition/Observation" as target


group TransformBundleImmunhistochemie(source operations: BackboneElement, target bundle: Bundle, target composition: Composition)
{
    operations -> composition.section = create('BackboneElement') as section, section.code = cc('http://uk-koeln.de/fhir/CodeSystem/nngm/sections', 'immunhistochemie') then
    {
        operations then CreateServiceRequestIHC(operations, bundle, composition, section);
        // operations then CreateSpecimenIHC(operations, bundle, composition, section);
        operations then CreateDiagnosticReportIHC(operations, bundle, composition, section);
        operations then CreateObservationIHC(operations, bundle, composition, section);
    };
}

/* -------------------------------------- Check if Service Request is required -------------------------------------------- */
group CreateServiceRequestIHC(source operations: BackboneElement, target bundle: Bundle, target composition: Composition, target section: BackboneElement)
{
    // Check whether resource should be created
    let resourceShouldBeCreated = create('Boolean');
    operations then SetBooleanToFalse(operations, resourceShouldBeCreated);

    operations.data as data, data.values as values where "blockindex = 15 and groupindex = 0 and itemid = 'id_2520'
                                                        or blockindex = 15 and groupindex = 0 and itemid = 'id_2462'
                                                        or blockindex = 15 and groupindex = 0 and itemid = 'id_2521'" then
    {
        operations then SetBooleanToTrue(operations, resourceShouldBeCreated);
    };
    
    // Create resource if bool set to true
    operations where "%resourceShouldBeCreated.valueBoolean = true" -> bundle.entry as entry, entry.resource = create('ServiceRequest') as serviceRequest then 
    {
        operations then TransformServiceRequestIHC(operations, serviceRequest, composition, section);
        operations -> entry.request as request, request.method = 'PUT', request.url = evaluate(serviceRequest, '\'ServiceRequest/\' + $this.id');
    };
}

/* -------------------------------------- Service Request -------------------------------------------- */
group TransformServiceRequestIHC(source operations: BackboneElement, target tgt: ServiceRequest, target composition: Composition, target section: BackboneElement)
{
    operations -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/ServiceRequest/nNGM/testung';

    // Status Extension
    operations then TransformIHCStatusExtension(operations, tgt);

    // Intent
    operations -> tgt.intent = cast('proposal', 'FHIR.code');
 
    // Category
    operations -> tgt.category as cat, 
                cat.coding as coding, 
                coding.code as code, 
                code.extension as dataAbsentReason, 
                dataAbsentReason.url = 'http://hl7.org/fhir/StructureDefinition/data-absent-reason', 
                dataAbsentReason.valueCode = cast('not-asked', 'FHIR.code');

    // Code
    operations -> tgt.code = cc('http://uk-koeln.de/fhir/ValueSet/nngm/testung-anforderung-code', 'immunhistochemie');

    // Subject
    operations -> tgt.subject = create('Reference') as subject, subject.reference = evaluate(composition, '\'Patient/\' + $this.subject.reference');

    // AuthoredOn
    operations -> tgt.authoredOn as ao, 
                ao.extension as dataAbsentReason, 
                dataAbsentReason.url = 'http://hl7.org/fhir/StructureDefinition/data-absent-reason', 
                dataAbsentReason.valueCode = cast('not-asked', 'FHIR.code');

    // Access data
    operations.data as data then
    {
        // ID + Composition insert
        data.values as values where "blockindex = 15 and groupindex = 0 and itemid = 'uuid_nngm_testung2'" then
        {
            values.value as value -> tgt.id = value;
            values.value as value -> section.entry = create('Reference') as serviceRequest, serviceRequest.reference = evaluate(value, '\'ServiceRequest/\' + $this');
        };

        //Status der Untersuchungen
        //Durchfuehrung
        data.values as values where "blockindex = 15 and groupindex = 0 and itemid = 'id_2520'" then
        {
            values.value as value where "$this.value = 'in Bearbeitung'" then 
            {
                value -> tgt.status = 'active';
            };
            values.value as value where "$this.value = 'abgeschlossen'" then 
            {
                value -> tgt.status = 'completed';
            };
        };

        // Referenzen
        // DiagnosticReport
        data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'uuid_nngm_befund2'" then
        {
            values.value as value -> tgt.reasonReference = create('Reference') as diagnosticReport, diagnosticReport.reference = evaluate(value, '\'DiagnosticReport/\' + $this');
        };

        // Observations
        data.values as values where "blockindex = 3 and groupindex = 0 and itemid = 'id_2508'" then
        {
            values.value as value -> tgt.reasonReference = create('Reference') as reference then SetReferenceToObservation(operations, value, reference);
        };

        // Specimen
        // data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'uuid_specimen_nngm4'" then
        // {
        //     values.value as value -> tgt.specimen = create('Reference') as specimen, specimen.reference = evaluate(value, '\'Specimen/\' + $this');
        // };
    };
}

/* -------------------------------------- Create double extensions for Fast Track -------------------------------------------- */
group TransformIHCStatusExtension(source operations: BackboneElement, target tgt: ServiceRequest)
{
    operations.data as data then
    {
        // Status des Abschlusses
        data.values as values where "blockindex = 15 and groupindex = 0 and itemid = 'id_2462'" then
        {
            values.value as value where "%tgt.status.extension.extension.where(url = 'status').exists().not()" then
            {
                value -> tgt.status as status, status.extension as statusAbschluss collate, statusAbschluss.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/nNGM/statusAbschluss', statusAbschluss.extension as statusExtension then
                {
                    value -> statusExtension.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/NNGM/statusAbschluss',value);
                    value -> statusExtension.url = 'status';
                };
            };
        };

        //Datum des Abschlusses
        data.values as values where "blockindex = 15 and groupindex = 0 and itemid = 'id_2521'" then
        {
            values.value as value where "%tgt.status.extension.extension.where(url = 'datum').exists().not()" then
            {
                value -> tgt.status as status, status.extension as statusAbschluss collate, statusAbschluss.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/nNGM/statusAbschluss', statusAbschluss.extension as datumExtension then
                {
                    value -> datumExtension.valueDate = dateOp(value, 'date');
                    value -> datumExtension.url = 'datum';
                };
            };
        };
    };
}

/*-----------------Specimen-----------------------*/
group CreateSpecimenIHC(source operations: BackboneElement, target bundle: Bundle, target composition: Composition, target section: BackboneElement)
{
    operations.data as data, data.values as values where "blockindex = 0 and groupindex = 0 and itemid = 'id_1601'" then
    {
        operations -> bundle.entry as entry, entry.resource = create('Specimen') as specimen then 
        {
            operations then TransformSpecimenIHC(operations, specimen, composition, section);
            operations -> entry.request as request, request.method = 'PUT', request.url = evaluate(specimen, '\'Specimen/\' + $this.id');
        };
    };
}

group TransformSpecimenIHC(source operations: BackboneElement, target tgt: Specimen, target composition: Composition, target section: BackboneElement) 
{
    // Metadata
    operations -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Specimen/nNGM';

    // fixed status
    operations -> tgt.type = create('BackboneElement') as cc, cc.coding as type,
                      type.system = 'http://snomed.info/sct', 
                      type.version = 'http://snomed.info/sct/900000000000207008',
                      type.code as code, 
                      code.extension as dataAbsentReason, 
                      dataAbsentReason.url = 'http://hl7.org/fhir/StructureDefinition/data-absent-reason', 
                      dataAbsentReason.valueCode = cast('not-asked', 'FHIR.code');

    // Patient reference
    operations -> tgt.subject = create('Reference') as subject, subject.reference = evaluate(composition, '\'Patient/\' + $this.subject.reference');

    // Access data
    operations.data as data then 
    {
        // ID + Composition insert
        data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'uuid_specimen_nngm4'" then
        {
            values.value as value -> tgt.id = value;
            values.value as value -> section.entry = create('Reference') as specimen, specimen.reference = evaluate(value, '\'Specimen/\' + $this');
        };
    };
}

/*-----------------DiagnosticReport-----------------------*/
group CreateDiagnosticReportIHC(source operations: BackboneElement, target bundle: Bundle, target composition: Composition, target section: BackboneElement)
{
    operations.data as data, data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'uuid_nngm_befund2'" then
    {
        operations -> bundle.entry as entry, entry.resource = create('DiagnosticReport') as diagnosticreport then 
        {
            operations then TransformDiagnosticReportIHC(operations, diagnosticreport, composition, section);
            operations -> entry.request as request, request.method = 'PUT', request.url = evaluate(diagnosticreport, '\'DiagnosticReport/\' + $this.id');
        };
    };

}

group TransformDiagnosticReportIHC(source operations: BackboneElement, target tgt: DiagnosticReport, target composition: Composition, target section: BackboneElement) 
{
    // Metadata
    operations -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/DiagnosticReport/nNGM/befund';

    // fixed status
    operations -> tgt.status = 'active';

    // TODO: code is missing

    // Subject
    operations -> tgt.subject = create('Reference') as subject, subject.reference = evaluate(composition, '\'Patient/\' + $this.subject.reference');

    // Access data
    operations.data as data then 
    {
        // ID + Composition insert
        data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'uuid_nngm_befund2'" then
        {
            values.value as value -> tgt.id = value;
            values.value as value -> section.entry = create('Reference') as diagnosticReport, diagnosticReport.reference = evaluate(value, '\'DiagnosticReport/\' + $this');
        };
        
        // Untersuchung-ID -> identifier.value
        data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'assessment_id'" then
        {
            values.value as value -> tgt.identifier as identifier, 
                                     identifier.system = 'http://uk-koeln.de/NamingSystem/nNGM/befundnummer', 
                                     identifier.value = value;
        };

        // Referenzen
        // Specimen
        // data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'uuid_specimen_nngm4'" then
        // {
        //     values.value as value -> tgt.specimen = create('Reference') as specimen, specimen.reference = evaluate(value, '\'Specimen/\' + $this');
        // };
        
        // Observations
        data.values as values where "blockindex = 3 and groupindex = 0 and itemid = 'id_2508'" then
        {
            values.value as value -> tgt.result = create('Reference') as reference then SetReferenceToObservation(operations, value, reference);
        };
    };
}

/* ------------------------------ Check which Observation is required ---------------------------- */
group CreateObservationIHC(source operations: BackboneElement, target bundle: Bundle, target composition: Composition, target section: BackboneElement)
{
    // Check whether observation should be created
    operations.data as data, data.values as values where "blockindex = 3 and groupindex = 0 and itemid = 'id_2508'" then
    {
        // BRAF
        values.value as value where "value = 'BRAF'" -> bundle.entry as entry, entry.resource = create('Observation') as observation then 
        {
            operations then TransformObservationBRAF(operations, observation, composition, section);
            operations -> entry.request as request, request.method = 'PUT', request.url = evaluate(observation, '\'Observation/\' + $this.id');        
        };

        // CK7
        values.value as value where "value = 'CK7'" -> bundle.entry as entry, entry.resource = create('Observation') as observation then 
        {
            operations then TransformObservationCK7(operations, observation, composition, section);
            operations -> entry.request as request, request.method = 'PUT', request.url = evaluate(observation, '\'Observation/\' + $this.id');        
        };

        // MIB1
        values.value as value where "value = 'MIB1'" -> bundle.entry as entry, entry.resource = create('Observation') as observation then 
        {
            operations then TransformObservationMIB1(operations, observation, composition, section);
            operations -> entry.request as request, request.method = 'PUT', request.url = evaluate(observation, '\'Observation/\' + $this.id');        
        };

        // Napsin A
        values.value as value where "value = 'Napsin A'" -> bundle.entry as entry, entry.resource = create('Observation') as observation then 
        {
            operations then TransformObservationNAPSINA(operations, observation, composition, section);
            operations -> entry.request as request, request.method = 'PUT', request.url = evaluate(observation, '\'Observation/\' + $this.id');        
        };

        // P40
        values.value as value where "value = 'P40'" -> bundle.entry as entry, entry.resource = create('Observation') as observation then 
        {
            operations then TransformObservationP40(operations, observation, composition, section);
            operations -> entry.request as request, request.method = 'PUT', request.url = evaluate(observation, '\'Observation/\' + $this.id');        
        };

        // Synaptophysin
        values.value as value where "value = 'Synaptophysin'" -> bundle.entry as entry, entry.resource = create('Observation') as observation then 
        {
            operations then TransformObservationSynaptophysin(operations, observation, composition, section);
            operations -> entry.request as request, request.method = 'PUT', request.url = evaluate(observation, '\'Observation/\' + $this.id');        
        };

        // TTF1
        values.value as value where "value = 'TTF1'" -> bundle.entry as entry, entry.resource = create('Observation') as observation then 
        {
            operations then TransformObservationTTF1(operations, observation, composition, section);
            operations -> entry.request as request, request.method = 'PUT', request.url = evaluate(observation, '\'Observation/\' + $this.id');        
        };

        // ALK
        values.value as value where "value = 'ALK'" -> bundle.entry as entry, entry.resource = create('Observation') as observation then 
        {
            operations then TransformObservationALK(operations, observation, composition, section);
            operations -> entry.request as request, request.method = 'PUT', request.url = evaluate(observation, '\'Observation/\' + $this.id');        
        };

        // MET
        values.value as value where "value = 'MET'" -> bundle.entry as entry, entry.resource = create('Observation') as observation then 
        {
            operations then TransformObservationMET(operations, observation, composition, section);
            operations -> entry.request as request, request.method = 'PUT', request.url = evaluate(observation, '\'Observation/\' + $this.id');        
        };

        // PD-L1
        values.value as value where "value = 'PD-L1'" -> bundle.entry as entry, entry.resource = create('Observation') as observation then 
        {
            operations then TransformObservationPDL1(operations, observation, composition, section);
            operations -> entry.request as request, request.method = 'PUT', request.url = evaluate(observation, '\'Observation/\' + $this.id');        
        };

        // ROS1
        values.value as value where "value = 'ROS1'" -> bundle.entry as entry, entry.resource = create('Observation') as observation then 
        {
            operations then TransformObservationROS1(operations, observation, composition, section);
            operations -> entry.request as request, request.method = 'PUT', request.url = evaluate(observation, '\'Observation/\' + $this.id');        
        };
    };
}

group TransformObservationBRAF(source operations: BackboneElement, target tgt: Observation, target composition: Composition, target section: BackboneElement)
{
    operations -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/ihc';

    // Status
    operations -> tgt.status = cast('final', 'FHIR.code');

    //IHC category
    operations then MapIHCCategory(operations, tgt);

    //BRAF code
    operations -> tgt.code = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/molpatho-obs-codes', 'BRAF');

    // Subject
    operations -> tgt.subject = create('Reference') as subject, subject.reference = evaluate(composition, '\'Patient/\' + $this.subject.reference');

    // Methode
    operations then MapIHCMethode(operations, tgt);

    // Access data
    operations.data as data then
    {
        // ID + Composition insert
        data.values as values where "blockindex = 4 and groupindex = 0 and itemid = 'uuid_ihc_braf'" then
        {
            values.value as value -> tgt.id = value;
            values.value as value -> section.entry = create('Reference') as observation, observation.reference = evaluate(value, '\'Observation/\' + $this');
        };

        // Netzwerkzentrum
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'id_2435'" then
        {
            values.value as nz -> tgt.component = create('BackboneElement') as nzcomponent then
            {
                values.value as value where "%tgt.component.where(code = 'C25341').exists().not()" then
                {
                    nz -> nzcomponent.valueString = nz;
                    nz -> nzcomponent.code = cc('http://ncit.nci.nih.gov', 'C25341');
                };
            };
        };

        // SOP-Versionsnummer des Standorts
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'id_2613'" then
        {
            values.value as sop -> tgt.component = create('BackboneElement') as sopcomponent then
            {
                values.value as value where "%tgt.component.where(code = 'C48443').exists().not()" then
                {
                    sop -> sopcomponent.valueString = sop;
                    sop -> sopcomponent.code = cc('http://ncit.nci.nih.gov', 'C48443');
                };
            };
        };

        // Date of Assessment end
        data.values as values where "blockindex = 15 and groupindex = 0 and itemid = 'id_2521'" then
        {
            values.value as effectiveDT -> tgt.effectivePeriod = create('Period') as period collate, period.end = dateOp(effectiveDT, 'date');
        };

        // Phänotyp
        data.values as values where "blockindex = 4 and groupindex = 0 and itemid = 'braf_ihc_phaenotype'" then
        {
            values.value as value where "%tgt.component.code.where(coding.code = 'C16977').exists().not()" then
            {
                values.value as phaenotyp->tgt.component = create('BackboneElement') as componentPhaenotyp then
                {
                    phaenotyp->componentPhaenotyp.valueString = phaenotyp;
                    phaenotyp->componentPhaenotyp.code = cc('http://ncit.nci.nih.gov', 'C16977');
                };
            };
        };

        // Date of Assessment 
        data.values as values where "blockindex = 4 and groupindex = 0 and itemid = 'braf_ihc_group'" then
        {
            values.value as effectiveDT -> tgt.effectivePeriod = create('Period') as period collate, period.start = dateOp(effectiveDT, 'date');
        };

        // Antikörper
        data.values as values where "blockindex = 4 and groupindex = 0 and itemid = 'braf_ihc_ab'" then
        {
            values.value as antikoerper -> tgt.component = create('BackboneElement') as componentAntikoerper then
            {
                antikoerper -> componentAntikoerper.valueCodeableConcept = cc('http://uk-koeln.de/fhir/CodeSystem/ihc-antikoerper', antikoerper);
                antikoerper -> componentAntikoerper.code = cc('http://ncit.nci.nih.gov', 'C16295');
            };
        };

        // Hersteller
        data.values as values where "blockindex = 4 and groupindex = 0 and itemid = 'braf_ihc_kit_ab_producer'" then
        {
            values.value as hersteller -> tgt.component = create('BackboneElement') as componentHersteller then
            {
                hersteller -> componentHersteller.valueCodeableConcept = cc('http://uk-koeln.de/fhir/CodeSystem/hersteller-molpatho', hersteller);
                hersteller -> componentHersteller.code = cc('http://ncit.nci.nih.gov', 'C25392');
            };
        };

        // Ergebnis
        data.values as values where "blockindex = 4 and groupindex = 0 and itemid = 'braf_ihc_result'" then
        {
            values.value where "$this.value = 'positiv'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA6576-8', 'Positive');
            };

            values.value where "$this.value = 'negativ'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA6577-6', 'Negative');
            };

            values.value where "$this.value = 'nicht auswertbar'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA18198-4', 'No call');
            };

            values.value where "$this.value = 'fraglich'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA11884-6', 'Indeterminate');
            };
        };

        // Referenzen
        // Specimen
        // data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'uuid_specimen_nngm4'" then
        // {
        //     values.value as value -> tgt.specimen = create('Reference') as specimen, specimen.reference = evaluate(value, '\'Specimen/\' + $this');
        // }; 
    };
}

group TransformObservationCK7(source operations: BackboneElement, target tgt: Observation, target composition: Composition, target section: BackboneElement)
{
    operations -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/ihc';

    // Status
    operations -> tgt.status = cast('final', 'FHIR.code');

    //IHC category
    operations then MapIHCCategory(operations, tgt);

    //CK7 code
    operations -> tgt.code = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/molpatho-obs-codes', 'CK7');

    // Subject
    operations -> tgt.subject = create('Reference') as subject, subject.reference = evaluate(composition, '\'Patient/\' + $this.subject.reference');

    // Methode
    operations then MapIHCMethode(operations, tgt);

    // Access data
    operations.data as data then
    {
        // ID + Composition insert
        data.values as values where "blockindex = 5 and groupindex = 0 and itemid = 'uuid_ihc_ck7'" then
        {
            values.value as value -> tgt.id = value;
            values.value as value -> section.entry = create('Reference') as observation, observation.reference = evaluate(value, '\'Observation/\' + $this');
        };

        // Netzwerkzentrum
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'id_2435'" then
        {
            values.value as nz -> tgt.component = create('BackboneElement') as nzcomponent then
            {
                values.value as value where "%tgt.component.where(code = 'C25341').exists().not()" then
                {
                    nz -> nzcomponent.valueString = nz;
                    nz -> nzcomponent.code = cc('http://ncit.nci.nih.gov', 'C25341');
                };
            };
        };

        // SOP-Versionsnummer des Standorts
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'id_2613'" then
        {
            values.value as sop -> tgt.component = create('BackboneElement') as sopcomponent then
            {
                values.value as value where "%tgt.component.where(code = 'C48443').exists().not()" then
                {
                    sop -> sopcomponent.valueString = sop;
                    sop -> sopcomponent.code = cc('http://ncit.nci.nih.gov', 'C48443');
                };
            };
        };

        // Date of Assessment end
        data.values as values where "blockindex = 15 and groupindex = 0 and itemid = 'id_2521'" then
        {
            values.value as effectiveDT -> tgt.effectivePeriod = create('Period') as period collate, period.end = dateOp(effectiveDT, 'date');
        };

        // Date of Assessment
        data.values as values where "blockindex = 5 and groupindex = 0 and itemid = 'id_2037'" then
        {
            values.value as effectiveDT -> tgt.effectivePeriod = create('Period') as period collate, period.start = dateOp(effectiveDT, 'date');
        };

        // Phänotyp
        data.values as values where "blockindex = 5 and groupindex = 0 and itemid = 'id_2038'" then
        {
            values.value as value where "%tgt.component.code.where(coding.code = 'C16977').exists().not()" then
            {
                values.value as phaenotyp->tgt.component = create('BackboneElement') as componentPhaenotyp then
                {
                    phaenotyp->componentPhaenotyp.valueString = phaenotyp;
                    phaenotyp->componentPhaenotyp.code = cc('http://ncit.nci.nih.gov', 'C16977');
                };
            };
        };

        // Antikörper
        data.values as values where "blockindex = 5 and groupindex = 0 and itemid = 'id_2041'" then
        {
            values.value as antikoerper -> tgt.component = create('BackboneElement') as componentAntikoerper then
            {
                antikoerper -> componentAntikoerper.valueCodeableConcept = cc('http://uk-koeln.de/fhir/CodeSystem/ihc-antikoerper', antikoerper);
                antikoerper -> componentAntikoerper.code = cc('http://ncit.nci.nih.gov', 'C16295');
            };
        };

        // Hersteller
        data.values as values where "blockindex = 5 and groupindex = 0 and itemid = 'id_2042'" then
        {
            values.value as hersteller -> tgt.component = create('BackboneElement') as componentHersteller then
            {
                hersteller -> componentHersteller.valueCodeableConcept = cc('http://uk-koeln.de/fhir/CodeSystem/hersteller-molpatho', hersteller);
                hersteller -> componentHersteller.code = cc('http://ncit.nci.nih.gov', 'C25392');
            };
        };

        // Ergebnis
        data.values as values where "blockindex = 5 and groupindex = 0 and itemid = 'id_2045'" then
        {
            values.value where "$this.value = 'positiv'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA6576-8', 'Positive');
            };

            values.value where "$this.value = 'negativ'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA6577-6', 'Negative');
            };

            values.value where "$this.value = 'nicht auswertbar'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA18198-4', 'No call');
            };

            values.value where "$this.value = 'fraglich'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA11884-6', 'Indeterminate');
            };
        };

        // Referenzen
        // Specimen
        // data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'uuid_specimen_nngm4'" then
        // {
        //     values.value as value -> tgt.specimen = create('Reference') as specimen, specimen.reference = evaluate(value, '\'Specimen/\' + $this');
        // };   
    };
}

group TransformObservationMIB1(source operations: BackboneElement, target tgt: Observation, target composition: Composition, target section: BackboneElement)
{
    operations -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/ihc';

    // Status
    operations -> tgt.status = cast('final', 'FHIR.code');

    //IHC category
    operations then MapIHCCategory(operations, tgt);

    //MIB1 code
    operations -> tgt.code = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/molpatho-obs-codes', 'MIB1');

    // Subject
    operations -> tgt.subject = create('Reference') as subject, subject.reference = evaluate(composition, '\'Patient/\' + $this.subject.reference');

    // Methode
    operations then MapIHCMethode(operations, tgt);

    // Access data
    operations.data as data then
    {
        // ID + Composition insert
        data.values as values where "blockindex = 6 and groupindex = 0 and itemid = 'uuid_ihc_mib1'" then
        {
            values.value as value -> tgt.id = value;
            values.value as value -> section.entry = create('Reference') as observation, observation.reference = evaluate(value, '\'Observation/\' + $this');
        };

        // Netzwerkzentrum
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'id_2435'" then
        {
            values.value as nz -> tgt.component = create('BackboneElement') as nzcomponent then
            {
                values.value as value where "%tgt.component.where(code = 'C25341').exists().not()" then
                {
                    nz -> nzcomponent.valueString = nz;
                    nz -> nzcomponent.code = cc('http://ncit.nci.nih.gov', 'C25341');
                };
            };
        };

        // SOP-Versionsnummer des Standorts
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'id_2613'" then
        {
            values.value as sop -> tgt.component = create('BackboneElement') as sopcomponent then
            {
                values.value as value where "%tgt.component.where(code = 'C48443').exists().not()" then
                {
                    sop -> sopcomponent.valueString = sop;
                    sop -> sopcomponent.code = cc('http://ncit.nci.nih.gov', 'C48443');
                };
            };
        };

        // Date of Assessment end
        data.values as values where "blockindex = 15 and groupindex = 0 and itemid = 'id_2521'" then
        {
            values.value as effectiveDT -> tgt.effectivePeriod = create('Period') as period collate, period.end = dateOp(effectiveDT, 'date');
        };

        // Phänotyp
        data.values as values where "blockindex = 6 and groupindex = 0 and itemid = 'id_2056'" then
        {
            values.value as value where "%tgt.component.code.where(coding.code = 'C16977').exists().not()" then
            {
                values.value as phaenotyp->tgt.component = create('BackboneElement') as componentPhaenotyp then
                {
                    phaenotyp->componentPhaenotyp.valueString = phaenotyp;
                    phaenotyp->componentPhaenotyp.code = cc('http://ncit.nci.nih.gov', 'C16977');
                };
            };
        };

        // Date of Assessment
        data.values as values where "blockindex = 6 and groupindex = 0 and itemid = 'id_2055'" then
        {
            values.value as effectiveDT -> tgt.effectivePeriod = create('Period') as period collate, period.start = dateOp(effectiveDT, 'date');
        };


        // Antikörper
        data.values as values where "blockindex = 6 and groupindex = 0 and itemid = 'id_2059'" then
        {
            values.value as antikoerper -> tgt.component = create('BackboneElement') as componentAntikoerper then
            {
                antikoerper -> componentAntikoerper.valueCodeableConcept = cc('http://uk-koeln.de/fhir/CodeSystem/ihc-antikoerper', antikoerper);
                antikoerper -> componentAntikoerper.code = cc('http://ncit.nci.nih.gov', 'C16295');
            };
        };

        // Hersteller
        data.values as values where "blockindex = 6 and groupindex = 0 and itemid = 'id_2060'" then
        {
            values.value as hersteller -> tgt.component = create('BackboneElement') as componentHersteller then
            {
                hersteller -> componentHersteller.valueCodeableConcept = cc('http://uk-koeln.de/fhir/CodeSystem/hersteller-molpatho', hersteller);
                hersteller -> componentHersteller.code = cc('http://ncit.nci.nih.gov', 'C25392');
            };
        };

        // Ergebnis
        data.values as values where "blockindex = 6 and groupindex = 0 and itemid = 'id_2063'" then
        {
            values.value where "$this.value = 'positiv'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA6576-8', 'Positive');
            };

            values.value where "$this.value = 'negativ'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA6577-6', 'Negative');
            };

            values.value where "$this.value = 'nicht auswertbar'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA18198-4', 'No call');
            };

            values.value where "$this.value = 'fraglich'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA11884-6', 'Indeterminate');
            };
        };

        // Referenzen
        // Specimen
        // data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'uuid_specimen_nngm4'" then
        // {
        //     values.value as value -> tgt.specimen = create('Reference') as specimen, specimen.reference = evaluate(value, '\'Specimen/\' + $this');
        // }; 
    };
}

group TransformObservationNAPSINA(source operations: BackboneElement, target tgt: Observation, target composition: Composition, target section: BackboneElement)
{
    operations -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/ihc';

    // Status
    operations -> tgt.status = cast('final', 'FHIR.code');

    //IHC category
    operations then MapIHCCategory(operations, tgt);

    //MIB1 code
    operations -> tgt.code = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/molpatho-obs-codes', 'Napsin A');

    // Subject
    operations -> tgt.subject = create('Reference') as subject, subject.reference = evaluate(composition, '\'Patient/\' + $this.subject.reference');

    // Methode
    operations then MapIHCMethode(operations, tgt);

    // Access data
    operations.data as data then
    {
        // ID + Composition insert
        data.values as values where "blockindex = 7 and groupindex = 0 and itemid = 'uuid_ihc_napsina'" then
        {
            values.value as value -> tgt.id = value;
            values.value as value -> section.entry = create('Reference') as observation, observation.reference = evaluate(value, '\'Observation/\' + $this');
        };

        // Netzwerkzentrum
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'id_2435'" then
        {
            values.value as nz -> tgt.component = create('BackboneElement') as nzcomponent then
            {
                values.value as value where "%tgt.component.where(code = 'C25341').exists().not()" then
                {
                    nz -> nzcomponent.valueString = nz;
                    nz -> nzcomponent.code = cc('http://ncit.nci.nih.gov', 'C25341');
                };
            };
        };

        // SOP-Versionsnummer des Standorts
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'id_2613'" then
        {
            values.value as sop -> tgt.component = create('BackboneElement') as sopcomponent then
            {
                values.value as value where "%tgt.component.where(code = 'C48443').exists().not()" then
                {
                    sop -> sopcomponent.valueString = sop;
                    sop -> sopcomponent.code = cc('http://ncit.nci.nih.gov', 'C48443');
                };
            };
        };

        // Date of Assessment end
        data.values as values where "blockindex = 15 and groupindex = 0 and itemid = 'id_2521'" then
        {
            values.value as effectiveDT -> tgt.effectivePeriod = create('Period') as period collate, period.end = dateOp(effectiveDT, 'date');
        };

        // Phänotyp
        data.values as values where "blockindex = 7 and groupindex = 0 and itemid = 'id_2065'" then
        {
            values.value as value where "%tgt.component.code.where(coding.code = 'C16977').exists().not()" then
            {
                values.value as phaenotyp->tgt.component = create('BackboneElement') as componentPhaenotyp then
                {
                    phaenotyp->componentPhaenotyp.valueString = phaenotyp;
                    phaenotyp->componentPhaenotyp.code = cc('http://ncit.nci.nih.gov', 'C16977');
                };
            };
        };

        // Date of Assessment
        data.values as values where "blockindex = 7 and groupindex = 0 and itemid = 'id_2064'" then
        {
            values.value as effectiveDT -> tgt.effectivePeriod = create('Period') as period collate, period.start = dateOp(effectiveDT, 'date');
        };

        // Antikörper
        data.values as values where "blockindex = 7 and groupindex = 0 and itemid = 'id_2068'" then
        {
            values.value as antikoerper -> tgt.component = create('BackboneElement') as componentAntikoerper then
            {
                antikoerper -> componentAntikoerper.valueCodeableConcept = cc('http://uk-koeln.de/fhir/CodeSystem/ihc-antikoerper', antikoerper);
                antikoerper -> componentAntikoerper.code = cc('http://ncit.nci.nih.gov', 'C16295');
            };
        };

        // Hersteller
        data.values as values where "blockindex = 7 and groupindex = 0 and itemid = 'id_2069'" then
        {
            values.value as hersteller -> tgt.component = create('BackboneElement') as componentHersteller then
            {
                hersteller -> componentHersteller.valueCodeableConcept = cc('http://uk-koeln.de/fhir/CodeSystem/hersteller-molpatho', hersteller);
                hersteller -> componentHersteller.code = cc('http://ncit.nci.nih.gov', 'C25392');
            };
        };

        // Ergebnis
        data.values as values where "blockindex = 7 and groupindex = 0 and itemid = 'id_2072'" then
        {
            values.value where "$this.value = 'positiv'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA6576-8', 'Positive');
            };

            values.value where "$this.value = 'negativ'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA6577-6', 'Negative');
            };

            values.value where "$this.value = 'nicht auswertbar'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA18198-4', 'No call');
            };

            values.value where "$this.value = 'fraglich'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA11884-6', 'Indeterminate');
            };
        };

        // Referenzen
        // Specimen
        // data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'uuid_specimen_nngm4'" then
        // {
        //     values.value as value -> tgt.specimen = create('Reference') as specimen, specimen.reference = evaluate(value, '\'Specimen/\' + $this');
        // }; 
    };
}

group TransformObservationP40(source operations: BackboneElement, target tgt: Observation, target composition: Composition, target section: BackboneElement)
{
    operations -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/ihc';

    // Status
    operations -> tgt.status = cast('final', 'FHIR.code');

    //IHC category
    operations then MapIHCCategory(operations, tgt);

    //P40 code
    operations -> tgt.code = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/molpatho-obs-codes', 'P40');

    // Subject
    operations -> tgt.subject = create('Reference') as subject, subject.reference = evaluate(composition, '\'Patient/\' + $this.subject.reference');

    // Methode
    operations then MapIHCMethode(operations, tgt);

    // Access data
    operations.data as data then
    {
        // ID + Composition insert
        data.values as values where "blockindex = 8 and groupindex = 0 and itemid = 'uuid_ihc_p40'" then
        {
            values.value as value -> tgt.id = value;
            values.value as value -> section.entry = create('Reference') as observation, observation.reference = evaluate(value, '\'Observation/\' + $this');
        };

        // Netzwerkzentrum
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'id_2435'" then
        {
            values.value as nz -> tgt.component = create('BackboneElement') as nzcomponent then
            {
                values.value as value where "%tgt.component.where(code = 'C25341').exists().not()" then
                {
                    nz -> nzcomponent.valueString = nz;
                    nz -> nzcomponent.code = cc('http://ncit.nci.nih.gov', 'C25341');
                };
            };
        };

        // SOP-Versionsnummer des Standorts
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'id_2613'" then
        {
            values.value as sop -> tgt.component = create('BackboneElement') as sopcomponent then
            {
                values.value as value where "%tgt.component.where(code = 'C48443').exists().not()" then
                {
                    sop -> sopcomponent.valueString = sop;
                    sop -> sopcomponent.code = cc('http://ncit.nci.nih.gov', 'C48443');
                };
            };
        };

        // Date of Assessment end
        data.values as values where "blockindex = 15 and groupindex = 0 and itemid = 'id_2521'" then
        {
            values.value as effectiveDT -> tgt.effectivePeriod = create('Period') as period collate, period.end = dateOp(effectiveDT, 'date');
        };

        // Phänotyp
        data.values as values where "blockindex = 8 and groupindex = 0 and itemid = 'id_2074'" then
        {
            values.value as value where "%tgt.component.code.where(coding.code = 'C16977').exists().not()" then
            {
                values.value as phaenotyp->tgt.component = create('BackboneElement') as componentPhaenotyp then
                {
                    phaenotyp->componentPhaenotyp.valueString = phaenotyp;
                    phaenotyp->componentPhaenotyp.code = cc('http://ncit.nci.nih.gov', 'C16977');
                };
            };
        };

        // Date of Assessment
        data.values as values where "blockindex = 8 and groupindex = 0 and itemid = 'id_2073'" then
        {
            values.value as effectiveDT -> tgt.effectivePeriod = create('Period') as period collate, period.start = dateOp(effectiveDT, 'date');
        };

        // Antikörper
        data.values as values where "blockindex = 8 and groupindex = 0 and itemid = 'id_2077'" then
        {
            values.value as antikoerper -> tgt.component = create('BackboneElement') as componentAntikoerper then
            {
                antikoerper -> componentAntikoerper.valueCodeableConcept = cc('http://uk-koeln.de/fhir/CodeSystem/ihc-antikoerper', antikoerper);
                antikoerper -> componentAntikoerper.code = cc('http://ncit.nci.nih.gov', 'C16295');
            };
        };

        // Hersteller
        data.values as values where "blockindex = 8 and groupindex = 0 and itemid = 'id_2078'" then
        {
            values.value as hersteller -> tgt.component = create('BackboneElement') as componentHersteller then
            {
                hersteller -> componentHersteller.valueCodeableConcept = cc('http://uk-koeln.de/fhir/CodeSystem/hersteller-molpatho', hersteller);
                hersteller -> componentHersteller.code = cc('http://ncit.nci.nih.gov', 'C25392');
            };
        };

        // Ergebnis
        data.values as values where "blockindex = 8 and groupindex = 0 and itemid = 'id_2079'" then
        {
            values.value where "$this.value = 'positiv'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA6576-8', 'Positive');
            };

            values.value where "$this.value = 'negativ'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA6577-6', 'Negative');
            };

            values.value where "$this.value = 'nicht auswertbar'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA18198-4', 'No call');
            };

            values.value where "$this.value = 'fraglich'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA11884-6', 'Indeterminate');
            };
        };

        // Referenzen
        // Specimen
        // data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'uuid_specimen_nngm4'" then
        // {
        //     values.value as value -> tgt.specimen = create('Reference') as specimen, specimen.reference = evaluate(value, '\'Specimen/\' + $this');
        // }; 
    };
}

group TransformObservationSynaptophysin(source operations: BackboneElement, target tgt: Observation, target composition: Composition, target section: BackboneElement)
{
    operations -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/ihc';

    // Status
    operations -> tgt.status = cast('final', 'FHIR.code');

    //IHC category
    operations then MapIHCCategory(operations, tgt);

    //Synaptophysin code
    operations -> tgt.code = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/molpatho-obs-codes', 'Synaptophysin');

    // Subject
    operations -> tgt.subject = create('Reference') as subject, subject.reference = evaluate(composition, '\'Patient/\' + $this.subject.reference');

    // Methode
    operations then MapIHCMethode(operations, tgt);

    // Access data
    operations.data as data then
    {
        // ID + Composition insert
        data.values as values where "blockindex = 9 and groupindex = 0 and itemid = 'uuid_ihc_synaptophysin'" then
        {
            values.value as value -> tgt.id = value;
            values.value as value -> section.entry = create('Reference') as observation, observation.reference = evaluate(value, '\'Observation/\' + $this');
        };

        // Netzwerkzentrum
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'id_2435'" then
        {
            values.value as nz -> tgt.component = create('BackboneElement') as nzcomponent then
            {
                values.value as value where "%tgt.component.where(code = 'C25341').exists().not()" then
                {
                    nz -> nzcomponent.valueString = nz;
                    nz -> nzcomponent.code = cc('http://ncit.nci.nih.gov', 'C25341');
                };
            };
        };

        // SOP-Versionsnummer des Standorts
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'id_2613'" then
        {
            values.value as sop -> tgt.component = create('BackboneElement') as sopcomponent then
            {
                values.value as value where "%tgt.component.where(code = 'C48443').exists().not()" then
                {
                    sop -> sopcomponent.valueString = sop;
                    sop -> sopcomponent.code = cc('http://ncit.nci.nih.gov', 'C48443');
                };
            };
        };

        // Date of Assessment end
        data.values as values where "blockindex = 15 and groupindex = 0 and itemid = 'id_2521'" then
        {
            values.value as effectiveDT -> tgt.effectivePeriod = create('Period') as period collate, period.end = dateOp(effectiveDT, 'date');
        };

        // Phänotyp
        data.values as values where "blockindex = 9 and groupindex = 0 and itemid = 'id_2081'" then
        {
            values.value as value where "%tgt.component.code.where(coding.code = 'C16977').exists().not()" then
            {
                values.value as phaenotyp->tgt.component = create('BackboneElement') as componentPhaenotyp then
                {
                    phaenotyp->componentPhaenotyp.valueString = phaenotyp;
                    phaenotyp->componentPhaenotyp.code = cc('http://ncit.nci.nih.gov', 'C16977');
                };
            };
        };

        // Date of Assessment
        data.values as values where "blockindex = 9 and groupindex = 0 and itemid = 'id_2080'" then
        {
            values.value as effectiveDT -> tgt.effectivePeriod = create('Period') as period collate, period.start = dateOp(effectiveDT, 'date');
        };

        // Antikörper
        data.values as values where "blockindex = 9 and groupindex = 0 and itemid = 'id_2084'" then
        {
            values.value as antikoerper -> tgt.component = create('BackboneElement') as componentAntikoerper then
            {
                antikoerper -> componentAntikoerper.valueCodeableConcept = cc('http://uk-koeln.de/fhir/CodeSystem/ihc-antikoerper', antikoerper);
                antikoerper -> componentAntikoerper.code = cc('http://ncit.nci.nih.gov', 'C16295');
            };
        };

        // Hersteller
        data.values as values where "blockindex = 9 and groupindex = 0 and itemid = 'id_2085'" then
        {
            values.value as hersteller -> tgt.component = create('BackboneElement') as componentHersteller then
            {
                hersteller -> componentHersteller.valueCodeableConcept = cc('http://uk-koeln.de/fhir/CodeSystem/hersteller-molpatho', hersteller);
                hersteller -> componentHersteller.code = cc('http://ncit.nci.nih.gov', 'C25392');
            };
        };

        // Ergebnis
        data.values as values where "blockindex = 9 and groupindex = 0 and itemid = 'id_2088'" then
        {
            values.value where "$this.value = 'positiv'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA6576-8', 'Positive');
            };

            values.value where "$this.value = 'negativ'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA6577-6', 'Negative');
            };

            values.value where "$this.value = 'nicht auswertbar'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA18198-4', 'No call');
            };

            values.value where "$this.value = 'fraglich'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA11884-6', 'Indeterminate');
            };
        };
        
        // Referenzen
        // Specimen
        // data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'uuid_specimen_nngm4'" then
        // {
        //     values.value as value -> tgt.specimen = create('Reference') as specimen, specimen.reference = evaluate(value, '\'Specimen/\' + $this');
        // };   
    };
}

group TransformObservationTTF1(source operations: BackboneElement, target tgt: Observation, target composition: Composition, target section: BackboneElement)
{
    operations -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/ihc';

    // Status
    operations -> tgt.status = cast('final', 'FHIR.code');

    //IHC category
    operations then MapIHCCategory(operations, tgt);

    //TTF1 code
    operations -> tgt.code = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/molpatho-obs-codes', 'TTF1');

    // Subject
    operations -> tgt.subject = create('Reference') as subject, subject.reference = evaluate(composition, '\'Patient/\' + $this.subject.reference');

    // Methode
    operations then MapIHCMethode(operations, tgt);
    
    // Access data
    operations.data as data then
    {
        // ID + Composition insert
        data.values as values where "blockindex = 10 and groupindex = 0 and itemid = 'uuid_ihc_ttf1'" then
        {
            values.value as value -> tgt.id = value;
            values.value as value -> section.entry = create('Reference') as observation, observation.reference = evaluate(value, '\'Observation/\' + $this');
        };

        // Netzwerkzentrum
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'id_2435'" then
        {
            values.value as nz -> tgt.component = create('BackboneElement') as nzcomponent then
            {
                values.value as value where "%tgt.component.where(code = 'C25341').exists().not()" then
                {
                    nz -> nzcomponent.valueString = nz;
                    nz -> nzcomponent.code = cc('http://ncit.nci.nih.gov', 'C25341');
                };
            };
        };

        // SOP-Versionsnummer des Standorts
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'id_2613'" then
        {
            values.value as sop -> tgt.component = create('BackboneElement') as sopcomponent then
            {
                values.value as value where "%tgt.component.where(code = 'C48443').exists().not()" then
                {
                    sop -> sopcomponent.valueString = sop;
                    sop -> sopcomponent.code = cc('http://ncit.nci.nih.gov', 'C48443');
                };
            };
        };

        // Date of Assessment end
        data.values as values where "blockindex = 15 and groupindex = 0 and itemid = 'id_2521'" then
        {
            values.value as effectiveDT -> tgt.effectivePeriod = create('Period') as period collate, period.end = dateOp(effectiveDT, 'date');
        };

        // Phänotyp
        data.values as values where "blockindex = 10 and groupindex = 0 and itemid = 'id_2090'" then
        {
            values.value as value where "%tgt.component.code.where(coding.code = 'C16977').exists().not()" then
            {
                values.value as phaenotyp->tgt.component = create('BackboneElement') as componentPhaenotyp then
                {
                    phaenotyp->componentPhaenotyp.valueString = phaenotyp;
                    phaenotyp->componentPhaenotyp.code = cc('http://ncit.nci.nih.gov', 'C16977');
                };
            };
        };

        // Date of Assessment
        data.values as values where "blockindex = 10 and groupindex = 0 and itemid = 'id_2089'" then
        {
            values.value as effectiveDT -> tgt.effectivePeriod = create('Period') as period collate, period.start = dateOp(effectiveDT, 'date');
        };

        // Antikörper
        data.values as values where "blockindex = 10 and groupindex = 0 and itemid = 'id_2093'" then
        {
            values.value as antikoerper -> tgt.component = create('BackboneElement') as componentAntikoerper then
            {
                antikoerper -> componentAntikoerper.valueCodeableConcept = cc('http://uk-koeln.de/fhir/CodeSystem/ihc-antikoerper', antikoerper);
                antikoerper -> componentAntikoerper.code = cc('http://ncit.nci.nih.gov', 'C16295');
            };
        };

        // Hersteller
        data.values as values where "blockindex = 10 and groupindex = 0 and itemid = 'id_2094'" then
        {
            values.value as hersteller -> tgt.component = create('BackboneElement') as componentHersteller then
            {
                hersteller -> componentHersteller.valueCodeableConcept = cc('http://uk-koeln.de/fhir/CodeSystem/hersteller-molpatho', hersteller);
                hersteller -> componentHersteller.code = cc('http://ncit.nci.nih.gov', 'C25392');
            };
        };

        // Ergebnis
        data.values as values where "blockindex = 10 and groupindex = 0 and itemid = 'id_2097'" then
        {
            values.value where "$this.value = 'positiv'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA6576-8', 'Positive');
            };

            values.value where "$this.value = 'negativ'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA6577-6', 'Negative');
            };

            values.value where "$this.value = 'nicht auswertbar'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA18198-4', 'No call');
            };

            values.value where "$this.value = 'fraglich'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA11884-6', 'Indeterminate');
            };
        };

        // Referenzen
        // Specimen
        // data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'uuid_specimen_nngm4'" then
        // {
        //     values.value as value -> tgt.specimen = create('Reference') as specimen, specimen.reference = evaluate(value, '\'Specimen/\' + $this');
        // }; 
    };
}

group TransformObservationALK(source operations: BackboneElement, target tgt: Observation, target composition: Composition, target section: BackboneElement)
{
    operations -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/ihc';

    // Status
    operations -> tgt.status = cast('final', 'FHIR.code');

    //IHC category
    operations then MapIHCCategory(operations, tgt);

    //ALK code
    operations -> tgt.code = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/molpatho-obs-codes', 'ALK');

    // Subject
    operations -> tgt.subject = create('Reference') as subject, subject.reference = evaluate(composition, '\'Patient/\' + $this.subject.reference');

    // Methode
    operations then MapIHCMethode(operations, tgt);
    
    // Access data
    operations.data as data then
    {
        // ID + Composition insert
        data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'uuid_ihc_alk'" then
        {
            values.value as value -> tgt.id = value;
            values.value as value -> section.entry = create('Reference') as observation, observation.reference = evaluate(value, '\'Observation/\' + $this');
        };

        // Netzwerkzentrum
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'id_2435'" then
        {
            values.value as nz -> tgt.component = create('BackboneElement') as nzcomponent then
            {
                values.value as value where "%tgt.component.where(code = 'C25341').exists().not()" then
                {
                    nz -> nzcomponent.valueString = nz;
                    nz -> nzcomponent.code = cc('http://ncit.nci.nih.gov', 'C25341');
                };
            };
        };

        // SOP-Versionsnummer des Standorts
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'id_2613'" then
        {
            values.value as sop -> tgt.component = create('BackboneElement') as sopcomponent then
            {
                values.value as value where "%tgt.component.where(code = 'C48443').exists().not()" then
                {
                    sop -> sopcomponent.valueString = sop;
                    sop -> sopcomponent.code = cc('http://ncit.nci.nih.gov', 'C48443');
                };
            };
        };

        // Date of Assessment end
        data.values as values where "blockindex = 15 and groupindex = 0 and itemid = 'id_2521'" then
        {
            values.value as effectiveDT -> tgt.effectivePeriod = create('Period') as period collate, period.end = dateOp(effectiveDT, 'date');
        };

        // Phänotyp
        data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'id_2534'" then
        {
            values.value as value where "%tgt.component.code.where(coding.code = 'C16977').exists().not()" then
            {
                values.value as phaenotyp->tgt.component = create('BackboneElement') as componentPhaenotyp then
                {
                    phaenotyp->componentPhaenotyp.valueString = phaenotyp;
                    phaenotyp->componentPhaenotyp.code = cc('http://ncit.nci.nih.gov', 'C16977');
                };
            };
        };

        // Date of Assessment
        data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'id_2098'" then
        {
            values.value as effectiveDT -> tgt.effectivePeriod = create('Period') as period collate, period.start = dateOp(effectiveDT, 'date');
        };


        // Antikörper
        data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'id_2102'" then
        {
            values.value as antikoerper -> tgt.component = create('BackboneElement') as componentAntikoerper then
            {
                antikoerper -> componentAntikoerper.valueCodeableConcept = cc('http://uk-koeln.de/fhir/CodeSystem/ihc-antikoerper', antikoerper);
                antikoerper -> componentAntikoerper.code = cc('http://ncit.nci.nih.gov', 'C16295');
            };
        };

        // Hersteller
        data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'id_2103'" then
        {
            values.value as hersteller -> tgt.component = create('BackboneElement') as componentHersteller then
            {
                hersteller -> componentHersteller.valueCodeableConcept = cc('http://uk-koeln.de/fhir/CodeSystem/hersteller-molpatho', hersteller);
                hersteller -> componentHersteller.code = cc('http://ncit.nci.nih.gov', 'C25392');
            };
        };

        // Ergebnis
        data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'id_2106'" then
        {
            values.value where "$this.value = 'positiv'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA6576-8', 'Positive');
            };

            values.value where "$this.value = 'negativ'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA6577-6', 'Negative');
            };

            values.value where "$this.value = 'nicht auswertbar'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA18198-4', 'No call');
            };

            values.value where "$this.value = 'fraglich'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA11884-6', 'Indeterminate');
            };
        };
        
        // Referenzen
        // Specimen
        // data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'uuid_specimen_nngm4'" then
        // {
        //     values.value as value -> tgt.specimen = create('Reference') as specimen, specimen.reference = evaluate(value, '\'Specimen/\' + $this');
        // };   
    };
}

group TransformObservationMET(source operations: BackboneElement, target tgt: Observation, target composition: Composition, target section: BackboneElement)
{
    operations -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/ihc';
    
    // Status
    operations -> tgt.status = cast('final', 'FHIR.code');

    //IHC category
    operations then MapIHCCategory(operations, tgt);

    //MET code
    operations -> tgt.code = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/molpatho-obs-codes', 'MET');

    // Subject
    operations -> tgt.subject = create('Reference') as subject, subject.reference = evaluate(composition, '\'Patient/\' + $this.subject.reference');

    // Methode
    operations then MapIHCMethode(operations, tgt);

    // Access data
    operations.data as data then
    {
        // ID + Composition insert
        data.values as values where "blockindex = 12 and groupindex = 0 and itemid = 'uuid_ihc_met'" then
        {
            values.value as value -> tgt.id = value;
            values.value as value -> section.entry = create('Reference') as observation, observation.reference = evaluate(value, '\'Observation/\' + $this');
        };

        // Netzwerkzentrum
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'id_2435'" then
        {
            values.value as nz -> tgt.component = create('BackboneElement') as nzcomponent then
            {
                values.value as value where "%tgt.component.where(code = 'C25341').exists().not()" then
                {
                    nz -> nzcomponent.valueString = nz;
                    nz -> nzcomponent.code = cc('http://ncit.nci.nih.gov', 'C25341');
                };
            };
        };

        // SOP-Versionsnummer des Standorts
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'id_2613'" then
        {
            values.value as sop -> tgt.component = create('BackboneElement') as sopcomponent then
            {
                values.value as value where "%tgt.component.where(code = 'C48443').exists().not()" then
                {
                    sop -> sopcomponent.valueString = sop;
                    sop -> sopcomponent.code = cc('http://ncit.nci.nih.gov', 'C48443');
                };
            };
        };

        // Date of Assessment end
        data.values as values where "blockindex = 15 and groupindex = 0 and itemid = 'id_2521'" then
        {
            values.value as effectiveDT -> tgt.effectivePeriod = create('Period') as period collate, period.end = dateOp(effectiveDT, 'date');
        };

        // Phänotyp
        data.values as values where "blockindex = 12 and groupindex = 0 and itemid = 'id_2535'" then
        {
            values.value as value where "%tgt.component.code.where(coding.code = 'C16977').exists().not()" then
            {
                values.value as phaenotyp->tgt.component = create('BackboneElement') as componentPhaenotyp then
                {
                    phaenotyp->componentPhaenotyp.valueString = phaenotyp;
                    phaenotyp->componentPhaenotyp.code = cc('http://ncit.nci.nih.gov', 'C16977');
                };
            };
        };

        // Date of Assessment
        data.values as values where "blockindex = 12 and groupindex = 0 and itemid = 'id_2132'" then
        {
            values.value as effectiveDT -> tgt.effectivePeriod = create('Period') as period collate, period.start = dateOp(effectiveDT, 'date');
        };

        // Antikörper
        data.values as values where "blockindex = 12 and groupindex = 0 and itemid = 'id_2136'" then
        {
            values.value as antikoerper -> tgt.component = create('BackboneElement') as componentAntikoerper then
            {
                antikoerper -> componentAntikoerper.valueCodeableConcept = cc('http://uk-koeln.de/fhir/CodeSystem/ihc-antikoerper', antikoerper);
                antikoerper -> componentAntikoerper.code = cc('http://ncit.nci.nih.gov', 'C16295');
            };
        };

        // Hersteller
        data.values as values where "blockindex = 12 and groupindex = 0 and itemid = 'id_2451'" then
        {
            values.value as hersteller -> tgt.component = create('BackboneElement') as componentHersteller then
            {
                hersteller -> componentHersteller.valueCodeableConcept = cc('http://uk-koeln.de/fhir/CodeSystem/hersteller-molpatho', hersteller);
                hersteller -> componentHersteller.code = cc('http://ncit.nci.nih.gov', 'C25392');
            };
        };

        // Ergebnis
        data.values as values where "blockindex = 12 and groupindex = 0 and itemid = 'id_2139'" then
        {
            values.value where "$this.value = 'positiv'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA6576-8', 'Positive');
            };

            values.value where "$this.value = 'negativ'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA6577-6', 'Negative');
            };

            values.value where "$this.value = 'nicht auswertbar'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA18198-4', 'No call');
            };

            values.value where "$this.value = 'fraglich'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA11884-6', 'Indeterminate');
            };
        };
        

        // Klassifikation
        data.values as values where "blockindex = 12 and groupindex = 0 and itemid = 'id_2140'" then
        {
            values.value as klassifikation -> tgt.component = create('BackboneElement') as componentKlassifikation then
            {
                klassifikation -> componentKlassifikation.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/0-3+-klassifikation', klassifikation);
                klassifikation -> componentKlassifikation.code = cc('http://ncit.nci.nih.gov', 'C25161');
            };
        };

        // Expression High Level
        data.values as values where "blockindex = 12 and groupindex = 0 and itemid = 'id_2141'" then
        {
            values.value as expression where "$this.value = 'yes'" then
            {
                expression -> tgt.component = create('BackboneElement') as componentExpression then
                {
                    expression -> componentExpression.valueBoolean = 'true';
                    expression -> componentExpression.code = cc('http://ncit.nci.nih.gov', 'C129474');
                };
            };
            values.value as expression where "$this.value = 'no'" then
            {
                expression -> tgt.component = create('BackboneElement') as componentExpression then
                {
                    expression -> componentExpression.valueBoolean = 'false';
                    expression -> componentExpression.code = cc('http://ncit.nci.nih.gov', 'C129474');
                };
            };
        };

        // Referenzen
        // Specimen
        // data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'uuid_specimen_nngm4'" then
        // {
        //     values.value as value -> tgt.specimen = create('Reference') as specimen, specimen.reference = evaluate(value, '\'Specimen/\' + $this');
        // };   
    };
}

group TransformObservationPDL1(source operations: BackboneElement, target tgt: Observation, target composition: Composition, target section: BackboneElement)
{
    operations -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/ihc';

    // Status
    operations -> tgt.status = cast('final', 'FHIR.code');

    //IHC category
    operations then MapIHCCategory(operations, tgt);

    //PD-L1 code
    operations -> tgt.code = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/molpatho-obs-codes', 'PD-L1');

    // Subject
    operations -> tgt.subject = create('Reference') as subject, subject.reference = evaluate(composition, '\'Patient/\' + $this.subject.reference');

    // Methode
    operations then MapIHCMethode(operations, tgt);

    // Access data
    operations.data as data then
    {
        // ID + Composition insert
        data.values as values where "blockindex = 13 and groupindex = 0 and itemid = 'uuid_ihc_pdl1'" then
        {
            values.value as value -> tgt.id = value;
            values.value as value -> section.entry = create('Reference') as observation, observation.reference = evaluate(value, '\'Observation/\' + $this');
        };

        // Netzwerkzentrum
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'id_2435'" then
        {
            values.value as nz -> tgt.component = create('BackboneElement') as nzcomponent then
            {
                values.value as value where "%tgt.component.where(code = 'C25341').exists().not()" then
                {
                    nz -> nzcomponent.valueString = nz;
                    nz -> nzcomponent.code = cc('http://ncit.nci.nih.gov', 'C25341');
                };
            };
        };

        // SOP-Versionsnummer des Standorts
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'id_2613'" then
        {
            values.value as sop -> tgt.component = create('BackboneElement') as sopcomponent then
            {
                values.value as value where "%tgt.component.where(code = 'C48443').exists().not()" then
                {
                    sop -> sopcomponent.valueString = sop;
                    sop -> sopcomponent.code = cc('http://ncit.nci.nih.gov', 'C48443');
                };
            };
        };

        // Date of Assessment end
        data.values as values where "blockindex = 15 and groupindex = 0 and itemid = 'id_2521'" then
        {
            values.value as effectiveDT -> tgt.effectivePeriod = create('Period') as period collate, period.end = dateOp(effectiveDT, 'date');
        };

        // Phänotyp
        data.values as values where "blockindex = 13 and groupindex = 0 and itemid = 'id_2173'" then
        {
            values.value as value where "%tgt.component.code.where(coding.code = 'C16977').exists().not()" then
            {
                values.value as phaenotyp->tgt.component = create('BackboneElement') as componentPhaenotyp then
                {
                    phaenotyp->componentPhaenotyp.valueString = phaenotyp;
                    phaenotyp->componentPhaenotyp.code = cc('http://ncit.nci.nih.gov', 'C16977');
                };
            };
        };

        // Date of Assessment
        data.values as values where "blockindex = 13 and groupindex = 0 and itemid = 'id_2172'" then
        {
            values.value as effectiveDT -> tgt.effectivePeriod = create('Period') as period collate, period.start = dateOp(effectiveDT, 'date');
        };

        // Antikörper
        data.values as values where "blockindex = 13 and groupindex = 0 and itemid = 'id_2176'" then
        {
            values.value as antikoerper -> tgt.component = create('BackboneElement') as componentAntikoerper then
            {
                antikoerper -> componentAntikoerper.valueCodeableConcept = cc('http://uk-koeln.de/fhir/CodeSystem/ihc-antikoerper', antikoerper);
                antikoerper -> componentAntikoerper.code = cc('http://ncit.nci.nih.gov', 'C16295');
            };
        };

        // Hersteller
        data.values as values where "blockindex = 13 and groupindex = 0 and itemid = 'id_2177'" then
        {
            values.value as hersteller -> tgt.component = create('BackboneElement') as componentHersteller then
            {
                hersteller -> componentHersteller.valueCodeableConcept = cc('http://uk-koeln.de/fhir/CodeSystem/hersteller-molpatho', hersteller);
                hersteller -> componentHersteller.code = cc('http://ncit.nci.nih.gov', 'C25392');
            };
        };

        // Ergebnis
        data.values as values where "blockindex = 13 and groupindex = 0 and itemid = 'id_2180'" then
        {
            values.value where "$this.value = 'auswertbar'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA6576-8', 'Positive');
            };

            values.value as ergebnis where "$this.value = 'nicht auswertbar'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA18198-4', 'No call');
            };
        };
        

        // Menge an Tumorzellen
        data.values as values where "blockindex = 13 and groupindex = 0 and itemid = 'id_2181'" then
        {
            values.value as ergebnis -> tgt.component = create('BackboneElement') as postumorzellencomponent then
            {
                ergebnis -> postumorzellencomponent.valueQuantity = create('Quantity') as quantity then MapPercentageValue(ergebnis, quantity);
                ergebnis -> postumorzellencomponent.code = cc('http://ncit.nci.nih.gov', 'C127771');
            };
        };

        // Fläche positiver Immunzellen / Gesamttumorfläche
        data.values as values where "blockindex = 13 and groupindex = 0 and itemid = 'id_2182'" then
        {
            values.value as ergebnis -> tgt.component = create('BackboneElement') as postumorzellencomponent then
            {
                ergebnis -> postumorzellencomponent.valueQuantity = create('Quantity') as quantity then MapPercentageValue(ergebnis, quantity);
                ergebnis -> postumorzellencomponent.code = cc('http://uk-koeln.de/fhir/CodeSystem/tbd-codes', 'tcell-surface-ratio');
            };
        };

        // Referenzen
        // Specimen
        // data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'uuid_specimen_nngm4'" then
        // {
        //     values.value as value -> tgt.specimen = create('Reference') as specimen, specimen.reference = evaluate(value, '\'Specimen/\' + $this');
        // };
    };
}

group TransformObservationROS1(source operations: BackboneElement, target tgt: Observation, target composition: Composition, target section: BackboneElement)
{
    operations -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/ihc';

    // Status
    operations -> tgt.status = cast('final', 'FHIR.code');

    //IHC category
    operations then MapIHCCategory(operations, tgt);

    //ROS1 code
    operations -> tgt.code = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/molpatho-obs-codes', 'ROS1');

    // Subject
    operations -> tgt.subject = create('Reference') as subject, subject.reference = evaluate(composition, '\'Patient/\' + $this.subject.reference');

    // Methode
    operations then MapIHCMethode(operations, tgt);

    // Access data
    operations.data as data then
    {
        // ID + Composition insert
        data.values as values where "blockindex = 14 and groupindex = 0 and itemid = 'uuid_ihc_ros1'" then
        {
            values.value as value -> tgt.id = value;
            values.value as value -> section.entry = create('Reference') as observation, observation.reference = evaluate(value, '\'Observation/\' + $this');
        };

        // Netzwerkzentrum
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'id_2435'" then
        {
            values.value as nz -> tgt.component = create('BackboneElement') as nzcomponent then
            {
                values.value as value where "%tgt.component.where(code = 'C25341').exists().not()" then
                {
                    nz -> nzcomponent.valueString = nz;
                    nz -> nzcomponent.code = cc('http://ncit.nci.nih.gov', 'C25341');
                };
            };
        };

        // SOP-Versionsnummer des Standorts
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'id_2613'" then
        {
            values.value as sop -> tgt.component = create('BackboneElement') as sopcomponent then
            {
                values.value as value where "%tgt.component.where(code = 'C48443').exists().not()" then
                {
                    sop -> sopcomponent.valueString = sop;
                    sop -> sopcomponent.code = cc('http://ncit.nci.nih.gov', 'C48443');
                };
            };
        };

        // Date of Assessment end
        data.values as values where "blockindex = 15 and groupindex = 0 and itemid = 'id_2521'" then
        {
            values.value as effectiveDT -> tgt.effectivePeriod = create('Period') as period collate, period.end = dateOp(effectiveDT, 'date');
        };

        // Phänotyp
        data.values as values where "blockindex = 14 and groupindex = 0 and itemid = 'id_2536'" then
        {
            values.value as value where "%tgt.component.code.where(coding.code = 'C16977').exists().not()" then
            {
                values.value as phaenotyp->tgt.component = create('BackboneElement') as componentPhaenotyp then
                {
                    phaenotyp->componentPhaenotyp.valueString = phaenotyp;
                    phaenotyp->componentPhaenotyp.code = cc('http://ncit.nci.nih.gov', 'C16977');
                };
            };
        };

        // Date of Assessment
        data.values as values where "blockindex = 14 and groupindex = 0 and itemid = 'id_2211'" then
        {
            values.value as effectiveDT -> tgt.effectivePeriod = create('Period') as period collate, period.start = dateOp(effectiveDT, 'date');
        };

        // Antikörper
        data.values as values where "blockindex = 14 and groupindex = 0 and itemid = 'id_2215'" then
        {
            values.value as antikoerper -> tgt.component = create('BackboneElement') as componentAntikoerper then
            {
                antikoerper -> componentAntikoerper.valueCodeableConcept = cc('http://uk-koeln.de/fhir/CodeSystem/ihc-antikoerper', antikoerper);
                antikoerper -> componentAntikoerper.code = cc('http://ncit.nci.nih.gov', 'C16295');
            };
        };

        // Hersteller
        data.values as values where "blockindex = 14 and groupindex = 0 and itemid = 'id_2216'" then
        {
            values.value as hersteller -> tgt.component = create('BackboneElement') as componentHersteller then
            {
                hersteller -> componentHersteller.valueCodeableConcept = cc('http://uk-koeln.de/fhir/CodeSystem/hersteller-molpatho', hersteller);
                hersteller -> componentHersteller.code = cc('http://ncit.nci.nih.gov', 'C25392');
            };
        };

        // Ergebnis
        data.values as values where "blockindex = 14 and groupindex = 0 and itemid = 'id_2219'" then
        {
            values.value where "$this.value = 'positiv'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA6576-8', 'Positive');
            };

            values.value where "$this.value = 'negativ'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA6577-6', 'Negative');
            };

            values.value where "$this.value = 'nicht auswertbar'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA18198-4', 'No call');
            };

            values.value where "$this.value = 'fraglich'" then 
            {
                values.value as ergebnis ->  tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/nNGM/ergebnis-posNegIndNoCall', 'LA11884-6', 'Indeterminate');
            };
        };
    
        // Referenzen
        // Specimen
        // data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'uuid_specimen_nngm4'" then
        // {
        //     values.value as value -> tgt.specimen = create('Reference') as specimen, specimen.reference = evaluate(value, '\'Specimen/\' + $this');
        // };
    };
}

/*-----------------HELPERS----------------------------*/
group MapPercentageValue(source src: string, target tgt: Quantity)
{
    src -> tgt.value = src,
            tgt.system = 'http://unitsofmeasure.org',
            tgt.unit = 'percentage',
            tgt.code = '%';
}


group MapIHCCategory(source operation: BackboneElement, target tgt: Observation)
{
    //IHC category
    operation -> tgt.category as category then
    {
        operation -> category.coding = create ('Coding') as coding, coding.system = 'http://hl7.org/fhir/ValueSet/observation-category',
                                                                        coding.code = 'laboratory';                                                    
    };
}

group MapIHCMethode(source operation: BackboneElement, target tgt: Observation)
{
    // IHC Methode
    operation -> tgt.method = cc('http://ncit.nci.nih.gov', 'C23020');
}

group SetReferenceToObservation(source operations: BackboneElement, source name: string, target tgt: Reference)
{
    // Check which observation should be referenced
    name where "%name = 'BRAF'" then 
    {
        operations.data as data, data.values as values where "blockindex = 4 and groupindex = 0 and itemid = 'uuid_ihc_braf'" then
        {
            values.value as value -> tgt.reference = evaluate(value, '\'Observation/\' + $this');
        };
    };
    
    name where "%name = 'CK7'" then 
    {
        operations.data as data, data.values as values where "blockindex = 5 and groupindex = 0 and itemid = 'uuid_ihc_ck7'" then
        {
            values.value as value -> tgt.reference = evaluate(value, '\'Observation/\' + $this');
        };    
    };
    
    name where "%name = 'MIB1'" then 
    {
        operations.data as data, data.values as values where "blockindex = 6 and groupindex = 0 and itemid = 'uuid_ihc_mib1'" then
        {
            values.value as value -> tgt.reference = evaluate(value, '\'Observation/\' + $this');
        };   
    };

    name where "%name = 'Napsin A'" then 
    {
        operations.data as data, data.values as values where "blockindex = 7 and groupindex = 0 and itemid = 'uuid_ihc_napsina'" then
        {
            values.value as value -> tgt.reference = evaluate(value, '\'Observation/\' + $this');
        };    
    };

    name where "%name = 'P40'" then 
    {
        operations.data as data, data.values as values where "blockindex = 8 and groupindex = 0 and itemid = 'uuid_ihc_p40'" then
        {
            values.value as value -> tgt.reference = evaluate(value, '\'Observation/\' + $this');
        };     
    };

    name where "%name = 'Synaptophysin'" then 
    {
        operations.data as data, data.values as values where "blockindex = 9 and groupindex = 0 and itemid = 'uuid_ihc_synaptophysin'" then
        {
            values.value as value -> tgt.reference = evaluate(value, '\'Observation/\' + $this');
        };   
    };

    name where "%name = 'TTF1'" then 
    {
        operations.data as data, data.values as values where "blockindex = 10 and groupindex = 0 and itemid = 'uuid_ihc_ttf1'" then
        {
            values.value as value -> tgt.reference = evaluate(value, '\'Observation/\' + $this');
        };   
    };

    name where "%name = 'ALK'" then 
    {
        operations.data as data, data.values as values where "blockindex = 11 and groupindex = 0 and itemid = 'uuid_ihc_alk'" then
        {
            values.value as value -> tgt.reference = evaluate(value, '\'Observation/\' + $this');
        };   
    };

    name where "%name = 'MET'" then 
    {
        operations.data as data, data.values as values where "blockindex = 12 and groupindex = 0 and itemid = 'uuid_ihc_met'" then
        {
            values.value as value -> tgt.reference = evaluate(value, '\'Observation/\' + $this');
        };    
    };

    name where "%name = 'PD-L1'" then 
    {
        operations.data as data, data.values as values where "blockindex = 13 and groupindex = 0 and itemid = 'uuid_ihc_pdl1'" then
        {
            values.value as value -> tgt.reference = evaluate(value, '\'Observation/\' + $this');
        };   
    };

    name where "%name = 'ROS1'" then 
    {
        operations.data as data, data.values as values where "blockindex = 14 and groupindex = 0 and itemid = 'uuid_ihc_ros1'" then
        {
            values.value as value -> tgt.reference = evaluate(value, '\'Observation/\' + $this');
        };     
    };
}