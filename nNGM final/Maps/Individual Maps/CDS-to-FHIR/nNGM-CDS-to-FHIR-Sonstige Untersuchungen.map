/// version = 0.1
/// title = "SonstigeUntersuchungenMap"

/*
TODO
- The repeatindex for the observation is not implemented
*/

map "http://uk-koeln.de/fhir/StructureMap/nNGM_Mapping_SonstigeUntersuchungenFHIR" = nNGM_Mapping_SonstigeUntersuchungenFHIR

uses "http://hl7.org/fhir/StructureDefinition/CTS_Transport" as source

uses "http://hl7.org/fhir/StructureDefinition/DiagnosticReport" as target
uses "http://hl7.org/fhir/StructureDefinition/Organization" as target
uses "http://hl7.org/fhir/StructureDefinition/Observation" as target
uses "http://hl7.org/fhir/StructureDefinition/ServiceRequest" as target

group TransformBundleSonstigeUntersuchungen(source src: CTS_Transport, target bundle: Bundle)
{
    //Check if any fields are filled in before creating the Speciment
    src -> bundle.entry as entry then CreateSpecimenSonstigeUntersuchungen(src, entry);

    //Check if any fields are filled in before creating the DiagnosticReport
    src -> bundle.entry as entry then CreateDiagnosticReportSonstigeUntersuchungen(src, entry);

    //Check if any fields are filled in before creating the Organization
    src -> bundle.entry as entry then CreateOrganizationSonstigeUntersuchungen(src, entry);

    //Check if any fields are filled in before creating the observation
    src -> bundle.entry as entry then CreateObservationSonstigeUntersuchungen(src, entry);

    //Check if any fields are filled in before creating the ServiceRequest
    src -> bundle.entry as entry then CreateServiceRequestSonstigeUntersuchungen(src, entry);
}

group CreateSpecimenSonstigeUntersuchungen(source src: CTS_Transport, target tgt: BackboneElement)
{
    src.operations as operations, operations.data as data then
    {
        data.values as values where "blockindex = 0 and groupindex = 0 and itemid = 'id_1601'" then
        {
            src -> tgt.resource = create('Specimen') as specimen then TransformSpecimenSonstigeUntersuchungen(src, specimen);
        };
    };
}

/* ------------------------------ Specimen ---------------------------- */
group TransformSpecimenSonstigeUntersuchungen(source src: CTS_Transport, target tgt: Specimen)
{
    src -> tgt.id = uuid();
    src -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Specimen/nNGM';

    // Type
    src -> tgt.type as type, type.coding as snomedGlobalPatientSet, snomedGlobalPatientSet.system = 'http://snomed.info/sct',
                                                                    snomedGlobalPatientSet.version = 'http://snomed.info/sct/900000000000207008',
                                                                    snomedGlobalPatientSet.code = 'UNKNOWN';

    // Patient reference 
    src.patid as patid -> tgt.subject = create('Reference') as subject, subject.reference = evaluate(patid, '\'Patient/\' + $this');

    src.operations as operations, operations.data as data then
    {
        /* ------------------------------ Healex Referenzen ---------------------------- */
        // Biopsy-ID
        data.values as values where "blockindex = 0 and groupindex = 0 and itemid = 'id_1601'" then
        {
            values.value as bid -> tgt.identifier = create('identifier') as biopsieID,
                                                            biopsieID.system= 'http://uk-koeln.de/NamingSystem/nNGM/biopsienummer',
                                                            biopsieID.value = bid;
        };

    };
}

/* ------------------------------ Check if DiagnosticReport needs to be created ---------------------------- */
group CreateDiagnosticReportSonstigeUntersuchungen(source src: CTS_Transport, target tgt: BackboneElement)
{
    src.operations as operations, operations.data as data then
    {   
        data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'assessment_id'" then
        {
            src -> tgt.resource = create('DiagnosticReport') as diagnosticReport then TransformDiagnosticReportSonstigeUntersuchungen(src, diagnosticReport);
        };
    };
}

/* ------------------------------ DiagnosticReport ---------------------------- */
group TransformDiagnosticReportSonstigeUntersuchungen(source src: CTS_Transport, target tgt: DiagnosticReport)
{
    // Metadata
    src -> tgt.id = uuid();
    src -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/DiagnosticReport/nNGM/befund';

    // Status
    src ->  tgt.status as status, 
            status.extension as dataAbsentReason, 
            dataAbsentReason.url = 'http://hl7.org/fhir/StructureDefinition/data-absent-reason', 
            dataAbsentReason.valueCode = cast('not-asked', 'FHIR.code');

    // Code
    src ->  tgt.code as code, 
            code.extension as dataAbsentReason, 
            dataAbsentReason.url = 'http://hl7.org/fhir/StructureDefinition/data-absent-reason', 
            dataAbsentReason.valueCode = cast('not-asked', 'FHIR.code');

    src.operations as operations, operations.data as data then
    {
        //Referenzen
        //Untersuchungs-ID
        data.values as values where "blockindex = 1 and groupindex = 0 and itemid = 'assessment_id'" then
        {
            values.value as id -> tgt.identifier = create('Identifier') as befundNummer,
                                                          befundNummer.system = 'http://uk-koeln.de/NamingSystem/nNGM/befundnummer',
                                                          befundNummer.value = id;
        };
    };
}

/* ------------------------------ Organization ---------------------------- */
group CreateOrganizationSonstigeUntersuchungen(source src: CTS_Transport, target tgt: BackboneElement)
{
    src.operations as operations, operations.data as data then
    {
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'id_2435'" then
        {
            src -> tgt.resource = create('Organization') as organization then TransformOrganizationSonstigeUntersuchungen(src, organization);
        };
    };
}

/* ------------------------------ Organization ---------------------------- */
group TransformOrganizationSonstigeUntersuchungen(source src: CTS_Transport, target tgt: Organization)
{
    src -> tgt.id = uuid();
    src -> tgt.meta as meta collate, meta.profile = 'http://clinicalsite.org/fhir/StructureDefinition/organizationalunit';

    src.operations as operations, operations.data as data then
    {
        /* ------------------------------ Netzwerkzentrum ---------------------------- */
        // Standort
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'id_2435'" then
        {
            values.value as name -> tgt.name = name;
        };

    };
}

/* ------------------------------ Check if Observation needs to be created ---------------------------- */
group CreateObservationSonstigeUntersuchungen(source src: CTS_Transport, target tgt: BackboneElement)
{
    src.operations as operations, operations.data as data then
    {
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid ='id_2618'
                                    or blockindex = 3 and groupindex = 0 and repeatindex = 0 and itemid ='id_2527'
                                    or blockindex = 3 and groupindex = 0 and repeatindex = 0 and itemid ='id_2026'
                                    or blockindex = 3 and groupindex = 0 and repeatindex = 0 and itemid ='id_2027'
                                    or blockindex = 3 and groupindex = 0 and repeatindex = 0 and itemid ='id_2028'
                                    or blockindex = 3 and groupindex = 0 and repeatindex = 0 and itemid ='id_2282'
                                    or blockindex = 3 and groupindex = 0 and repeatindex = 0 and itemid ='id_2283'
                                    or blockindex = 3 and groupindex = 0 and repeatindex = 0 and itemid ='id_2031'" then
        {
            src -> tgt.resource = create('Observation') as observation then TransformObservationSonstigeUntersuchungen(src, observation);
        };
    };
}

/* ------------------------------------ Observation ----------------------------------- */
group TransformObservationSonstigeUntersuchungen(source src: CTS_Transport, target tgt: Observation)
{
    src -> tgt.id = uuid();
    src -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/Observation/weitere-untersuchung';
    
    src ->  tgt.status as status, 
            status.extension as dataAbsentReason, 
            dataAbsentReason.url = 'http://hl7.org/fhir/StructureDefinition/data-absent-reason', 
            dataAbsentReason.valueCode = cast('not-asked', 'FHIR.code');


    src -> tgt.method as method,
            method.extension as dataAbsentReason, 
            dataAbsentReason.url = 'http://hl7.org/fhir/StructureDefinition/data-absent-reason', 
            dataAbsentReason.valueCode = cast('not-asked', 'FHIR.code');

    src.operations as operations, operations.data as data then
    {
        // SOP-Versionsnummer des Standorts
        data.values as values where "blockindex = 2 and groupindex = 0 and itemid = 'id_2618'" then
        {
            values.value as sop -> tgt.component = create('BackboneElement') as componentSop then
            {
                sop -> componentSop.valueString = sop;
                sop -> componentSop.code = cc('http://ncit.nci.nih.gov', 'C48443');
            };
        };
        // Date of Assessment
        data.values as values where "blockindex = 3 and groupindex = 0 and repeatindex = 0 and itemid ='id_2527'" then
        {
            values.value as effectiveDT -> tgt.effectiveDateTime = dateOp(effectiveDT, 'date');
        };
        //Bezeichnung
        data.values as values where "blockindex = 3 and groupindex = 0 and repeatindex = 0 and itemid ='id_2026'" then
        {
            values.value as value -> tgt.code = create('CodeableConcept') as code then
            {
                value -> code.coding as coding, 
                            coding.system = 'http://loinc.org',
                            coding.code = '69548-6';
                value -> code.text = value;
            };
        };
        // Assay
        data.values as values where "blockindex = 3 and groupindex = 0 and repeatindex = 0 and itemid ='id_2027'" then
        {
            values.value as assay -> tgt.component = create('BackboneElement') as componentAssay then
            {
                assay -> componentAssay.code = cc('http://ncit.nci.nih.gov', 'C60819');
                assay -> componentAssay.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/ish-fish-kits', assay) ;
            };
        };

        // Hersteller
        data.values as values where "blockindex = 3 and groupindex = 0 and repeatindex = 0 and itemid ='id_2028'" then
        {
            values.value as hersteller -> tgt.component = create('BackboneElement') as componentHersteller then
            {
                hersteller -> componentHersteller.code = cc('http://ncit.nci.nih.gov', 'C25392');
                hersteller -> componentHersteller.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/hersteller-molpatho', hersteller);
            };
        };
        
        //Gen
        data.values as values where "blockindex = 3 and groupindex = 0 and repeatindex = 0 and itemid ='id_2282'" then
        {
            values.value as geneStudied -> tgt.component = create('BackboneElement') as componentGeneStudied then
            {
                geneStudied -> componentGeneStudied.code = cc('http://ncit.nci.nih.gov', '48018-6');
                geneStudied -> componentGeneStudied.valueCodeableConcept = cc('http://hl7.org/fhir/uv/genomics-reporting/ValueSet/hgnc', geneStudied);
            };
        };
        //Phaenotyp
        data.values as values where "blockindex = 3 and groupindex = 0 and repeatindex = 0 and itemid ='id_2283'" then
        {
            
            values.value as phaenotyp where "$this.value = 'Expression'" then 
            {
                phaenotyp -> tgt.component = create('BackboneElement') as componentPhaenotyp then
                {
                    phaenotyp -> componentPhaenotyp.code = cc('http://ncit.nci.nih.gov', 'C16977');
                    phaenotyp -> componentPhaenotyp.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/phenotypes', 'C80488');
                };
            };
            values.value as phaenotyp where "$this.value = 'Fusion Gene'" then 
            {
                phaenotyp -> tgt.component = create('BackboneElement') as componentPhaenotyp then
                {
                    phaenotyp -> componentPhaenotyp.code = cc('http://ncit.nci.nih.gov', 'C16977');
                    phaenotyp -> componentPhaenotyp.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/phenotypes', 'C28510');
                };
            };
            values.value as phaenotyp where "$this.value = 'Amplification'" then 
            {
                phaenotyp -> tgt.component = create('BackboneElement') as componentPhaenotyp then
                {
                    phaenotyp -> componentPhaenotyp.code = cc('http://ncit.nci.nih.gov', 'C16977');
                    phaenotyp -> componentPhaenotyp.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/phenotypes', 'C25418');
                };
            };
            values.value as phaenotyp where "$this.value != 'Amplification' and $this.value != 'Expression' and $this.value != 'Fusion Gene'" then 
            {
                phaenotyp -> tgt.component = create('BackboneElement') as componentPhaenotyp then
                {
                    phaenotyp -> componentPhaenotyp.code = cc('http://ncit.nci.nih.gov', 'C16977');
                    phaenotyp -> componentPhaenotyp.valueString = phaenotyp;
                };
            };
        };
        // Ergebnis
        data.values as values where "blockindex = 3 and groupindex = 0  and repeatindex = 0 and itemid = 'id_2031'" then
        {
            values.value as ergebnis where "$this.value = 'positiv'" then 
            {
                ergebnis -> tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/act_non_act_na-value-codes', 'aktivierende-Mutation','aktivierende Mutation');
            };
            values.value as ergebnis where "$this.value = 'negativ'" then 
            {
                ergebnis -> tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/act_non_act_na-value-codes', 'keine-aktivierende-Mutation','keine aktivierende Mutation');
            };
            values.value as ergebnis where "$this.value = 'nicht auswertbar'" then 
            {
                ergebnis -> tgt.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/act_non_act_na-value-codes', 'nicht-auswertbar','nicht auswertbar');
            };
        };
    };
}


/* -------------------------------------- Check if ServiceRequest needs to be created -------------------------------------------- */
group CreateServiceRequestSonstigeUntersuchungen(source src: CTS_Transport, target tgt: BackboneElement)
{
    src.operations as operations, operations.data as data then
    {
        data.values as values where "blockindex = 4 and groupindex = 0 and itemid = 'id_2520'
                                    or blockindex = 4 and groupindex = 0 and itemid = 'id_2462'
                                    or blockindex = 4 and groupindex = 0 and itemid = 'id_2521'" then
        {
            src -> tgt.resource = create('ServiceRequest') as serviceRequest then TransformServiceRequestSonstigeUntersuchungen(src, serviceRequest);
        };
    };
}

/* -------------------------------------- ServiceRequest -------------------------------------------- */
group TransformServiceRequestSonstigeUntersuchungen(source src: CTS_Transport, target tgt: ServiceRequest)
{
    // Metadata
    src -> tgt.id = uuid();
    src -> tgt.meta as meta collate, meta.profile = 'http://uk-koeln.de/fhir/StructureDefinition/ServiceRequest/nNGM/testung';

    // intent
    src -> tgt.intent = 'proposal';

     // Subject
    src.patid as patid -> tgt.subject = create('Reference') as subject, subject.reference = evaluate(patid, '\'Patient/\' + $this');

    // Category
    src -> tgt.category as category, 
            category.coding as coding,
            coding.code as code,
            code.extension as dataAbsentReason, 
            dataAbsentReason.url = 'http://hl7.org/fhir/StructureDefinition/data-absent-reason', 
            dataAbsentReason.valueCode = cast('not-asked', 'FHIR.code');

    // Code 
    src -> tgt.code = cc('http://uk-koeln.de/fhir/ValueSet/nngm/testung-anforderung-code', 'sonstige-untersuchungen');

    // authoredOn
    src -> tgt.authoredOn as code, 
            code.extension as dataAbsentReason, 
            dataAbsentReason.url = 'http://hl7.org/fhir/StructureDefinition/data-absent-reason', 
            dataAbsentReason.valueCode = cast('not-asked', 'FHIR.code');    
        
    src.operations as operations, operations.data as data then
    {
        //Status der Untersuchungen
        //Durchfuehrung
        data.values as values where "blockindex = 4 and groupindex = 0 and itemid = 'id_2520'" then
        {
            values.value as value where "$this.value = 'in Bearbeitung'" then 
            {
                value -> tgt.status = 'active';
            };
            values.value as value where "$this.value = 'abgeschlossen'" then 
            {
                value -> tgt.status = 'completed';
            };
        };
    };

    // Extensions
    src then TransformSonstigeUntersuchungenStatusExtension(src, tgt);
}

/* -------------------------------------- Create double extensions for Status -------------------------------------------- */
group TransformSonstigeUntersuchungenStatusExtension(source src: CTS_Transport, target tgt: ServiceRequest)
{
    src.operations as operations, operations.data as data then
    {
        // Status des Abschlusses
        data.values as values where "blockindex = 4 and groupindex = 0 and itemid = 'id_2462'" then
        {
            values.value as value where "%tgt.status.extension.extension.where(url = 'status').exists().not()" then
            {
                value -> tgt.status as status collate, status.extension as statusAbschluss collate, statusAbschluss.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/nNGM/statusAbschluss', statusAbschluss.extension as statusExtension then
                {
                    value -> statusExtension.valueCodeableConcept = cc('http://uk-koeln.de/fhir/ValueSet/NNGM/statusAbschluss',value, value);
                    value -> statusExtension.url = 'status';
                };
            };
        };

        //Datum des Abschlusses
        data.values as values where "blockindex = 4 and groupindex = 0 and itemid = 'id_2521'" then
        {
            values.value as value where "%tgt.status.extension.extension.where(url = 'datum').exists().not()" then
            {
                value -> tgt.status as status collate, status.extension as statusAbschluss collate, statusAbschluss.url = 'http://uk-koeln.de/fhir/StructureDefinition/Extension/nNGM/statusAbschluss', statusAbschluss.extension as datumExtension then
                {
                    value -> datumExtension.valueDate = dateOp(value, 'date');
                    value -> datumExtension.url = 'datum';
                };
            };
        };
    };
}